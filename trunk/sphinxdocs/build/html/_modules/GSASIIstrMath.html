

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GSASIIstrMath &mdash; GSAS-II 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GSAS-II 0.2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for GSASIIstrMath</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">*GSASIIstrMath - structure math routines*</span>
<span class="sd">-----------------------------------------</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c">########### SVN repository information ###################</span>
<span class="c"># $Date: 2013-05-17 12:13:15 -0500 (Fri, 17 May 2013) $</span>
<span class="c"># $Author: vondreele $</span>
<span class="c"># $Revision: 920 $</span>
<span class="c"># $URL: https://subversion.xor.aps.anl.gov/pyGSAS/trunk/GSASIIstrMath.py $</span>
<span class="c"># $Id: GSASIIstrMath.py 920 2013-05-17 17:13:15Z vondreele $</span>
<span class="c">########### SVN repository information ###################</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">nl</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="kn">as</span> <span class="nn">so</span>
<span class="kn">import</span> <span class="nn">GSASIIpath</span>
<span class="n">GSASIIpath</span><span class="o">.</span><span class="n">SetVersionNumber</span><span class="p">(</span><span class="s">&quot;$Revision: 920 $&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">GSASIIElem</span> <span class="kn">as</span> <span class="nn">G2el</span>
<span class="kn">import</span> <span class="nn">GSASIIlattice</span> <span class="kn">as</span> <span class="nn">G2lat</span>
<span class="kn">import</span> <span class="nn">GSASIIspc</span> <span class="kn">as</span> <span class="nn">G2spc</span>
<span class="kn">import</span> <span class="nn">GSASIIpwd</span> <span class="kn">as</span> <span class="nn">G2pwd</span>
<span class="kn">import</span> <span class="nn">GSASIImapvars</span> <span class="kn">as</span> <span class="nn">G2mv</span>
<span class="kn">import</span> <span class="nn">GSASIImath</span> <span class="kn">as</span> <span class="nn">G2mth</span>

<span class="n">sind</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">cosd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">tand</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">asind</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">acosd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">atan2d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    
<span class="n">ateln2</span> <span class="o">=</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>

<span class="c">################################################################################</span>
<span class="c">##### Rigid Body Models</span>
<span class="c">################################################################################</span>
        
<div class="viewcode-block" id="ApplyRBModels"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.ApplyRBModels">[docs]</a><span class="k">def</span> <span class="nf">ApplyRBModels</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">,</span><span class="n">Update</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Takes RB info from RBModels in Phase and RB data in rigidbodyDict along with</span>
<span class="sd">    current RB values in parmDict &amp; modifies atom contents (xyz &amp; Uij) of parmDict</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">atxIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Ax:&#39;</span><span class="p">,</span><span class="s">&#39;Ay:&#39;</span><span class="p">,</span><span class="s">&#39;Az:&#39;</span><span class="p">]</span>
    <span class="n">atuIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;AU11:&#39;</span><span class="p">,</span><span class="s">&#39;AU22:&#39;</span><span class="p">,</span><span class="s">&#39;AU33:&#39;</span><span class="p">,</span><span class="s">&#39;AU12:&#39;</span><span class="p">,</span><span class="s">&#39;AU13:&#39;</span><span class="p">,</span><span class="s">&#39;AU23:&#39;</span><span class="p">]</span>
    <span class="n">RBIds</span> <span class="o">=</span> <span class="n">rigidbodyDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;RBIds&#39;</span><span class="p">,{</span><span class="s">&#39;Vector&#39;</span><span class="p">:[],</span><span class="s">&#39;Residue&#39;</span><span class="p">:[]})</span>  <span class="c">#these are lists of rbIds</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="n">VRBIds</span> <span class="o">=</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">]</span>
    <span class="n">RRBIds</span> <span class="o">=</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Update</span><span class="p">:</span>
        <span class="n">RBData</span> <span class="o">=</span> <span class="n">rigidbodyDict</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RBData</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">rigidbodyDict</span><span class="p">)</span>     <span class="c"># don&#39;t mess with original!</span>
    <span class="k">if</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">]:</span>                       <span class="c"># first update the vector magnitudes</span>
        <span class="n">VRBData</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">rbId</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">VRBIds</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">VRBData</span><span class="p">[</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;VectMag&#39;</span><span class="p">])):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;::RBV;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">VRBData</span><span class="p">[</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;VectMag&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">Phases</span><span class="p">:</span>
        <span class="n">Phase</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
        <span class="n">General</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">AtLookup</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FillAtomLookUp</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">])</span>
        <span class="n">pfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::&#39;</span>
        <span class="k">if</span> <span class="n">Update</span><span class="p">:</span>
            <span class="n">RBModels</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">RBModels</span> <span class="o">=</span>  <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">])</span> <span class="c"># again don&#39;t mess with original!</span>
        <span class="k">for</span> <span class="n">irb</span><span class="p">,</span><span class="n">RBObj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBModels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Vector&#39;</span><span class="p">,[])):</span>
            <span class="n">jrb</span> <span class="o">=</span> <span class="n">VRBIds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">])</span>
            <span class="n">rbsx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">irb</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jrb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">px</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBVPx:&#39;</span><span class="p">,</span><span class="s">&#39;RBVPy:&#39;</span><span class="p">,</span><span class="s">&#39;RBVPz:&#39;</span><span class="p">]):</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">px</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">po</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBVOa:&#39;</span><span class="p">,</span><span class="s">&#39;RBVOi:&#39;</span><span class="p">,</span><span class="s">&#39;RBVOj:&#39;</span><span class="p">,</span><span class="s">&#39;RBVOk:&#39;</span><span class="p">]):</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">po</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="n">TLS</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">TLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBVT11:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT22:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT33:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT12:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT13:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT23:&#39;</span><span class="p">]):</span>
                    <span class="n">TLS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">pt</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">TLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBVL11:&#39;</span><span class="p">,</span><span class="s">&#39;RBVL22:&#39;</span><span class="p">,</span><span class="s">&#39;RBVL33:&#39;</span><span class="p">,</span><span class="s">&#39;RBVL12:&#39;</span><span class="p">,</span><span class="s">&#39;RBVL13:&#39;</span><span class="p">,</span><span class="s">&#39;RBVL23:&#39;</span><span class="p">]):</span>
                    <span class="n">TLS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">pt</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">TLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBVS12:&#39;</span><span class="p">,</span><span class="s">&#39;RBVS13:&#39;</span><span class="p">,</span><span class="s">&#39;RBVS21:&#39;</span><span class="p">,</span><span class="s">&#39;RBVS23:&#39;</span><span class="p">,</span><span class="s">&#39;RBVS31:&#39;</span><span class="p">,</span><span class="s">&#39;RBVS32:&#39;</span><span class="p">,</span><span class="s">&#39;RBVSAA:&#39;</span><span class="p">,</span><span class="s">&#39;RBVSBB:&#39;</span><span class="p">]):</span>
                    <span class="n">TLS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">pt</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;U&#39;</span> <span class="ow">in</span> <span class="n">TLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">TLS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVU:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="n">XYZ</span><span class="p">,</span><span class="n">Cart</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Vector&#39;</span><span class="p">)</span>
            <span class="n">UIJ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBUIJ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">Cart</span><span class="p">,</span><span class="n">RBObj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
                <span class="n">atId</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atxIds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">UIJ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                        <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atuIds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span> <span class="o">=</span> <span class="n">UIJ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">UIJ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;I&#39;</span><span class="p">:</span>
                    <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AUiso:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span> <span class="o">=</span> <span class="n">UIJ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            
        <span class="k">for</span> <span class="n">irb</span><span class="p">,</span><span class="n">RBObj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBModels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Residue&#39;</span><span class="p">,[])):</span>
            <span class="n">jrb</span> <span class="o">=</span> <span class="n">RRBIds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">])</span>
            <span class="n">rbsx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">irb</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jrb</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">px</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBRPx:&#39;</span><span class="p">,</span><span class="s">&#39;RBRPy:&#39;</span><span class="p">,</span><span class="s">&#39;RBRPz:&#39;</span><span class="p">]):</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">px</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">po</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBROa:&#39;</span><span class="p">,</span><span class="s">&#39;RBROi:&#39;</span><span class="p">,</span><span class="s">&#39;RBROj:&#39;</span><span class="p">,</span><span class="s">&#39;RBROk:&#39;</span><span class="p">]):</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">po</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>                
            <span class="n">TLS</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">TLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBRT11:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT22:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT33:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT12:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT13:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT23:&#39;</span><span class="p">]):</span>
                    <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">pt</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">TLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBRL11:&#39;</span><span class="p">,</span><span class="s">&#39;RBRL22:&#39;</span><span class="p">,</span><span class="s">&#39;RBRL33:&#39;</span><span class="p">,</span><span class="s">&#39;RBRL12:&#39;</span><span class="p">,</span><span class="s">&#39;RBRL13:&#39;</span><span class="p">,</span><span class="s">&#39;RBRL23:&#39;</span><span class="p">]):</span>
                    <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">pt</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">TLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBRS12:&#39;</span><span class="p">,</span><span class="s">&#39;RBRS13:&#39;</span><span class="p">,</span><span class="s">&#39;RBRS21:&#39;</span><span class="p">,</span><span class="s">&#39;RBRS23:&#39;</span><span class="p">,</span><span class="s">&#39;RBRS31:&#39;</span><span class="p">,</span><span class="s">&#39;RBRS32:&#39;</span><span class="p">,</span><span class="s">&#39;RBRSAA:&#39;</span><span class="p">,</span><span class="s">&#39;RBRSBB:&#39;</span><span class="p">]):</span>
                    <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">pt</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;U&#39;</span> <span class="ow">in</span> <span class="n">TLS</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRU:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">itors</span><span class="p">,</span><span class="n">tors</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]):</span>
                <span class="n">tors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRTr;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itors</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span>
            <span class="n">XYZ</span><span class="p">,</span><span class="n">Cart</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">)</span>
            <span class="n">UIJ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBUIJ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">Cart</span><span class="p">,</span><span class="n">RBObj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
                <span class="n">atId</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atxIds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">UIJ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                        <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atuIds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span> <span class="o">=</span> <span class="n">UIJ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">UIJ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;I&#39;</span><span class="p">:</span>
                    <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AUiso:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span> <span class="o">=</span> <span class="n">UIJ</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    </div>
<div class="viewcode-block" id="ApplyRBModelDervs"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.ApplyRBModelDervs">[docs]</a><span class="k">def</span> <span class="nf">ApplyRBModelDervs</span><span class="p">(</span><span class="n">dFdvDict</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">,</span><span class="n">Phase</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">atxIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;dAx:&#39;</span><span class="p">,</span><span class="s">&#39;dAy:&#39;</span><span class="p">,</span><span class="s">&#39;dAz:&#39;</span><span class="p">]</span>
    <span class="n">atuIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;AU11:&#39;</span><span class="p">,</span><span class="s">&#39;AU22:&#39;</span><span class="p">,</span><span class="s">&#39;AU33:&#39;</span><span class="p">,</span><span class="s">&#39;AU12:&#39;</span><span class="p">,</span><span class="s">&#39;AU13:&#39;</span><span class="p">,</span><span class="s">&#39;AU23:&#39;</span><span class="p">]</span>
    <span class="n">TIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;T11:&#39;</span><span class="p">,</span><span class="s">&#39;T22:&#39;</span><span class="p">,</span><span class="s">&#39;T33:&#39;</span><span class="p">,</span><span class="s">&#39;T12:&#39;</span><span class="p">,</span><span class="s">&#39;T13:&#39;</span><span class="p">,</span><span class="s">&#39;T23:&#39;</span><span class="p">]</span>
    <span class="n">LIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;L11:&#39;</span><span class="p">,</span><span class="s">&#39;L22:&#39;</span><span class="p">,</span><span class="s">&#39;L33:&#39;</span><span class="p">,</span><span class="s">&#39;L12:&#39;</span><span class="p">,</span><span class="s">&#39;L13:&#39;</span><span class="p">,</span><span class="s">&#39;L23:&#39;</span><span class="p">]</span>
    <span class="n">SIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;S12:&#39;</span><span class="p">,</span><span class="s">&#39;S13:&#39;</span><span class="p">,</span><span class="s">&#39;S21:&#39;</span><span class="p">,</span><span class="s">&#39;S23:&#39;</span><span class="p">,</span><span class="s">&#39;S31:&#39;</span><span class="p">,</span><span class="s">&#39;S32:&#39;</span><span class="p">,</span><span class="s">&#39;SAA:&#39;</span><span class="p">,</span><span class="s">&#39;SBB:&#39;</span><span class="p">]</span>
    <span class="n">PIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Px:&#39;</span><span class="p">,</span><span class="s">&#39;Py:&#39;</span><span class="p">,</span><span class="s">&#39;Pz:&#39;</span><span class="p">]</span>
    <span class="n">OIds</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Oa:&#39;</span><span class="p">,</span><span class="s">&#39;Oi:&#39;</span><span class="p">,</span><span class="s">&#39;Oj:&#39;</span><span class="p">,</span><span class="s">&#39;Ok:&#39;</span><span class="p">]</span>
    <span class="n">RBIds</span> <span class="o">=</span> <span class="n">rigidbodyDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;RBIds&#39;</span><span class="p">,{</span><span class="s">&#39;Vector&#39;</span><span class="p">:[],</span><span class="s">&#39;Residue&#39;</span><span class="p">:[]})</span>  <span class="c">#these are lists of rbIds</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="n">VRBIds</span> <span class="o">=</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">]</span>
    <span class="n">RRBIds</span> <span class="o">=</span> <span class="n">RBIds</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span>
    <span class="n">RBData</span> <span class="o">=</span> <span class="n">rigidbodyDict</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;RB&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">dFdvDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>        <span class="c">#NB: this is a vector which is no. refl. long &amp; must be filled!</span>
    <span class="n">General</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="n">rpd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span>
    <span class="n">rpd2</span> <span class="o">=</span> <span class="n">rpd</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">Bmat</span><span class="p">))</span>
    <span class="n">gvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">g</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">g</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]]))</span>
    <span class="n">AtLookup</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FillAtomLookUp</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">])</span>
    <span class="n">pfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::&#39;</span>
    <span class="n">RBModels</span> <span class="o">=</span>  <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">irb</span><span class="p">,</span><span class="n">RBObj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBModels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Vector&#39;</span><span class="p">,[])):</span>
        <span class="n">VModel</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">][</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]]</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Pos</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">jrb</span> <span class="o">=</span> <span class="n">VRBIds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">])</span>
        <span class="n">rbsx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">irb</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jrb</span><span class="p">)</span>
        <span class="n">dXdv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">VModel</span><span class="p">[</span><span class="s">&#39;VectMag&#39;</span><span class="p">])):</span>
            <span class="n">dCdv</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">VModel</span><span class="p">[</span><span class="s">&#39;rbVect&#39;</span><span class="p">][</span><span class="n">iv</span><span class="p">]:</span>
                <span class="n">dCdv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">vec</span><span class="p">))</span>
            <span class="n">dXdv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dCdv</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">XYZ</span><span class="p">,</span><span class="n">Cart</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Vector&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ia</span><span class="p">,</span><span class="n">atId</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]):</span>
            <span class="n">atNum</span> <span class="o">=</span> <span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">]</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.0001</span>
            <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">VModel</span><span class="p">[</span><span class="s">&#39;VectMag&#39;</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">dFdvDict</span><span class="p">[</span><span class="s">&#39;::RBV;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iv</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jrb</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">dXdv</span><span class="p">[</span><span class="n">iv</span><span class="p">][</span><span class="n">ia</span><span class="p">][</span><span class="n">ix</span><span class="p">]</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atxIds</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atNum</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBVPx:&#39;</span><span class="p">,</span><span class="s">&#39;RBVPy:&#39;</span><span class="p">,</span><span class="s">&#39;RBVPz:&#39;</span><span class="p">]):</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atxIds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atNum</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span>
                <span class="n">XYZ1</span><span class="p">,</span><span class="n">Cart1</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Vector&#39;</span><span class="p">)</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">dx</span>
                <span class="n">XYZ2</span><span class="p">,</span><span class="n">Cart2</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Vector&#39;</span><span class="p">)</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span>
                <span class="n">dXdO</span> <span class="o">=</span> <span class="p">(</span><span class="n">XYZ2</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">-</span><span class="n">XYZ1</span><span class="p">[</span><span class="n">ia</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBV&#39;</span><span class="o">+</span><span class="n">OIds</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dXdO</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atxIds</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atNum</span><span class="p">)]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Cart</span><span class="p">[</span><span class="n">ia</span><span class="p">])</span>
            <span class="n">dFdu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">Uid</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span> <span class="k">for</span> <span class="n">Uid</span> <span class="ow">in</span> <span class="n">atuIds</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">gvec</span>
            <span class="n">dFdu</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">U6toUij</span><span class="p">(</span><span class="n">dFdu</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">dFdu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">dFdu</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])),([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>            
            <span class="n">dFdu</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">UijtoU6</span><span class="p">(</span><span class="n">dFdu</span><span class="p">)</span>
            <span class="n">atNum</span> <span class="o">=</span> <span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBVT11:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT22:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT33:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT12:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT13:&#39;</span><span class="p">,</span><span class="s">&#39;RBVT23:&#39;</span><span class="p">]):</span>
                    <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVL11:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVL22:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVL33:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVL12:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVL13:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVL23:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVS12:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVS13:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVS21:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVS23:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVS31:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVS32:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVSAA:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVSBB:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;U&#39;</span> <span class="ow">in</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBVU:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AUiso:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span>


    <span class="k">for</span> <span class="n">irb</span><span class="p">,</span><span class="n">RBObj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBModels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Residue&#39;</span><span class="p">,[])):</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Pos</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">jrb</span> <span class="o">=</span> <span class="n">RRBIds</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">])</span>
        <span class="n">torData</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]][</span><span class="s">&#39;rbSeq&#39;</span><span class="p">]</span>
        <span class="n">rbsx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">irb</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jrb</span><span class="p">)</span>
        <span class="n">XYZ</span><span class="p">,</span><span class="n">Cart</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">itors</span><span class="p">,</span><span class="n">tors</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]):</span>     <span class="c">#derivative error?</span>
            <span class="n">tname</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRTr;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">itors</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">rbsx</span>           
            <span class="n">orId</span><span class="p">,</span><span class="n">pvId</span> <span class="o">=</span> <span class="n">torData</span><span class="p">[</span><span class="n">itors</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">pivotVec</span> <span class="o">=</span> <span class="n">Cart</span><span class="p">[</span><span class="n">orId</span><span class="p">]</span><span class="o">-</span><span class="n">Cart</span><span class="p">[</span><span class="n">pvId</span><span class="p">]</span>
            <span class="n">QA</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span><span class="n">pivotVec</span><span class="p">)</span>
            <span class="n">QB</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span><span class="n">pivotVec</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ir</span> <span class="ow">in</span> <span class="n">torData</span><span class="p">[</span><span class="n">itors</span><span class="p">][</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">atNum</span> <span class="o">=</span> <span class="n">AtLookup</span><span class="p">[</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">][</span><span class="n">ir</span><span class="p">]]</span>
                <span class="n">rVec</span> <span class="o">=</span> <span class="n">Cart</span><span class="p">[</span><span class="n">ir</span><span class="p">]</span><span class="o">-</span><span class="n">Cart</span><span class="p">[</span><span class="n">pvId</span><span class="p">]</span>
                <span class="n">dR</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QB</span><span class="p">,</span><span class="n">rVec</span><span class="p">)</span><span class="o">-</span><span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QA</span><span class="p">,</span><span class="n">rVec</span><span class="p">)</span>
                <span class="n">dRdT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">dR</span><span class="p">))</span><span class="o">/.</span><span class="mo">002</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">dFdvDict</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dRdT</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atxIds</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atNum</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">ia</span><span class="p">,</span><span class="n">atId</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]):</span>
            <span class="n">atNum</span> <span class="o">=</span> <span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">]</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="mf">0.0001</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBRPx:&#39;</span><span class="p">,</span><span class="s">&#39;RBRPy:&#39;</span><span class="p">,</span><span class="s">&#39;RBRPz:&#39;</span><span class="p">]):</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atxIds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atNum</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">iv</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span>
                <span class="n">XYZ1</span><span class="p">,</span><span class="n">Cart1</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">)</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">dx</span>
                <span class="n">XYZ2</span><span class="p">,</span><span class="n">Cart2</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">)</span>
                <span class="n">Q</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span>
                <span class="n">dXdO</span> <span class="o">=</span> <span class="p">(</span><span class="n">XYZ2</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">-</span><span class="n">XYZ1</span><span class="p">[</span><span class="n">ia</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBR&#39;</span><span class="o">+</span><span class="n">OIds</span><span class="p">[</span><span class="n">iv</span><span class="p">]</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dXdO</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">atxIds</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">atNum</span><span class="p">)]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Cart</span><span class="p">[</span><span class="n">ia</span><span class="p">])</span>
            <span class="n">dFdu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">Uid</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span> <span class="k">for</span> <span class="n">Uid</span> <span class="ow">in</span> <span class="n">atuIds</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">/</span><span class="n">gvec</span>
            <span class="n">dFdu</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">U6toUij</span><span class="p">(</span><span class="n">dFdu</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">dFdu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Amat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">tensordot</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">dFdu</span><span class="p">,([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])),([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">dFdu</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">UijtoU6</span><span class="p">(</span><span class="n">dFdu</span><span class="p">)</span>
            <span class="n">atNum</span> <span class="o">=</span> <span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;RBRT11:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT22:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT33:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT12:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT13:&#39;</span><span class="p">,</span><span class="s">&#39;RBRT23:&#39;</span><span class="p">]):</span>
                    <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRL11:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRL22:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRL33:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRL12:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRL13:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRL23:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd2</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRS12:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRS13:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRS21:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRS23:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRS31:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRS32:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRSAA:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRSBB:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">*</span><span class="p">(</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dFdu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;U&#39;</span> <span class="ow">in</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;RBRU:&#39;</span><span class="o">+</span><span class="n">rbsx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AUiso:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">atId</span><span class="p">])]</span>
    
<span class="c">################################################################################</span>
<span class="c">##### Penalty &amp; restraint functions </span>
<span class="c">################################################################################</span>
</div>
<div class="viewcode-block" id="penaltyFxn"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.penaltyFxn">[docs]</a><span class="k">def</span> <span class="nf">penaltyFxn</span><span class="p">(</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varyList</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">Histograms</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">restraintDict</span><span class="p">,</span><span class="n">rigidbodyDict</span> <span class="o">=</span> <span class="n">HistoPhases</span>
    <span class="n">pNames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pVals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pWt</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">negWt</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">Phases</span><span class="p">:</span>
        <span class="n">pId</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
        <span class="n">negWt</span><span class="p">[</span><span class="n">pId</span><span class="p">]</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Pawley neg wt&#39;</span><span class="p">]</span>
        <span class="n">General</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">textureData</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">AtLookup</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FillAtomLookUp</span><span class="p">(</span><span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">])</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">phase</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restraintDict</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">phaseRest</span> <span class="o">=</span> <span class="n">restraintDict</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&#39;Bond&#39;</span><span class="p">,</span><span class="s">&#39;Bonds&#39;</span><span class="p">],[</span><span class="s">&#39;Angle&#39;</span><span class="p">,</span><span class="s">&#39;Angles&#39;</span><span class="p">],[</span><span class="s">&#39;Plane&#39;</span><span class="p">,</span><span class="s">&#39;Planes&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s">&#39;Chiral&#39;</span><span class="p">,</span><span class="s">&#39;Volumes&#39;</span><span class="p">],[</span><span class="s">&#39;Torsion&#39;</span><span class="p">,</span><span class="s">&#39;Torsions&#39;</span><span class="p">],[</span><span class="s">&#39;Rama&#39;</span><span class="p">,</span><span class="s">&#39;Ramas&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s">&#39;ChemComp&#39;</span><span class="p">,</span><span class="s">&#39;Sites&#39;</span><span class="p">],[</span><span class="s">&#39;Texture&#39;</span><span class="p">,</span><span class="s">&#39;HKLs&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">rest</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">itemRest</span> <span class="o">=</span> <span class="n">phaseRest</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">itemRest</span><span class="p">[</span><span class="n">rest</span><span class="p">]</span> <span class="ow">and</span> <span class="n">itemRest</span><span class="p">[</span><span class="s">&#39;Use&#39;</span><span class="p">]:</span>
                <span class="n">wt</span> <span class="o">=</span> <span class="n">itemRest</span><span class="p">[</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Bond&#39;</span><span class="p">,</span><span class="s">&#39;Angle&#39;</span><span class="p">,</span><span class="s">&#39;Plane&#39;</span><span class="p">,</span><span class="s">&#39;Chiral&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemRest</span><span class="p">[</span><span class="n">rest</span><span class="p">]):</span>
                        <span class="n">pNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomCoordsByID</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">AtLookup</span><span class="p">,</span><span class="n">indx</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getSyXYZ</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Bond&#39;</span><span class="p">:</span>
                            <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDist</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Angle&#39;</span><span class="p">:</span>
                            <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestAngle</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Plane&#39;</span><span class="p">:</span>
                            <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestPlane</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Chiral&#39;</span><span class="p">:</span>
                            <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestChiral</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">pVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span>
                        <span class="n">pWt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">esd</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">,</span><span class="s">&#39;Rama&#39;</span><span class="p">]:</span>
                    <span class="n">coeffDict</span> <span class="o">=</span> <span class="n">itemRest</span><span class="p">[</span><span class="s">&#39;Coeff&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">cofName</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemRest</span><span class="p">[</span><span class="n">rest</span><span class="p">]):</span>
                        <span class="n">pNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomCoordsByID</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">AtLookup</span><span class="p">,</span><span class="n">indx</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getSyXYZ</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Torsion&#39;</span><span class="p">:</span>
                            <span class="n">tor</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestTorsion</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                            <span class="n">restr</span><span class="p">,</span><span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">calcTorsionEnergy</span><span class="p">(</span><span class="n">tor</span><span class="p">,</span><span class="n">coeffDict</span><span class="p">[</span><span class="n">cofName</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">phi</span><span class="p">,</span><span class="n">psi</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestRama</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                            <span class="n">restr</span><span class="p">,</span><span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">calcRamaEnergy</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="n">psi</span><span class="p">,</span><span class="n">coeffDict</span><span class="p">[</span><span class="n">cofName</span><span class="p">])</span>                               
                        <span class="n">pVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span>
                        <span class="n">pWt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">esd</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;ChemComp&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">factors</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemRest</span><span class="p">[</span><span class="n">rest</span><span class="p">]):</span>
                        <span class="n">pNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="n">mul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cs</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mul</span><span class="o">*</span><span class="n">frac</span><span class="o">*</span><span class="n">factors</span><span class="p">)</span>
                        <span class="n">pVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span>
                        <span class="n">pWt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">esd</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>                    
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Texture&#39;</span><span class="p">:</span>
                    <span class="n">SHkeys</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="n">SHCoef</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetSHCoeff</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">SHkeys</span><span class="p">)</span>
                    <span class="n">shModels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;cylindrical&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="s">&#39;shear - 2/m&#39;</span><span class="p">,</span><span class="s">&#39;rolling - mmm&#39;</span><span class="p">]</span>
                    <span class="n">SamSym</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">shModels</span><span class="p">,[</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;-1&#39;</span><span class="p">,</span><span class="s">&#39;2/m&#39;</span><span class="p">,</span><span class="s">&#39;mmm&#39;</span><span class="p">]))</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">hkl</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">esd1</span><span class="p">,</span><span class="n">ifesd2</span><span class="p">,</span><span class="n">esd2</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">itemRest</span><span class="p">[</span><span class="n">rest</span><span class="p">]):</span>
                        <span class="n">PH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hkl</span><span class="p">)</span>
                        <span class="n">phi</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CrsAng</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hkl</span><span class="p">),</span><span class="n">cell</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="n">ODFln</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Flnh</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span><span class="n">SHCoef</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="n">R</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestPolefig</span><span class="p">(</span><span class="n">ODFln</span><span class="p">,</span><span class="n">SamSym</span><span class="p">[</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">]],</span><span class="n">grid</span><span class="p">)</span>
                        <span class="n">Z1</span> <span class="o">=</span> <span class="o">-</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
                        <span class="n">IndZ1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">Z1</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">IndZ1</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
                            <span class="n">pNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">:</span><span class="si">%.2f</span><span class="s">:</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">R</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">P</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
                            <span class="n">pVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Z1</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                            <span class="n">pWt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">esd1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ifesd2</span><span class="p">:</span>
                            <span class="n">Z2</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">Z</span>
                            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span><span class="n">grid</span><span class="p">):</span>
                                <span class="n">pNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">:</span><span class="si">%.2f</span><span class="s">:</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;-unit&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">R</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">P</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
                                <span class="n">pVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Z1</span><span class="p">[</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ind</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                                <span class="n">pWt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wt</span><span class="o">/</span><span class="n">esd2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
         
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">varyList</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;PWLref&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">pId</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">negWt</span><span class="p">[</span><span class="n">pId</span><span class="p">]:</span>
                <span class="n">pNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">pVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
                <span class="n">pWt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">negWt</span><span class="p">[</span><span class="n">pId</span><span class="p">])</span>
    <span class="n">pVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pVals</span><span class="p">)</span>
    <span class="n">pWt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pWt</span><span class="p">)</span>         <span class="c">#should this be np.sqrt?</span>
    <span class="k">return</span> <span class="n">pNames</span><span class="p">,</span><span class="n">pVals</span><span class="p">,</span><span class="n">pWt</span>
    </div>
<div class="viewcode-block" id="penaltyDeriv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.penaltyDeriv">[docs]</a><span class="k">def</span> <span class="nf">penaltyDeriv</span><span class="p">(</span><span class="n">pNames</span><span class="p">,</span><span class="n">pVal</span><span class="p">,</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varyList</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">Histograms</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">restraintDict</span><span class="p">,</span><span class="n">rigidbodyDict</span> <span class="o">=</span> <span class="n">HistoPhases</span>
    <span class="n">pDerv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">varyList</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">pVal</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">Phases</span><span class="p">:</span>
<span class="c">#        if phase not in restraintDict:</span>
<span class="c">#            continue</span>
        <span class="n">pId</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
        <span class="n">General</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">AtLookup</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FillAtomLookUp</span><span class="p">(</span><span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">])</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">textureData</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span>

        <span class="n">SHkeys</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">SHCoef</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetSHCoeff</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">SHkeys</span><span class="p">)</span>
        <span class="n">shModels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;cylindrical&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="s">&#39;shear - 2/m&#39;</span><span class="p">,</span><span class="s">&#39;rolling - mmm&#39;</span><span class="p">]</span>
        <span class="n">SamSym</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">shModels</span><span class="p">,[</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;-1&#39;</span><span class="p">,</span><span class="s">&#39;2/m&#39;</span><span class="p">,</span><span class="s">&#39;mmm&#39;</span><span class="p">]))</span>
        <span class="n">sam</span> <span class="o">=</span> <span class="n">SamSym</span><span class="p">[</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">]]</span>
        <span class="n">phaseRest</span> <span class="o">=</span> <span class="n">restraintDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phase</span><span class="p">,{})</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Bond&#39;</span><span class="p">:</span><span class="s">&#39;Bonds&#39;</span><span class="p">,</span><span class="s">&#39;Angle&#39;</span><span class="p">:</span><span class="s">&#39;Angles&#39;</span><span class="p">,</span><span class="s">&#39;Plane&#39;</span><span class="p">:</span><span class="s">&#39;Planes&#39;</span><span class="p">,</span>
            <span class="s">&#39;Chiral&#39;</span><span class="p">:</span><span class="s">&#39;Volumes&#39;</span><span class="p">,</span><span class="s">&#39;Torsion&#39;</span><span class="p">:</span><span class="s">&#39;Torsions&#39;</span><span class="p">,</span><span class="s">&#39;Rama&#39;</span><span class="p">:</span><span class="s">&#39;Ramas&#39;</span><span class="p">,</span>
            <span class="s">&#39;ChemComp&#39;</span><span class="p">:</span><span class="s">&#39;Sites&#39;</span><span class="p">,</span><span class="s">&#39;Texture&#39;</span><span class="p">:</span><span class="s">&#39;HKLs&#39;</span><span class="p">}</span>
        <span class="n">lasthkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span><span class="n">pName</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pNames</span><span class="p">):</span>
            <span class="n">pnames</span> <span class="o">=</span> <span class="n">pName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pId</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">pnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">pnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;PWL&#39;</span> <span class="ow">in</span> <span class="n">pName</span><span class="p">:</span>
                    <span class="n">pDerv</span><span class="p">[</span><span class="n">varyList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pName</span><span class="p">)][</span><span class="n">ip</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
                    <span class="k">continue</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pnames</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> 
                <span class="n">itemRest</span> <span class="o">=</span> <span class="n">phaseRest</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Bond&#39;</span><span class="p">,</span><span class="s">&#39;Angle&#39;</span><span class="p">,</span><span class="s">&#39;Plane&#39;</span><span class="p">,</span><span class="s">&#39;Chiral&#39;</span><span class="p">]:</span>
                    <span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span> <span class="o">=</span> <span class="n">itemRest</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]][</span><span class="nb">id</span><span class="p">]</span>
                    <span class="n">dNames</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                        <span class="n">dNames</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;::dA&#39;</span><span class="o">+</span><span class="n">Xname</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="k">for</span> <span class="n">Xname</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">]]</span>
                    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomCoordsByID</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">AtLookup</span><span class="p">,</span><span class="n">indx</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Bond&#39;</span><span class="p">:</span>
                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDeriv</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDist</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Angle&#39;</span><span class="p">:</span>
                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDeriv</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">getRestAngle</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Plane&#39;</span><span class="p">:</span>
                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDeriv</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">getRestPlane</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Chiral&#39;</span><span class="p">:</span>
                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDeriv</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">getRestChiral</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">,</span><span class="s">&#39;Rama&#39;</span><span class="p">]:</span>
                    <span class="n">coffDict</span> <span class="o">=</span> <span class="n">itemRest</span><span class="p">[</span><span class="s">&#39;Coeff&#39;</span><span class="p">]</span>
                    <span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">cofName</span><span class="p">,</span><span class="n">esd</span> <span class="o">=</span> <span class="n">itemRest</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]][</span><span class="nb">id</span><span class="p">]</span>
                    <span class="n">dNames</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                        <span class="n">dNames</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;::dA&#39;</span><span class="o">+</span><span class="n">Xname</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span> <span class="k">for</span> <span class="n">Xname</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">]]</span>
                    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomCoordsByID</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">AtLookup</span><span class="p">,</span><span class="n">indx</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;Torsion&#39;</span><span class="p">:</span>
                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getTorsionDeriv</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">,</span><span class="n">coffDict</span><span class="p">[</span><span class="n">cofName</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRamaDeriv</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">,</span><span class="n">coffDict</span><span class="p">[</span><span class="n">cofName</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;ChemComp&#39;</span><span class="p">:</span>
                    <span class="n">indx</span><span class="p">,</span><span class="n">factors</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span> <span class="o">=</span> <span class="n">itemRest</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]][</span><span class="nb">id</span><span class="p">]</span>
                    <span class="n">dNames</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                        <span class="n">dNames</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;::Afrac:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">AtLookup</span><span class="p">[</span><span class="n">ind</span><span class="p">])]</span>
                        <span class="n">mul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">deriv</span> <span class="o">=</span> <span class="n">mul</span><span class="o">*</span><span class="n">factors</span>
                <span class="k">elif</span> <span class="s">&#39;Texture&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">deriv</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">dNames</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">hkl</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">esd1</span><span class="p">,</span><span class="n">ifesd2</span><span class="p">,</span><span class="n">esd2</span> <span class="o">=</span> <span class="n">itemRest</span><span class="p">[</span><span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]][</span><span class="nb">id</span><span class="p">]</span>
                    <span class="n">hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hkl</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">lasthkl</span><span class="o">-</span><span class="n">hkl</span><span class="p">):</span>
                        <span class="n">PH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hkl</span><span class="p">)</span>
                        <span class="n">phi</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CrsAng</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hkl</span><span class="p">),</span><span class="n">cell</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="n">ODFln</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Flnh</span><span class="p">(</span><span class="bp">False</span><span class="p">,</span><span class="n">SHCoef</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="n">lasthkl</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">hkl</span><span class="p">)</span>                        
                    <span class="k">if</span> <span class="s">&#39;unit&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gam</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pnames</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">psi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pnames</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">SHname</span> <span class="ow">in</span> <span class="n">ODFln</span><span class="p">:</span>
                            <span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">SHname</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                            <span class="n">Ksl</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GetKsl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">sam</span><span class="p">,</span><span class="n">psi</span><span class="p">,</span><span class="n">gam</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">dNames</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;::&#39;</span><span class="o">+</span><span class="n">SHname</span><span class="p">]</span>
                            <span class="n">deriv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">ODFln</span><span class="p">[</span><span class="n">SHname</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ksl</span><span class="o">/</span><span class="n">SHCoef</span><span class="p">[</span><span class="n">SHname</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">dName</span><span class="p">,</span><span class="n">drv</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dNames</span><span class="p">,</span><span class="n">deriv</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ind</span> <span class="o">=</span> <span class="n">varyList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dName</span><span class="p">)</span>
                        <span class="n">pDerv</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">ip</span><span class="p">]</span> <span class="o">+=</span> <span class="n">drv</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">pDerv</span>

<span class="c">################################################################################</span>
<span class="c">##### Function &amp; derivative calculations</span>
<span class="c">################################################################################        </span>
                    </div>
<div class="viewcode-block" id="GetAtomFXU"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetAtomFXU">[docs]</a><span class="k">def</span> <span class="nf">GetAtomFXU</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">Natoms</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;Natoms&#39;</span><span class="p">][</span><span class="n">pfx</span><span class="p">]</span>
    <span class="n">Tdata</span> <span class="o">=</span> <span class="n">Natoms</span><span class="o">*</span><span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,]</span>
    <span class="n">Mdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Natoms</span><span class="p">)</span>
    <span class="n">IAdata</span> <span class="o">=</span> <span class="n">Natoms</span><span class="o">*</span><span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,]</span>
    <span class="n">Fdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Natoms</span><span class="p">)</span>
    <span class="n">FFdata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">BLdata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Xdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">Natoms</span><span class="p">))</span>
    <span class="n">dXdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">Natoms</span><span class="p">))</span>
    <span class="n">Uisodata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Natoms</span><span class="p">)</span>
    <span class="n">Uijdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">6</span><span class="p">,</span><span class="n">Natoms</span><span class="p">))</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Atype:&#39;</span><span class="p">:</span><span class="n">Tdata</span><span class="p">,</span><span class="s">&#39;Amul:&#39;</span><span class="p">:</span><span class="n">Mdata</span><span class="p">,</span><span class="s">&#39;Afrac:&#39;</span><span class="p">:</span><span class="n">Fdata</span><span class="p">,</span><span class="s">&#39;AI/A:&#39;</span><span class="p">:</span><span class="n">IAdata</span><span class="p">,</span>
        <span class="s">&#39;dAx:&#39;</span><span class="p">:</span><span class="n">dXdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;dAy:&#39;</span><span class="p">:</span><span class="n">dXdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;dAz:&#39;</span><span class="p">:</span><span class="n">dXdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s">&#39;Ax:&#39;</span><span class="p">:</span><span class="n">Xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;Ay:&#39;</span><span class="p">:</span><span class="n">Xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;Az:&#39;</span><span class="p">:</span><span class="n">Xdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;AUiso:&#39;</span><span class="p">:</span><span class="n">Uisodata</span><span class="p">,</span>
        <span class="s">&#39;AU11:&#39;</span><span class="p">:</span><span class="n">Uijdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;AU22:&#39;</span><span class="p">:</span><span class="n">Uijdata</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;AU33:&#39;</span><span class="p">:</span><span class="n">Uijdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="s">&#39;AU12:&#39;</span><span class="p">:</span><span class="n">Uijdata</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s">&#39;AU13:&#39;</span><span class="p">:</span><span class="n">Uijdata</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s">&#39;AU23:&#39;</span><span class="p">:</span><span class="n">Uijdata</span><span class="p">[</span><span class="mi">5</span><span class="p">]}</span>
    <span class="k">for</span> <span class="n">iatm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Natoms</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">parm</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="n">key</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iatm</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parm</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">iatm</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">Tdata</span><span class="p">,</span><span class="n">Mdata</span><span class="p">,</span><span class="n">Fdata</span><span class="p">,</span><span class="n">Xdata</span><span class="p">,</span><span class="n">dXdata</span><span class="p">,</span><span class="n">IAdata</span><span class="p">,</span><span class="n">Uisodata</span><span class="p">,</span><span class="n">Uijdata</span>
    </div>
<div class="viewcode-block" id="getFFvalues"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.getFFvalues">[docs]</a><span class="k">def</span> <span class="nf">getFFvalues</span><span class="p">(</span><span class="n">FFtables</span><span class="p">,</span><span class="n">SQ</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">FFvals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">El</span> <span class="ow">in</span> <span class="n">FFtables</span><span class="p">:</span>
        <span class="n">FFvals</span><span class="p">[</span><span class="n">El</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2el</span><span class="o">.</span><span class="n">ScatFac</span><span class="p">(</span><span class="n">FFtables</span><span class="p">[</span><span class="n">El</span><span class="p">],</span><span class="n">SQ</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">FFvals</span>
    </div>
<div class="viewcode-block" id="getBLvalues"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.getBLvalues">[docs]</a><span class="k">def</span> <span class="nf">getBLvalues</span><span class="p">(</span><span class="n">BLtables</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">BLvals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">El</span> <span class="ow">in</span> <span class="n">BLtables</span><span class="p">:</span>
        <span class="n">BLvals</span><span class="p">[</span><span class="n">El</span><span class="p">]</span> <span class="o">=</span> <span class="n">BLtables</span><span class="p">[</span><span class="n">El</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">BLvals</span>
        </div>
<div class="viewcode-block" id="StructureFactor"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.StructureFactor">[docs]</a><span class="k">def</span> <span class="nf">StructureFactor</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Compute structure factors for all h,k,l for phase</span>
<span class="sd">    puts the result, F^2, in each ref[8] in refList</span>
<span class="sd">    input:</span>
<span class="sd">    </span>
<span class="sd">    :param list refList: [ref] where each ref = h,k,l,m,d,...,[equiv h,k,l],phase[equiv] </span>
<span class="sd">    :param np.array G:      reciprocal metric tensor</span>
<span class="sd">    :param str pfx:    phase id string</span>
<span class="sd">    :param dict SGData: space group info. dictionary output from SpcGroup</span>
<span class="sd">    :param dict calcControls:</span>
<span class="sd">    :param dict ParmDict:</span>

<span class="sd">    &#39;&#39;&#39;</span>        
    <span class="n">twopi</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">twopisq</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">phfx</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">hfx</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
    <span class="n">Mast</span> <span class="o">=</span> <span class="n">twopisq</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span><span class="n">ast</span><span class="p">)</span>
    <span class="n">FFtables</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;FFtables&#39;</span><span class="p">]</span>
    <span class="n">BLtables</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;BLtables&#39;</span><span class="p">]</span>
    <span class="n">Tdata</span><span class="p">,</span><span class="n">Mdata</span><span class="p">,</span><span class="n">Fdata</span><span class="p">,</span><span class="n">Xdata</span><span class="p">,</span><span class="n">dXdata</span><span class="p">,</span><span class="n">IAdata</span><span class="p">,</span><span class="n">Uisodata</span><span class="p">,</span><span class="n">Uijdata</span> <span class="o">=</span> <span class="n">GetAtomFXU</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="n">FF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tdata</span><span class="p">))</span>
    <span class="k">if</span> <span class="s">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
        <span class="n">FP</span><span class="p">,</span><span class="n">FPP</span> <span class="o">=</span> <span class="n">G2el</span><span class="o">.</span><span class="n">BlenRes</span><span class="p">(</span><span class="n">Tdata</span><span class="p">,</span><span class="n">BLtables</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">FP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">FFtables</span><span class="p">[</span><span class="n">El</span><span class="p">][</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;FP&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">El</span> <span class="ow">in</span> <span class="n">Tdata</span><span class="p">])</span>
        <span class="n">FPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">FFtables</span><span class="p">[</span><span class="n">El</span><span class="p">][</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;FPP&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">El</span> <span class="ow">in</span> <span class="n">Tdata</span><span class="p">])</span>
    <span class="n">maxPos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGOps&#39;</span><span class="p">])</span>
    <span class="n">Uij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2lat</span><span class="o">.</span><span class="n">U6toUij</span><span class="p">(</span><span class="n">Uijdata</span><span class="p">))</span>
    <span class="n">bij</span> <span class="o">=</span> <span class="n">Mast</span><span class="o">*</span><span class="n">Uij</span><span class="o">.</span><span class="n">T</span>
    <span class="k">for</span> <span class="n">refl</span> <span class="ow">in</span> <span class="n">refList</span><span class="p">:</span>
        <span class="n">fbs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">SQ</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">SQfactor</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">SQ</span><span class="o">*</span><span class="n">twopisq</span>
        <span class="n">Bab</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;BabA&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;BabU&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">SQfactor</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>                <span class="c">#no form factors</span>
            <span class="k">if</span> <span class="s">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                <span class="n">refl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">getBLvalues</span><span class="p">(</span><span class="n">BLtables</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>       <span class="c">#&#39;X&#39;</span>
                <span class="n">refl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">getFFvalues</span><span class="p">(</span><span class="n">FFtables</span><span class="p">,</span><span class="n">SQ</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">El</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Tdata</span><span class="p">):</span>
            <span class="n">FF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">El</span><span class="p">]</span>           
        <span class="n">Uniq</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">twopi</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Uniq</span><span class="p">,(</span><span class="n">dXdata</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Xdata</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">+</span><span class="n">phi</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
        <span class="n">sinp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">cosp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">occ</span> <span class="o">=</span> <span class="n">Mdata</span><span class="o">*</span><span class="n">Fdata</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Uniq</span><span class="p">)</span>
        <span class="n">biso</span> <span class="o">=</span> <span class="o">-</span><span class="n">SQfactor</span><span class="o">*</span><span class="n">Uisodata</span>
        <span class="n">Tiso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">biso</span><span class="o">&lt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">biso</span><span class="p">),</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">HbH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">bij</span><span class="p">,</span><span class="n">h</span><span class="p">))</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">Uniq</span><span class="p">])</span>
        <span class="n">Tuij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">HbH</span><span class="o">&lt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">HbH</span><span class="p">),</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Tcorr</span> <span class="o">=</span> <span class="n">Tiso</span><span class="o">*</span><span class="n">Tuij</span>
        <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">FF</span><span class="o">+</span><span class="n">FP</span><span class="o">-</span><span class="n">Bab</span><span class="p">)</span><span class="o">*</span><span class="n">occ</span><span class="o">*</span><span class="n">cosp</span><span class="o">*</span><span class="n">Tcorr</span><span class="p">,</span><span class="o">-</span><span class="n">FPP</span><span class="o">*</span><span class="n">occ</span><span class="o">*</span><span class="n">sinp</span><span class="o">*</span><span class="n">Tcorr</span><span class="p">])</span>
        <span class="n">fas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>        <span class="c">#real</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGInv&#39;</span><span class="p">]:</span>
            <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">FF</span><span class="o">+</span><span class="n">FP</span><span class="o">-</span><span class="n">Bab</span><span class="p">)</span><span class="o">*</span><span class="n">occ</span><span class="o">*</span><span class="n">sinp</span><span class="o">*</span><span class="n">Tcorr</span><span class="p">,</span><span class="n">FPP</span><span class="o">*</span><span class="n">occ</span><span class="o">*</span><span class="n">cosp</span><span class="o">*</span><span class="n">Tcorr</span><span class="p">])</span>
            <span class="n">fbs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fasq</span> <span class="o">=</span> <span class="n">fas</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">fbsq</span> <span class="o">=</span> <span class="n">fbs</span><span class="o">**</span><span class="mi">2</span>        <span class="c">#imaginary</span>
        <span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fasq</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fbsq</span><span class="p">)</span>
        <span class="n">refl</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">atan2d</span><span class="p">(</span><span class="n">fbs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    </div>
<div class="viewcode-block" id="StructureFactorDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.StructureFactorDerv">[docs]</a><span class="k">def</span> <span class="nf">StructureFactorDerv</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">twopi</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">twopisq</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">phfx</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">hfx</span>
    <span class="n">ast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
    <span class="n">Mast</span> <span class="o">=</span> <span class="n">twopisq</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">ast</span><span class="p">,</span><span class="n">ast</span><span class="p">)</span>
    <span class="n">FFtables</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;FFtables&#39;</span><span class="p">]</span>
    <span class="n">BLtables</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;BLtables&#39;</span><span class="p">]</span>
    <span class="n">Tdata</span><span class="p">,</span><span class="n">Mdata</span><span class="p">,</span><span class="n">Fdata</span><span class="p">,</span><span class="n">Xdata</span><span class="p">,</span><span class="n">dXdata</span><span class="p">,</span><span class="n">IAdata</span><span class="p">,</span><span class="n">Uisodata</span><span class="p">,</span><span class="n">Uijdata</span> <span class="o">=</span> <span class="n">GetAtomFXU</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="n">FF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tdata</span><span class="p">))</span>
    <span class="k">if</span> <span class="s">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
        <span class="n">FP</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">FPP</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">FP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">FFtables</span><span class="p">[</span><span class="n">El</span><span class="p">][</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;FP&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">El</span> <span class="ow">in</span> <span class="n">Tdata</span><span class="p">])</span>
        <span class="n">FPP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">FFtables</span><span class="p">[</span><span class="n">El</span><span class="p">][</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;FPP&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">El</span> <span class="ow">in</span> <span class="n">Tdata</span><span class="p">])</span>
    <span class="n">maxPos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGOps&#39;</span><span class="p">])</span>       
    <span class="n">Uij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2lat</span><span class="o">.</span><span class="n">U6toUij</span><span class="p">(</span><span class="n">Uijdata</span><span class="p">))</span>
    <span class="n">bij</span> <span class="o">=</span> <span class="n">Mast</span><span class="o">*</span><span class="n">Uij</span><span class="o">.</span><span class="n">T</span>
    <span class="n">dFdvDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dFdfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">Mdata</span><span class="p">)))</span>
    <span class="n">dFdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">Mdata</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">dFdui</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">Mdata</span><span class="p">)))</span>
    <span class="n">dFdua</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">Mdata</span><span class="p">),</span><span class="mi">6</span><span class="p">))</span>
    <span class="n">dFdbab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">iref</span><span class="p">,</span><span class="n">refl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refList</span><span class="p">):</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">SQ</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>             <span class="c"># or (sin(theta)/lambda)**2</span>
        <span class="n">SQfactor</span> <span class="o">=</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">SQ</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">dBabdA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;BabU&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">SQfactor</span><span class="p">)</span>
        <span class="n">Bab</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;BabA&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dBabdA</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">El</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Tdata</span><span class="p">):</span>            
            <span class="n">FF</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">El</span><span class="p">]</span>           
        <span class="n">Uniq</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">twopi</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">((</span><span class="n">dXdata</span><span class="o">.</span><span class="n">T</span><span class="o">+</span><span class="n">Xdata</span><span class="o">.</span><span class="n">T</span><span class="p">),</span><span class="n">Uniq</span><span class="p">)</span><span class="o">+</span><span class="n">phi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:])</span>
        <span class="n">sinp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">cosp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
        <span class="n">occ</span> <span class="o">=</span> <span class="n">Mdata</span><span class="o">*</span><span class="n">Fdata</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Uniq</span><span class="p">)</span>
        <span class="n">biso</span> <span class="o">=</span> <span class="o">-</span><span class="n">SQfactor</span><span class="o">*</span><span class="n">Uisodata</span>
        <span class="n">Tiso</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">biso</span><span class="o">&lt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">biso</span><span class="p">),</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">HbH</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">bij</span><span class="p">,</span><span class="n">H</span><span class="p">))</span>
        <span class="n">Hij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Mast</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">U</span><span class="p">)</span> <span class="k">for</span> <span class="n">U</span> <span class="ow">in</span> <span class="n">Uniq</span><span class="p">])</span>
        <span class="n">Hij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">G2lat</span><span class="o">.</span><span class="n">UijtoU6</span><span class="p">(</span><span class="n">Uij</span><span class="p">)</span> <span class="k">for</span> <span class="n">Uij</span> <span class="ow">in</span> <span class="n">Hij</span><span class="p">])</span>
        <span class="n">Tuij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">HbH</span><span class="o">&lt;</span><span class="mf">1.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">HbH</span><span class="p">),</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">Tcorr</span> <span class="o">=</span> <span class="n">Tiso</span><span class="o">*</span><span class="n">Tuij</span>
        <span class="n">fot</span> <span class="o">=</span> <span class="p">(</span><span class="n">FF</span><span class="o">+</span><span class="n">FP</span><span class="o">-</span><span class="n">Bab</span><span class="p">)</span><span class="o">*</span><span class="n">occ</span><span class="o">*</span><span class="n">Tcorr</span>
        <span class="n">fotp</span> <span class="o">=</span> <span class="n">FPP</span><span class="o">*</span><span class="n">occ</span><span class="o">*</span><span class="n">Tcorr</span>
        <span class="n">fa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fot</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">cosp</span><span class="p">,</span><span class="n">fotp</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">cosp</span><span class="p">])</span>       <span class="c">#non positions</span>
        <span class="n">fb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fot</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">sinp</span><span class="p">,</span><span class="o">-</span><span class="n">fotp</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">sinp</span><span class="p">])</span>
        
        <span class="n">fas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fa</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fbs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">fot</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">sinp</span><span class="p">,</span><span class="o">-</span><span class="n">fotp</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">sinp</span><span class="p">])</span>   <span class="c">#positions</span>
        <span class="n">fbx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fot</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">cosp</span><span class="p">,</span><span class="o">-</span><span class="n">fot</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span><span class="o">*</span><span class="n">cosp</span><span class="p">])</span>
        <span class="c">#sum below is over Uniq</span>
        <span class="n">dfadfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fa</span><span class="o">/</span><span class="n">occ</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dfadx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">twopi</span><span class="o">*</span><span class="n">Uniq</span><span class="o">*</span><span class="n">fax</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dfadui</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">SQfactor</span><span class="o">*</span><span class="n">fa</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dfadua</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">Hij</span><span class="o">*</span><span class="n">fa</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dfadba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">cosp</span><span class="o">*</span><span class="p">(</span><span class="n">occ</span><span class="o">*</span><span class="n">Tcorr</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c">#NB: the above have been checked against PA(1:10,1:2) in strfctr.for      </span>
        <span class="n">dFdfr</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">fas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dfadfr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dfadfr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">Mdata</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Uniq</span><span class="p">)</span>
        <span class="n">dFdx</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">fas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dfadx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dfadx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dFdui</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">fas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dfadui</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dfadui</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dFdua</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">fas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dfadua</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dfadua</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dFdbab</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dfadba</span><span class="o">*</span><span class="n">dBabdA</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">dfadba</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;BabA&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">SQfactor</span><span class="o">*</span><span class="n">dBabdA</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGInv&#39;</span><span class="p">]:</span>
            <span class="n">dfbdfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fb</span><span class="o">/</span><span class="n">occ</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>        <span class="c">#problem here if occ=0 for some atom</span>
            <span class="n">dfbdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">twopi</span><span class="o">*</span><span class="n">Uniq</span><span class="o">*</span><span class="n">fbx</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>          
            <span class="n">dfbdui</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">SQfactor</span><span class="o">*</span><span class="n">fb</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dfbdua</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">Hij</span><span class="o">*</span><span class="n">fb</span><span class="p">[:,:,:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">dfbdba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">sinp</span><span class="o">*</span><span class="p">(</span><span class="n">occ</span><span class="o">*</span><span class="n">Tcorr</span><span class="p">)[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dFdfr</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">fbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dfbdfr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dfbdfr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">Mdata</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">Uniq</span><span class="p">)</span>
            <span class="n">dFdx</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">fbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dfbdx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dfbdx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dFdui</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">fbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dfbdui</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">fbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dfbdui</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dFdua</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">fbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dfbdua</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">fbs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dfbdua</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dFdbab</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dfbdba</span><span class="o">*</span><span class="n">dBabdA</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">dfbdba</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;BabA&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">SQfactor</span><span class="o">*</span><span class="n">dBabdA</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
        <span class="c">#loop over atoms - each dict entry is list of derivatives for all the reflections</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Mdata</span><span class="p">)):</span>     
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Afrac:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dFdfr</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;dAx:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dFdx</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;dAy:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dFdx</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;dAz:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dFdx</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AUiso:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dFdui</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AU11:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dFdua</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AU22:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dFdua</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AU33:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dFdua</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AU12:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">dFdua</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AU13:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">dFdua</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;AU23:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">dFdua</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;BabA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dFdbab</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;BabU&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dFdbab</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dFdvDict</span>
    </div>
<div class="viewcode-block" id="SCExtinction"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.SCExtinction">[docs]</a><span class="k">def</span> <span class="nf">SCExtinction</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varyList</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Single crystal extinction function; puts correction in ref[13] and returns</span>
<span class="sd">    corrections needed for derivatives</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">ref</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">dervCor</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">dervDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EType&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">cos2T</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>         <span class="c">#cos(2theta)</span>
        <span class="k">if</span> <span class="s">&#39;SXC&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
            <span class="n">AV</span> <span class="o">=</span> <span class="mf">7.9406e5</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Vol&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">PL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cos2T</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam&#39;</span><span class="p">]</span>
            <span class="n">P12</span> <span class="o">=</span> <span class="p">(</span><span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Cos2TM&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">cos2T</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Cos2TM&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">cos2T</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;SNT&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
            <span class="n">AV</span> <span class="o">=</span> <span class="mf">1.e7</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Vol&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">PL</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">P12</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="s">&#39;SNC&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
            <span class="n">AV</span> <span class="o">=</span> <span class="mf">1.e7</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Vol&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">PL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cos2T</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam&#39;</span><span class="p">]</span>
            <span class="n">P12</span> <span class="o">=</span> <span class="mf">1.0</span>
            
        <span class="n">PLZ</span> <span class="o">=</span> <span class="n">AV</span><span class="o">*</span><span class="n">P12</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;Primary&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EType&#39;</span><span class="p">]:</span>
            <span class="n">PLZ</span> <span class="o">*=</span> <span class="mf">1.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PLZ</span> <span class="o">*=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Tbar&#39;</span><span class="p">]</span>
                        
        <span class="k">if</span> <span class="s">&#39;Primary&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EType&#39;</span><span class="p">]:</span>
            <span class="n">PSIG</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Ep&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&#39;I &amp; II&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EType&#39;</span><span class="p">]:</span>
            <span class="n">PSIG</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Eg&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Es&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">PL</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Eg&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;Type II&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EType&#39;</span><span class="p">]:</span>
            <span class="n">PSIG</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Es&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>       <span class="c"># &#39;Secondary Type I&#39;</span>
            <span class="n">PSIG</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Eg&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">PL</span>
            
        <span class="n">AG</span> <span class="o">=</span> <span class="mf">0.58</span><span class="o">+</span><span class="mf">0.48</span><span class="o">*</span><span class="n">cos2T</span><span class="o">+</span><span class="mf">0.24</span><span class="o">*</span><span class="n">cos2T</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">AL</span> <span class="o">=</span> <span class="mf">0.025</span><span class="o">+</span><span class="mf">0.285</span><span class="o">*</span><span class="n">cos2T</span>
        <span class="n">BG</span> <span class="o">=</span> <span class="mf">0.02</span><span class="o">-</span><span class="mf">0.025</span><span class="o">*</span><span class="n">cos2T</span>
        <span class="n">BL</span> <span class="o">=</span> <span class="mf">0.15</span><span class="o">-</span><span class="mf">0.2</span><span class="o">*</span><span class="p">(</span><span class="mf">0.75</span><span class="o">-</span><span class="n">cos2T</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">cos2T</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">BL</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.45</span><span class="o">*</span><span class="n">cos2T</span>
        <span class="n">CG</span> <span class="o">=</span> <span class="mf">2.</span>
        <span class="n">CL</span> <span class="o">=</span> <span class="mf">2.</span>
        <span class="n">PF</span> <span class="o">=</span> <span class="n">PLZ</span><span class="o">*</span><span class="n">PSIG</span>
        
        <span class="k">if</span> <span class="s">&#39;Gaussian&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EApprox&#39;</span><span class="p">]:</span>
            <span class="n">PF4</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">CG</span><span class="o">*</span><span class="n">PF</span><span class="o">+</span><span class="n">AG</span><span class="o">*</span><span class="n">PF</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">BG</span><span class="o">*</span><span class="n">PF</span><span class="p">)</span>
            <span class="n">extCor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">PF4</span><span class="p">)</span>
            <span class="n">PF3</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">CG</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">AG</span><span class="o">*</span><span class="n">PF</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">BG</span><span class="o">*</span><span class="n">PF</span><span class="p">)</span><span class="o">-</span><span class="n">AG</span><span class="o">*</span><span class="n">PF</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">BG</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">BG</span><span class="o">*</span><span class="n">PF</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">PF4</span><span class="o">*</span><span class="n">extCor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PF4</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">+</span><span class="n">CL</span><span class="o">*</span><span class="n">PF</span><span class="o">+</span><span class="n">AL</span><span class="o">*</span><span class="n">PF</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">BL</span><span class="o">*</span><span class="n">PF</span><span class="p">)</span>
            <span class="n">extCor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">PF4</span><span class="p">)</span>
            <span class="n">PF3</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">CL</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">AL</span><span class="o">*</span><span class="n">PF</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">BL</span><span class="o">*</span><span class="n">PF</span><span class="p">)</span><span class="o">-</span><span class="n">AL</span><span class="o">*</span><span class="n">PF</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">BL</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">BL</span><span class="o">*</span><span class="n">PF</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">PF4</span><span class="o">*</span><span class="n">extCor</span><span class="p">)</span>

        <span class="n">dervCor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">PF</span><span class="p">)</span><span class="o">*</span><span class="n">PF3</span>
        <span class="k">if</span> <span class="s">&#39;Primary&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EType&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Ep&#39;</span> <span class="ow">in</span> <span class="n">varyList</span><span class="p">:</span>
            <span class="n">dervDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Ep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">PLZ</span><span class="o">*</span><span class="n">PF3</span>
        <span class="k">if</span> <span class="s">&#39;II&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EType&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Es&#39;</span> <span class="ow">in</span> <span class="n">varyList</span><span class="p">:</span>
            <span class="n">dervDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Es&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">PLZ</span><span class="o">*</span><span class="n">PF3</span><span class="o">*</span><span class="p">(</span><span class="n">PSIG</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Es&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">3</span>
        <span class="k">if</span> <span class="s">&#39;I&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;EType&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Eg&#39;</span> <span class="ow">in</span> <span class="n">varyList</span><span class="p">:</span>
            <span class="n">dervDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Eg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="n">PLZ</span><span class="o">*</span><span class="n">PF3</span><span class="o">*</span><span class="p">(</span><span class="n">PSIG</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Eg&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">PL</span><span class="o">**</span><span class="mi">2</span>
               
        <span class="n">ref</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">extCor</span>
    <span class="k">return</span> <span class="n">dervCor</span><span class="p">,</span><span class="n">dervDict</span>
        
    </div>
<div class="viewcode-block" id="Dict2Values"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.Dict2Values">[docs]</a><span class="k">def</span> <span class="nf">Dict2Values</span><span class="p">(</span><span class="n">parmdict</span><span class="p">,</span> <span class="n">varylist</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Use before call to leastsq to setup list of values for the parameters </span>
<span class="sd">    in parmdict, as selected by key in varylist&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">parmdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">]</span> 
    </div>
<div class="viewcode-block" id="Values2Dict"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.Values2Dict">[docs]</a><span class="k">def</span> <span class="nf">Values2Dict</span><span class="p">(</span><span class="n">parmdict</span><span class="p">,</span> <span class="n">varylist</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Use after call to leastsq to update the parameter dictionary with </span>
<span class="sd">    values corresponding to keys in varylist&#39;&#39;&#39;</span>
    <span class="n">parmdict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">varylist</span><span class="p">,</span><span class="n">values</span><span class="p">))</span>
    </div>
<div class="viewcode-block" id="GetNewCellParms"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetNewCellParms">[docs]</a><span class="k">def</span> <span class="nf">GetNewCellParms</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varyList</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">newCellDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">Anames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
    <span class="n">Ddict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s">&#39;D11&#39;</span><span class="p">,</span><span class="s">&#39;D22&#39;</span><span class="p">,</span><span class="s">&#39;D33&#39;</span><span class="p">,</span><span class="s">&#39;D12&#39;</span><span class="p">,</span><span class="s">&#39;D13&#39;</span><span class="p">,</span><span class="s">&#39;D23&#39;</span><span class="p">],</span><span class="n">Anames</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">varyList</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">Ddict</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;::&#39;</span><span class="o">+</span><span class="n">Ddict</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>       <span class="c">#key is e.g. &#39;0::A0&#39;</span>
            <span class="n">parm</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;::&#39;</span><span class="o">+</span><span class="n">keys</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>             <span class="c">#parm is e.g. &#39;0::D11&#39;</span>
            <span class="n">newCellDict</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">item</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">newCellDict</span>          <span class="c"># is e.g. {&#39;0::D11&#39;:A0+D11}</span>
    </div>
<div class="viewcode-block" id="ApplyXYZshifts"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.ApplyXYZshifts">[docs]</a><span class="k">def</span> <span class="nf">ApplyXYZshifts</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varyList</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    takes atom x,y,z shift and applies it to corresponding atom x,y,z value</span>
<span class="sd">    </span>
<span class="sd">    :param dict parmDict: parameter dictionary</span>
<span class="sd">    :param list varyList: list of variables</span>
<span class="sd">    :returns: newAtomDict - dictionary of new atomic coordinate names &amp; values; key is parameter shift name</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">newAtomDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;dA&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">parm</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">))</span>
            <span class="n">parmDict</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="n">newAtomDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parm</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">parm</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">newAtomDict</span>
    </div>
<div class="viewcode-block" id="SHTXcal"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.SHTXcal">[docs]</a><span class="k">def</span> <span class="nf">SHTXcal</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Spherical harmonics texture&#39;</span>
    <span class="n">IFCoup</span> <span class="o">=</span> <span class="s">&#39;Bragg&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;instType&#39;</span><span class="p">]</span>
    <span class="n">odfCor</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Gmat2cell</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">Sangls</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SH omega&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SH chi&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SH phi&#39;</span><span class="p">]]</span>
    <span class="n">Gangls</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Omega&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Chi&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Phi&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Azimuth&#39;</span><span class="p">]]</span>
    <span class="n">phi</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CrsAng</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
    <span class="n">psi</span><span class="p">,</span><span class="n">gam</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">SamAng</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">Gangls</span><span class="p">,</span><span class="n">Sangls</span><span class="p">,</span><span class="n">IFCoup</span><span class="p">)</span> <span class="c">#ignore 2 sets of angle derivs.</span>
    <span class="n">SHnames</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GenSHCoeff</span><span class="p">(</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SHmodel&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SHorder&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">SHnames</span><span class="p">:</span>
        <span class="n">L</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">N</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">))</span>
        <span class="n">Kcl</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GetKcl</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="n">phi</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">Ksl</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GetKsl</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SHmodel&#39;</span><span class="p">],</span><span class="n">psi</span><span class="p">,</span><span class="n">gam</span><span class="p">)</span>
        <span class="n">Lnorm</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Lnorm</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">odfCor</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">Lnorm</span><span class="o">*</span><span class="n">Kcl</span><span class="o">*</span><span class="n">Ksl</span>
    <span class="k">return</span> <span class="n">odfCor</span>
    </div>
<div class="viewcode-block" id="SHTXcalDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.SHTXcalDerv">[docs]</a><span class="k">def</span> <span class="nf">SHTXcalDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Spherical harmonics texture derivatives&#39;</span>
    <span class="n">FORPI</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">IFCoup</span> <span class="o">=</span> <span class="s">&#39;Bragg&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;instType&#39;</span><span class="p">]</span>
    <span class="n">odfCor</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">dFdODF</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dFdSA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Gmat2cell</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">Sangls</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SH omega&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SH chi&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SH phi&#39;</span><span class="p">]]</span>
    <span class="n">Gangls</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Omega&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Chi&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Phi&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Azimuth&#39;</span><span class="p">]]</span>
    <span class="n">phi</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CrsAng</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
    <span class="n">psi</span><span class="p">,</span><span class="n">gam</span><span class="p">,</span><span class="n">dPSdA</span><span class="p">,</span><span class="n">dGMdA</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">SamAng</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">Gangls</span><span class="p">,</span><span class="n">Sangls</span><span class="p">,</span><span class="n">IFCoup</span><span class="p">)</span>
    <span class="n">SHnames</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GenSHCoeff</span><span class="p">(</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SHmodel&#39;</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SHorder&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">SHnames</span><span class="p">:</span>
        <span class="n">L</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">N</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">))</span>
        <span class="n">Kcl</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GetKcl</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="n">phi</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span>
        <span class="n">Ksl</span><span class="p">,</span><span class="n">dKsdp</span><span class="p">,</span><span class="n">dKsdg</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GetKsl</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SHmodel&#39;</span><span class="p">],</span><span class="n">psi</span><span class="p">,</span><span class="n">gam</span><span class="p">)</span>
        <span class="n">Lnorm</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Lnorm</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="n">odfCor</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">Lnorm</span><span class="o">*</span><span class="n">Kcl</span><span class="o">*</span><span class="n">Ksl</span>
        <span class="n">dFdODF</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lnorm</span><span class="o">*</span><span class="n">Kcl</span><span class="o">*</span><span class="n">Ksl</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">dFdSA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">Lnorm</span><span class="o">*</span><span class="n">Kcl</span><span class="o">*</span><span class="p">(</span><span class="n">dKsdp</span><span class="o">*</span><span class="n">dPSdA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">dKsdg</span><span class="o">*</span><span class="n">dGMdA</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">odfCor</span><span class="p">,</span><span class="n">dFdODF</span><span class="p">,</span><span class="n">dFdSA</span>
    </div>
<div class="viewcode-block" id="SHPOcal"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.SHPOcal">[docs]</a><span class="k">def</span> <span class="nf">SHPOcal</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;spherical harmonics preferred orientation (cylindrical symmetry only)&#39;</span>
    <span class="n">odfCor</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Gmat2cell</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">Sangl</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;Bragg&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;instType&#39;</span><span class="p">]:</span>
        <span class="n">Gangls</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">90.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Azimuth&#39;</span><span class="p">]]</span>
        <span class="n">IFCoup</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Gangls</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Azimuth&#39;</span><span class="p">]]</span>
        <span class="n">IFCoup</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">phi</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CrsAng</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
    <span class="n">psi</span><span class="p">,</span><span class="n">gam</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">SamAng</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">Gangls</span><span class="p">,</span><span class="n">Sangl</span><span class="p">,</span><span class="n">IFCoup</span><span class="p">)</span> <span class="c">#ignore 2 sets of angle derivs.</span>
    <span class="n">SHnames</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GenSHCoeff</span><span class="p">(</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SHord&#39;</span><span class="p">],</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">SHnames</span><span class="p">:</span>
        <span class="n">L</span><span class="p">,</span><span class="n">N</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">))</span>
        <span class="n">Kcsl</span><span class="p">,</span><span class="n">Lnorm</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GetKclKsl</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="n">psi</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span> 
        <span class="n">odfCor</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">Lnorm</span><span class="o">*</span><span class="n">Kcsl</span>
    <span class="k">return</span> <span class="n">odfCor</span>
    </div>
<div class="viewcode-block" id="SHPOcalDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.SHPOcalDerv">[docs]</a><span class="k">def</span> <span class="nf">SHPOcalDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;spherical harmonics preferred orientation derivatives (cylindrical symmetry only)&#39;</span>
    <span class="n">FORPI</span> <span class="o">=</span> <span class="mf">12.5663706143592</span>
    <span class="n">odfCor</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">dFdODF</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Gmat2cell</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">Sangl</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;Bragg&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;instType&#39;</span><span class="p">]:</span>
        <span class="n">Gangls</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">90.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Azimuth&#39;</span><span class="p">]]</span>
        <span class="n">IFCoup</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Gangls</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Azimuth&#39;</span><span class="p">]]</span>
        <span class="n">IFCoup</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">phi</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CrsAng</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
    <span class="n">psi</span><span class="p">,</span><span class="n">gam</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">SamAng</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">Gangls</span><span class="p">,</span><span class="n">Sangl</span><span class="p">,</span><span class="n">IFCoup</span><span class="p">)</span> <span class="c">#ignore 2 sets of angle derivs.</span>
    <span class="n">SHnames</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GenSHCoeff</span><span class="p">(</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SHord&#39;</span><span class="p">],</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">SHnames</span><span class="p">:</span>
        <span class="n">L</span><span class="p">,</span><span class="n">N</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">))</span>
        <span class="n">Kcsl</span><span class="p">,</span><span class="n">Lnorm</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GetKclKsl</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="n">psi</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">beta</span><span class="p">)</span> 
        <span class="n">odfCor</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">Lnorm</span><span class="o">*</span><span class="n">Kcsl</span>
        <span class="n">dFdODF</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">Kcsl</span><span class="o">*</span><span class="n">Lnorm</span>
    <span class="k">return</span> <span class="n">odfCor</span><span class="p">,</span><span class="n">dFdODF</span>
    </div>
<div class="viewcode-block" id="GetPrefOri"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetPrefOri">[docs]</a><span class="k">def</span> <span class="nf">GetPrefOri</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">POcorr</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;poType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;MD&#39;</span><span class="p">:</span>
        <span class="n">MD</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MD&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">MD</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">MDAxis</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MDAxis&#39;</span><span class="p">]</span>
            <span class="n">sumMD</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">refl</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span>            
                <span class="n">cosP</span><span class="p">,</span><span class="n">sinP</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CosSinAngle</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">MDAxis</span><span class="p">,</span><span class="n">G</span><span class="p">)</span>
                <span class="n">A</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">MD</span><span class="o">*</span><span class="n">cosP</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">sinP</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">MD</span><span class="p">)</span>
                <span class="n">sumMD</span> <span class="o">+=</span> <span class="n">A</span><span class="o">**</span><span class="mi">3</span>
            <span class="n">POcorr</span> <span class="o">=</span> <span class="n">sumMD</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c">#spherical harmonics</span>
        <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SHord&#39;</span><span class="p">]:</span>
            <span class="n">POcorr</span> <span class="o">=</span> <span class="n">SHPOcal</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">POcorr</span>
    </div>
<div class="viewcode-block" id="GetPrefOriDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetPrefOriDerv">[docs]</a><span class="k">def</span> <span class="nf">GetPrefOriDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">POcorr</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">POderv</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;poType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;MD&#39;</span><span class="p">:</span>
        <span class="n">MD</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MD&#39;</span><span class="p">]</span>
        <span class="n">MDAxis</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MDAxis&#39;</span><span class="p">]</span>
        <span class="n">sumMD</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sumdMD</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">H</span> <span class="ow">in</span> <span class="n">refl</span><span class="p">[</span><span class="mi">11</span><span class="p">]:</span>            
            <span class="n">cosP</span><span class="p">,</span><span class="n">sinP</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CosSinAngle</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">MDAxis</span><span class="p">,</span><span class="n">G</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">MD</span><span class="o">*</span><span class="n">cosP</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">sinP</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">MD</span><span class="p">)</span>
            <span class="n">sumMD</span> <span class="o">+=</span> <span class="n">A</span><span class="o">**</span><span class="mi">3</span>
            <span class="n">sumdMD</span> <span class="o">-=</span> <span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">A</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">MD</span><span class="o">*</span><span class="n">cosP</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">sinP</span><span class="o">/</span><span class="n">MD</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">POcorr</span> <span class="o">=</span> <span class="n">sumMD</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
        <span class="n">POderv</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sumdMD</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c">#spherical harmonics</span>
        <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SHord&#39;</span><span class="p">]:</span>
            <span class="n">POcorr</span><span class="p">,</span><span class="n">POderv</span> <span class="o">=</span> <span class="n">SHPOcalDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">POcorr</span><span class="p">,</span><span class="n">POderv</span>
    </div>
<div class="viewcode-block" id="GetAbsorb"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetAbsorb">[docs]</a><span class="k">def</span> <span class="nf">GetAbsorb</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="k">if</span> <span class="s">&#39;Debye&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;instType&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">Absorb</span><span class="p">(</span><span class="s">&#39;Cylinder&#39;</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Absorption&#39;</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>
    </div>
<div class="viewcode-block" id="GetAbsorbDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetAbsorbDerv">[docs]</a><span class="k">def</span> <span class="nf">GetAbsorbDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="k">if</span> <span class="s">&#39;Debye&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;instType&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">AbsorbDerv</span><span class="p">(</span><span class="s">&#39;Cylinder&#39;</span><span class="p">,</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Absorption&#39;</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    </div>
<div class="viewcode-block" id="GetIntensityCorr"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetIntensityCorr">[docs]</a><span class="k">def</span> <span class="nf">GetIntensityCorr</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">Icorr</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>               <span class="c">#scale*multiplicity</span>
    <span class="k">if</span> <span class="s">&#39;X&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
        <span class="n">Icorr</span> <span class="o">*=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">Polarization</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Polariz.&#39;</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Azimuth&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Icorr</span> <span class="o">*=</span> <span class="n">GetPrefOri</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SHorder&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">:</span>
        <span class="n">Icorr</span> <span class="o">*=</span> <span class="n">SHTXcal</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="n">Icorr</span> <span class="o">*=</span> <span class="n">GetAbsorb</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">Icorr</span>        
    </div>
<div class="viewcode-block" id="GetIntensityDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetIntensityDerv">[docs]</a><span class="k">def</span> <span class="nf">GetIntensityDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">dIdsh</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
    <span class="n">dIdsp</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;X&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
        <span class="n">pola</span><span class="p">,</span><span class="n">dIdPola</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">Polarization</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Polariz.&#39;</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Azimuth&#39;</span><span class="p">])</span>
        <span class="n">dIdPola</span> <span class="o">/=</span> <span class="n">pola</span>
    <span class="k">else</span><span class="p">:</span>       <span class="c">#&#39;N&#39;</span>
        <span class="n">dIdPola</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">POcorr</span><span class="p">,</span><span class="n">dIdPO</span> <span class="o">=</span> <span class="n">GetPrefOriDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iPO</span> <span class="ow">in</span> <span class="n">dIdPO</span><span class="p">:</span>
        <span class="n">dIdPO</span><span class="p">[</span><span class="n">iPO</span><span class="p">]</span> <span class="o">/=</span> <span class="n">POcorr</span>
    <span class="n">dFdODF</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">dFdSA</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SHorder&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="p">:</span>
        <span class="n">odfCor</span><span class="p">,</span><span class="n">dFdODF</span><span class="p">,</span><span class="n">dFdSA</span> <span class="o">=</span> <span class="n">SHTXcalDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">iSH</span> <span class="ow">in</span> <span class="n">dFdODF</span><span class="p">:</span>
            <span class="n">dFdODF</span><span class="p">[</span><span class="n">iSH</span><span class="p">]</span> <span class="o">/=</span> <span class="n">odfCor</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">dFdSA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">odfCor</span>
    <span class="n">dFdAb</span> <span class="o">=</span> <span class="n">GetAbsorbDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dIdsh</span><span class="p">,</span><span class="n">dIdsp</span><span class="p">,</span><span class="n">dIdPola</span><span class="p">,</span><span class="n">dIdPO</span><span class="p">,</span><span class="n">dFdODF</span><span class="p">,</span><span class="n">dFdSA</span><span class="p">,</span><span class="n">dFdAb</span>
        </div>
<div class="viewcode-block" id="GetSampleSigGam"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetSampleSigGam">[docs]</a><span class="k">def</span> <span class="nf">GetSampleSigGam</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">GB</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">costh</span> <span class="o">=</span> <span class="n">cosd</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="c">#crystallite size</span>
    <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SizeType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;isotropic&#39;</span><span class="p">:</span>
        <span class="n">Sgam</span> <span class="o">=</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">costh</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SizeType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;uniaxial&#39;</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SizeAxis&#39;</span><span class="p">])</span>
        <span class="n">cosP</span><span class="p">,</span><span class="n">sinP</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CosSinAngle</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">G</span><span class="p">)</span>
        <span class="n">Sgam</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.8</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;a&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">costh</span><span class="p">)</span>
        <span class="n">Sgam</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sinP</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;a&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">cosP</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>           <span class="c">#ellipsoidal crystallites</span>
        <span class="n">Sij</span> <span class="o">=</span><span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size:</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">lenR</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">ellipseSize</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">Sij</span><span class="p">,</span><span class="n">GB</span><span class="p">)</span>
        <span class="n">Sgam</span> <span class="o">=</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">costh</span><span class="o">*</span><span class="n">lenR</span><span class="p">)</span>
    <span class="c">#microstrain                </span>
    <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MustrainType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;isotropic&#39;</span><span class="p">:</span>
        <span class="n">Mgam</span> <span class="o">=</span> <span class="mf">0.018</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">elif</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MustrainType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;uniaxial&#39;</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MustrainAxis&#39;</span><span class="p">])</span>
        <span class="n">cosP</span><span class="p">,</span><span class="n">sinP</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CosSinAngle</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">G</span><span class="p">)</span>
        <span class="n">Si</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">]</span>
        <span class="n">Sa</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;a&#39;</span><span class="p">]</span>
        <span class="n">Mgam</span> <span class="o">=</span> <span class="mf">0.018</span><span class="o">*</span><span class="n">Si</span><span class="o">*</span><span class="n">Sa</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Si</span><span class="o">*</span><span class="n">cosP</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">Sa</span><span class="o">*</span><span class="n">sinP</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>       <span class="c">#generalized - P.W. Stephens model</span>
        <span class="n">pwrs</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MuPwrs&#39;</span><span class="p">]</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pwr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pwrs</span><span class="p">):</span>
            <span class="nb">sum</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="n">pwr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">Mgam</span> <span class="o">=</span> <span class="mf">0.018</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span>
    <span class="n">gam</span> <span class="o">=</span> <span class="n">Sgam</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">Mgam</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="n">Sgam</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">Mgam</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">sig</span> <span class="o">/=</span> <span class="n">ateln2</span>
    <span class="k">return</span> <span class="n">sig</span><span class="p">,</span><span class="n">gam</span>
        </div>
<div class="viewcode-block" id="GetSampleSigGamDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetSampleSigGamDerv">[docs]</a><span class="k">def</span> <span class="nf">GetSampleSigGamDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">GB</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">gamDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sigDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">costh</span> <span class="o">=</span> <span class="n">cosd</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">tanth</span> <span class="o">=</span> <span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="c">#crystallite size derivatives</span>
    <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SizeType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;isotropic&#39;</span><span class="p">:</span>
        <span class="n">Sgam</span> <span class="o">=</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">costh</span><span class="p">)</span>
        <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.8</span><span class="o">*</span><span class="n">wave</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">costh</span><span class="p">)</span>
        <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.6</span><span class="o">*</span><span class="n">Sgam</span><span class="o">*</span><span class="n">wave</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">costh</span><span class="o">*</span><span class="n">ateln2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SizeType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;uniaxial&#39;</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;SizeAxis&#39;</span><span class="p">])</span>
        <span class="n">cosP</span><span class="p">,</span><span class="n">sinP</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CosSinAngle</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">G</span><span class="p">)</span>
        <span class="n">Si</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">]</span>
        <span class="n">Sa</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;a&#39;</span><span class="p">]</span>
        <span class="n">gami</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.8</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Si</span><span class="o">*</span><span class="n">Sa</span><span class="p">)</span>
        <span class="n">sqtrm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">sinP</span><span class="o">*</span><span class="n">Sa</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">cosP</span><span class="o">*</span><span class="n">Si</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Sgam</span> <span class="o">=</span> <span class="n">gami</span><span class="o">*</span><span class="n">sqtrm</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">Sgam</span><span class="o">/</span><span class="n">costh</span>
        <span class="n">dsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">gami</span><span class="o">*</span><span class="n">Si</span><span class="o">*</span><span class="n">cosP</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">sqtrm</span><span class="o">*</span><span class="n">costh</span><span class="p">)</span><span class="o">-</span><span class="n">gam</span><span class="o">/</span><span class="n">Si</span><span class="p">)</span>
        <span class="n">dsa</span> <span class="o">=</span> <span class="p">(</span><span class="n">gami</span><span class="o">*</span><span class="n">Sa</span><span class="o">*</span><span class="n">sinP</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">sqtrm</span><span class="o">*</span><span class="n">costh</span><span class="p">)</span><span class="o">-</span><span class="n">gam</span><span class="o">/</span><span class="n">Sa</span><span class="p">)</span>
        <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsi</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span>
        <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span>
        <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">dsi</span><span class="o">*</span><span class="n">Sgam</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">ateln2</span>
        <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">dsa</span><span class="o">*</span><span class="n">Sgam</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">ateln2</span>
    <span class="k">else</span><span class="p">:</span>           <span class="c">#ellipsoidal crystallites</span>
        <span class="n">const</span> <span class="o">=</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">costh</span><span class="p">)</span>
        <span class="n">Sij</span> <span class="o">=</span><span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size:</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">lenR</span><span class="p">,</span><span class="n">dRdS</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">ellipseSizeDerv</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">Sij</span><span class="p">,</span><span class="n">GB</span><span class="p">)</span>
        <span class="n">Sgam</span> <span class="o">=</span> <span class="mf">1.8</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">costh</span><span class="o">*</span><span class="n">lenR</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size:</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]):</span>
            <span class="n">gamDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">const</span><span class="o">/</span><span class="n">lenR</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dRdS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span>
            <span class="n">sigDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">Sgam</span><span class="o">*</span><span class="p">(</span><span class="n">const</span><span class="o">/</span><span class="n">lenR</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dRdS</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">ateln2</span>
    <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sgam</span>
    <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">Sgam</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">ateln2</span>
            
    <span class="c">#microstrain derivatives                </span>
    <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MustrainType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;isotropic&#39;</span><span class="p">:</span>
        <span class="n">Mgam</span> <span class="o">=</span> <span class="mf">0.018</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">0.018</span><span class="o">*</span><span class="n">tanth</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">0.036</span><span class="o">*</span><span class="n">Mgam</span><span class="o">*</span><span class="n">tanth</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">ateln2</span><span class="p">)</span>        
    <span class="k">elif</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MustrainType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;uniaxial&#39;</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MustrainAxis&#39;</span><span class="p">])</span>
        <span class="n">cosP</span><span class="p">,</span><span class="n">sinP</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CosSinAngle</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="n">G</span><span class="p">)</span>
        <span class="n">Si</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">]</span>
        <span class="n">Sa</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;a&#39;</span><span class="p">]</span>
        <span class="n">gami</span> <span class="o">=</span> <span class="mf">0.018</span><span class="o">*</span><span class="n">Si</span><span class="o">*</span><span class="n">Sa</span><span class="o">*</span><span class="n">tanth</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">sqtrm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">Si</span><span class="o">*</span><span class="n">cosP</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">Sa</span><span class="o">*</span><span class="n">sinP</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Mgam</span> <span class="o">=</span> <span class="n">gami</span><span class="o">/</span><span class="n">sqtrm</span>
        <span class="n">dsi</span> <span class="o">=</span> <span class="o">-</span><span class="n">gami</span><span class="o">*</span><span class="n">Si</span><span class="o">*</span><span class="n">cosP</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sqtrm</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">dsa</span> <span class="o">=</span> <span class="o">-</span><span class="n">gami</span><span class="o">*</span><span class="n">Sa</span><span class="o">*</span><span class="n">sinP</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sqtrm</span><span class="o">**</span><span class="mi">3</span>
        <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mgam</span><span class="o">/</span><span class="n">Si</span><span class="o">+</span><span class="n">dsi</span><span class="p">)</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span>
        <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Mgam</span><span class="o">/</span><span class="n">Sa</span><span class="o">+</span><span class="n">dsa</span><span class="p">)</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span>
        <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Mgam</span><span class="o">/</span><span class="n">Si</span><span class="o">+</span><span class="n">dsi</span><span class="p">)</span><span class="o">*</span><span class="n">Mgam</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">ateln2</span>
        <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Mgam</span><span class="o">/</span><span class="n">Sa</span><span class="o">+</span><span class="n">dsa</span><span class="p">)</span><span class="o">*</span><span class="n">Mgam</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">ateln2</span>       
    <span class="k">else</span><span class="p">:</span>       <span class="c">#generalized - P.W. Stephens model</span>
        <span class="n">pwrs</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;MuPwrs&#39;</span><span class="p">]</span>
        <span class="n">const</span> <span class="o">=</span> <span class="mf">0.018</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">tanth</span>
        <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">pwr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pwrs</span><span class="p">):</span>
            <span class="n">term</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="n">pwr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="nb">sum</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">*</span><span class="n">term</span>
            <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">const</span><span class="o">*</span><span class="n">term</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span>
            <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> \
                <span class="mf">2.</span><span class="o">*</span><span class="n">const</span><span class="o">*</span><span class="n">term</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">ateln2</span>
        <span class="n">Mgam</span> <span class="o">=</span> <span class="mf">0.018</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="nb">sum</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pwrs</span><span class="p">)):</span>
            <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">*=</span> <span class="n">Mgam</span>
    <span class="n">gamDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mgam</span>
    <span class="n">sigDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">Mgam</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">ateln2</span>
    <span class="k">return</span> <span class="n">sigDict</span><span class="p">,</span><span class="n">gamDict</span>
        </div>
<div class="viewcode-block" id="GetReflPos"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetReflPos">[docs]</a><span class="k">def</span> <span class="nf">GetReflPos</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">dsq</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">G2lat</span><span class="o">.</span><span class="n">calc_rDsq2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]),</span><span class="n">G</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dsq</span><span class="p">)</span>

    <span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">asind</span><span class="p">(</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">d</span><span class="p">))</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Zero&#39;</span><span class="p">]</span>
    <span class="n">const</span> <span class="o">=</span> <span class="mf">9.e-2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Gonio. radius&#39;</span><span class="p">])</span>                  <span class="c">#shifts in microns</span>
    <span class="k">if</span> <span class="s">&#39;Bragg&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;instType&#39;</span><span class="p">]:</span>
        <span class="n">pos</span> <span class="o">-=</span> <span class="n">const</span><span class="o">*</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Shift&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">pos</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span> \
            <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Transparency&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span>            <span class="c">#trans(=1/mueff) in cm</span>
    <span class="k">else</span><span class="p">:</span>               <span class="c">#Debye-Scherrer - simple but maybe not right</span>
        <span class="n">pos</span> <span class="o">-=</span> <span class="n">const</span><span class="o">*</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;DisplaceX&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;DisplaceY&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pos</span>
</div>
<div class="viewcode-block" id="GetReflPosDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetReflPosDerv">[docs]</a><span class="k">def</span> <span class="nf">GetReflPosDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">dpr</span> <span class="o">=</span> <span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">dstsq</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">calc_rDsq</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]),</span><span class="n">A</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dstsq</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Zero&#39;</span><span class="p">]</span>
    <span class="n">const</span> <span class="o">=</span> <span class="n">dpr</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">wave</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">dstsq</span><span class="o">/</span><span class="mf">4.0</span><span class="p">)</span>
    <span class="n">dpdw</span> <span class="o">=</span> <span class="n">const</span><span class="o">*</span><span class="n">dst</span>
    <span class="n">dpdA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">h</span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="p">])</span>
    <span class="n">dpdA</span> <span class="o">*=</span> <span class="n">const</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">dst</span><span class="p">)</span>
    <span class="n">dpdZ</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">const</span> <span class="o">=</span> <span class="mf">9.e-2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Gonio. radius&#39;</span><span class="p">])</span>                  <span class="c">#shifts in microns</span>
    <span class="k">if</span> <span class="s">&#39;Bragg&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;instType&#39;</span><span class="p">]:</span>
        <span class="n">dpdSh</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.</span><span class="o">*</span><span class="n">const</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">pos</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">dpdTr</span> <span class="o">=</span> <span class="o">-</span><span class="n">const</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">*</span><span class="mf">100.0</span>
        <span class="k">return</span> <span class="n">dpdA</span><span class="p">,</span><span class="n">dpdw</span><span class="p">,</span><span class="n">dpdZ</span><span class="p">,</span><span class="n">dpdSh</span><span class="p">,</span><span class="n">dpdTr</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>               <span class="c">#Debye-Scherrer - simple but maybe not right</span>
        <span class="n">dpdXd</span> <span class="o">=</span> <span class="o">-</span><span class="n">const</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">dpdYd</span> <span class="o">=</span> <span class="o">-</span><span class="n">const</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dpdA</span><span class="p">,</span><span class="n">dpdw</span><span class="p">,</span><span class="n">dpdZ</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="n">dpdXd</span><span class="p">,</span><span class="n">dpdYd</span>
            </div>
<div class="viewcode-block" id="GetHStrainShift"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetHStrainShift">[docs]</a><span class="k">def</span> <span class="nf">GetHStrainShift</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">laue</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span>
    <span class="n">uniq</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGUniq&#39;</span><span class="p">]</span>
    <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;m3&#39;</span><span class="p">,</span><span class="s">&#39;m3m&#39;</span><span class="p">]:</span>
        <span class="n">Dij</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span> \
            <span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;eA&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;6/m&#39;</span><span class="p">,</span><span class="s">&#39;6/mmm&#39;</span><span class="p">,</span><span class="s">&#39;3m1&#39;</span><span class="p">,</span><span class="s">&#39;31m&#39;</span><span class="p">,</span><span class="s">&#39;3&#39;</span><span class="p">]:</span>
        <span class="n">Dij</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;3R&#39;</span><span class="p">,</span><span class="s">&#39;3mR&#39;</span><span class="p">]:</span>
        <span class="n">Dij</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D12&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;4/m&#39;</span><span class="p">,</span><span class="s">&#39;4/mmm&#39;</span><span class="p">]:</span>
        <span class="n">Dij</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;mmm&#39;</span><span class="p">]:</span>
        <span class="n">Dij</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D22&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;2/m&#39;</span><span class="p">]:</span>
        <span class="n">Dij</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D22&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">uniq</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">Dij</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D23&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">l</span>
        <span class="k">elif</span> <span class="n">uniq</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
            <span class="n">Dij</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D13&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">l</span>
        <span class="k">elif</span> <span class="n">uniq</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">Dij</span> <span class="o">+=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D12&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">k</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Dij</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D22&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> \
            <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D12&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D13&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D23&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">l</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">Dij</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
            </div>
<div class="viewcode-block" id="GetHStrainShiftDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetHStrainShiftDerv">[docs]</a><span class="k">def</span> <span class="nf">GetHStrainShiftDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">phfx</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">laue</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span>
    <span class="n">uniq</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGUniq&#39;</span><span class="p">]</span>
    <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;m3&#39;</span><span class="p">,</span><span class="s">&#39;m3m&#39;</span><span class="p">]:</span>
        <span class="n">dDijDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;eA&#39;</span><span class="p">:</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">((</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;6/m&#39;</span><span class="p">,</span><span class="s">&#39;6/mmm&#39;</span><span class="p">,</span><span class="s">&#39;3m1&#39;</span><span class="p">,</span><span class="s">&#39;31m&#39;</span><span class="p">,</span><span class="s">&#39;3&#39;</span><span class="p">]:</span>
        <span class="n">dDijDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">:</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;3R&#39;</span><span class="p">,</span><span class="s">&#39;3mR&#39;</span><span class="p">]:</span>
        <span class="n">dDijDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D12&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;4/m&#39;</span><span class="p">,</span><span class="s">&#39;4/mmm&#39;</span><span class="p">]:</span>
        <span class="n">dDijDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">:</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;mmm&#39;</span><span class="p">]:</span>
        <span class="n">dDijDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D22&#39;</span><span class="p">:</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">:</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;2/m&#39;</span><span class="p">]:</span>
        <span class="n">dDijDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D22&#39;</span><span class="p">:</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">:</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">uniq</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">dDijDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D23&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">l</span>
        <span class="k">elif</span> <span class="n">uniq</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
            <span class="n">dDijDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D13&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">*</span><span class="n">l</span>
        <span class="k">elif</span> <span class="n">uniq</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">dDijDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D12&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span><span class="o">*</span><span class="n">k</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dDijDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D11&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D22&#39;</span><span class="p">:</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D33&#39;</span><span class="p">:</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D12&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">*</span><span class="n">k</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D13&#39;</span><span class="p">:</span><span class="n">h</span><span class="o">*</span><span class="n">l</span><span class="p">,</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;D23&#39;</span><span class="p">:</span><span class="n">k</span><span class="o">*</span><span class="n">l</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dDijDict</span><span class="p">:</span>
        <span class="n">dDijDict</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="n">refl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dDijDict</span>
    </div>
<div class="viewcode-block" id="GetFobsSq"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.GetFobsSq">[docs]</a><span class="k">def</span> <span class="nf">GetFobsSq</span><span class="p">(</span><span class="n">Histograms</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">calcControls</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">histoList</span> <span class="o">=</span> <span class="n">Histograms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">histoList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">histogram</span> <span class="ow">in</span> <span class="n">histoList</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">histogram</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">Histogram</span> <span class="o">=</span> <span class="n">Histograms</span><span class="p">[</span><span class="n">histogram</span><span class="p">]</span>
            <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">Limits</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Limits&#39;</span><span class="p">]</span>
            <span class="n">shl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;SH/L&#39;</span><span class="p">],</span><span class="mf">0.0005</span><span class="p">)</span>
            <span class="n">Ka2</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">kRatio</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">Ka2</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">lamRatio</span> <span class="o">=</span> <span class="mi">360</span><span class="o">*</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span><span class="p">])</span>
                <span class="n">kRatio</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;I(L2)/I(L1)&#39;</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">yc</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">]</span>
            <span class="n">xB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ymb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">yb</span><span class="p">)</span>
            <span class="n">ymb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ymb</span><span class="p">,</span><span class="n">ymb</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ycmb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yc</span><span class="o">-</span><span class="n">yb</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ycmb</span><span class="p">,</span><span class="n">ycmb</span><span class="o">/</span><span class="n">ymb</span><span class="p">,</span><span class="mf">1.e10</span><span class="p">)</span>          
            <span class="n">refLists</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">refLists</span><span class="p">:</span>
                <span class="n">Phase</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
                <span class="n">pId</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
                <span class="n">phfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">hId</span><span class="p">)</span>
                <span class="n">refList</span> <span class="o">=</span> <span class="n">refLists</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
                <span class="n">sumFo</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">sumdF</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">sumFosq</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">sumdFsq</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">refl</span> <span class="ow">in</span> <span class="n">refList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;histType&#39;</span><span class="p">]:</span>
                        <span class="n">yp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span>
                        <span class="n">Wd</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getWidthsCW</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">)</span>
                        <span class="n">iBeg</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xB</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">fmin</span><span class="p">))</span>
                        <span class="n">iFin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xB</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">fmax</span><span class="p">),</span><span class="n">xF</span><span class="p">))</span>
                        <span class="n">iFin2</span> <span class="o">=</span> <span class="n">iFin</span>
                        <span class="n">yp</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">G2pwd</span><span class="o">.</span><span class="n">getFCJVoigt3</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">])</span>    <span class="c">#&gt;90% of time spent here</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">pos2</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">lamRatio</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>       <span class="c"># + 360/pi * Dlam/lam * tan(th)</span>
                            <span class="n">Wd</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getWidthsCW</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">)</span>
                            <span class="n">iBeg2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xB</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pos2</span><span class="o">-</span><span class="n">fmin</span><span class="p">))</span>
                            <span class="n">iFin2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pos2</span><span class="o">+</span><span class="n">fmax</span><span class="p">),</span><span class="n">xF</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">iBeg2</span><span class="o">+</span><span class="n">iFin2</span><span class="p">:</span>       <span class="c">#peak below low limit - skip peak</span>
                                <span class="k">continue</span>
                            <span class="k">elif</span> <span class="ow">not</span> <span class="n">iBeg2</span><span class="o">-</span><span class="n">iFin2</span><span class="p">:</span>     <span class="c">#peak above high limit - done</span>
                                <span class="k">break</span>
                            <span class="n">yp</span><span class="p">[</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">kRatio</span><span class="o">*</span><span class="n">G2pwd</span><span class="o">.</span><span class="n">getFCJVoigt3</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">])</span>        <span class="c">#and here</span>
                        <span class="n">refl</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ratio</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">,</span><span class="n">yp</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span><span class="o">*</span><span class="n">ratio</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">kRatio</span><span class="p">)),</span><span class="mf">0.0</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;histType&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="s">&#39;TOF Undefined at present&#39;</span>
                        <span class="k">raise</span> <span class="ne">Exception</span>    <span class="c">#no TOF yet</span>
                    <span class="n">Fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
                    <span class="n">Fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]))</span>
                    <span class="n">sumFo</span> <span class="o">+=</span> <span class="n">Fo</span>
                    <span class="n">sumFosq</span> <span class="o">+=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                    <span class="n">sumdF</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Fo</span><span class="o">-</span><span class="n">Fc</span><span class="p">)</span>
                    <span class="n">sumdFsq</span> <span class="o">+=</span> <span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">-</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">Histogram</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">100.</span><span class="p">,(</span><span class="n">sumdF</span><span class="o">/</span><span class="n">sumFo</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
                <span class="n">Histogram</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Rf^2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">100.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sumdFsq</span><span class="o">/</span><span class="n">sumFosq</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
                <span class="n">Histogram</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Nref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">)</span>
                </div>
<div class="viewcode-block" id="getPowderProfile"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.getPowderProfile">[docs]</a><span class="k">def</span> <span class="nf">getPowderProfile</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">varylist</span><span class="p">,</span><span class="n">Histogram</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">pawleyLookup</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    
    <span class="k">def</span> <span class="nf">GetReflSigGam</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">GB</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">):</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;U&#39;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;V&#39;</span><span class="p">]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;W&#39;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;X&#39;</span><span class="p">]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Y&#39;</span><span class="p">]</span>
        <span class="n">tanPos</span> <span class="o">=</span> <span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">Ssig</span><span class="p">,</span><span class="n">Sgam</span> <span class="o">=</span> <span class="n">GetSampleSigGam</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">GB</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">U</span><span class="o">*</span><span class="n">tanPos</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">V</span><span class="o">*</span><span class="n">tanPos</span><span class="o">+</span><span class="n">W</span><span class="o">+</span><span class="n">Ssig</span>     <span class="c">#save peak sigma</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="n">X</span><span class="o">/</span><span class="n">cosd</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span><span class="n">Y</span><span class="o">*</span><span class="n">tanPos</span><span class="o">+</span><span class="n">Sgam</span>     <span class="c">#save peak gamma</span>
        <span class="n">gam</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span><span class="n">gam</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sig</span><span class="p">,</span><span class="n">gam</span>
                
    <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
    <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
    <span class="n">bakType</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;bakType&#39;</span><span class="p">]</span>
    <span class="n">yb</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getBackground</span><span class="p">(</span><span class="n">hfx</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">bakType</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">yb</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;histType&#39;</span><span class="p">]:</span>    
        <span class="n">shl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;SH/L&#39;</span><span class="p">],</span><span class="mf">0.002</span><span class="p">)</span>
        <span class="n">Ka2</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span><span class="p">]</span>
            <span class="n">Ka2</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">lamRatio</span> <span class="o">=</span> <span class="mi">360</span><span class="o">*</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span><span class="p">])</span>
            <span class="n">kRatio</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;I(L2)/I(L1)&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;TOF Undefined at present&#39;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]:</span>
        <span class="n">refList</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">][</span><span class="n">phase</span><span class="p">]</span>
        <span class="n">Phase</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
        <span class="n">pId</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
        <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">::&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span>
        <span class="n">phfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">hId</span><span class="p">)</span>
        <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">G</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">A2Gmat</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>       <span class="c">#recip &amp; real metric tensors</span>
        <span class="n">GA</span><span class="p">,</span><span class="n">GB</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Gmat2AB</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>    <span class="c">#Orthogonalization matricies</span>
        <span class="n">Vst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nl</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>    <span class="c">#V*</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;doPawley&#39;</span><span class="p">):</span>
            <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">StructureFactor</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
<span class="c">#            print &#39;sf calc time: %.3fs&#39;%(time.time()-time0)</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">refl</span> <span class="ow">in</span> <span class="n">refList</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;histType&#39;</span><span class="p">]:</span>
                <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetReflPos</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>         <span class="c">#corrected reflection position</span>
                <span class="n">Lorenz</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>           <span class="c">#Lorentz correction</span>
                <span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">+=</span> <span class="n">GetHStrainShift</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>               <span class="c">#apply hydrostatic strain shift</span>
                <span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">GetReflSigGam</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">GB</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>    <span class="c">#peak sig &amp; gam</span>
                <span class="n">GetIntensityCorr</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>    <span class="c">#puts corrections in refl[13]</span>
                <span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Vst</span><span class="o">*</span><span class="n">Lorenz</span>
                <span class="k">if</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;doPawley&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pInd</span> <span class="o">=</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;PWLref:</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pawleyLookup</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)])</span>
                        <span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">pInd</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<span class="c">#                        print &#39; ***Error %d,%d,%d missing from Pawley reflection list ***&#39;%(h,k,l)</span>
                        <span class="k">continue</span>
                <span class="n">Wd</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getWidthsCW</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">)</span>
                <span class="n">iBeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">fmin</span><span class="p">)</span>
                <span class="n">iFin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">fmax</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">iBeg</span><span class="o">+</span><span class="n">iFin</span><span class="p">:</span>       <span class="c">#peak below low limit - skip peak</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">iBeg</span><span class="o">-</span><span class="n">iFin</span><span class="p">:</span>     <span class="c">#peak above high limit - done</span>
                    <span class="k">break</span>
                <span class="n">yc</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">G2pwd</span><span class="o">.</span><span class="n">getFCJVoigt3</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">])</span>    <span class="c">#&gt;90% of time spent here</span>
                <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                    <span class="n">pos2</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">lamRatio</span><span class="o">*</span><span class="n">tand</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>       <span class="c"># + 360/pi * Dlam/lam * tan(th)</span>
                    <span class="n">Wd</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getWidthsCW</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">)</span>
                    <span class="n">iBeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pos2</span><span class="o">-</span><span class="n">fmin</span><span class="p">)</span>
                    <span class="n">iFin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pos2</span><span class="o">+</span><span class="n">fmax</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">iBeg</span><span class="o">+</span><span class="n">iFin</span><span class="p">:</span>       <span class="c">#peak below low limit - skip peak</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">iBeg</span><span class="o">-</span><span class="n">iFin</span><span class="p">:</span>     <span class="c">#peak above high limit - done</span>
                        <span class="k">return</span> <span class="n">yc</span><span class="p">,</span><span class="n">yb</span>
                    <span class="n">yc</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">kRatio</span><span class="o">*</span><span class="n">G2pwd</span><span class="o">.</span><span class="n">getFCJVoigt3</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">])</span>        <span class="c">#and here</span>
            <span class="k">elif</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;histType&#39;</span><span class="p">]:</span>
                <span class="k">print</span> <span class="s">&#39;TOF Undefined at present&#39;</span>
                <span class="k">raise</span> <span class="ne">Exception</span>    <span class="c">#no TOF yet</span>
<span class="c">#        print &#39;profile calc time: %.3fs&#39;%(time.time()-time0)</span>
    <span class="k">return</span> <span class="n">yc</span><span class="p">,</span><span class="n">yb</span>
    </div>
<div class="viewcode-block" id="getPowderProfileDerv"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.getPowderProfileDerv">[docs]</a><span class="k">def</span> <span class="nf">getPowderProfileDerv</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">varylist</span><span class="p">,</span><span class="n">Histogram</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">pawleyLookup</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    
    <span class="k">def</span> <span class="nf">cellVaryDerv</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">dpdA</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;-1&#39;</span><span class="p">,]:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A1&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A2&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A3&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">3</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A4&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">4</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A5&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">5</span><span class="p">]]]</span>
        <span class="k">elif</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;2/m&#39;</span><span class="p">,]:</span>
            <span class="k">if</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGUniq&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A1&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A2&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">2</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A3&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">3</span><span class="p">]]]</span>
            <span class="k">elif</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGUniq&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A1&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A2&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">2</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A4&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">4</span><span class="p">]]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A1&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A2&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">2</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A5&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">5</span><span class="p">]]]</span>
        <span class="k">elif</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;mmm&#39;</span><span class="p">,]:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A1&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A2&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
        <span class="k">elif</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;4/m&#39;</span><span class="p">,</span><span class="s">&#39;4/mmm&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A2&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
        <span class="k">elif</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;6/m&#39;</span><span class="p">,</span><span class="s">&#39;6/mmm&#39;</span><span class="p">,</span><span class="s">&#39;3m1&#39;</span><span class="p">,</span> <span class="s">&#39;31m&#39;</span><span class="p">,</span> <span class="s">&#39;3&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A2&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]</span>
        <span class="k">elif</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;3R&#39;</span><span class="p">,</span> <span class="s">&#39;3mR&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">2</span><span class="p">]],[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A3&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">5</span><span class="p">]]]</span>                       
        <span class="k">elif</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;m3m&#39;</span><span class="p">,</span><span class="s">&#39;m3&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A0&#39;</span><span class="p">,</span><span class="n">dpdA</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            
    <span class="c"># create a list of dependent variables and set up a dictionary to hold their derivatives</span>
    <span class="n">dependentVars</span> <span class="o">=</span> <span class="n">G2mv</span><span class="o">.</span><span class="n">GetDependentVars</span><span class="p">()</span>
    <span class="n">depDerivDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="c">#print &#39;dependent vars&#39;,dependentVars</span>
    <span class="n">lenX</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>                
    <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
    <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
    <span class="n">bakType</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;bakType&#39;</span><span class="p">]</span>
    <span class="n">dMdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">varylist</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">dMdb</span><span class="p">,</span><span class="n">dMddb</span><span class="p">,</span><span class="n">dMdpk</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getBackgroundDerv</span><span class="p">(</span><span class="n">hfx</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">bakType</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Back:0&#39;</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span> <span class="c"># for now assume that Back:x vars to not appear in constraints</span>
        <span class="n">bBpos</span> <span class="o">=</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Back:0&#39;</span><span class="p">)</span>
        <span class="n">dMdv</span><span class="p">[</span><span class="n">bBpos</span><span class="p">:</span><span class="n">bBpos</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">dMdb</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dMdb</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;DebyeA&#39;</span><span class="p">,</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;DebyeR&#39;</span><span class="p">,</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;DebyeU&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;Debye&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">parm</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))]</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parm</span><span class="p">)</span>
            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dMddb</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="nb">id</span><span class="o">+</span><span class="n">ip</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;BkPkpos&#39;</span><span class="p">,</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;BkPkint&#39;</span><span class="p">,</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;BkPksig&#39;</span><span class="p">,</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;BkPkgam&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;BkPk&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">parm</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">))]</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parm</span><span class="p">)</span>
            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dMdpk</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="nb">id</span><span class="o">+</span><span class="n">ip</span><span class="p">]</span>
    <span class="n">cw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">cw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cw</span><span class="p">,</span><span class="n">cw</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;histType&#39;</span><span class="p">]:</span>    
        <span class="n">shl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;SH/L&#39;</span><span class="p">],</span><span class="mf">0.002</span><span class="p">)</span>
        <span class="n">Ka2</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span> <span class="ow">in</span> <span class="n">parmDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span><span class="p">]</span>
            <span class="n">Ka2</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">lamRatio</span> <span class="o">=</span> <span class="mi">360</span><span class="o">*</span><span class="p">(</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam2&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam1&#39;</span><span class="p">])</span>
            <span class="n">kRatio</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;I(L2)/I(L1)&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;TOF Undefined at present&#39;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">for</span> <span class="n">phase</span> <span class="ow">in</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]:</span>
        <span class="n">refList</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">][</span><span class="n">phase</span><span class="p">]</span>
        <span class="n">Phase</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">pId</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
        <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">::&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pId</span><span class="p">)</span>
        <span class="n">phfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">hId</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">G</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">A2Gmat</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>       <span class="c">#recip &amp; real metric tensors</span>
        <span class="n">GA</span><span class="p">,</span><span class="n">GB</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Gmat2AB</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>    <span class="c">#Orthogonalization matricies</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;doPawley&#39;</span><span class="p">):</span>
            <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dFdvDict</span> <span class="o">=</span> <span class="n">StructureFactorDerv</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
<span class="c">#            print &#39;sf-derv time %.3fs&#39;%(time.time()-time0)</span>
            <span class="n">ApplyRBModelDervs</span><span class="p">(</span><span class="n">dFdvDict</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">,</span><span class="n">Phase</span><span class="p">)</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iref</span><span class="p">,</span><span class="n">refl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refList</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;histType&#39;</span><span class="p">]:</span>        <span class="c">#CW powder</span>
                <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">dIdsh</span><span class="p">,</span><span class="n">dIdsp</span><span class="p">,</span><span class="n">dIdpola</span><span class="p">,</span><span class="n">dIdPO</span><span class="p">,</span><span class="n">dFdODF</span><span class="p">,</span><span class="n">dFdSA</span><span class="p">,</span><span class="n">dFdAb</span> <span class="o">=</span> <span class="n">GetIntensityDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
                <span class="n">Wd</span><span class="p">,</span><span class="n">fmin</span><span class="p">,</span><span class="n">fmax</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getWidthsCW</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">)</span>
                <span class="n">iBeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">fmin</span><span class="p">)</span>
                <span class="n">iFin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">fmax</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">iBeg</span><span class="o">+</span><span class="n">iFin</span><span class="p">:</span>       <span class="c">#peak below low limit - skip peak</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">iBeg</span><span class="o">-</span><span class="n">iFin</span><span class="p">:</span>     <span class="c">#peak above high limit - done</span>
                    <span class="k">break</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">tanth</span> <span class="o">=</span> <span class="n">tand</span><span class="p">(</span><span class="n">pos</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="n">costh</span> <span class="o">=</span> <span class="n">cosd</span><span class="p">(</span><span class="n">pos</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="n">lenBF</span> <span class="o">=</span> <span class="n">iFin</span><span class="o">-</span><span class="n">iBeg</span>
                <span class="n">dMdpk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">lenBF</span><span class="p">))</span>
                <span class="n">dMdipk</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getdFCJVoigt3</span><span class="p">(</span><span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">dMdpk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">cw</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">dMdipk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">dervDict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;int&#39;</span><span class="p">:</span><span class="n">dMdpk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;pos&#39;</span><span class="p">:</span><span class="n">dMdpk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;sig&#39;</span><span class="p">:</span><span class="n">dMdpk</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;gam&#39;</span><span class="p">:</span><span class="n">dMdpk</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s">&#39;shl&#39;</span><span class="p">:</span><span class="n">dMdpk</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s">&#39;L1/L2&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dMdpk</span><span class="p">[</span><span class="mi">0</span><span class="p">])}</span>
                <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                    <span class="n">pos2</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="n">lamRatio</span><span class="o">*</span><span class="n">tanth</span>       <span class="c"># + 360/pi * Dlam/lam * tan(th)</span>
                    <span class="n">iBeg2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pos2</span><span class="o">-</span><span class="n">fmin</span><span class="p">)</span>
                    <span class="n">iFin2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">pos2</span><span class="o">+</span><span class="n">fmax</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iBeg2</span><span class="o">-</span><span class="n">iFin2</span><span class="p">:</span>
                        <span class="n">lenBF2</span> <span class="o">=</span> <span class="n">iFin2</span><span class="o">-</span><span class="n">iBeg2</span>
                        <span class="n">dMdpk2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">lenBF2</span><span class="p">))</span>
                        <span class="n">dMdipk2</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getdFCJVoigt3</span><span class="p">(</span><span class="n">pos2</span><span class="p">,</span><span class="n">refl</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">refl</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">shl</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                            <span class="n">dMdpk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">cw</span><span class="p">[</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">kRatio</span><span class="o">*</span><span class="n">dMdipk2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">dMdpk2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">cw</span><span class="p">[</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">*</span><span class="n">dMdipk2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dervDict2</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;int&#39;</span><span class="p">:</span><span class="n">dMdpk2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;pos&#39;</span><span class="p">:</span><span class="n">dMdpk2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;sig&#39;</span><span class="p">:</span><span class="n">dMdpk2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;gam&#39;</span><span class="p">:</span><span class="n">dMdpk2</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="s">&#39;shl&#39;</span><span class="p">:</span><span class="n">dMdpk2</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="s">&#39;L1/L2&#39;</span><span class="p">:</span><span class="n">dMdpk2</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]}</span>
                <span class="k">if</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;doPawley&#39;</span><span class="p">):</span>
                    <span class="n">dMdpw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">pIdx</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="s">&#39;PWLref:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pawleyLookup</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)])</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pIdx</span><span class="p">)</span>
                        <span class="n">dMdpw</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">=</span> <span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdpw</span><span class="p">[</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">dMdpw</span>
                    <span class="k">except</span><span class="p">:</span> <span class="c"># ValueError:</span>
                        <span class="k">pass</span>
                <span class="n">dpdA</span><span class="p">,</span><span class="n">dpdw</span><span class="p">,</span><span class="n">dpdZ</span><span class="p">,</span><span class="n">dpdSh</span><span class="p">,</span><span class="n">dpdTr</span><span class="p">,</span><span class="n">dpdX</span><span class="p">,</span><span class="n">dpdY</span> <span class="o">=</span> <span class="n">GetReflPosDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">{</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">:[</span><span class="n">dIdsh</span><span class="p">,</span><span class="s">&#39;int&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Polariz.&#39;</span><span class="p">:[</span><span class="n">dIdpola</span><span class="p">,</span><span class="s">&#39;int&#39;</span><span class="p">],</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">:[</span><span class="n">dIdsp</span><span class="p">,</span><span class="s">&#39;int&#39;</span><span class="p">],</span>
                    <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;U&#39;</span><span class="p">:[</span><span class="n">tanth</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="s">&#39;sig&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;V&#39;</span><span class="p">:[</span><span class="n">tanth</span><span class="p">,</span><span class="s">&#39;sig&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;W&#39;</span><span class="p">:[</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;sig&#39;</span><span class="p">],</span>
                    <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;X&#39;</span><span class="p">:[</span><span class="mf">1.0</span><span class="o">/</span><span class="n">costh</span><span class="p">,</span><span class="s">&#39;gam&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Y&#39;</span><span class="p">:[</span><span class="n">tanth</span><span class="p">,</span><span class="s">&#39;gam&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;SH/L&#39;</span><span class="p">:[</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;shl&#39;</span><span class="p">],</span>
                    <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;I(L2)/I(L1)&#39;</span><span class="p">:[</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;L1/L2&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Zero&#39;</span><span class="p">:[</span><span class="n">dpdZ</span><span class="p">,</span><span class="s">&#39;pos&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Lam&#39;</span><span class="p">:[</span><span class="n">dpdw</span><span class="p">,</span><span class="s">&#39;pos&#39;</span><span class="p">],</span>
                    <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Shift&#39;</span><span class="p">:[</span><span class="n">dpdSh</span><span class="p">,</span><span class="s">&#39;pos&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Transparency&#39;</span><span class="p">:[</span><span class="n">dpdTr</span><span class="p">,</span><span class="s">&#39;pos&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;DisplaceX&#39;</span><span class="p">:[</span><span class="n">dpdX</span><span class="p">,</span><span class="s">&#39;pos&#39;</span><span class="p">],</span>
                    <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;DisplaceY&#39;</span><span class="p">:[</span><span class="n">dpdY</span><span class="p">,</span><span class="s">&#39;pos&#39;</span><span class="p">],</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Absorption&#39;</span><span class="p">:[</span><span class="n">dFdAb</span><span class="p">,</span><span class="s">&#39;int&#39;</span><span class="p">],}</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">iPO</span> <span class="ow">in</span> <span class="n">dIdPO</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">iPO</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">iPO</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dIdPO</span><span class="p">[</span><span class="n">iPO</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">iPO</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dIdPO</span><span class="p">[</span><span class="n">iPO</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">iPO</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">iPO</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dIdPO</span><span class="p">[</span><span class="n">iPO</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">iPO</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dIdPO</span><span class="p">[</span><span class="n">iPO</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39;omega&#39;</span><span class="p">,</span><span class="s">&#39;chi&#39;</span><span class="p">,</span><span class="s">&#39;phi&#39;</span><span class="p">]):</span>
                    <span class="n">aname</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SH &#39;</span><span class="o">+</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">aname</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdSA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">aname</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdSA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">aname</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">aname</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdSA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">aname</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdSA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">iSH</span> <span class="ow">in</span> <span class="n">dFdODF</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">iSH</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">iSH</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdODF</span><span class="p">[</span><span class="n">iSH</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">iSH</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdODF</span><span class="p">[</span><span class="n">iSH</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">iSH</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">iSH</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdODF</span><span class="p">[</span><span class="n">iSH</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">iSH</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdODF</span><span class="p">[</span><span class="n">iSH</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span>
                <span class="n">cellDervNames</span> <span class="o">=</span> <span class="n">cellVaryDerv</span><span class="p">(</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">dpdA</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">dpdA</span> <span class="ow">in</span> <span class="n">cellDervNames</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dpdA</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dpdA</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dpdA</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dpdA</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span>
                <span class="n">dDijDict</span> <span class="o">=</span> <span class="n">GetHStrainShiftDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">phfx</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dDijDict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dDijDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dDijDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dDijDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dDijDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">]</span>
                <span class="n">sigDict</span><span class="p">,</span><span class="n">gamDict</span> <span class="o">=</span> <span class="n">GetSampleSigGamDerv</span><span class="p">(</span><span class="n">refl</span><span class="p">,</span><span class="n">wave</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">GB</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">gamDict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gamDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;gam&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gamDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;gam&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gamDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;gam&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">gamDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;gam&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sigDict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sigDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;sig&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sigDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;sig&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sigDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;sig&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">sigDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;sig&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;BabA&#39;</span><span class="p">,</span><span class="s">&#39;BabU&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">name</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cw</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">name</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cw</span><span class="p">[</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">phfx</span><span class="o">+</span><span class="n">name</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>                    
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">name</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cw</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">name</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cw</span><span class="p">[</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span>                  
            <span class="k">elif</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;histType&#39;</span><span class="p">]:</span>
                <span class="k">print</span> <span class="s">&#39;TOF Undefined at present&#39;</span>
                <span class="k">raise</span> <span class="ne">Exception</span>    <span class="c">#no TOF yet</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;doPawley&#39;</span><span class="p">):</span>
                <span class="c">#do atom derivatives -  for RB,F,X &amp; U so far              </span>
                <span class="n">corr</span> <span class="o">=</span> <span class="n">dervDict</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                    <span class="n">corr2</span> <span class="o">=</span> <span class="n">dervDict2</span><span class="p">[</span><span class="s">&#39;int&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">refl</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="o">+</span><span class="n">dependentVars</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;::RBV;&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">aname</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pfx</span><span class="p">)[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">aname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Af&#39;</span><span class="p">,</span><span class="s">&#39;dA&#39;</span><span class="p">,</span><span class="s">&#39;AU&#39;</span><span class="p">,</span><span class="s">&#39;RB&#39;</span><span class="p">]:</span> <span class="k">continue</span> <span class="c"># skip anything not an atom or rigid body param</span>
                        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                        <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">corr</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">dMdv</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">corr2</span>
                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dependentVars</span><span class="p">:</span>
                        <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg</span><span class="p">:</span><span class="n">iFin</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">corr</span>
                        <span class="k">if</span> <span class="n">Ka2</span><span class="p">:</span>
                            <span class="n">depDerivDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iBeg2</span><span class="p">:</span><span class="n">iFin2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dFdvDict</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">corr2</span>
<span class="c">#        print &#39;profile derv time: %.3fs&#39;%(time.time()-time0)</span>
    <span class="c"># now process derivatives in constraints</span>
    <span class="n">G2mv</span><span class="o">.</span><span class="n">Dict2Deriv</span><span class="p">(</span><span class="n">varylist</span><span class="p">,</span><span class="n">depDerivDict</span><span class="p">,</span><span class="n">dMdv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dMdv</span>
</div>
<div class="viewcode-block" id="dervRefine"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.dervRefine">[docs]</a><span class="k">def</span> <span class="nf">dervRefine</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">pawleyLookup</span><span class="p">,</span><span class="n">dlg</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">parmDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">varylist</span><span class="p">,</span><span class="n">values</span><span class="p">))</span>
    <span class="n">G2mv</span><span class="o">.</span><span class="n">Dict2Map</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span>
    <span class="n">Histograms</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">restraintDict</span><span class="p">,</span><span class="n">rigidbodyDict</span> <span class="o">=</span> <span class="n">HistoPhases</span>
    <span class="n">nvar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varylist</span><span class="p">)</span>
    <span class="n">dMdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">histoList</span> <span class="o">=</span> <span class="n">Histograms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">histoList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">histogram</span> <span class="ow">in</span> <span class="n">histoList</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">histogram</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">Histogram</span> <span class="o">=</span> <span class="n">Histograms</span><span class="p">[</span><span class="n">histogram</span><span class="p">]</span>
            <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">wtFactor</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span>
            <span class="n">Limits</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Limits&#39;</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">yc</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">wtFactor</span><span class="o">*</span><span class="n">w</span>
            <span class="n">xB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dMdvh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">])</span><span class="o">*</span><span class="n">getPowderProfileDerv</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">],</span>
                <span class="n">varylist</span><span class="p">,</span><span class="n">Histogram</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">pawleyLookup</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;HKLF&#39;</span> <span class="ow">in</span> <span class="n">histogram</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">Histogram</span> <span class="o">=</span> <span class="n">Histograms</span><span class="p">[</span><span class="n">histogram</span><span class="p">]</span>
            <span class="n">nobs</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Nobs&#39;</span><span class="p">]</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]</span>
            <span class="n">Phase</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
            <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">wtFactor</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span>
            <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">::&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span>
            <span class="n">phfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">],</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
            <span class="n">G</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">A2Gmat</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>       <span class="c">#recip &amp; real metric tensors</span>
            <span class="n">refList</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">]</span>
            <span class="n">dFdvDict</span> <span class="o">=</span> <span class="n">StructureFactorDerv</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
            <span class="n">ApplyRBModelDervs</span><span class="p">(</span><span class="n">dFdvDict</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">,</span><span class="n">Phase</span><span class="p">)</span>
            <span class="n">dMdvh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">varylist</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;F**2&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">iref</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refList</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dervCor</span><span class="p">,</span><span class="n">dervDict</span> <span class="o">=</span> <span class="n">SCExtinction</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span> <span class="c">#puts correction in refl[13]</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">w</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;minF/sig&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varylist</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dFdvDict</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span>
                            <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Ep&#39;</span><span class="p">,</span><span class="s">&#39;Es&#39;</span><span class="p">,</span><span class="s">&#39;Eg&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;BabA&#39;</span><span class="p">,</span><span class="s">&#39;BabU&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dervCor</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">item</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iref</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refList</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">dervCor</span><span class="p">,</span><span class="n">dervDict</span> <span class="o">=</span> <span class="n">SCExtinction</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span> <span class="c">#puts correction in refl[13]</span>
                        <span class="n">Fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                        <span class="n">Fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="k">if</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">Fo</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">Fo</span> <span class="o">&gt;=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;minF/sig&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varylist</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dFdvDict</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span>                           
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Ep&#39;</span><span class="p">,</span><span class="s">&#39;Es&#39;</span><span class="p">,</span><span class="s">&#39;Eg&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;BabA&#39;</span><span class="p">,</span><span class="s">&#39;BabU&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dervCor</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">item</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>        <span class="c">#skip non-histogram entries</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dMdv</span><span class="p">):</span>
            <span class="n">dMdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dMdv</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wtFactor</span><span class="p">)</span><span class="o">*</span><span class="n">dMdvh</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dMdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wtFactor</span><span class="p">)</span><span class="o">*</span><span class="n">dMdvh</span>
            
    <span class="n">pNames</span><span class="p">,</span><span class="n">pVals</span><span class="p">,</span><span class="n">pWt</span> <span class="o">=</span> <span class="n">penaltyFxn</span><span class="p">(</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pVals</span><span class="p">):</span>
        <span class="n">dpdv</span> <span class="o">=</span> <span class="n">penaltyDeriv</span><span class="p">(</span><span class="n">pNames</span><span class="p">,</span><span class="n">pVals</span><span class="p">,</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span>
        <span class="n">dMdv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">dMdv</span><span class="o">.</span><span class="n">T</span><span class="p">,(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pWt</span><span class="p">)</span><span class="o">*</span><span class="n">dpdv</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
        
    <span class="k">return</span> <span class="n">dMdv</span>
</div>
<div class="viewcode-block" id="HessRefine"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.HessRefine">[docs]</a><span class="k">def</span> <span class="nf">HessRefine</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">pawleyLookup</span><span class="p">,</span><span class="n">dlg</span><span class="p">):</span>
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">parmDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">varylist</span><span class="p">,</span><span class="n">values</span><span class="p">))</span>
    <span class="n">G2mv</span><span class="o">.</span><span class="n">Dict2Map</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span>
    <span class="n">Histograms</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">restraintDict</span><span class="p">,</span><span class="n">rigidbodyDict</span> <span class="o">=</span> <span class="n">HistoPhases</span>
    <span class="n">ApplyRBModels</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">)</span>        <span class="c">#,Update=True??</span>
    <span class="n">nvar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varylist</span><span class="p">)</span>
    <span class="n">Hess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">histoList</span> <span class="o">=</span> <span class="n">Histograms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">histoList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">histogram</span> <span class="ow">in</span> <span class="n">histoList</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">histogram</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">Histogram</span> <span class="o">=</span> <span class="n">Histograms</span><span class="p">[</span><span class="n">histogram</span><span class="p">]</span>
            <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">wtFactor</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span>
            <span class="n">Limits</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Limits&#39;</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">yc</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">wtFactor</span><span class="o">*</span><span class="n">w</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">y</span><span class="o">-</span><span class="n">yc</span>
            <span class="n">xB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dMdvh</span> <span class="o">=</span> <span class="n">getPowderProfileDerv</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">],</span>
                <span class="n">varylist</span><span class="p">,</span><span class="n">Histogram</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">pawleyLookup</span><span class="p">)</span>
            <span class="n">Wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">])[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
            <span class="n">Dy</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
            <span class="n">dMdvh</span> <span class="o">*=</span> <span class="n">Wt</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">],</span><span class="n">newmsg</span><span class="o">=</span><span class="s">&#39;Hessian for histogram </span><span class="si">%d</span><span class="se">\n</span><span class="s">All data Rw=</span><span class="si">%8.3f%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">,</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">],</span><span class="s">&#39;%&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Hess</span><span class="p">):</span>
                <span class="n">Hess</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">dMdvh</span><span class="p">,</span><span class="n">dMdvh</span><span class="p">)</span>
                <span class="n">dMdvh</span> <span class="o">*=</span> <span class="n">Wt</span><span class="o">*</span><span class="n">Dy</span>
                <span class="n">Vec</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dMdvh</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Hess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">dMdvh</span><span class="p">,</span><span class="n">dMdvh</span><span class="p">)</span>
                <span class="n">dMdvh</span> <span class="o">*=</span> <span class="n">Wt</span><span class="o">*</span><span class="n">Dy</span>
                <span class="n">Vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dMdvh</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;HKLF&#39;</span> <span class="ow">in</span> <span class="n">histogram</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">Histogram</span> <span class="o">=</span> <span class="n">Histograms</span><span class="p">[</span><span class="n">histogram</span><span class="p">]</span>
            <span class="n">nobs</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Nobs&#39;</span><span class="p">]</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]</span>
            <span class="n">Phase</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
            <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">wtFactor</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span>
            <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">::&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span>
            <span class="n">phfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">],</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
            <span class="n">G</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">A2Gmat</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>       <span class="c">#recip &amp; real metric tensors</span>
            <span class="n">refList</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">]</span>
            <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dFdvDict</span> <span class="o">=</span> <span class="n">StructureFactorDerv</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>  <span class="c">#accurate for powders!</span>
            <span class="n">ApplyRBModelDervs</span><span class="p">(</span><span class="n">dFdvDict</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">,</span><span class="n">Phase</span><span class="p">)</span>
            <span class="n">dMdvh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">varylist</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">)))</span>
            <span class="n">wdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;F**2&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">iref</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refList</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dervCor</span><span class="p">,</span><span class="n">dervDict</span> <span class="o">=</span> <span class="n">SCExtinction</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span> <span class="c">#puts correction in refl[13]</span>
                        <span class="n">w</span> <span class="o">=</span>  <span class="mf">1.0</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">w</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;minF/sig&#39;</span><span class="p">]:</span>
                            <span class="n">wdf</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varylist</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dFdvDict</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Ep&#39;</span><span class="p">,</span><span class="s">&#39;Es&#39;</span><span class="p">,</span><span class="s">&#39;Eg&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;BabA&#39;</span><span class="p">,</span><span class="s">&#39;BabU&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">item</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">iref</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refList</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">dervCor</span><span class="p">,</span><span class="n">dervDict</span> <span class="o">=</span> <span class="n">SCExtinction</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span> <span class="c">#puts correction in refl[13]</span>
                        <span class="n">Fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                        <span class="n">Fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="k">if</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">Fo</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="n">Fo</span> <span class="o">&gt;=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;minF/sig&#39;</span><span class="p">]:</span>
                            <span class="n">wdf</span><span class="p">[</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">Fo</span><span class="o">*</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">Fo</span><span class="o">-</span><span class="n">Fc</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">varylist</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">dFdvDict</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span>                           
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Ep&#39;</span><span class="p">,</span><span class="s">&#39;Es&#39;</span><span class="p">,</span><span class="s">&#39;Eg&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dervDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;BabA&#39;</span><span class="p">,</span><span class="s">&#39;BabU&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span> <span class="ow">in</span> <span class="n">varylist</span><span class="p">:</span>
                                    <span class="n">dMdvh</span><span class="p">[</span><span class="n">varylist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="n">item</span><span class="p">)][</span><span class="n">iref</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">dFdvDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="n">item</span><span class="p">][</span><span class="n">iref</span><span class="p">]</span><span class="o">*</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dervCor</span>
                        
            <span class="k">if</span> <span class="n">dlg</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">],</span><span class="n">newmsg</span><span class="o">=</span><span class="s">&#39;Hessian for histogram </span><span class="si">%d</span><span class="s"> Rw=</span><span class="si">%8.3f%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">,</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">],</span><span class="s">&#39;%&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Hess</span><span class="p">):</span>
                <span class="n">Vec</span> <span class="o">+=</span> <span class="n">wtFactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dMdvh</span><span class="o">*</span><span class="n">wdf</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Hess</span> <span class="o">+=</span> <span class="n">wtFactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">dMdvh</span><span class="p">,</span><span class="n">dMdvh</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Vec</span> <span class="o">=</span> <span class="n">wtFactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dMdvh</span><span class="o">*</span><span class="n">wdf</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Hess</span> <span class="o">=</span> <span class="n">wtFactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">dMdvh</span><span class="p">,</span><span class="n">dMdvh</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>        <span class="c">#skip non-histogram entries</span>
    <span class="n">pNames</span><span class="p">,</span><span class="n">pVals</span><span class="p">,</span><span class="n">pWt</span> <span class="o">=</span> <span class="n">penaltyFxn</span><span class="p">(</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pVals</span><span class="p">):</span>
        <span class="n">dpdv</span> <span class="o">=</span> <span class="n">penaltyDeriv</span><span class="p">(</span><span class="n">pNames</span><span class="p">,</span><span class="n">pVals</span><span class="p">,</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span>
        <span class="n">Vec</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dpdv</span><span class="o">*</span><span class="n">pWt</span><span class="o">*</span><span class="n">pVals</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hess</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">dpdv</span><span class="o">*</span><span class="n">pWt</span><span class="p">,</span><span class="n">dpdv</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Vec</span><span class="p">,</span><span class="n">Hess</span>
</div>
<div class="viewcode-block" id="errRefine"><a class="viewcode-back" href="../GSASIIstruc.html#GSASIIstrMath.errRefine">[docs]</a><span class="k">def</span> <span class="nf">errRefine</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">pawleyLookup</span><span class="p">,</span><span class="n">dlg</span><span class="p">):</span>        
    <span class="s">&#39;Needs a doc string&#39;</span>
    <span class="n">parmDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">varylist</span><span class="p">,</span><span class="n">values</span><span class="p">))</span>
    <span class="n">Values2Dict</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span> <span class="n">varylist</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="n">G2mv</span><span class="o">.</span><span class="n">Dict2Map</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span>
    <span class="n">Histograms</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">restraintDict</span><span class="p">,</span><span class="n">rigidbodyDict</span> <span class="o">=</span> <span class="n">HistoPhases</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">SumwYo</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Nobs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ApplyRBModels</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">rigidbodyDict</span><span class="p">)</span>
    <span class="n">histoList</span> <span class="o">=</span> <span class="n">Histograms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">histoList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">histogram</span> <span class="ow">in</span> <span class="n">histoList</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">histogram</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">Histogram</span> <span class="o">=</span> <span class="n">Histograms</span><span class="p">[</span><span class="n">histogram</span><span class="p">]</span>
            <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">wtFactor</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span>
            <span class="n">Limits</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Limits&#39;</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">yc</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">yd</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">wtFactor</span><span class="o">*</span><span class="n">w</span>
            <span class="n">yc</span> <span class="o">*=</span> <span class="mf">0.0</span>                           <span class="c">#zero full calcd profiles</span>
            <span class="n">yb</span> <span class="o">*=</span> <span class="mf">0.0</span>
            <span class="n">yd</span> <span class="o">*=</span> <span class="mf">0.0</span>
            <span class="n">xB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">xF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Nobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xF</span><span class="o">-</span><span class="n">xB</span>
            <span class="n">Nobs</span> <span class="o">+=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Nobs&#39;</span><span class="p">]</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;sumwYo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">SumwYo</span> <span class="o">+=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;sumwYo&#39;</span><span class="p">]</span>
            <span class="n">yc</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">],</span><span class="n">yb</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]</span> <span class="o">=</span> <span class="n">getPowderProfile</span><span class="p">(</span><span class="n">parmDict</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">],</span>
                <span class="n">varylist</span><span class="p">,</span><span class="n">Histogram</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">pawleyLookup</span><span class="p">)</span>
            <span class="n">yc</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]</span> <span class="o">+=</span> <span class="n">yb</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]</span>
            <span class="n">yd</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]</span><span class="o">-</span><span class="n">yc</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;sumwYd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">yd</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">]))</span>
            <span class="n">wdy</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">W</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">yd</span><span class="p">[</span><span class="n">xB</span><span class="p">:</span><span class="n">xF</span><span class="p">])</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">100.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">wdy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;sumwYo&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">],</span><span class="n">newmsg</span><span class="o">=</span><span class="s">&#39;For histogram </span><span class="si">%d</span><span class="s"> Rw=</span><span class="si">%8.3f%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">,</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">],</span><span class="s">&#39;%&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">M</span><span class="p">,</span><span class="n">wdy</span><span class="p">))</span>
<span class="c">#end of PWDR processing</span>
        <span class="k">elif</span> <span class="s">&#39;HKLF&#39;</span> <span class="ow">in</span> <span class="n">histogram</span><span class="p">[:</span><span class="mi">4</span><span class="p">]:</span>
            <span class="n">Histogram</span> <span class="o">=</span> <span class="n">Histograms</span><span class="p">[</span><span class="n">histogram</span><span class="p">]</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]</span>
            <span class="n">Phase</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
            <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">wtFactor</span> <span class="o">=</span> <span class="n">calcControls</span><span class="p">[</span><span class="n">hfx</span><span class="o">+</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span>
            <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">::&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span>
            <span class="n">phfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">],</span><span class="n">hId</span><span class="p">)</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">parmDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;A</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
            <span class="n">G</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">A2Gmat</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>       <span class="c">#recip &amp; real metric tensors</span>
            <span class="n">refList</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">]</span>
            <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">StructureFactor</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">)</span>
<span class="c">#            print &#39;sf-calc time: %.3f&#39;%(time.time()-time0)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refList</span><span class="p">))</span>
            <span class="n">sumwYo</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sumFo</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sumFo2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sumdF</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sumdF2</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nobs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;F**2&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refList</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">SCExtinction</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span> <span class="c">#puts correction in refl[13]</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                        <span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>                       <span class="c">#correct Fc^2 for extinction</span>
                        <span class="n">ref</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">w</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;minF/sig&#39;</span><span class="p">]:</span>
                            <span class="n">sumFo2</span> <span class="o">+=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                            <span class="n">Fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                            <span class="n">sumFo</span> <span class="o">+=</span> <span class="n">Fo</span>
                            <span class="n">sumFo2</span> <span class="o">+=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                            <span class="n">sumdF</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Fo</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
                            <span class="n">sumdF2</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                            <span class="n">nobs</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                            <span class="n">sumwYo</span> <span class="o">+=</span> <span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refList</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">SCExtinction</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">phfx</span><span class="p">,</span><span class="n">hfx</span><span class="p">,</span><span class="n">pfx</span><span class="p">,</span><span class="n">calcControls</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span> <span class="c">#puts correction in refl[13]</span>
                        <span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">parmDict</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
                        <span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">*=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span>                       <span class="c">#correct Fc^2 for extinction</span>
                        <span class="n">Fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                        <span class="n">Fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                        <span class="n">w</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">Fo</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">w</span><span class="o">*</span><span class="n">Fo</span> <span class="o">&gt;=</span> <span class="n">calcControls</span><span class="p">[</span><span class="s">&#39;minF/sig&#39;</span><span class="p">]:</span>
                            <span class="n">sumFo</span> <span class="o">+=</span> <span class="n">Fo</span>
                            <span class="n">sumFo2</span> <span class="o">+=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                            <span class="n">sumdF</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Fo</span><span class="o">-</span><span class="n">Fc</span><span class="p">)</span>
                            <span class="n">sumdF2</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
                            <span class="n">nobs</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">w</span><span class="o">*</span><span class="p">(</span><span class="n">Fo</span><span class="o">-</span><span class="n">Fc</span><span class="p">)</span>
                            <span class="n">sumwYo</span> <span class="o">+=</span> <span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">Fo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;Nobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nobs</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;sumwYo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sumwYo</span>
            <span class="n">SumwYo</span> <span class="o">+=</span> <span class="n">sumwYo</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">100.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;sumwYo&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">sumdF</span><span class="o">/</span><span class="n">sumFo</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Rf^2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">sumdF2</span><span class="o">/</span><span class="n">sumFo2</span>
            <span class="n">Histogram</span><span class="p">[</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Nref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nobs</span>
            <span class="n">Nobs</span> <span class="o">+=</span> <span class="n">nobs</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">],</span><span class="n">newmsg</span><span class="o">=</span><span class="s">&#39;For histogram </span><span class="si">%d</span><span class="s"> Rw=</span><span class="si">%8.3f%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hId</span><span class="p">,</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">],</span><span class="s">&#39;%&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">M</span><span class="p">,</span><span class="n">wtFactor</span><span class="o">*</span><span class="n">df</span><span class="p">))</span>
<span class="c"># end of HKLF processing</span>
    <span class="n">Histograms</span><span class="p">[</span><span class="s">&#39;sumwYo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SumwYo</span>
    <span class="n">Histograms</span><span class="p">[</span><span class="s">&#39;Nobs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nobs</span>
    <span class="n">Rw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">100.</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">M</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">SumwYo</span><span class="p">)</span><span class="o">*</span><span class="mf">100.</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dlg</span><span class="p">:</span>
        <span class="n">GoOn</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">Rw</span><span class="p">,</span><span class="n">newmsg</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s%8.3f%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="s">&#39;All data Rw =&#39;</span><span class="p">,</span><span class="n">Rw</span><span class="p">,</span><span class="s">&#39;%&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">GoOn</span><span class="p">:</span>
            <span class="n">parmDict</span><span class="p">[</span><span class="s">&#39;saved values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">Exception</span>         <span class="c">#Abort!!</span>
    <span class="n">pDict</span><span class="p">,</span><span class="n">pVals</span><span class="p">,</span><span class="n">pWt</span> <span class="o">=</span> <span class="n">penaltyFxn</span><span class="p">(</span><span class="n">HistoPhases</span><span class="p">,</span><span class="n">parmDict</span><span class="p">,</span><span class="n">varylist</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pVals</span><span class="p">):</span>
        <span class="n">pSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pWt</span><span class="o">*</span><span class="n">pVals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39;Penalty function: </span><span class="si">%.3f</span><span class="s"> on </span><span class="si">%d</span><span class="s"> terms&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pSum</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">pVals</span><span class="p">))</span>
        <span class="n">Nobs</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pVals</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">M</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pWt</span><span class="p">)</span><span class="o">*</span><span class="n">pVals</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">M</span>
                        </div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Von Dreele and Toby for Argonne National Laboratory.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>