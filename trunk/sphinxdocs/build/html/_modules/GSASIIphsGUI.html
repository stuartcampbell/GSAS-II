

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GSASIIphsGUI &mdash; GSAS-II 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GSAS-II 0.2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for GSASIIphsGUI</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#GSASII - phase data display routines</span>
<span class="c">########### SVN repository information ###################</span>
<span class="c"># $Date: 2013-05-15 18:18:22 -0500 (Wed, 15 May 2013) $</span>
<span class="c"># $Author: toby $</span>
<span class="c"># $Revision: 906 $</span>
<span class="c"># $URL: https://subversion.xor.aps.anl.gov/pyGSAS/trunk/GSASIIphsGUI.py $</span>
<span class="c"># $Id: GSASIIphsGUI.py 906 2013-05-15 23:18:22Z toby $</span>
<span class="c">########### SVN repository information ###################</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">*GSASIIphsGUI: Phase GUI*</span>
<span class="sd">=========================</span>
<span class="sd">Module to create the GUI for display of phase information</span>
<span class="sd">in the data display window when a phase is selected.</span>
<span class="sd">(pages displayed in response to some phase tabs are done in other modules,</span>
<span class="sd">such as GSASIIddata.)</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">wx.grid</span> <span class="kn">as</span> <span class="nn">wg</span>
<span class="kn">import</span> <span class="nn">wx.lib.gridmovers</span> <span class="kn">as</span> <span class="nn">wgmove</span>
<span class="kn">import</span> <span class="nn">wx.wizard</span> <span class="kn">as</span> <span class="nn">wz</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span> <span class="kn">as</span> <span class="nn">ran</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">GSASIIpath</span>
<span class="n">GSASIIpath</span><span class="o">.</span><span class="n">SetVersionNumber</span><span class="p">(</span><span class="s">&quot;$Revision: 906 $&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">GSASIIlattice</span> <span class="kn">as</span> <span class="nn">G2lat</span>
<span class="kn">import</span> <span class="nn">GSASIIspc</span> <span class="kn">as</span> <span class="nn">G2spc</span>
<span class="kn">import</span> <span class="nn">GSASIIElem</span> <span class="kn">as</span> <span class="nn">G2elem</span>
<span class="kn">import</span> <span class="nn">GSASIIElemGUI</span> <span class="kn">as</span> <span class="nn">G2elemGUI</span>
<span class="kn">import</span> <span class="nn">GSASIIddataGUI</span> <span class="kn">as</span> <span class="nn">G2ddG</span>
<span class="kn">import</span> <span class="nn">GSASIIplot</span> <span class="kn">as</span> <span class="nn">G2plt</span>
<span class="kn">import</span> <span class="nn">GSASIIgrid</span> <span class="kn">as</span> <span class="nn">G2gd</span>
<span class="kn">import</span> <span class="nn">GSASIIIO</span> <span class="kn">as</span> <span class="nn">G2IO</span>
<span class="kn">import</span> <span class="nn">GSASIIstruct</span> <span class="kn">as</span> <span class="nn">G2str</span>
<span class="kn">import</span> <span class="nn">GSASIImath</span> <span class="kn">as</span> <span class="nn">G2mth</span>
<span class="kn">import</span> <span class="nn">GSASIIpwd</span> <span class="kn">as</span> <span class="nn">G2pwd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">nl</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>

<span class="n">VERY_LIGHT_GREY</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">235</span><span class="p">,</span><span class="mi">235</span><span class="p">,</span><span class="mi">235</span><span class="p">)</span>
<span class="n">WHITE</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">)</span>
<span class="n">BLACK</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mapDefault</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;MapType&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;RefList&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Resolution&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span><span class="s">&#39;Show bonds&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
                <span class="s">&#39;rho&#39;</span><span class="p">:[],</span><span class="s">&#39;rhoMax&#39;</span><span class="p">:</span><span class="mf">0.</span><span class="p">,</span><span class="s">&#39;mapSize&#39;</span><span class="p">:</span><span class="mf">10.0</span><span class="p">,</span><span class="s">&#39;cutOff&#39;</span><span class="p">:</span><span class="mf">50.</span><span class="p">,</span><span class="s">&#39;Flip&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">}</span>
<span class="c"># trig functions in degrees</span>
<span class="n">sind</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">tand</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">cosd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">asind</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">acosd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>


<div class="viewcode-block" id="UpdatePhaseData"><a class="viewcode-back" href="../GSASIIphsGUI.html#GSASIIphsGUI.UpdatePhaseData">[docs]</a><span class="k">def</span> <span class="nf">UpdatePhaseData</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Item</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">oldPage</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create the data display window contents when a phase is clicked on</span>
<span class="sd">    in the man (data tree) window.</span>
<span class="sd">    Called only from :mod:`GSASIIgrid.MovePatternTreeToGrid`,</span>
<span class="sd">    which in turn is called from :mod:`GSASII.GSASII.OnPatternTreeSelChanged`</span>
<span class="sd">    when a tree item is selected.</span>

<span class="sd">    :param wx.frame G2frame: the main GSAS-II frame object</span>

<span class="sd">    :param wx.TreeItemId Item: the tree item that was selected</span>

<span class="sd">    :param dict data: all the information on the phase in a dictionary</span>

<span class="sd">    :param int oldPage: This sets a tab to select when moving</span>
<span class="sd">      from one phase to another, in which case the same tab is selected</span>
<span class="sd">      to display first. This is set only when the previous data tree</span>
<span class="sd">      selection is a phase, if not the value is None. The default action</span>
<span class="sd">      is to bring up the General tab.</span>

<span class="sd">    &#39;&#39;&#39;</span>
       
<span class="c">#patch</span>
    <span class="k">if</span> <span class="s">&#39;RBModels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c">#end patch    </span>

    <span class="k">global</span> <span class="n">rbAtmDict</span>   
    <span class="n">rbAtmDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">:</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
    <span class="n">PhaseName</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span>
    <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;Phase Data for &#39;</span><span class="o">+</span><span class="n">PhaseName</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">CreateStatusBar</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSNoteBook</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">GetClientSize</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">SetupGeneral</span><span class="p">():</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotopes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c"># various patches</span>
        <span class="k">if</span> <span class="s">&#39;Isotope&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s">&#39;Data plot type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Data plot type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Mustrain&#39;</span>
        <span class="k">if</span> <span class="s">&#39;POhkl&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;POhkl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;Map&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapDefault</span>
        <span class="k">if</span> <span class="s">&#39;Flip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Flip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;RefList&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Resolution&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span><span class="s">&#39;Norm element&#39;</span><span class="p">:</span><span class="s">&#39;None&#39;</span><span class="p">,</span>
                <span class="s">&#39;k-factor&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span><span class="s">&#39;k-Max&#39;</span><span class="p">:</span><span class="mf">20.</span><span class="p">}</span>
        <span class="k">if</span> <span class="s">&#39;doPawley&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;doPawley&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s">&#39;Pawley dmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley dmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="s">&#39;Pawley neg wt&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley neg wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="s">&#39;MCSA controls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;MCSA controls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Data source&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Annealing&#39;</span><span class="p">:[</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">0.001</span><span class="p">,</span><span class="mf">0.90</span><span class="p">,</span><span class="mi">1000</span><span class="p">],</span>
            <span class="s">&#39;dmin&#39;</span><span class="p">:</span><span class="mf">2.0</span><span class="p">,</span><span class="s">&#39;Algolrithm&#39;</span><span class="p">:</span><span class="s">&#39;Normal&#39;</span><span class="p">,</span><span class="s">&#39;Jump coeff&#39;</span><span class="p">:[</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]}</span> <span class="c">#&#39;Normal&#39;,&#39;Random jump&#39;,&#39;Tremayne jump&#39;</span>
<span class="c"># end of patches</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;NoAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AngleRadii&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;vdWRadii&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomMass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Mydir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dirname</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">cia</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span><span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">cia</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">12</span><span class="p">]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">cia</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">:</span>
            <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>              <span class="c">#force to standard form</span>
            <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]):</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;NoAtoms&#39;</span><span class="p">][</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;UNK&#39;</span><span class="p">:</span>
                <span class="n">Info</span> <span class="o">=</span> <span class="n">G2elem</span><span class="o">.</span><span class="n">GetAtomInfo</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">])</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">])</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Info</span><span class="p">[</span><span class="s">&#39;Z&#39;</span><span class="p">]</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotopes&#39;</span><span class="p">][</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Info</span><span class="p">[</span><span class="s">&#39;Isotopes&#39;</span><span class="p">]</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Info</span><span class="p">[</span><span class="s">&#39;Drad&#39;</span><span class="p">])</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AngleRadii&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Info</span><span class="p">[</span><span class="s">&#39;Arad&#39;</span><span class="p">])</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;vdWRadii&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Info</span><span class="p">[</span><span class="s">&#39;Vdrad&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotope&#39;</span><span class="p">]:</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Info</span><span class="p">[</span><span class="s">&#39;Isotopes&#39;</span><span class="p">][</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotope&#39;</span><span class="p">][</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]]][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotope&#39;</span><span class="p">][</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]]</span> <span class="o">=</span> <span class="s">&#39;Nat. Abund.&#39;</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomMass&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Info</span><span class="p">[</span><span class="s">&#39;Mass&#39;</span><span class="p">])</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;NoAtoms&#39;</span><span class="p">][</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]]</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Color&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Info</span><span class="p">[</span><span class="s">&#39;Color&#39;</span><span class="p">])</span>
        <span class="n">F000X</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">F000N</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]):</span>
            <span class="n">F000X</span> <span class="o">+=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;NoAtoms&#39;</span><span class="p">][</span><span class="n">elem</span><span class="p">]</span><span class="o">*</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Z&#39;</span><span class="p">]</span>
            <span class="n">isotope</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotope&#39;</span><span class="p">][</span><span class="n">elem</span><span class="p">]</span>
            <span class="n">F000N</span> <span class="o">+=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;NoAtoms&#39;</span><span class="p">][</span><span class="n">elem</span><span class="p">]</span><span class="o">*</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotopes&#39;</span><span class="p">][</span><span class="n">elem</span><span class="p">][</span><span class="n">isotope</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;F000X&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">F000X</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;F000N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">F000N</span>
       

<span class="c">################################################################################</span>
<span class="c">##### General phase routines</span>
<span class="c">################################################################################</span>

    <span class="k">def</span> <span class="nf">UpdateGeneral</span><span class="p">():</span>
        <span class="sd">&#39;&#39;&#39;Draw the controls for the General phase data subpage</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="sd">&quot;&quot;&quot; This is the default dictionary structure for phase data</span>
<span class="sd">        (taken from GSASII.py)</span>
<span class="sd">        &#39;General&#39;:{</span>
<span class="sd">            &#39;Name&#39;:PhaseName</span>
<span class="sd">            &#39;Type&#39;:&#39;nuclear&#39;</span>
<span class="sd">            &#39;SGData&#39;:SGData</span>
<span class="sd">            &#39;Cell&#39;:[False,10.,10.,10.,90.,90.,90,1000.]</span>
<span class="sd">            &#39;AtomPtrs&#39;:[]</span>
<span class="sd">            &#39;Histogram list&#39;:[&#39;&#39;,]</span>
<span class="sd">            &#39;Pawley dmin&#39;:1.0,</span>
<span class="sd">            &#39;Pawley neg wt&#39;:0.0}</span>
<span class="sd">        &#39;Atoms&#39;:[]</span>
<span class="sd">        &#39;Drawing&#39;:{}</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">phaseTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;nuclear&#39;</span><span class="p">,</span><span class="s">&#39;modulated&#39;</span><span class="p">,</span><span class="s">&#39;magnetic&#39;</span><span class="p">,</span><span class="s">&#39;macromolecular&#39;</span><span class="p">]</span>
        <span class="n">SetupGeneral</span><span class="p">()</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Map</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span>
        <span class="n">Flip</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Flip&#39;</span><span class="p">]</span>
        <span class="n">MCSA</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;MCSA controls&#39;</span><span class="p">]</span>  
        <span class="n">PWDR</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
        
        <span class="k">def</span> <span class="nf">NameSizer</span><span class="p">():</span>
                   
            <span class="k">def</span> <span class="nf">OnPhaseName</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">oldName</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NameTxt</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">oldName</span><span class="p">,</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">])</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;Phase Data for &#39;</span><span class="o">+</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">])</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">SetItemText</span><span class="p">(</span><span class="n">Item</span><span class="p">,</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">])</span>
                <span class="c">#Hmm, need to change phase name key in Reflection Lists for each histogram</span>
                            
            <span class="k">def</span> <span class="nf">OnPhaseType</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]:</span>             <span class="c">#can change only if no atoms!</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TypeTxt</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateGeneral</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">TypeTxt</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">])</span>                
                
            <span class="k">def</span> <span class="nf">OnSpaceGroup</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">SpcGp</span> <span class="o">=</span> <span class="n">SGTxt</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">SGErr</span><span class="p">,</span><span class="n">SGData</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SpcGroup</span><span class="p">(</span><span class="n">SpcGp</span><span class="p">)</span>
                <span class="c"># try a lookup on the user-supplied name</span>
                <span class="k">if</span> <span class="n">SGErr</span><span class="p">:</span>
                    <span class="n">SpGrpNorm</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">StandardizeSpcName</span><span class="p">(</span><span class="n">SpcGp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">SpGrpNorm</span><span class="p">:</span>
                        <span class="n">E</span><span class="p">,</span><span class="n">SGData</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SpcGroup</span><span class="p">(</span><span class="n">SpGrpNorm</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">E</span><span class="p">:</span> <span class="n">SGErr</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">SGErr</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">G2spc</span><span class="o">.</span><span class="n">SGErrors</span><span class="p">(</span><span class="n">SGErr</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Space Group set to previous&#39;</span><span class="p">]</span>
                    <span class="n">SGTxt</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SpGrp&#39;</span><span class="p">])</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Space Group Error&#39;</span>
                    <span class="n">Style</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ICON_EXCLAMATION</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SGPrint</span><span class="p">(</span><span class="n">SGData</span><span class="p">)</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGData</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Space Group Information&#39;</span>
                    <span class="n">Style</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ICON_INFORMATION</span>
                <span class="n">Text</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">Text</span> <span class="o">+=</span> <span class="n">line</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">MessageBox</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span><span class="n">caption</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">Style</span><span class="p">)</span>
<span class="c">#                dataDisplay.DestroyChildren()           #needed to clear away bad cellSizer, etc.</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateGeneral</span><span class="p">)</span>
                
            <span class="n">nameSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">nameSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Phase name: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">NameTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">],</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">NameTxt</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnPhaseName</span><span class="p">)</span>
            <span class="n">NameTxt</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnPhaseName</span><span class="p">)</span>
            <span class="n">nameSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">NameTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">nameSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;  Phase type: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">TypeTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">phaseTypes</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">TypeTxt</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span> <span class="n">OnPhaseType</span><span class="p">)</span>
            <span class="n">nameSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">TypeTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">nameSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;  Space group: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">SGTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SpGrp&#39;</span><span class="p">],</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">SGTxt</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnSpaceGroup</span><span class="p">)</span>
            <span class="n">nameSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">SGTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nameSizer</span>
            
        <span class="k">def</span> <span class="nf">CellSizer</span><span class="p">():</span>
            
            <span class="n">cellGUIlist</span> <span class="o">=</span> <span class="p">[[[</span><span class="s">&#39;m3&#39;</span><span class="p">,</span><span class="s">&#39;m3m&#39;</span><span class="p">],</span><span class="mi">4</span><span class="p">,</span><span class="nb">zip</span><span class="p">([</span><span class="s">&quot; Unit cell: a = &quot;</span><span class="p">,</span><span class="s">&quot; Vol = &quot;</span><span class="p">],[</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">],[</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])],</span>
            <span class="p">[[</span><span class="s">&#39;3R&#39;</span><span class="p">,</span><span class="s">&#39;3mR&#39;</span><span class="p">],</span><span class="mi">6</span><span class="p">,</span><span class="nb">zip</span><span class="p">([</span><span class="s">&quot; a = &quot;</span><span class="p">,</span><span class="s">&quot; alpha = &quot;</span><span class="p">,</span><span class="s">&quot; Vol = &quot;</span><span class="p">],[</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">],[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])],</span>
            <span class="p">[[</span><span class="s">&#39;3&#39;</span><span class="p">,</span><span class="s">&#39;3m1&#39;</span><span class="p">,</span><span class="s">&#39;31m&#39;</span><span class="p">,</span><span class="s">&#39;6/m&#39;</span><span class="p">,</span><span class="s">&#39;6/mmm&#39;</span><span class="p">,</span><span class="s">&#39;4/m&#39;</span><span class="p">,</span><span class="s">&#39;4/mmm&#39;</span><span class="p">],</span><span class="mi">6</span><span class="p">,</span><span class="nb">zip</span><span class="p">([</span><span class="s">&quot; a = &quot;</span><span class="p">,</span><span class="s">&quot; c = &quot;</span><span class="p">,</span><span class="s">&quot; Vol = &quot;</span><span class="p">],[</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">],[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])],</span>
            <span class="p">[[</span><span class="s">&#39;mmm&#39;</span><span class="p">],</span><span class="mi">8</span><span class="p">,</span><span class="nb">zip</span><span class="p">([</span><span class="s">&quot; a = &quot;</span><span class="p">,</span><span class="s">&quot; b = &quot;</span><span class="p">,</span><span class="s">&quot; c = &quot;</span><span class="p">,</span><span class="s">&quot; Vol = &quot;</span><span class="p">],[</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])],</span>
            <span class="p">[[</span><span class="s">&#39;2/m&#39;</span><span class="o">+</span><span class="s">&#39;a&#39;</span><span class="p">],</span><span class="mi">10</span><span class="p">,</span><span class="nb">zip</span><span class="p">([</span><span class="s">&quot; a = &quot;</span><span class="p">,</span><span class="s">&quot; b = &quot;</span><span class="p">,</span><span class="s">&quot; c = &quot;</span><span class="p">,</span><span class="s">&quot; alpha = &quot;</span><span class="p">,</span><span class="s">&quot; Vol = &quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">],[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">])],</span>
            <span class="p">[[</span><span class="s">&#39;2/m&#39;</span><span class="o">+</span><span class="s">&#39;b&#39;</span><span class="p">],</span><span class="mi">10</span><span class="p">,</span><span class="nb">zip</span><span class="p">([</span><span class="s">&quot; a = &quot;</span><span class="p">,</span><span class="s">&quot; b = &quot;</span><span class="p">,</span><span class="s">&quot; c = &quot;</span><span class="p">,</span><span class="s">&quot; beta = &quot;</span><span class="p">,</span><span class="s">&quot; Vol = &quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">],[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">])],</span>
            <span class="p">[[</span><span class="s">&#39;2/m&#39;</span><span class="o">+</span><span class="s">&#39;c&#39;</span><span class="p">],</span><span class="mi">10</span><span class="p">,</span><span class="nb">zip</span><span class="p">([</span><span class="s">&quot; a = &quot;</span><span class="p">,</span><span class="s">&quot; b = &quot;</span><span class="p">,</span><span class="s">&quot; c = &quot;</span><span class="p">,</span><span class="s">&quot; gamma = &quot;</span><span class="p">,</span><span class="s">&quot; Vol = &quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">],[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">])],</span>
            <span class="p">[[</span><span class="s">&#39;-1&#39;</span><span class="p">],</span><span class="mi">8</span><span class="p">,</span><span class="nb">zip</span><span class="p">([</span><span class="s">&quot; a = &quot;</span><span class="p">,</span><span class="s">&quot; b = &quot;</span><span class="p">,</span><span class="s">&quot; c = &quot;</span><span class="p">,</span><span class="s">&quot; Vol = &quot;</span><span class="p">,</span><span class="s">&quot; alpha = &quot;</span><span class="p">,</span><span class="s">&quot; beta = &quot;</span><span class="p">,</span><span class="s">&quot; gamma = &quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">])]]</span>
                
            <span class="k">def</span> <span class="nf">OnCellRef</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cellRef</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                
            <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
                <span class="n">laue</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">laue</span> <span class="o">==</span> <span class="s">&#39;2/m&#39;</span><span class="p">:</span>
                    <span class="n">laue</span> <span class="o">+=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGUniq&#39;</span><span class="p">]</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">ObjId</span> <span class="o">=</span> <span class="n">cellList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ObjId</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>               <span class="c">#bad cell edge - reset</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="mi">6</span><span class="o">+</span><span class="n">ObjId</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>                       <span class="c">#bad angle</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="mf">90.</span>
                <span class="k">if</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;m3&#39;</span><span class="p">,</span><span class="s">&#39;m3m&#39;</span><span class="p">]:</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.0</span>
                    <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;3R&#39;</span><span class="p">,</span><span class="s">&#39;3mR&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ObjId</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;3&#39;</span><span class="p">,</span><span class="s">&#39;3m1&#39;</span><span class="p">,</span><span class="s">&#39;31m&#39;</span><span class="p">,</span><span class="s">&#39;6/m&#39;</span><span class="p">,</span><span class="s">&#39;6/mmm&#39;</span><span class="p">,</span><span class="s">&#39;4/m&#39;</span><span class="p">,</span><span class="s">&#39;4/mmm&#39;</span><span class="p">]:</span>                    
                    <span class="n">cell</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">120.</span>
                    <span class="k">if</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;4/m&#39;</span><span class="p">,</span><span class="s">&#39;4/mmm&#39;</span><span class="p">]:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>
                    <span class="k">if</span> <span class="n">ObjId</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;mmm&#39;</span><span class="p">]:</span>
                    <span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>
                    <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;2/m&#39;</span><span class="o">+</span><span class="s">&#39;a&#39;</span><span class="p">]:</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>
                    <span class="k">if</span> <span class="n">ObjId</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;2/m&#39;</span><span class="o">+</span><span class="s">&#39;b&#39;</span><span class="p">]:</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>
                    <span class="k">if</span> <span class="n">ObjId</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                <span class="k">elif</span> <span class="n">laue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;2/m&#39;</span><span class="o">+</span><span class="s">&#39;c&#39;</span><span class="p">]:</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mf">90.</span>
                    <span class="k">if</span> <span class="n">ObjId</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cell</span><span class="p">[</span><span class="n">ObjId</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">if</span> <span class="n">ObjId</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.5f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ObjId</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">ObjId</span><span class="p">]))</span>                        
                <span class="n">cell</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">calc_V</span><span class="p">(</span><span class="n">G2lat</span><span class="o">.</span><span class="n">cell2A</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]))</span>
                <span class="n">volVal</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">7</span><span class="p">]))</span>
                <span class="n">density</span><span class="p">,</span><span class="n">mattCoeff</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getDensity</span><span class="p">(</span><span class="n">generalData</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">denSizer</span><span class="p">:</span>
                    <span class="n">denSizer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">density</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">denSizer</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">denSizer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mattCoeff</span><span class="p">))</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>
            
            <span class="n">cell</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span>
            <span class="n">laue</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">laue</span> <span class="o">==</span> <span class="s">&#39;2/m&#39;</span><span class="p">:</span>
                <span class="n">laue</span> <span class="o">+=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SGUniq&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cellGUI</span> <span class="ow">in</span> <span class="n">cellGUIlist</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">laue</span> <span class="ow">in</span> <span class="n">cellGUI</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">useGUI</span> <span class="o">=</span> <span class="n">cellGUI</span>
            <span class="n">cellSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">useGUI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">PWDR</span><span class="p">:</span>
                <span class="n">cellRef</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Refine unit cell:&#39;</span><span class="p">)</span>
                <span class="n">cellSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">cellRef</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">cellRef</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnCellRef</span><span class="p">)</span>
                <span class="n">cellRef</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cellList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">txt</span><span class="p">,</span><span class="n">fmt</span><span class="p">,</span><span class="n">ifEdit</span><span class="p">,</span><span class="n">Id</span> <span class="ow">in</span> <span class="n">useGUI</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">cellSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">txt</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ifEdit</span><span class="p">:</span>          <span class="c">#a,b,c,etc.</span>
                    <span class="n">cellVal</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="n">fmt</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="n">Id</span><span class="o">+</span><span class="mi">1</span><span class="p">])),</span>
                        <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                    <span class="n">cellVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnCellChange</span><span class="p">)</span>        
                    <span class="n">cellVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnCellChange</span><span class="p">)</span>
                    <span class="n">cellSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">cellVal</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                    <span class="n">cellList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cellVal</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>               <span class="c">#volume</span>
                    <span class="n">volVal</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="n">fmt</span><span class="o">%</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">7</span><span class="p">])),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                    <span class="n">volVal</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                    <span class="n">cellSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">volVal</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cellSizer</span>
            
        <span class="k">def</span> <span class="nf">ElemSizer</span><span class="p">():</span>
            
            <span class="k">def</span> <span class="nf">OnIsotope</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">isotope</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotope&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">isotope</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;AtomMass&#39;</span><span class="p">][</span><span class="n">indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotopes&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="n">isotope</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">density</span><span class="p">,</span><span class="n">mattCoeff</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getDensity</span><span class="p">(</span><span class="n">generalData</span><span class="p">)</span>
                <span class="n">denSizer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">density</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">denSizer</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">denSizer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mattCoeff</span><span class="p">))</span>
                
            <span class="n">elemSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Elements&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]:</span>
                <span class="n">typTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">elem</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                <span class="n">typTxt</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">typTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Isotope&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]:</span>
                <span class="n">choices</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotopes&#39;</span><span class="p">][</span><span class="n">elem</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">isoSel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Isotope&#39;</span><span class="p">][</span><span class="n">elem</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
                <span class="n">isoSel</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnIsotope</span><span class="p">)</span>
                <span class="n">Indx</span><span class="p">[</span><span class="n">isoSel</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">elem</span>
                <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">isoSel</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
            <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; No. per cell&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]:</span>
                <span class="n">numbTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;NoAtoms&#39;</span><span class="p">][</span><span class="n">elem</span><span class="p">]),</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                <span class="n">numbTxt</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">numbTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Atom weight&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">wt</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomMass&#39;</span><span class="p">]:</span>
                <span class="n">wtTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">wt</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                <span class="n">wtTxt</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wtTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Bond radii&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">]:</span>
                <span class="n">bondRadii</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">rad</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                <span class="n">bondRadii</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">bondRadii</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Angle radii&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AngleRadii&#39;</span><span class="p">]:</span>
                <span class="n">elemTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">rad</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                <span class="n">elemTxt</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">elemTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; van der Waals radii&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;vdWRadii&#39;</span><span class="p">]:</span>
                <span class="n">elemTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">rad</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                <span class="n">elemTxt</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">elemTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Default color&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Color&#39;</span><span class="p">]:</span>
                <span class="n">colorTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                <span class="n">colorTxt</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span><span class="p">))</span>
                <span class="n">elemSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">colorTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">elemSizer</span>
        
        <span class="k">def</span> <span class="nf">DenSizer</span><span class="p">():</span>
            
            <span class="n">mass</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getMass</span><span class="p">(</span><span class="n">generalData</span><span class="p">)</span>
            <span class="n">density</span><span class="p">,</span><span class="n">mattCoeff</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getDensity</span><span class="p">(</span><span class="n">generalData</span><span class="p">)</span>
            <span class="n">denSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">denSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Density: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">denTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">density</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
            <span class="n">denTxt</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
            <span class="n">denSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">denTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mattTxt</span> <span class="o">=</span> <span class="bp">None</span>        
            <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span> <span class="ow">and</span> <span class="n">mass</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">denSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Matthews coeff.: &#39;</span><span class="p">),</span>
                    <span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">mattTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mattCoeff</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
                <span class="n">mattTxt</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="n">denSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">mattTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">denSizer</span><span class="p">,</span><span class="n">denTxt</span><span class="p">,</span><span class="n">mattTxt</span>
            
        <span class="k">def</span> <span class="nf">PawleySizer</span><span class="p">():</span>
            
            <span class="k">def</span> <span class="nf">OnPawleyRef</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;doPawley&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pawlRef</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            
            <span class="k">def</span> <span class="nf">OnPawleyVal</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pawlVal</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">dmin</span> <span class="o">&lt;=</span> <span class="mf">20.</span><span class="p">:</span>
                        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley dmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dmin</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">pawlVal</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley dmin&#39;</span><span class="p">]))</span>          <span class="c">#reset in case of error                </span>
            
            <span class="k">def</span> <span class="nf">OnPawleyNegWt</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pawlNegWt</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="mf">0.</span> <span class="o">&lt;=</span> <span class="n">wt</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">:</span>
                        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley neg wt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wt</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">pawlNegWt</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley neg wt&#39;</span><span class="p">]))</span>          <span class="c">#reset in case of error                </span>

            <span class="n">pawleySizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">pawleySizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Pawley controls: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">pawlRef</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Do Pawley refinement?&#39;</span><span class="p">)</span>
            <span class="n">pawlRef</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;doPawley&#39;</span><span class="p">])</span>
            <span class="n">pawlRef</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span><span class="n">OnPawleyRef</span><span class="p">)</span>
            <span class="n">pawleySizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pawlRef</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">pawleySizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Pawley dmin: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">pawlVal</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley dmin&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">pawlVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnPawleyVal</span><span class="p">)</span>        
            <span class="n">pawlVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnPawleyVal</span><span class="p">)</span>
            <span class="n">pawleySizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pawlVal</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">pawleySizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Pawley neg. wt.: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">pawlNegWt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley neg wt&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">pawlNegWt</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnPawleyNegWt</span><span class="p">)</span>        
            <span class="n">pawlNegWt</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnPawleyNegWt</span><span class="p">)</span>
            <span class="n">pawleySizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pawlNegWt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pawleySizer</span>
            
        <span class="k">def</span> <span class="nf">MapSizer</span><span class="p">():</span>
            
            <span class="k">def</span> <span class="nf">OnMapType</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Map</span><span class="p">[</span><span class="s">&#39;MapType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapType</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                
            <span class="k">def</span> <span class="nf">OnRefList</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Map</span><span class="p">[</span><span class="s">&#39;RefList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refList</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                
            <span class="k">def</span> <span class="nf">OnResVal</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mapRes</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mf">20.</span><span class="p">:</span>
                        <span class="n">Map</span><span class="p">[</span><span class="s">&#39;Resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">mapRes</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">Map</span><span class="p">[</span><span class="s">&#39;Resolution&#39;</span><span class="p">]))</span>          <span class="c">#reset in case of error</span>
            
            <span class="k">def</span> <span class="nf">OnCutOff</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cutOff</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="mf">10.0</span> <span class="o">&lt;=</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mf">100.</span><span class="p">:</span>
                        <span class="n">Map</span><span class="p">[</span><span class="s">&#39;cutOff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">cutOff</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.1f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">Map</span><span class="p">[</span><span class="s">&#39;cutOff&#39;</span><span class="p">]))</span>          <span class="c">#reset in case of error</span>
            
            <span class="c">#patch</span>
            <span class="k">if</span> <span class="s">&#39;cutOff&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Map</span><span class="p">:</span>
                <span class="n">Map</span><span class="p">[</span><span class="s">&#39;cutOff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">100.0</span>
            <span class="n">mapTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Fobs&#39;</span><span class="p">,</span><span class="s">&#39;Fcalc&#39;</span><span class="p">,</span><span class="s">&#39;delt-F&#39;</span><span class="p">,</span><span class="s">&#39;2*Fo-Fc&#39;</span><span class="p">,</span><span class="s">&#39;Omit&#39;</span><span class="p">,</span><span class="s">&#39;Patterson&#39;</span><span class="p">]</span>
            <span class="n">refList</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]:</span>
                 <span class="n">mapTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Patterson&#39;</span><span class="p">,]</span>
                 <span class="n">Map</span><span class="p">[</span><span class="s">&#39;MapType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Patterson&#39;</span>
            <span class="n">mapSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">lineSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Fourier map controls: Map type: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mapType</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">Map</span><span class="p">[</span><span class="s">&#39;MapType&#39;</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">mapTypes</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">mapType</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnMapType</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">mapType</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Reflection set from: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">refList</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">Map</span><span class="p">[</span><span class="s">&#39;RefList&#39;</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">refList</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">refList</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnRefList</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mapSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">lineSizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">line2Sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Resolution: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mapRes</span> <span class="o">=</span>  <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Map</span><span class="p">[</span><span class="s">&#39;Resolution&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">mapRes</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnResVal</span><span class="p">)</span>        
            <span class="n">mapRes</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnResVal</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">mapRes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Peak cutoff %: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">cutOff</span> <span class="o">=</span>  <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Map</span><span class="p">[</span><span class="s">&#39;cutOff&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">cutOff</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnCutOff</span><span class="p">)</span>        
            <span class="n">cutOff</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnCutOff</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">cutOff</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mapSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">line2Sizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mapSizer</span>
                
        <span class="k">def</span> <span class="nf">FlipSizer</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;k-Max&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Flip</span><span class="p">:</span> <span class="n">Flip</span><span class="p">[</span><span class="s">&#39;k-Max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">20.</span>
            
            <span class="k">def</span> <span class="nf">OnRefList</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Flip</span><span class="p">[</span><span class="s">&#39;RefList&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refList</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                
            <span class="k">def</span> <span class="nf">OnNormElem</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">PE</span> <span class="o">=</span> <span class="n">G2elemGUI</span><span class="o">.</span><span class="n">PickElement</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">ifNone</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">PE</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">Flip</span><span class="p">[</span><span class="s">&#39;Norm element&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PE</span><span class="o">.</span><span class="n">Elem</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">normElem</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;Norm element&#39;</span><span class="p">])</span>
                <span class="n">PE</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>                
                
            <span class="k">def</span> <span class="nf">OnResVal</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">flipRes</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="mf">0.25</span> <span class="o">&lt;=</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mf">20.</span><span class="p">:</span>
                        <span class="n">Flip</span><span class="p">[</span><span class="s">&#39;Resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">flipRes</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;Resolution&#39;</span><span class="p">]))</span>          <span class="c">#reset in case of error</span>
            
            <span class="k">def</span> <span class="nf">OnkFactor</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kFactor</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="mf">0.1</span> <span class="o">&lt;=</span> <span class="n">res</span> <span class="o">&lt;=</span> <span class="mf">1.2</span><span class="p">:</span>
                        <span class="n">Flip</span><span class="p">[</span><span class="s">&#39;k-factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">kFactor</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;k-factor&#39;</span><span class="p">]))</span>          <span class="c">#reset in case of error</span>
            
            <span class="k">def</span> <span class="nf">OnkMax</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kMax</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mf">10.</span><span class="p">:</span>
                        <span class="n">Flip</span><span class="p">[</span><span class="s">&#39;k-Max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">kMax</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.1f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;k-Max&#39;</span><span class="p">]))</span>          <span class="c">#reset in case of error</span>

            <span class="n">refList</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">flipSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">lineSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Charge flip controls: Reflection set from: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">refList</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;RefList&#39;</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">refList</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">refList</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnRefList</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Normalizing element: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">normElem</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;Norm element&#39;</span><span class="p">],</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_READONLY</span><span class="p">)</span>
            <span class="n">normElem</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="n">OnNormElem</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">normElem</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">flipSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">lineSizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">line2Sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Resolution: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">flipRes</span> <span class="o">=</span>  <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;Resolution&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">flipRes</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnResVal</span><span class="p">)</span>        
            <span class="n">flipRes</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnResVal</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">flipRes</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; k-Factor (0.1-1.2): &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">kFactor</span> <span class="o">=</span>  <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;k-factor&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">kFactor</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnkFactor</span><span class="p">)</span>        
            <span class="n">kFactor</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnkFactor</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">kFactor</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; k-Max (&gt;=10.0): &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">kMax</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Flip</span><span class="p">[</span><span class="s">&#39;k-Max&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">kMax</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnkMax</span><span class="p">)</span>        
            <span class="n">kMax</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnkMax</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">kMax</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">flipSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">line2Sizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flipSizer</span>
            
        <span class="k">def</span> <span class="nf">MCSASizer</span><span class="p">():</span>
            <span class="n">Ind</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="k">def</span> <span class="nf">OnRefList</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Data source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refList</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            
            <span class="k">def</span> <span class="nf">OnDmin</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dmin</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="mf">1.0</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>
                        <span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;dmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">dmin</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;dmin&#39;</span><span class="p">]))</span>          <span class="c">#reset in case of error</span>
            
            <span class="k">def</span> <span class="nf">OnAlist</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Algolrithm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Alist</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">if</span> <span class="s">&#39;Tremayne&#39;</span> <span class="ow">in</span> <span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Algolrithm&#39;</span><span class="p">]:</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateGeneral</span><span class="p">)</span>
            
            <span class="k">def</span> <span class="nf">OnAjump</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="o">.</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Jump coeff&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Jump coeff&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]))</span>          <span class="c">#reset in case of error</span>
            
            <span class="k">def</span> <span class="nf">OnAnneal</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">ind</span><span class="p">,</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                        <span class="k">if</span> <span class="o">.</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">val</span><span class="p">:</span>
                            <span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Annealing&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">val</span><span class="p">:</span>
                            <span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Annealing&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                    
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">fmt</span><span class="o">%</span><span class="p">(</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Annealing&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]))</span>          <span class="c">#reset in case of error</span>
                       
            <span class="n">refList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Pawley ref&#39;</span><span class="p">]):</span>
                <span class="n">refList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Pawley reflections&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="s">&#39;HKLF&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">refList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">mcsaSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">lineSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Monte Carlo/Simulated Annealing controls: Reflection set from: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">refList</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Data source&#39;</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">refList</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">refList</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnRefList</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">refList</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; d-min: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;dmin&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">dmin</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnDmin</span><span class="p">)</span>        
            <span class="n">dmin</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnDmin</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mcsaSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">lineSizer</span><span class="p">)</span>
            <span class="n">mcsaSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),)</span>
            <span class="n">line2Sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">Achoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Normal&#39;</span><span class="p">,</span><span class="s">&#39;Random jump&#39;</span><span class="p">,</span><span class="s">&#39;Tremayne jump&#39;</span><span class="p">]</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; MC/SA algorithm: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">Alist</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Algolrithm&#39;</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">Achoice</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">Alist</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnAlist</span><span class="p">)</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Alist</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;Tremayne&#39;</span> <span class="ow">in</span> <span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Algolrithm&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">&#39; A-jump: &#39;</span><span class="p">,</span><span class="s">&#39; B-jump: &#39;</span><span class="p">]):</span>
                    <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                    <span class="n">Ajump</span> <span class="o">=</span>  <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Jump coeff&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                    <span class="n">Ajump</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnAjump</span><span class="p">)</span>        
                    <span class="n">Ajump</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnAjump</span><span class="p">)</span>
                    <span class="n">Indx</span><span class="p">[</span><span class="n">Ajump</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Ajump</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mcsaSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">line2Sizer</span><span class="p">)</span>
            <span class="n">mcsaSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),)</span>
            <span class="n">line3Sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">line3Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Annealing schedule: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; Start temp: &#39;</span><span class="p">,</span><span class="s">&#39; Final temp: &#39;</span><span class="p">,</span><span class="s">&#39; Slope: &#39;</span><span class="p">,</span><span class="s">&#39; No. trials: &#39;</span><span class="p">]</span>
            <span class="n">fmts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%.1f</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">name</span><span class="p">,</span><span class="n">fmt</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">fmts</span><span class="p">)):</span>
                <span class="n">line3Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">anneal</span> <span class="o">=</span>  <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">fmt</span><span class="o">%</span><span class="p">(</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;Annealing&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                <span class="n">anneal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnAnneal</span><span class="p">)</span>        
                <span class="n">anneal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnAnneal</span><span class="p">)</span>
                <span class="n">Indx</span><span class="p">[</span><span class="n">anneal</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">fmt</span><span class="p">]</span>
                <span class="n">line3Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">anneal</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mcsaSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">line3Sizer</span><span class="p">)</span>            
            <span class="k">return</span> <span class="n">mcsaSizer</span>

        <span class="c"># UpdateGeneral execution starts here</span>
        <span class="n">General</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">General</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">NameSizer</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>        
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">CellSizer</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">Indx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">denSizer</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]):</span>
            <span class="n">denSizer</span> <span class="o">=</span> <span class="n">DenSizer</span><span class="p">()</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">denSizer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>            
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ElemSizer</span><span class="p">())</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">,</span><span class="n">dataDisplay</span><span class="p">)</span>

        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">PawleySizer</span><span class="p">())</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">,</span><span class="n">dataDisplay</span><span class="p">)</span>
        
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">MapSizer</span><span class="p">())</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">,</span><span class="n">dataDisplay</span><span class="p">)</span>

        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">FlipSizer</span><span class="p">())</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">,</span><span class="n">dataDisplay</span><span class="p">)</span>

        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">MCSASizer</span><span class="p">())</span>

        <span class="n">dataDisplay</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">PhaseUserSize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">ComputeFittingWindowSize</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>  <span class="c"># get size needed by window</span>
            <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">35</span>                           <span class="c">#compensate for status bar</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">dataDisplay</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">GetClientSize</span><span class="p">())</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="c">################################################################################</span>
<span class="c">#####  Atom routines</span>
<span class="c">################################################################################</span>

    <span class="k">def</span> <span class="nf">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Display the contents of the Atoms tab</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">RefreshAtomGrid</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>

            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>                    
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>                          <span class="c">#double click on col label! Change all atoms!</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">noSkip</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;refine&#39;</span><span class="p">:</span>
                    <span class="n">Type</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;nuclear&#39;</span><span class="p">,</span><span class="s">&#39;macromolecular&#39;</span><span class="p">]:</span>
                        <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;F - site fraction&#39;</span><span class="p">,</span><span class="s">&#39;X - coordinates&#39;</span><span class="p">,</span><span class="s">&#39;U - thermal parameters&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;magnetic&#39;</span><span class="p">,]:</span>
                        <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;F - site fraction&#39;</span><span class="p">,</span><span class="s">&#39;X - coordinates&#39;</span><span class="p">,</span><span class="s">&#39;U - thermal parameters&#39;</span><span class="p">,</span><span class="s">&#39;M - magnetic moment&#39;</span><span class="p">]</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Refinement controls&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
                        <span class="n">parms</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                            <span class="n">parms</span> <span class="o">+=</span> <span class="n">choice</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;I/A&#39;</span><span class="p">:</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Isotropic&#39;</span><span class="p">,</span><span class="s">&#39;Anisotropic&#39;</span><span class="p">]</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Thermal Motion&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                        <span class="n">parms</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Type&#39;</span><span class="p">:</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Atom types&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                        <span class="n">parms</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                        <span class="n">noSkip</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">parms</span> <span class="o">==</span> <span class="n">atomData</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">c</span><span class="p">]:</span>
                                <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                    <span class="n">SetupGeneral</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;residue&#39;</span><span class="p">:</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">:</span>
                            <span class="n">choice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
                    <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                        <span class="n">parms</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                        <span class="n">noSkip</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">parms</span> <span class="o">==</span> <span class="n">atomData</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">c</span><span class="p">]:</span>
                                <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;res no&#39;</span><span class="p">:</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">:</span>
                            <span class="n">choice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Residue no.&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                        <span class="n">parms</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                        <span class="n">noSkip</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">parms</span><span class="p">)</span> <span class="o">==</span> <span class="n">atomData</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">c</span><span class="p">]:</span>
                                <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;chain&#39;</span><span class="p">:</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">:</span>
                            <span class="n">choice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">])</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Chain&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                        <span class="n">parms</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                        <span class="n">noSkip</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                            <span class="k">if</span> <span class="n">parms</span> <span class="o">==</span> <span class="n">atomData</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">c</span><span class="p">]:</span>
                                <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Uiso&#39;</span><span class="p">:</span>       <span class="c">#this needs to ask for value</span>
                    <span class="k">pass</span>                                        <span class="c">#&amp; then change all &#39;I&#39; atoms</span>
                <span class="k">if</span> <span class="n">sel</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">noSkip</span><span class="p">:</span>
                    <span class="n">ui</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;U11&#39;</span><span class="p">)</span>
                    <span class="n">us</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Uiso&#39;</span><span class="p">)</span>
                    <span class="n">ss</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;site sym&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                        <span class="n">ID</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">parms</span> <span class="o">!=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="ow">and</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;I/A&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">parms</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>                <span class="c">#&#39;I&#39; --&gt; &#39;A&#39;</span>
                                <span class="n">Uiso</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetCellValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">us</span><span class="p">))</span>
                                <span class="n">sytsym</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ss</span><span class="p">]</span>
                                <span class="n">CSI</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GetCSuinel</span><span class="p">(</span><span class="n">sytsym</span><span class="p">)</span>
                                <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ui</span><span class="p">:</span><span class="n">ui</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uiso</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">CSI</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                                <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">us</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                                <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">us</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                                    <span class="n">ci</span> <span class="o">=</span> <span class="n">ui</span><span class="o">+</span><span class="n">i</span>
                                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">CSI</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">WHITE</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>                           <span class="c">#&#39;A&#39; --&gt; &#39;I&#39;</span>
                                <span class="n">Uij</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ui</span><span class="p">:</span><span class="n">ui</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
                                <span class="n">Uiso</span> <span class="o">=</span> <span class="p">(</span><span class="n">Uij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">Uij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Uij</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mf">3.0</span>
                                <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">us</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uiso</span>
                                <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">us</span><span class="p">,</span><span class="n">WHITE</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                                    <span class="n">ci</span> <span class="o">=</span> <span class="n">ui</span><span class="o">+</span><span class="n">i</span>
                                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">IsReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;refine&#39;</span><span class="p">:</span>
                                <span class="n">rbExcl</span> <span class="o">=</span> <span class="n">rbAtmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">rbExcl</span><span class="p">:</span>
                                    <span class="k">for</span> <span class="n">excl</span> <span class="ow">in</span> <span class="n">rbExcl</span><span class="p">:</span>
                                        <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">excl</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span>
                            <span class="k">else</span><span class="p">:</span> 
                                <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span>
                        <span class="k">if</span> <span class="s">&#39;Atoms&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>
                            <span class="n">DrawAtomsReplaceByID</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">],</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">],</span><span class="n">ID</span><span class="p">)</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">Paint</span><span class="p">)</span>
                    
        <span class="k">def</span> <span class="nf">ChangeAtomCell</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            
            <span class="k">def</span> <span class="nf">chkUij</span><span class="p">(</span><span class="n">Uij</span><span class="p">,</span><span class="n">CSI</span><span class="p">):</span> <span class="c">#needs to do something!!!</span>
                <span class="k">return</span> <span class="n">Uij</span>

            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ID</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">]:</span>
                    <span class="n">ci</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
                    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ci</span><span class="p">:</span><span class="n">ci</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">None</span> <span class="ow">in</span> <span class="n">XYZ</span><span class="p">:</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">SScol</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;site sym&#39;</span><span class="p">)</span>
                    <span class="n">Mulcol</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;mult&#39;</span><span class="p">)</span>
                    <span class="n">E</span><span class="p">,</span><span class="n">SGData</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SpcGroup</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SpGrp&#39;</span><span class="p">])</span>
                    <span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SytSym</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">SScol</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sytsym</span>
                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">Mulcol</span><span class="p">]</span> <span class="o">=</span> <span class="n">Mult</span>
                    <span class="k">if</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;I/A&#39;</span><span class="p">)]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                        <span class="n">ui</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;U11&#39;</span><span class="p">)</span>
                        <span class="n">CSI</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GetCSuinel</span><span class="p">(</span><span class="n">Sytsym</span><span class="p">)</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ui</span><span class="p">:</span><span class="n">ui</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">chkUij</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ui</span><span class="p">:</span><span class="n">ui</span><span class="o">+</span><span class="mi">6</span><span class="p">],</span><span class="n">Sytsym</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                            <span class="n">ci</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">ui</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">CSI</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                                <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">WHITE</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">SetupGeneral</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;I/A&#39;</span><span class="p">:</span>            <span class="c">#note use of text color to make it vanish!</span>
                    <span class="k">if</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;I&#39;</span><span class="p">:</span>
                        <span class="n">Uij</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">c</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Uij</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">Uij</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Uij</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mf">3.0</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">WHITE</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">BLACK</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                            <span class="n">ci</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;U11&#39;</span><span class="p">)</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">CSI</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GetCSuinel</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;site sym&#39;</span><span class="p">)])</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="mf">0.0</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                            <span class="n">ci</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;U11&#39;</span><span class="p">)</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">*</span><span class="n">CSI</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">BLACK</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">CSI</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                                <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">WHITE</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;U11&#39;</span><span class="p">,</span><span class="s">&#39;U22&#39;</span><span class="p">,</span><span class="s">&#39;U33&#39;</span><span class="p">,</span><span class="s">&#39;U12&#39;</span><span class="p">,</span><span class="s">&#39;U13&#39;</span><span class="p">,</span><span class="s">&#39;U23&#39;</span><span class="p">]:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                    <span class="n">CSI</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GetCSuinel</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;site sym&#39;</span><span class="p">)])</span>
                    <span class="n">iUij</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">c</span><span class="o">-</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;U11&#39;</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">iUij</span> <span class="o">==</span> <span class="n">CSI</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;U11&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span><span class="o">*</span><span class="n">CSI</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;refine&#39;</span><span class="p">:</span>
                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">rbAtmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;&#39;</span><span class="p">),</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;Atoms&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>
                    <span class="n">DrawAtomsReplaceByID</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">],</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">],</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">Paint</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">AtomTypeSelect</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Type&#39;</span><span class="p">:</span>
                <span class="n">PE</span> <span class="o">=</span> <span class="n">G2elemGUI</span><span class="o">.</span><span class="n">PickElement</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">PE</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">PE</span><span class="o">.</span><span class="n">Elem</span> <span class="o">!=</span> <span class="s">&#39;None&#39;</span><span class="p">:</span>                        
                        <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">PE</span><span class="o">.</span><span class="n">Elem</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;(</span><span class="si">%d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;(</span><span class="si">%d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">PE</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="n">SetupGeneral</span><span class="p">()</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">Paint</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetCellValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">ID</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;Atoms&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>
                    <span class="n">DrawAtomsReplaceByID</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">],</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">],</span><span class="n">ID</span><span class="p">)</span>
                <span class="n">SetupGeneral</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">RowSelect</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">AltDown</span><span class="p">():</span>
                <span class="n">Atoms</span><span class="o">.</span><span class="n">frm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>                    
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">IsSelection</span><span class="p">():</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>                   <span class="c">#only row clicks</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ControlDown</span><span class="p">():</span>                    
                    <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">():</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">DeselectRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">ShiftDown</span><span class="p">():</span>
                    <span class="n">indxs</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                    <span class="n">ibeg</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">indxs</span><span class="p">:</span>
                        <span class="n">ibeg</span> <span class="o">=</span> <span class="n">indxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ibeg</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">AltDown</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rbAtmDict</span><span class="p">:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;**** ERROR - atom is in a rigid body and can not be moved ****&#39;</span><span class="p">)</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">frm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>    
                        <span class="k">if</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">frm</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>           <span class="c">#pick atom to be moved</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">frm</span> <span class="o">=</span> <span class="n">r</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                            <span class="n">n</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span>
                            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Atom &#39;</span><span class="o">+</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; is to be moved&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>                       <span class="c">#move it</span>
                            <span class="n">item</span> <span class="o">=</span> <span class="n">atomData</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">frm</span><span class="p">)</span>
                            <span class="n">atomData</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">frm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">Paint</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                
        <span class="k">def</span> <span class="nf">ChangeSelection</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">():</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">DeselectRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedCols</span><span class="p">():</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">DeselectCol</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SelectCol</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    
        <span class="k">def</span> <span class="nf">Paint</span><span class="p">():</span>
        
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomData</span><span class="p">):</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
                <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">atomTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Atoms</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">atomTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Atoms</span><span class="o">.</span><span class="n">frm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>            
            <span class="n">colType</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Type&#39;</span><span class="p">)</span>
            <span class="n">colR</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;refine&#39;</span><span class="p">)</span>
            <span class="n">colSS</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;site sym&#39;</span><span class="p">)</span>
            <span class="n">colX</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">colIA</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;I/A&#39;</span><span class="p">)</span>
            <span class="n">colU11</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;U11&#39;</span><span class="p">)</span>
            <span class="n">colUiso</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Uiso&#39;</span><span class="p">)</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">GridCellAttr</span><span class="p">()</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">IncRef</span><span class="p">()</span>               <span class="c">#fix from Jim Hester</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">SetEditor</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GridFractionEditor</span><span class="p">(</span><span class="n">Atoms</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colX</span><span class="p">,</span><span class="n">colX</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">Atoms</span><span class="o">.</span><span class="n">SetColAttr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">colU11</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">colU11</span><span class="o">+</span><span class="mi">6</span><span class="p">):</span>
                <span class="n">Atoms</span><span class="o">.</span><span class="n">SetColSize</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>            
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                <span class="n">atId</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">rbExcl</span> <span class="o">=</span> <span class="n">rbAtmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atId</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">Atoms</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colSS</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>                         <span class="c">#site sym</span>
                <span class="n">Atoms</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colSS</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>                       <span class="c">#Mult</span>
                <span class="k">if</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetCellValue</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colIA</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                    <span class="n">CSI</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GetCSuinel</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;site sym&#39;</span><span class="p">)])</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colUiso</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colUiso</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                        <span class="n">ci</span> <span class="o">=</span> <span class="n">colU11</span><span class="o">+</span><span class="n">i</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">BLACK</span><span class="p">)</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">CSI</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&#39;U&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rbExcl</span><span class="p">:</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">WHITE</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colUiso</span><span class="p">,</span><span class="n">WHITE</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colUiso</span><span class="p">,</span><span class="n">BLACK</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;U&#39;</span> <span class="ow">in</span> <span class="n">rbExcl</span><span class="p">:</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">colUiso</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                        <span class="n">ci</span> <span class="o">=</span> <span class="n">colU11</span><span class="o">+</span><span class="n">i</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">ci</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;X&#39;</span> <span class="ow">in</span> <span class="n">rbExcl</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">colX</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="n">colR</span><span class="p">:</span>
                            <span class="n">Atoms</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Atoms</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># FillAtomsGrid executable code starts here</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">DData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">resRBData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Residue&#39;</span><span class="p">,[])</span>
        <span class="n">vecRBData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Vector&#39;</span><span class="p">,[])</span>
        <span class="n">rbAtmDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">rbObj</span> <span class="ow">in</span> <span class="n">resRBData</span><span class="o">+</span><span class="n">vecRBData</span><span class="p">:</span>
            <span class="n">exclList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;X&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]))]</span>
            <span class="n">rbAtmDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">],</span><span class="n">exclList</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;None&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]:</span>
                    <span class="n">rbAtmDict</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;U&#39;</span>            
        <span class="c"># exclList will be &#39;x&#39; or &#39;xu&#39; if TLS used in RB</span>
        <span class="n">Items</span> <span class="o">=</span> <span class="p">[</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSEDITINSERT</span><span class="p">,</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSEDITDELETE</span><span class="p">,</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSREFINE</span><span class="p">,</span> 
            <span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSMODIFY</span><span class="p">,</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSTRANSFORM</span><span class="p">,</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMVIEWINSERT</span><span class="p">,</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMMOVE</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">atomData</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Items</span><span class="p">:</span>    
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">AtomsMenu</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Items</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">AtomsMenu</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">Items</span> <span class="o">=</span> <span class="p">[</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMVIEWINSERT</span><span class="p">,</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSVIEWADD</span><span class="p">,</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMMOVE</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;showABC&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Items</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">AtomsMenu</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">Items</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">AtomsMenu</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">AAchoice</span> <span class="o">=</span> <span class="s">&quot;: ,ALA,ARG,ASN,ASP,CYS,GLN,GLU,GLY,HIS,ILE,LEU,LYS,MET,PHE,PRO,SER,THR,TRP,TYR,VAL,MSE,HOH,UNK&quot;</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_CHOICE</span><span class="o">+</span><span class="s">&quot;: ,X,XU,U,F,FX,FXU,FU&quot;</span><span class="p">,]</span><span class="o">+</span> \
            <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,5&#39;</span><span class="p">,]</span><span class="o">+</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,4&#39;</span><span class="p">,</span> <span class="c">#x,y,z,frac</span>
            <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_CHOICE</span><span class="o">+</span><span class="s">&quot;:I,A&quot;</span><span class="p">,]</span>
        <span class="n">Types</span> <span class="o">+=</span> <span class="mi">7</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,5&#39;</span><span class="p">,]</span>
        <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;Type&#39;</span><span class="p">,</span><span class="s">&#39;refine&#39;</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="s">&#39;frac&#39;</span><span class="p">,</span><span class="s">&#39;site sym&#39;</span><span class="p">,</span><span class="s">&#39;mult&#39;</span><span class="p">,</span><span class="s">&#39;I/A&#39;</span><span class="p">,</span><span class="s">&#39;Uiso&#39;</span><span class="p">,</span><span class="s">&#39;U11&#39;</span><span class="p">,</span><span class="s">&#39;U22&#39;</span><span class="p">,</span><span class="s">&#39;U33&#39;</span><span class="p">,</span><span class="s">&#39;U12&#39;</span><span class="p">,</span><span class="s">&#39;U13&#39;</span><span class="p">,</span><span class="s">&#39;U23&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;magnetic&#39;</span><span class="p">:</span>
            <span class="n">colLabels</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;Mx&#39;</span><span class="p">,</span><span class="s">&#39;My&#39;</span><span class="p">,</span><span class="s">&#39;Mz&#39;</span><span class="p">]</span>
            <span class="n">Types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_CHOICE</span><span class="o">+</span><span class="s">&quot;: ,X,XU,U,M,MX,MXU,MU,F,FX,FXU,FU,FM,FMX,FMU,&quot;</span>
            <span class="n">Types</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,4&#39;</span><span class="p">,]</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;res no&#39;</span><span class="p">,</span><span class="s">&#39;residue&#39;</span><span class="p">,</span><span class="s">&#39;chain&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">colLabels</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span>
                <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_CHOICE</span><span class="o">+</span><span class="n">AAchoice</span><span class="p">,</span>
                <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">]</span> <span class="o">+</span> <span class="n">Types</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;modulated&#39;</span><span class="p">:</span>
            <span class="n">Types</span> <span class="o">+=</span> <span class="p">[]</span>
            <span class="n">colLabels</span> <span class="o">+=</span> <span class="p">[]</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGPolax&#39;</span><span class="p">]:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Warning: The location of the origin is arbitrary in &#39;</span><span class="o">+</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGPolax&#39;</span><span class="p">])</span>
        <span class="n">Atoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">ChangeAtomCell</span><span class="p">)</span>
        <span class="n">Atoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_LEFT_DCLICK</span><span class="p">,</span> <span class="n">AtomTypeSelect</span><span class="p">)</span>
        <span class="n">Atoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_DCLICK</span><span class="p">,</span> <span class="n">RefreshAtomGrid</span><span class="p">)</span>
        <span class="n">Atoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span> <span class="n">RowSelect</span><span class="p">)</span>
        <span class="n">Atoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_RIGHT_CLICK</span><span class="p">,</span> <span class="n">ChangeSelection</span><span class="p">)</span>
        <span class="n">Atoms</span><span class="o">.</span><span class="n">SetMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">PhaseUserSize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">([</span><span class="mi">700</span><span class="p">,</span><span class="mi">300</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">Paint</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnAtomAdd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">AtomAdd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">StopPropagation</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">OnAtomViewAdd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">drawData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">drawData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">AtomAdd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">AtomAdd</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">StopPropagation</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">AtomAdd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">El</span><span class="o">=</span><span class="s">&#39;H&#39;</span><span class="p">,</span><span class="n">Name</span><span class="o">=</span><span class="s">&#39;UNK&#39;</span><span class="p">):</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Ncol</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">()</span>
        <span class="n">atId</span> <span class="o">=</span> <span class="n">ran</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">)</span>
        <span class="n">E</span><span class="p">,</span><span class="n">SGData</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SpcGroup</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SpGrp&#39;</span><span class="p">])</span>
        <span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SytSym</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">],</span><span class="n">SGData</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
            <span class="n">atomData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">Name</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">Name</span><span class="p">,</span><span class="n">El</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="mf">0.10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">atId</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;nuclear&#39;</span><span class="p">:</span>
            <span class="n">atomData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Name</span><span class="p">,</span><span class="n">El</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">atId</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;magnetic&#39;</span><span class="p">:</span>
            <span class="n">atomData</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Name</span><span class="p">,</span><span class="n">El</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">atId</span><span class="p">])</span>
        <span class="n">SetupGeneral</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;Atoms&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>            
            <span class="n">DrawAtomAdd</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">],</span><span class="n">atomData</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnAtomInsert</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">AtomInsert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">StopPropagation</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">OnAtomViewInsert</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;Drawing&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">drawData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">drawData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">AtomAdd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
            <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">StopPropagation</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">OnRBAppend</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>          <span class="c">#unfinished!</span>
        <span class="n">rbData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>   
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Rigid bodies&#39;</span><span class="p">))</span>
        <span class="n">general</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">general</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">rbNames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">rbVec</span> <span class="ow">in</span> <span class="n">rbData</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rbVec</span> <span class="o">!=</span> <span class="s">&#39;AtInfo&#39;</span><span class="p">:</span>
                <span class="n">rbNames</span><span class="p">[</span><span class="n">rbData</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">][</span><span class="n">rbVec</span><span class="p">][</span><span class="s">&#39;RBname&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">,</span><span class="n">rbVec</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rbRes</span> <span class="ow">in</span> <span class="n">rbData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rbRes</span> <span class="o">!=</span> <span class="s">&#39;AtInfo&#39;</span><span class="p">:</span>
                <span class="n">rbNames</span><span class="p">[</span><span class="n">rbData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="n">rbRes</span><span class="p">][</span><span class="s">&#39;RBname&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">,</span><span class="n">rbRes</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rbNames</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - no rigid bodies defined ****&#39;</span>
            <span class="k">return</span>
        
    <span class="k">def</span> <span class="nf">OnAtomMove</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">drawData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">drawData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - only one atom can be moved ****&#39;</span>
        <span class="k">elif</span> <span class="n">atomData</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rbAtmDict</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - Atoms in rigid bodies can not be moved ****&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atomData</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span>
            <span class="n">SetupGeneral</span><span class="p">()</span>
            <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
            <span class="n">ID</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">DrawAtomsReplaceByID</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">],</span><span class="n">atomData</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">ID</span><span class="p">)</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">StopPropagation</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">DrawAtomsReplaceByID</span><span class="p">(</span><span class="n">drawingData</span><span class="p">,</span><span class="n">atom</span><span class="p">,</span><span class="n">ID</span><span class="p">):</span>
        <span class="n">IDs</span> <span class="o">=</span> <span class="p">[</span><span class="n">ID</span><span class="p">,]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FindAtomIndexByIDs</span><span class="p">(</span><span class="n">atomData</span><span class="p">,</span><span class="n">IDs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">MakeDrawAtom</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span><span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">MakeDrawAtom</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span><span class="n">oldatom</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">AA3letter</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ALA&#39;</span><span class="p">,</span><span class="s">&#39;ARG&#39;</span><span class="p">,</span><span class="s">&#39;ASN&#39;</span><span class="p">,</span><span class="s">&#39;ASP&#39;</span><span class="p">,</span><span class="s">&#39;CYS&#39;</span><span class="p">,</span><span class="s">&#39;GLN&#39;</span><span class="p">,</span><span class="s">&#39;GLU&#39;</span><span class="p">,</span><span class="s">&#39;GLY&#39;</span><span class="p">,</span><span class="s">&#39;HIS&#39;</span><span class="p">,</span><span class="s">&#39;ILE&#39;</span><span class="p">,</span>
            <span class="s">&#39;LEU&#39;</span><span class="p">,</span><span class="s">&#39;LYS&#39;</span><span class="p">,</span><span class="s">&#39;MET&#39;</span><span class="p">,</span><span class="s">&#39;PHE&#39;</span><span class="p">,</span><span class="s">&#39;PRO&#39;</span><span class="p">,</span><span class="s">&#39;SER&#39;</span><span class="p">,</span><span class="s">&#39;THR&#39;</span><span class="p">,</span><span class="s">&#39;TRP&#39;</span><span class="p">,</span><span class="s">&#39;TYR&#39;</span><span class="p">,</span><span class="s">&#39;VAL&#39;</span><span class="p">,</span><span class="s">&#39;MSE&#39;</span><span class="p">,</span><span class="s">&#39;HOH&#39;</span><span class="p">,</span><span class="s">&#39;WAT&#39;</span><span class="p">,</span><span class="s">&#39;UNK&#39;</span><span class="p">]</span>
        <span class="n">AA1letter</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;D&#39;</span><span class="p">,</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;Q&#39;</span><span class="p">,</span><span class="s">&#39;E&#39;</span><span class="p">,</span><span class="s">&#39;G&#39;</span><span class="p">,</span><span class="s">&#39;H&#39;</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span>
            <span class="s">&#39;L&#39;</span><span class="p">,</span><span class="s">&#39;K&#39;</span><span class="p">,</span><span class="s">&#39;M&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">,</span><span class="s">&#39;P&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;W&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;V&#39;</span><span class="p">,</span><span class="s">&#39;M&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">]</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;nuclear&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oldatom</span><span class="p">:</span>
                <span class="n">opr</span> <span class="o">=</span> <span class="n">oldatom</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>                    
                    <span class="n">X</span><span class="p">,</span><span class="n">U</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">ApplyStringOps</span><span class="p">(</span><span class="n">opr</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span><span class="n">atom</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">17</span><span class="p">])</span>
                    <span class="n">atomInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">+</span><span class="n">oldatom</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">U</span><span class="p">)</span><span class="o">+</span><span class="n">oldatom</span><span class="p">[</span><span class="mi">17</span><span class="p">:]][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">ApplyStringOps</span><span class="p">(</span><span class="n">opr</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
                    <span class="n">atomInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">+</span><span class="n">oldatom</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span><span class="o">+</span><span class="n">oldatom</span><span class="p">[</span><span class="mi">17</span><span class="p">:]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atomInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;1&#39;</span><span class="p">,]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;vdW balls&#39;</span><span class="p">,]</span><span class="o">+</span>
                    <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,]</span><span class="o">+</span><span class="p">[[</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">],]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span><span class="o">+</span><span class="p">[[],[]]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ct</span><span class="p">,</span><span class="n">cs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>         <span class="c">#type &amp; color</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">oneLetter</span> <span class="o">=</span> <span class="n">AA3letter</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">oneLetter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">atomInfo</span> <span class="o">=</span> <span class="p">[[</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span><span class="o">+</span>
                <span class="p">[</span><span class="n">AA1letter</span><span class="p">[</span><span class="n">oneLetter</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">],]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span>
                <span class="n">atom</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;1&#39;</span><span class="p">,]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;sticks&#39;</span><span class="p">,]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,]</span><span class="o">+</span><span class="p">[[</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">],]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">12</span><span class="p">:]</span><span class="o">+</span><span class="p">[[],[]]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ct</span><span class="p">,</span><span class="n">cs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span>         <span class="c">#type &amp; color</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;magnetic&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">oldatom</span><span class="p">:</span>
                <span class="n">atomInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">oldatom</span><span class="p">[</span><span class="mi">3</span><span class="p">:]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atomInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;vdW balls&#39;</span><span class="p">,]</span><span class="o">+</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span><span class="o">+</span><span class="p">[[],[]]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ct</span><span class="p">,</span><span class="n">cs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>         <span class="c">#type &amp; color</span>
    <span class="c">#     elif generalData[&#39;Type&#39;] == &#39;modulated&#39;:</span>
    <span class="c">#        ?????   for future</span>
        <span class="n">atNum</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">])</span>
        <span class="n">atomInfo</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Color&#39;</span><span class="p">][</span><span class="n">atNum</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">atomInfo</span>
        
    <span class="k">def</span> <span class="nf">AtomInsert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">Ncol</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">()</span>
            <span class="n">E</span><span class="p">,</span><span class="n">SGData</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SpcGroup</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SpGrp&#39;</span><span class="p">])</span>
            <span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SytSym</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">SGData</span><span class="p">)</span>
            <span class="n">atId</span> <span class="o">=</span> <span class="n">ran</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
                <span class="n">atomData</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">indx</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;UNK&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;UNK&#39;</span><span class="p">,</span><span class="s">&#39;UNK&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="mf">0.10</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">atId</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;nuclear&#39;</span><span class="p">:</span>
                <span class="n">atomData</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">indx</span><span class="p">,[</span><span class="s">&#39;UNK&#39;</span><span class="p">,</span><span class="s">&#39;UNK&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">atId</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;magnetic&#39;</span><span class="p">:</span>
                <span class="n">atomData</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">indx</span><span class="p">,[</span><span class="s">&#39;UNK&#39;</span><span class="p">,</span><span class="s">&#39;UNK&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">Sytsym</span><span class="p">,</span><span class="n">Mult</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">atId</span><span class="p">])</span>
            <span class="n">SetupGeneral</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">AtomDelete</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="n">IDs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">indx</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                <span class="n">atom</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rbAtmDict</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;**** ERROR - atom is in a rigid body and can not be deleted ****&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">IDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">del</span> <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;Atoms&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>
                <span class="n">DrawAtomsDeleteByIDs</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">FillAtomsGrid</span><span class="p">,</span><span class="n">Atoms</span><span class="p">)</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            <span class="n">SetupGeneral</span><span class="p">()</span>
        <span class="n">event</span><span class="o">.</span><span class="n">StopPropagation</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">AtomRefine</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;refine&#39;</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">Type</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;nuclear&#39;</span><span class="p">,</span><span class="s">&#39;macromolecular&#39;</span><span class="p">]:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;F - site fraction&#39;</span><span class="p">,</span><span class="s">&#39;X - coordinates&#39;</span><span class="p">,</span><span class="s">&#39;U - thermal parameters&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">Type</span> <span class="o">==</span> <span class="s">&#39;magnetic&#39;</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;F - site fraction&#39;</span><span class="p">,</span><span class="s">&#39;X - coordinates&#39;</span><span class="p">,</span><span class="s">&#39;U - thermal parameters&#39;</span><span class="p">,</span><span class="s">&#39;M - magnetic moment&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Refinement controls&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
                <span class="n">parms</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                    <span class="n">parms</span> <span class="o">+=</span> <span class="n">choice</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">IsReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span>
                <span class="n">Atoms</span><span class="o">.</span><span class="n">ForceRefresh</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">AtomModify</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">,</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="s">&#39;frac&#39;</span><span class="p">,</span><span class="s">&#39;I/A&#39;</span><span class="p">,</span><span class="s">&#39;Uiso&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Atom parameter&#39;</span><span class="p">,</span><span class="n">choices</span><span class="p">)</span>
            <span class="n">parm</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                <span class="n">cid</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">parm</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">parm</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2elemGUI</span><span class="o">.</span><span class="n">PickElement</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">Elem</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;None&#39;</span><span class="p">]:</span>
                        <span class="n">El</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">Elem</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>                        
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">IsReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cid</span><span class="p">):</span>
                                <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">El</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">El</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
                                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">El</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;(</span><span class="si">%d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">El</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;(</span><span class="si">%d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">SetupGeneral</span><span class="p">()</span>
                        <span class="k">if</span> <span class="s">&#39;Atoms&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                                <span class="n">ID</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">DrawAtomsReplaceByID</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">],</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">],</span><span class="n">ID</span><span class="p">)</span>
                    <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">parm</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">,]:</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Do you really want to rename the selected atoms?&#39;</span><span class="p">,</span><span class="s">&#39;Rename&#39;</span><span class="p">,</span> 
                    <span class="n">wx</span><span class="o">.</span><span class="n">YES_NO</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">ICON_QUESTION</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_YES</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">IsReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cid</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">El</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">El</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
                                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">El</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;(</span><span class="si">%d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">El</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;(</span><span class="si">%d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                    
            <span class="k">elif</span> <span class="n">parm</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;I/A&#39;</span><span class="p">]:</span>
                <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Isotropic&#39;</span><span class="p">,</span><span class="s">&#39;Anisotropic&#39;</span><span class="p">]</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Thermal parameter model&#39;</span><span class="p">,</span><span class="n">choices</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                    <span class="n">parm</span> <span class="o">=</span> <span class="n">choices</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">IsReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cid</span><span class="p">):</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
                    <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">parm</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;frac&#39;</span><span class="p">,</span><span class="s">&#39;Uiso&#39;</span><span class="p">]:</span>
                <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">if</span>  <span class="n">parm</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Uiso&#39;</span><span class="p">]:</span>
                    <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.25</span><span class="p">]</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="mf">0.01</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new value for &#39;</span><span class="o">+</span><span class="n">parm</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">limits</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">IsReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cid</span><span class="p">):</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
                    <span class="n">SetupGeneral</span><span class="p">()</span>
                    <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">parm</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">]:</span>
                <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Atom shift&#39;</span><span class="p">,</span><span class="s">&#39;Enter shift for &#39;</span><span class="o">+</span><span class="n">parm</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">limits</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">IsReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cid</span><span class="p">):</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cid</span><span class="p">]</span> <span class="o">+=</span> <span class="n">parm</span>
                    <span class="n">SetupGeneral</span><span class="p">()</span>
                    <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">AtomTransform</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">cuia</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;I/A&#39;</span><span class="p">)</span>
            <span class="n">cuij</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;U11&#39;</span><span class="p">)</span>
            <span class="n">css</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;site sym&#39;</span><span class="p">)</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SymOpDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">New</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">Inv</span><span class="p">,</span><span class="n">Cent</span><span class="p">,</span><span class="n">Opr</span><span class="p">,</span><span class="n">Cell</span><span class="p">,</span><span class="n">New</span><span class="p">,</span><span class="n">Force</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                    <span class="n">Cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span>
                    <span class="n">cent</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGCen&#39;</span><span class="p">][</span><span class="n">Cent</span><span class="p">]</span>
                    <span class="n">M</span><span class="p">,</span><span class="n">T</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGOps&#39;</span><span class="p">][</span><span class="n">Opr</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">XYZ</span><span class="p">)</span><span class="o">+</span><span class="n">T</span>
                        <span class="k">if</span> <span class="n">Inv</span><span class="p">:</span>
                            <span class="n">XYZ</span> <span class="o">=</span> <span class="o">-</span><span class="n">XYZ</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">XYZ</span><span class="o">+</span><span class="n">cent</span><span class="o">+</span><span class="n">Cell</span>
                        <span class="k">if</span> <span class="n">Force</span><span class="p">:</span>
                            <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">MoveToUnitCell</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">New</span><span class="p">:</span>
                            <span class="n">atom</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atom</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYZ</span>
                        <span class="n">atom</span><span class="p">[</span><span class="n">css</span><span class="p">:</span><span class="n">css</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SytSym</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">cuia</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                            <span class="n">Uij</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cuij</span><span class="p">:</span><span class="n">cuij</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
                            <span class="n">U</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">Uij2U</span><span class="p">(</span><span class="n">Uij</span><span class="p">)</span>
                            <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">U</span><span class="p">),</span><span class="n">M</span><span class="p">)</span>
                            <span class="n">Uij</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">U2Uij</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
                            <span class="n">atom</span><span class="p">[</span><span class="n">cuij</span><span class="p">:</span><span class="n">cuij</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uij</span>
                        <span class="k">if</span> <span class="n">New</span><span class="p">:</span>
                            <span class="n">atomData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">Atoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">New</span><span class="p">:</span>
                <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Atoms</span><span class="o">.</span><span class="n">ForceRefresh</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnDistAngle</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="n">Oxyz</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">DisAglData</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">DisAglCtls</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;OrigIndx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx</span>
            <span class="k">if</span> <span class="s">&#39;DisAglCtls&#39;</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
                <span class="n">DisAglCtls</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">DisAglDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">DisAglCtls</span><span class="p">,</span><span class="n">generalData</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">DisAglCtls</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DisAglCtls</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Atoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomData</span><span class="p">):</span>
                <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cn</span><span class="p">:</span><span class="n">cn</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                    <span class="n">Oxyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cn</span><span class="p">:</span><span class="n">cn</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;OrigAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Oxyz</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;TargAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="c">#+ volume</span>
            <span class="k">if</span> <span class="s">&#39;pId&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
                <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;covData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;Covariance&#39;</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">G2str</span><span class="o">.</span><span class="n">DistAngle</span><span class="p">(</span><span class="n">DisAglCtls</span><span class="p">,</span><span class="n">DisAglData</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c"># inside DistAngle for missing atom types in DisAglCtls</span>
                <span class="k">print</span> <span class="s">&#39;**** ERROR - try again but do &quot;Reset&quot; to fill in missing atom types ****&#39;</span>
                
    <span class="k">def</span> <span class="nf">OnReImport</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;reimport atoms from file to be developed&#39;</span>
        <span class="n">reqrdr</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">ReImportMenuId</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>
        <span class="n">rdlist</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">OnImportGeneric</span><span class="p">(</span><span class="n">reqrdr</span><span class="p">,</span>
                                         <span class="n">G2frame</span><span class="o">.</span><span class="n">ImportPhaseReaderlist</span><span class="p">,</span>
                                         <span class="s">&#39;phase&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rdlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
        <span class="c"># for now rdlist is only expected to have one element</span>
        <span class="c"># for now always use the first phase for when multiple phases are ever implemented</span>
        <span class="c"># but it would be better to loop until we find a phase that matches the one in data</span>
        <span class="k">for</span> <span class="n">rd</span> <span class="ow">in</span> <span class="n">rdlist</span><span class="p">:</span>
            <span class="c"># rd contains all info for a phase</span>
            <span class="n">PhaseName</span> <span class="o">=</span> <span class="n">rd</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Name&#39;</span><span class="p">]</span>
            <span class="k">print</span> <span class="s">&#39;Read phase &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">PhaseName</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; from file &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">lastimport</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">rd</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="k">return</span>
                        
<span class="c">################################################################################</span>
<span class="c">#Structure drawing GUI stuff                </span>
<span class="c">################################################################################</span>

    <span class="k">def</span> <span class="nf">SetupDrawingData</span><span class="p">():</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">AA3letter</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ALA&#39;</span><span class="p">,</span><span class="s">&#39;ARG&#39;</span><span class="p">,</span><span class="s">&#39;ASN&#39;</span><span class="p">,</span><span class="s">&#39;ASP&#39;</span><span class="p">,</span><span class="s">&#39;CYS&#39;</span><span class="p">,</span><span class="s">&#39;GLN&#39;</span><span class="p">,</span><span class="s">&#39;GLU&#39;</span><span class="p">,</span><span class="s">&#39;GLY&#39;</span><span class="p">,</span><span class="s">&#39;HIS&#39;</span><span class="p">,</span><span class="s">&#39;ILE&#39;</span><span class="p">,</span>
            <span class="s">&#39;LEU&#39;</span><span class="p">,</span><span class="s">&#39;LYS&#39;</span><span class="p">,</span><span class="s">&#39;MET&#39;</span><span class="p">,</span><span class="s">&#39;PHE&#39;</span><span class="p">,</span><span class="s">&#39;PRO&#39;</span><span class="p">,</span><span class="s">&#39;SER&#39;</span><span class="p">,</span><span class="s">&#39;THR&#39;</span><span class="p">,</span><span class="s">&#39;TRP&#39;</span><span class="p">,</span><span class="s">&#39;TYR&#39;</span><span class="p">,</span><span class="s">&#39;VAL&#39;</span><span class="p">,</span><span class="s">&#39;MSE&#39;</span><span class="p">,</span><span class="s">&#39;HOH&#39;</span><span class="p">,</span><span class="s">&#39;WAT&#39;</span><span class="p">,</span><span class="s">&#39;UNK&#39;</span><span class="p">]</span>
        <span class="n">AA1letter</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">,</span><span class="s">&#39;D&#39;</span><span class="p">,</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;Q&#39;</span><span class="p">,</span><span class="s">&#39;E&#39;</span><span class="p">,</span><span class="s">&#39;G&#39;</span><span class="p">,</span><span class="s">&#39;H&#39;</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span>
            <span class="s">&#39;L&#39;</span><span class="p">,</span><span class="s">&#39;K&#39;</span><span class="p">,</span><span class="s">&#39;M&#39;</span><span class="p">,</span><span class="s">&#39;F&#39;</span><span class="p">,</span><span class="s">&#39;P&#39;</span><span class="p">,</span><span class="s">&#39;S&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;W&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;V&#39;</span><span class="p">,</span><span class="s">&#39;M&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">]</span>
        <span class="n">defaultDrawing</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Atoms&#39;</span><span class="p">:[],</span><span class="s">&#39;viewPoint&#39;</span><span class="p">:[[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],[]],</span><span class="s">&#39;showHydrogen&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;backColor&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;depthFog&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;Zclip&#39;</span><span class="p">:</span><span class="mf">50.0</span><span class="p">,</span><span class="s">&#39;cameraPos&#39;</span><span class="p">:</span><span class="mf">50.</span><span class="p">,</span><span class="s">&#39;Zstep&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="s">&#39;radiusFactor&#39;</span><span class="p">:</span><span class="mf">0.85</span><span class="p">,</span><span class="s">&#39;contourLevel&#39;</span><span class="p">:</span><span class="mf">1.</span><span class="p">,</span><span class="s">&#39;bondRadius&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span><span class="s">&#39;ballScale&#39;</span><span class="p">:</span><span class="mf">0.33</span><span class="p">,</span>
            <span class="s">&#39;vdwScale&#39;</span><span class="p">:</span><span class="mf">0.67</span><span class="p">,</span><span class="s">&#39;ellipseProb&#39;</span><span class="p">:</span><span class="mi">50</span><span class="p">,</span><span class="s">&#39;sizeH&#39;</span><span class="p">:</span><span class="mf">0.50</span><span class="p">,</span><span class="s">&#39;unitCellBox&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;showABC&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&#39;selectedAtoms&#39;</span><span class="p">:[],</span><span class="s">&#39;Atoms&#39;</span><span class="p">:[],</span><span class="s">&#39;oldxy&#39;</span><span class="p">:[],</span>
            <span class="s">&#39;bondList&#39;</span><span class="p">:{},</span><span class="s">&#39;viewDir&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]}</span>
        <span class="n">V0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">V0</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span><span class="o">*</span><span class="n">V0</span><span class="p">))</span>
        <span class="n">defaultDrawing</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AV2Q</span><span class="p">(</span><span class="n">A</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">drawingData</span><span class="p">:</span>                 <span class="c">#fill with defaults if empty</span>
            <span class="n">drawingData</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaultDrawing</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Zstep&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drawingData</span><span class="p">:</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">if</span> <span class="s">&#39;contourLevel&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drawingData</span><span class="p">:</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">if</span> <span class="s">&#39;viewDir&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drawingData</span><span class="p">:</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;Quaternion&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drawingData</span><span class="p">:</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AV2Q</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="s">&#39;showRigidBodies&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">drawingData</span><span class="p">:</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showRigidBodies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;nuclear&#39;</span><span class="p">:</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">17</span><span class="p">]</span>         <span class="c">#x, type, style &amp; index</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>         <span class="c">#x, type, style &amp; index</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;magnetic&#39;</span><span class="p">:</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">20</span><span class="p">]</span>         <span class="c">#x, type, style &amp; index</span>
<span class="c">#        elif generalData[&#39;Type&#39;] == &#39;modulated&#39;:</span>
<span class="c">#           ?????   for future</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">drawingData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Atoms&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">:</span>
                <span class="n">DrawAtomAdd</span><span class="p">(</span><span class="n">drawingData</span><span class="p">,</span><span class="n">atom</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drawingData</span>
            
    <span class="k">def</span> <span class="nf">DrawAtomAdd</span><span class="p">(</span><span class="n">drawingData</span><span class="p">,</span><span class="n">atom</span><span class="p">):</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MakeDrawAtom</span><span class="p">(</span><span class="n">atom</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">OnRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>        
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="n">restData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>   
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Restraints&#39;</span><span class="p">))</span>
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>            
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">atNames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atXYZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atSymOp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atIndx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atXYZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">atSymOp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">cs</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">atIndx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">ci</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span> <span class="o">==</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWRESTRBOND</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bondData</span> <span class="o">=</span> <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">][</span><span class="s">&#39;Bond&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">bondData</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Bonds&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
                <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">][</span><span class="s">&#39;Bond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bondData</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDist</span><span class="p">(</span><span class="n">atXYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
            <span class="n">bondData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atIndx</span><span class="p">,</span><span class="n">atSymOp</span><span class="p">,</span><span class="mf">1.54</span><span class="p">,</span><span class="mf">0.01</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span> <span class="o">==</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWRESTRANGLE</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">angleData</span> <span class="o">=</span> <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">][</span><span class="s">&#39;Angle&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">angleData</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Angles&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
                <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">][</span><span class="s">&#39;Angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">angleData</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestAngle</span><span class="p">(</span><span class="n">atXYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
            <span class="n">angleData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atIndx</span><span class="p">,</span><span class="n">atSymOp</span><span class="p">,</span><span class="mf">109.5</span><span class="p">,</span><span class="mf">1.0</span><span class="p">])</span>            
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span> <span class="o">==</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWRESTRPLANE</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">planeData</span> <span class="o">=</span> <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">][</span><span class="s">&#39;Plane&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">planeData</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Planes&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
                <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">][</span><span class="s">&#39;Plane&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">planeData</span>
            <span class="n">plane</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestPlane</span><span class="p">(</span><span class="n">atXYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
            <span class="n">planeData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atIndx</span><span class="p">,</span><span class="n">atSymOp</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.01</span><span class="p">])</span>            
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span> <span class="o">==</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWRESTRCHIRAL</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chiralData</span> <span class="o">=</span> <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">][</span><span class="s">&#39;Chiral&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">chiralData</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Volumes&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
                <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">restData</span><span class="p">[</span><span class="n">PhaseName</span><span class="p">][</span><span class="s">&#39;Chiral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chiralData</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestChiral</span><span class="p">(</span><span class="n">atXYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
            <span class="n">chiralData</span><span class="p">[</span><span class="s">&#39;Volumes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atIndx</span><span class="p">,</span><span class="n">atSymOp</span><span class="p">,</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">0.1</span><span class="p">])</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR wrong number of atoms selected for this restraint&#39;</span>
            <span class="k">return</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">SetItemPyData</span><span class="p">(</span>   
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Restraints&#39;</span><span class="p">),</span><span class="n">restData</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnDefineRB</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="n">indx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">RBData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>   
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Rigid bodies&#39;</span><span class="p">))</span>
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>            
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">rbXYZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rbType</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atNames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">AtInfo</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="s">&#39;AtInfo&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
            <span class="n">rbtype</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">ct</span><span class="p">]</span>
            <span class="n">atNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbtype</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">rbType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbtype</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rbtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AtInfo</span><span class="p">:</span>
                <span class="n">Info</span> <span class="o">=</span> <span class="n">G2elem</span><span class="o">.</span><span class="n">GetAtomInfo</span><span class="p">(</span><span class="n">rbtype</span><span class="p">)</span>
                <span class="n">AtInfo</span><span class="p">[</span><span class="n">rbtype</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Info</span><span class="p">[</span><span class="s">&#39;Drad&#39;</span><span class="p">],</span><span class="n">Info</span><span class="p">[</span><span class="s">&#39;Color&#39;</span><span class="p">]]</span>
            <span class="n">rbXYZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]),</span><span class="n">Amat</span><span class="p">))</span>
        <span class="n">rbXYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rbXYZ</span><span class="p">)</span>
        <span class="n">rbXYZ</span> <span class="o">-=</span> <span class="n">rbXYZ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rbId</span> <span class="o">=</span> <span class="n">ran</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">)</span>
        <span class="n">rbName</span> <span class="o">=</span> <span class="s">&#39;UNKRB&#39;</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextEntryDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Enter the name for the new rigid body&#39;</span><span class="p">,</span>
            <span class="s">&#39;Edit rigid body name&#39;</span><span class="p">,</span><span class="n">rbName</span> <span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="n">rbName</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
        <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="n">rbId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;RBname&#39;</span><span class="p">:</span><span class="n">rbName</span><span class="p">,</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">:</span><span class="n">rbXYZ</span><span class="p">,</span><span class="s">&#39;rbTypes&#39;</span><span class="p">:</span><span class="n">rbType</span><span class="p">,</span>
            <span class="s">&#39;atNames&#39;</span><span class="p">:</span><span class="n">atNames</span><span class="p">,</span><span class="s">&#39;rbRef&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="bp">False</span><span class="p">],</span><span class="s">&#39;rbSeq&#39;</span><span class="p">:[],</span><span class="s">&#39;SelSeq&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;useCount&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
        <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;RBIds&#39;</span><span class="p">][</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbId</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New rigid body UNKRB added to set of Residue rigid bodies&#39;</span><span class="p">)</span>

<span class="c">################################################################################</span>
<span class="c">##### Atom draw routines</span>
<span class="c">################################################################################</span>
            
    <span class="k">def</span> <span class="nf">UpdateDrawAtoms</span><span class="p">(</span><span class="n">atomStyle</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">SetupDrawingData</span><span class="p">()</span>
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">atomStyle</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">:</span>
                <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomStyle</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,5&#39;</span><span class="p">,]</span><span class="o">+</span> \
            <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_CHOICE</span><span class="o">+</span><span class="s">&quot;: ,lines,vdW balls,sticks,balls &amp; sticks,ellipsoids,polyhedra&quot;</span><span class="p">,</span>
            <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_CHOICE</span><span class="o">+</span><span class="s">&quot;: ,type,name,number&quot;</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span>
        <span class="n">styleChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;lines&#39;</span><span class="p">,</span><span class="s">&#39;vdW balls&#39;</span><span class="p">,</span><span class="s">&#39;sticks&#39;</span><span class="p">,</span><span class="s">&#39;balls &amp; sticks&#39;</span><span class="p">,</span><span class="s">&#39;ellipsoids&#39;</span><span class="p">,</span><span class="s">&#39;polyhedra&#39;</span><span class="p">]</span>
        <span class="n">labelChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;number&#39;</span><span class="p">]</span>
        <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="s">&#39;Type&#39;</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="s">&#39;Sym Op&#39;</span><span class="p">,</span><span class="s">&#39;Style&#39;</span><span class="p">,</span><span class="s">&#39;Label&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">,</span><span class="s">&#39;I/A&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">,</span><span class="s">&#39;1-letter&#39;</span><span class="p">,</span><span class="s">&#39;Chain&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">colLabels</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="n">Types</span>
            <span class="n">Types</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_CHOICE</span><span class="o">+</span><span class="s">&quot;: ,lines,vdW balls,sticks,balls &amp; sticks,ellipsoids,backbone,ribbons,schematic&quot;</span>
            <span class="n">styleChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;lines&#39;</span><span class="p">,</span><span class="s">&#39;vdW balls&#39;</span><span class="p">,</span><span class="s">&#39;sticks&#39;</span><span class="p">,</span><span class="s">&#39;balls &amp; sticks&#39;</span><span class="p">,</span><span class="s">&#39;ellipsoids&#39;</span><span class="p">,</span><span class="s">&#39;backbone&#39;</span><span class="p">,</span><span class="s">&#39;ribbons&#39;</span><span class="p">,</span><span class="s">&#39;schematic&#39;</span><span class="p">]</span>
            <span class="n">labelChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;number&#39;</span><span class="p">,</span><span class="s">&#39;residue&#39;</span><span class="p">,</span><span class="s">&#39;1-letter&#39;</span><span class="p">,</span><span class="s">&#39;chain&#39;</span><span class="p">]</span>
            <span class="n">Types</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_CHOICE</span><span class="o">+</span><span class="s">&quot;: ,type,name,number,residue,1-letter,chain&quot;</span>
<span class="c">#        elif generalData[&#39;Type&#39;] == &#39;modulated&#39;:</span>
<span class="c">#            Types += []</span>
<span class="c">#            colLabels += []</span>

        <span class="k">def</span> <span class="nf">RefreshAtomGrid</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>

            <span class="k">def</span> <span class="nf">SetChoice</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                        <span class="n">srchStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">][:</span><span class="n">n</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">srchStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">srchStr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choice</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                            <span class="n">choice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">][:</span><span class="n">n</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">choice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]))</span>
                <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
                    <span class="n">parms</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                        <span class="n">parms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choice</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="n">noSkip</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                    <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;selectedAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">)):</span>
                        <span class="n">test</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
                            <span class="n">test</span> <span class="o">=</span> <span class="n">test</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
                        <span class="k">if</span>  <span class="n">test</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;selectedAtoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>                    
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                    <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;selectedAtoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>                    
            <span class="k">elif</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>                          <span class="c">#dclick on col label</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">Parms</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">noSkip</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Style&#39;</span><span class="p">:</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Atom drawing style&#39;</span><span class="p">,</span><span class="n">styleChoice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                        <span class="n">parms</span> <span class="o">=</span> <span class="n">styleChoice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">)):</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span>
                            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetCellValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">parms</span><span class="p">)</span>
                        <span class="n">FindBondsDraw</span><span class="p">()</span>
                        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Label&#39;</span><span class="p">:</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Atom labelling style&#39;</span><span class="p">,</span><span class="n">labelChoice</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                        <span class="n">parms</span> <span class="o">=</span> <span class="n">labelChoice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">)):</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span>
                            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetCellValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">parms</span><span class="p">)</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>                    
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Color&#39;</span><span class="p">:</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ColourDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetColourData</span><span class="p">()</span><span class="o">.</span><span class="n">GetColour</span><span class="p">()</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">GridCellAttr</span><span class="p">()</span>                <span class="c">#needs to be here - gets lost if outside loop!</span>
                        <span class="n">attr</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">attr</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">)):</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetAttr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
                        <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Residue&#39;</span><span class="p">:</span>
                    <span class="n">SetChoice</span><span class="p">(</span><span class="s">&#39;Residue&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;1-letter&#39;</span><span class="p">:</span>
                    <span class="n">SetChoice</span><span class="p">(</span><span class="s">&#39;1-letter&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Chain&#39;</span><span class="p">:</span>
                    <span class="n">SetChoice</span><span class="p">(</span><span class="s">&#39;Chain&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Name&#39;</span><span class="p">:</span>
                    <span class="n">SetChoice</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Sym Op&#39;</span><span class="p">:</span>
                    <span class="n">SetChoice</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Type&#39;</span><span class="p">:</span>
                    <span class="n">SetChoice</span><span class="p">(</span><span class="s">&#39;Type&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="s">&#39;I/A&#39;</span><span class="p">]:</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Style&#39;</span><span class="p">,</span><span class="s">&#39;Label&#39;</span><span class="p">]:</span>
                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetCellValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">FindBondsDraw</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Color&#39;</span><span class="p">:</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ColourDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">color</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetColourData</span><span class="p">()</span><span class="o">.</span><span class="n">GetColour</span><span class="p">()</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">GridCellAttr</span><span class="p">()</span>                <span class="c">#needs to be here - gets lost if outside loop!</span>
                        <span class="n">attr</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">attr</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetAttr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                    <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                    
        <span class="k">def</span> <span class="nf">RowSelect</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">IsSelection</span><span class="p">():</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>                   <span class="c">#only row clicks</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ControlDown</span><span class="p">():</span>                    
                    <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">():</span>
                        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">DeselectRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">ShiftDown</span><span class="p">():</span>
                    <span class="n">indxs</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                    <span class="n">ibeg</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">indxs</span><span class="p">:</span>
                        <span class="n">ibeg</span> <span class="o">=</span> <span class="n">indxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ibeg</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>                
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;selectedAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;selectedAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>                    
                
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]):</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">[:</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;I/A&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">atomTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">atomTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetColSize</span><span class="p">(</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Style&#39;</span><span class="p">),</span><span class="mi">80</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetColSize</span><span class="p">(</span><span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Color&#39;</span><span class="p">),</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">RefreshAtomGrid</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_DCLICK</span><span class="p">,</span> <span class="n">RefreshAtomGrid</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_LEFT_DCLICK</span><span class="p">,</span> <span class="n">RefreshAtomGrid</span><span class="p">)</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span> <span class="n">RowSelect</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]):</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">GridCellAttr</span><span class="p">()</span>                <span class="c">#needs to be here - gets lost if outside loop!</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">attr</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetAttr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetCellValue</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;selectedAtoms&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colLabels</span><span class="p">)):</span>
           <span class="n">attr</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">GridCellAttr</span><span class="p">()</span>                <span class="c">#needs to be here - gets lost if outside loop!</span>
           <span class="n">attr</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
           <span class="n">attr</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
           <span class="k">if</span> <span class="n">colLabels</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Style&#39;</span><span class="p">,</span><span class="s">&#39;Label&#39;</span><span class="p">,</span><span class="s">&#39;Color&#39;</span><span class="p">]:</span>
                <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetColAttr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">([</span><span class="mi">600</span><span class="p">,</span><span class="mi">300</span><span class="p">])</span>
        
        <span class="n">FindBondsDraw</span><span class="p">()</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">DrawAtomStyle</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
            <span class="n">styleChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;lines&#39;</span><span class="p">,</span><span class="s">&#39;vdW balls&#39;</span><span class="p">,</span><span class="s">&#39;sticks&#39;</span><span class="p">,</span><span class="s">&#39;balls &amp; sticks&#39;</span><span class="p">,</span><span class="s">&#39;ellipsoids&#39;</span><span class="p">,</span><span class="s">&#39;polyhedra&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
                <span class="n">styleChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;lines&#39;</span><span class="p">,</span><span class="s">&#39;vdW balls&#39;</span><span class="p">,</span><span class="s">&#39;sticks&#39;</span><span class="p">,</span><span class="s">&#39;balls &amp; sticks&#39;</span><span class="p">,</span><span class="s">&#39;ellipsoids&#39;</span><span class="p">,</span>
                <span class="s">&#39;backbone&#39;</span><span class="p">,</span><span class="s">&#39;ribbons&#39;</span><span class="p">,</span><span class="s">&#39;schematic&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Atom drawing style&#39;</span><span class="p">,</span><span class="n">styleChoice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                <span class="n">parms</span> <span class="o">=</span> <span class="n">styleChoice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cs</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetCellValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">parms</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">FindBondsDraw</span><span class="p">()</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">DrawAtomLabel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
            <span class="n">styleChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;number&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
                <span class="n">styleChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;type&#39;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;number&#39;</span><span class="p">,</span><span class="s">&#39;residue&#39;</span><span class="p">,</span><span class="s">&#39;1-letter&#39;</span><span class="p">,</span><span class="s">&#39;chain&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Atom label style&#39;</span><span class="p">,</span><span class="n">styleChoice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                <span class="n">parms</span> <span class="o">=</span> <span class="n">styleChoice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parms</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetCellValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">parms</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">DrawAtomColor</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>

        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Select Custom Color, change color, Add to Custom Colors, then OK&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Change color, Add to Custom Colors, then OK&#39;</span><span class="p">)</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
            <span class="n">atmColors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">atmTypes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atmColors</span><span class="p">:</span>
                    <span class="n">atmColors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">atmTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ct</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atmColors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ColourData</span><span class="p">()</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">SetChooseFull</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ColourDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atmColors</span><span class="p">)):</span>                    
                    <span class="n">atmColors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetColourData</span><span class="p">()</span><span class="o">.</span><span class="n">GetColour</span><span class="p">()</span>
                <span class="n">colorDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">atmTypes</span><span class="p">,</span><span class="n">atmColors</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">colorDict</span><span class="p">[</span><span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">ct</span><span class="p">]]</span>
                    <span class="n">atomData</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">GridCellAttr</span><span class="p">()</span>                <span class="c">#needs to be here - gets lost if outside loop!</span>
                    <span class="n">attr</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
                    <span class="n">drawAtoms</span><span class="o">.</span><span class="n">SetAttr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">attr</span><span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">ResetAtomColors</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">:</span>            
            <span class="n">atNum</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">])</span>
            <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Color&#39;</span><span class="p">][</span><span class="n">atNum</span><span class="p">])</span>
        <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>        
        
    <span class="k">def</span> <span class="nf">SetViewPoint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;viewPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">atomData</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">],[</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>                                  <span class="c">#do I really want to do this?</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">noDuplicate</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">atomData</span><span class="p">):</span>                  <span class="c">#be careful where this is used - it&#39;s slow</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">True</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]),</span><span class="n">atol</span><span class="o">=</span><span class="mf">0.0002</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
                
    <span class="k">def</span> <span class="nf">AddSymEquiv</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="n">indx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">cuia</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;I/A&#39;</span><span class="p">)</span>
            <span class="n">cuij</span> <span class="o">=</span> <span class="n">cuia</span><span class="o">+</span><span class="mi">2</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SymOpDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">Inv</span><span class="p">,</span><span class="n">Cent</span><span class="p">,</span><span class="n">Opr</span><span class="p">,</span><span class="n">Cell</span><span class="p">,</span><span class="n">New</span><span class="p">,</span><span class="n">Force</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                    <span class="n">Cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span>
                    <span class="n">cent</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGCen&#39;</span><span class="p">][</span><span class="n">Cent</span><span class="p">]</span>
                    <span class="n">M</span><span class="p">,</span><span class="n">T</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGOps&#39;</span><span class="p">][</span><span class="n">Opr</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">XYZ</span><span class="p">)</span><span class="o">+</span><span class="n">T</span>
                        <span class="k">if</span> <span class="n">Inv</span><span class="p">:</span>
                            <span class="n">XYZ</span> <span class="o">=</span> <span class="o">-</span><span class="n">XYZ</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">XYZ</span><span class="o">+</span><span class="n">cent</span><span class="o">+</span><span class="n">Cell</span>
                        <span class="k">if</span> <span class="n">Force</span><span class="p">:</span>
                            <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">MoveToUnitCell</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">noDuplicate</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">atomData</span><span class="p">):</span>
                            <span class="n">atom</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                            <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYZ</span>
                            <span class="n">atomOp</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                            <span class="n">newOp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(((</span><span class="n">Opr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="n">Cent</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Inv</span><span class="p">))</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span> \
                                <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>                            
                            <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">StringOpsProd</span><span class="p">(</span><span class="n">atomOp</span><span class="p">,</span><span class="n">newOp</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">cuia</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                                <span class="n">Uij</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cuij</span><span class="p">:</span><span class="n">cuij</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
                                <span class="n">U</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">Uij2U</span><span class="p">(</span><span class="n">Uij</span><span class="p">)</span>
                                <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">U</span><span class="p">),</span><span class="n">M</span><span class="p">)</span>
                                <span class="n">Uij</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">U2Uij</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
                                <span class="n">atom</span><span class="p">[</span><span class="n">cuij</span><span class="p">:</span><span class="n">cuij</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uij</span>
                            <span class="n">atomData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">TransformSymEquiv</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="n">indx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">cuia</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;I/A&#39;</span><span class="p">)</span>
            <span class="n">cuij</span> <span class="o">=</span> <span class="n">cuia</span><span class="o">+</span><span class="mi">2</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SymOpDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">Inv</span><span class="p">,</span><span class="n">Cent</span><span class="p">,</span><span class="n">Opr</span><span class="p">,</span><span class="n">Cell</span><span class="p">,</span><span class="n">New</span><span class="p">,</span><span class="n">Force</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                    <span class="n">Cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span>
                    <span class="n">cent</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGCen&#39;</span><span class="p">][</span><span class="n">Cent</span><span class="p">]</span>
                    <span class="n">M</span><span class="p">,</span><span class="n">T</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGOps&#39;</span><span class="p">][</span><span class="n">Opr</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">XYZ</span><span class="p">)</span><span class="o">+</span><span class="n">T</span>
                        <span class="k">if</span> <span class="n">Inv</span><span class="p">:</span>
                            <span class="n">XYZ</span> <span class="o">=</span> <span class="o">-</span><span class="n">XYZ</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">XYZ</span><span class="o">+</span><span class="n">cent</span><span class="o">+</span><span class="n">Cell</span>
                        <span class="k">if</span> <span class="n">Force</span><span class="p">:</span>
                            <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">MoveToUnitCell</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
                        <span class="n">atom</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                        <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYZ</span>
                        <span class="n">atomOp</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">newOp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(((</span><span class="n">Opr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">100</span><span class="o">*</span><span class="n">Cent</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">Inv</span><span class="p">))</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                        <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">StringOpsProd</span><span class="p">(</span><span class="n">atomOp</span><span class="p">,</span><span class="n">newOp</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">cuia</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                            <span class="n">Uij</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cuij</span><span class="p">:</span><span class="n">cuij</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
                            <span class="n">U</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">Uij2U</span><span class="p">(</span><span class="n">Uij</span><span class="p">)</span>
                            <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">U</span><span class="p">),</span><span class="n">M</span><span class="p">)</span>
                            <span class="n">Uij</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">U2Uij</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
                            <span class="n">atom</span><span class="p">[</span><span class="n">cuij</span><span class="p">:</span><span class="n">cuij</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">Uij</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomData</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">FillCoordSphere</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">]</span>
        <span class="n">atomTypes</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">indH</span> <span class="o">=</span> <span class="n">atomTypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">)</span>
            <span class="n">radii</span><span class="p">[</span><span class="n">indH</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>            
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">indx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">numAtoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">)</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">cellArray</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CellBlock</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                    <span class="n">atomA</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">xyzA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomA</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">indA</span> <span class="o">=</span> <span class="n">atomTypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atomA</span><span class="p">[</span><span class="n">ct</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">atomB</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">[:</span><span class="n">numAtoms</span><span class="p">]:</span>
                        <span class="n">indB</span> <span class="o">=</span> <span class="n">atomTypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atomB</span><span class="p">[</span><span class="n">ct</span><span class="p">])</span>
                        <span class="n">sumR</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">indA</span><span class="p">]</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">indB</span><span class="p">]</span>
                        <span class="n">xyzB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomB</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">cellArray</span><span class="o">+</span><span class="n">xyzB</span><span class="p">:</span>
                            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">xyz</span><span class="o">-</span><span class="n">xyzA</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;radiusFactor&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sumR</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">noDuplicate</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">atomData</span><span class="p">):</span>
                                    <span class="n">oprB</span> <span class="o">=</span> <span class="n">atomB</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                                    <span class="n">C</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">-</span><span class="n">xyzB</span>
                                    <span class="n">newOp</span> <span class="o">=</span> <span class="s">&#39;1+&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
                                    <span class="n">newAtom</span> <span class="o">=</span> <span class="n">atomB</span><span class="p">[:]</span>
                                    <span class="n">newAtom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
                                    <span class="n">newAtom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">StringOpsProd</span><span class="p">(</span><span class="n">oprB</span><span class="p">,</span><span class="n">newOp</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                                    <span class="n">atomData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newAtom</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomData</span>
            <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">FillUnitCell</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="n">indx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="n">cuia</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;I/A&#39;</span><span class="p">)</span>
            <span class="n">cuij</span> <span class="o">=</span> <span class="n">cuia</span><span class="o">+</span><span class="mi">2</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">cuia</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                        <span class="n">Uij</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cuij</span><span class="p">:</span><span class="n">cuij</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GenAtom</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">Uij</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="n">atom</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                            <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;+&#39;</span> \
                                <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">atom</span><span class="p">[</span><span class="n">cuij</span><span class="p">:</span><span class="n">cuij</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">Opp</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">Opposite</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">Opp</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">noDuplicate</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">atomData</span><span class="p">):</span>
                                    <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">xyz</span><span class="o">-</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                                    <span class="n">cell</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span> \
                                        <span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                    <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
                                    <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">StringOpsProd</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span><span class="n">SGData</span><span class="p">)</span>
                                    <span class="n">atomData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">[:])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GenAtom</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">Move</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="n">atom</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                            <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;+&#39;</span> \
                                <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">Opp</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">Opposite</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">Opp</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">noDuplicate</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">atomData</span><span class="p">):</span>
                                    <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rint</span><span class="p">(</span><span class="n">xyz</span><span class="o">-</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]),</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                                    <span class="n">cell</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="o">+</span> \
                                        <span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;,&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                    <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
                                    <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">StringOpsProd</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span><span class="n">SGData</span><span class="p">)</span>
                                    <span class="n">atomData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">[:])</span>               
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atomData</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
            <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">FindBondsToo</span><span class="p">():</span>                         <span class="c">#works but slow for large structures - keep as reference</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">]</span>
        <span class="n">atomTypes</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">indH</span> <span class="o">=</span> <span class="n">atomTypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">)</span>
            <span class="n">radii</span><span class="p">[</span><span class="n">indH</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>            
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">:</span>
            <span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomData</span><span class="p">):</span>
            <span class="n">Atoms</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]),</span><span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">],</span><span class="n">radii</span><span class="p">[</span><span class="n">atomTypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">])]])</span>
        <span class="k">for</span> <span class="n">atomA</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atomA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;lines&#39;</span><span class="p">,</span><span class="s">&#39;sticks&#39;</span><span class="p">,</span><span class="s">&#39;ellipsoids&#39;</span><span class="p">,</span><span class="s">&#39;balls &amp; sticks&#39;</span><span class="p">,</span><span class="s">&#39;polyhedra&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">atomB</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="p">:</span>                    
                    <span class="n">Dx</span> <span class="o">=</span> <span class="n">atomB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">atomA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">DX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">Dx</span><span class="p">)</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">DX</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">sumR</span> <span class="o">=</span> <span class="n">atomA</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">atomB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="mf">0.5</span> <span class="o">&lt;</span> <span class="n">dist</span> <span class="o">&lt;=</span> <span class="mf">0.85</span><span class="o">*</span><span class="n">sumR</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="n">atomA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">atomA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;polyhedra&#39;</span><span class="p">:</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DX</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">atomB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;polyhedra&#39;</span><span class="p">:</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">atomB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Dx</span><span class="o">*</span><span class="n">atomA</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">sumR</span><span class="p">)</span>
                            <span class="n">atomData</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">Dx</span><span class="o">*</span><span class="n">atomB</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">sumR</span><span class="p">)</span>
                    
    <span class="k">def</span> <span class="nf">FindBondsDraw</span><span class="p">():</span>                    <span class="c">#uses numpy &amp; masks - very fast even for proteins!</span>
        <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
        <span class="n">hydro</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;showHydrogen&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">]</span>
        <span class="n">atomTypes</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">indH</span> <span class="o">=</span> <span class="n">atomTypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;H&#39;</span><span class="p">)</span>
            <span class="n">radii</span><span class="p">[</span><span class="n">indH</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>            
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">:</span>
            <span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>               <span class="c">#clear out old bonds/polyhedra</span>
            <span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Indx</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">))</span>
        <span class="n">Atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Styles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Radii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atomData</span><span class="p">:</span>
            <span class="n">Atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">Styles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hydro</span> <span class="ow">and</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;H&#39;</span><span class="p">:</span>
                    <span class="n">Radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radii</span><span class="p">[</span><span class="n">atomTypes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">])])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>          <span class="c">#changed atom type!</span>
                <span class="n">Radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">0.20</span><span class="p">)</span>
        <span class="n">Atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
        <span class="n">Radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Radii</span><span class="p">)</span>
        <span class="n">IASR</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Indx</span><span class="p">,</span><span class="n">Atoms</span><span class="p">,</span><span class="n">Styles</span><span class="p">,</span><span class="n">Radii</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atomA</span> <span class="ow">in</span> <span class="n">IASR</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atomA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;lines&#39;</span><span class="p">,</span><span class="s">&#39;sticks&#39;</span><span class="p">,</span><span class="s">&#39;ellipsoids&#39;</span><span class="p">,</span><span class="s">&#39;balls &amp; sticks&#39;</span><span class="p">,</span><span class="s">&#39;polyhedra&#39;</span><span class="p">]:</span>
                <span class="n">Dx</span> <span class="o">=</span> <span class="n">Atoms</span><span class="o">-</span><span class="n">atomA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">Dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span><span class="mf">0.5</span><span class="p">)</span> <span class="c">#gets rid of G2frame &amp; disorder &quot;bonds&quot; &lt; 0.5A</span>
                <span class="n">sumR</span> <span class="o">=</span> <span class="n">atomA</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">Radii</span>
                <span class="n">IndB</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dist</span><span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;radiusFactor&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sumR</span><span class="p">,</span><span class="mf">0.</span><span class="p">))</span>                 <span class="c">#get indices of bonded atoms</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">atomA</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">IndB</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">Styles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;polyhedra&#39;</span><span class="p">:</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">Dx</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="n">Styles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;polyhedra&#39;</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Dx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">Radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sumR</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">Dx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">Radii</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">sumR</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">Styles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;polyhedra&#39;</span><span class="p">:</span>
                    <span class="n">Bonds</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">Faces</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">FaceGen</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">uniqueCombinations</span><span class="p">(</span><span class="n">Bonds</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>     <span class="c">#N.B. this is a generator</span>
                        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">FaceGen</span><span class="p">:</span>
                            <span class="n">vol</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">vol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">Bonds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">vol</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
                                    <span class="n">face</span> <span class="o">=</span> <span class="p">[</span><span class="n">face</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">face</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">face</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                <span class="n">face</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nl</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">face</span><span class="o">-</span><span class="n">bond</span><span class="p">))</span><span class="o">+</span><span class="mf">0.0001</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">Bonds</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                    <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">face</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">face</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">face</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">face</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                    <span class="n">norm</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">norm</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                                    <span class="n">Faces</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">face</span><span class="p">,</span><span class="n">norm</span><span class="p">])</span>
                        <span class="n">atomData</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Faces</span>
                        
    <span class="k">def</span> <span class="nf">DrawAtomsDelete</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>   
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="n">indx</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">indx</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
            <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">StopPropagation</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">OnReloadDrawAtoms</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
        <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">StopPropagation</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">DrawAtomsDeleteByIDs</span><span class="p">(</span><span class="n">IDs</span><span class="p">):</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FindAtomIndexByIDs</span><span class="p">(</span><span class="n">atomData</span><span class="p">,</span><span class="n">IDs</span><span class="p">)</span>
        <span class="n">indx</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            
    <span class="k">def</span> <span class="nf">ChangeDrawAtomsByIDs</span><span class="p">(</span><span class="n">colName</span><span class="p">,</span><span class="n">IDs</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">colName</span> <span class="o">==</span> <span class="s">&#39;Name&#39;</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">colName</span> <span class="o">==</span> <span class="s">&#39;Type&#39;</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">ct</span>
        <span class="k">elif</span> <span class="n">colName</span> <span class="o">==</span> <span class="s">&#39;I/A&#39;</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">cs</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FindAtomIndexByIDs</span><span class="p">(</span><span class="n">atomData</span><span class="p">,</span><span class="n">IDs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atomData</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                
    <span class="k">def</span> <span class="nf">OnDrawPlane</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - need 4+ atoms for plane calculation&#39;</span>
            <span class="k">return</span>
        <span class="n">PlaneData</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomData</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
                <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cn</span><span class="p">:</span><span class="n">cn</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">PlaneData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span>
        <span class="n">PlaneData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="n">PlaneData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="c">#+ volume</span>
        <span class="n">G2str</span><span class="o">.</span><span class="n">BestPlane</span><span class="p">(</span><span class="n">PlaneData</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnDrawDistVP</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="c"># distance to view point</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;***** ERROR - no atoms selected&#39;</span>
            <span class="k">return</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>            
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">viewPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&#39; Distance from view point at </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> to:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">viewPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">viewPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">viewPt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">atomDData</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">atomDData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">Dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="n">viewPt</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">Dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">print</span> <span class="s">&#39;Atom: </span><span class="si">%8s</span><span class="s"> (</span><span class="si">%12s</span><span class="s">) distance = </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cn</span><span class="p">],</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">],</span><span class="n">dist</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">OnDrawDAT</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="c">#distance, angle, torsion </span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - wrong number of atoms for distance, angle or torsion calculation&#39;</span>
            <span class="k">return</span>
        <span class="n">DATData</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ocx</span><span class="p">,</span><span class="nb">oct</span><span class="p">,</span><span class="n">ocs</span><span class="p">,</span><span class="n">cia</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">]</span>
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">atomDData</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">drawAtoms</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">cn</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Name&#39;</span><span class="p">)</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;I/A&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">8</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Oxyz</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">DATData</span><span class="p">[</span><span class="s">&#39;Natoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">atomDData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cn</span><span class="p">:</span><span class="n">cn</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span> <span class="c">#also gets Sym Op</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FindAtomIndexByIDs</span><span class="p">(</span><span class="n">atomData</span><span class="p">,[</span><span class="n">atom</span><span class="p">[</span><span class="n">cid</span><span class="p">],],</span><span class="bp">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Oxyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">id</span><span class="p">,]</span><span class="o">+</span><span class="n">atomData</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="n">cx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">DATData</span><span class="p">[</span><span class="s">&#39;Datoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
        <span class="n">DATData</span><span class="p">[</span><span class="s">&#39;Oatoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Oxyz</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">DATData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span>
        <span class="n">DATData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">DATData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="c">#+ volume</span>
        <span class="k">if</span> <span class="s">&#39;pId&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">DATData</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
            <span class="n">DATData</span><span class="p">[</span><span class="s">&#39;covData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s">&#39;Covariance&#39;</span><span class="p">))</span>
        <span class="n">G2str</span><span class="o">.</span><span class="n">DisAglTor</span><span class="p">(</span><span class="n">DATData</span><span class="p">)</span>
                
<span class="c">################################################################################</span>
<span class="c">#### Draw Options page</span>
<span class="c">################################################################################</span>

    <span class="k">def</span> <span class="nf">UpdateDrawOptions</span><span class="p">():</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="kn">import</span> <span class="nn">wx.lib.colourselect</span> <span class="kn">as</span> <span class="nn">wcs</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">SetupDrawingData</span><span class="p">()</span>
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;nuclear&#39;</span><span class="p">:</span>
            <span class="n">pickChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">,</span><span class="s">&#39;Bonds&#39;</span><span class="p">,</span><span class="s">&#39;Torsions&#39;</span><span class="p">,</span><span class="s">&#39;Planes&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
            <span class="n">pickChoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">,</span><span class="s">&#39;Residues&#39;</span><span class="p">,</span><span class="s">&#39;Chains&#39;</span><span class="p">,</span><span class="s">&#39;Bonds&#39;</span><span class="p">,</span><span class="s">&#39;Torsions&#39;</span><span class="p">,</span><span class="s">&#39;Planes&#39;</span><span class="p">,</span><span class="s">&#39;phi/psi&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">SlopSizer</span><span class="p">():</span>
            
            <span class="k">def</span> <span class="nf">OnCameraPos</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cameraPos</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">cameraPosTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; Camera Distance: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]))</span>
                <span class="n">ZclipTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; Z clipping: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">A&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zclip&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">OnZclip</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zclip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Zclip</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">ZclipTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; Z clipping: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">A&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zclip&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnZstep</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Zstep</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.01</span> <span class="o">&lt;=</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zstep&#39;</span><span class="p">]</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zstep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span>
                <span class="n">Zstep</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">A&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zstep&#39;</span><span class="p">]))</span>
                
            <span class="k">def</span> <span class="nf">OnMoveZ</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">move</span> <span class="o">=</span> <span class="n">MoveZ</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zstep&#39;</span><span class="p">]</span>
                <span class="n">MoveZ</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">VP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">VD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]))</span>
                <span class="n">VD</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">VD</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">VP</span> <span class="o">+=</span> <span class="n">move</span><span class="o">*</span><span class="n">VD</span>
                <span class="n">VP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">VP</span><span class="p">)</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">VP</span>
                <span class="n">panel</span> <span class="o">=</span> <span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetChildren</span><span class="p">()</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">panel</span><span class="p">]</span>
                <span class="n">panel</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;viewPoint&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">VP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VP</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">VP</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>                
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnVdWScale</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;vdwScale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vdwScale</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">/</span><span class="mf">100.</span>
                <span class="n">vdwScaleTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; van der Waals scale: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;vdwScale&#39;</span><span class="p">]))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    
            <span class="k">def</span> <span class="nf">OnEllipseProb</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ellipseProb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ellipseProb</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">ellipseProbTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; Ellipsoid probability: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%d%%</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ellipseProb&#39;</span><span class="p">]))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    
            <span class="k">def</span> <span class="nf">OnBallScale</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ballScale&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ballScale</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">/</span><span class="mf">100.</span>
                <span class="n">ballScaleTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; Ball scale: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ballScale&#39;</span><span class="p">]))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">OnBondRadius</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;bondRadius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bondRadius</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">/</span><span class="mf">100.</span>
                <span class="n">bondRadiusTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; Bond radius, A: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;bondRadius&#39;</span><span class="p">]))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnContourLevel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contourLevel</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">/</span><span class="mf">100.</span>
                <span class="n">contourLevelTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; Contour level: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">][</span><span class="s">&#39;rhoMax&#39;</span><span class="p">]))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">OnMapSize</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;mapSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapSize</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">/</span><span class="mf">10.</span>
                <span class="n">mapSizeTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39; Map radius, A: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;mapSize&#39;</span><span class="p">]))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

            
            <span class="n">slopSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">slideSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">AddGrowableCol</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
            <span class="n">cameraPosTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s">&#39; Camera Distance: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;cameraPos&#39;</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">cameraPosTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">cameraPos</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">],</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;cameraSlider&#39;</span><span class="p">)</span>
            <span class="n">cameraPos</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
            <span class="n">cameraPos</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnCameraPos</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">cameraPos</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
            
            <span class="n">ZclipTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Z clipping: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">A&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zclip&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ZclipTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">Zclip</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zclip&#39;</span><span class="p">])</span>
            <span class="n">Zclip</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span>
            <span class="n">Zclip</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnZclip</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Zclip</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
            
            <span class="n">ZstepSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">ZstepSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Z step:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">Zstep</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zstep&#39;</span><span class="p">]),</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">Zstep</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnZstep</span><span class="p">)</span>
            <span class="n">Zstep</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnZstep</span><span class="p">)</span>
            <span class="n">ZstepSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Zstep</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ZstepSizer</span><span class="p">)</span>
            <span class="n">MoveSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">MoveSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;   Press to step:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">MoveZ</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SpinButton</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SP_HORIZONTAL</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
            <span class="n">MoveZ</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">MoveZ</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">MoveZ</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SPIN</span><span class="p">,</span> <span class="n">OnMoveZ</span><span class="p">)</span>
            <span class="n">MoveSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">MoveZ</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">MoveSizer</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
            
            <span class="n">vdwScaleTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; van der Waals scale: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;vdwScale&#39;</span><span class="p">]))</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">vdwScaleTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">vdwScale</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;vdwScale&#39;</span><span class="p">]))</span>
            <span class="n">vdwScale</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnVdWScale</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">vdwScale</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
    
            <span class="n">ellipseProbTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Ellipsoid probability: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%d%%</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ellipseProb&#39;</span><span class="p">]))</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ellipseProbTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">ellipseProb</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ellipseProb&#39;</span><span class="p">])</span>
            <span class="n">ellipseProb</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">99</span><span class="p">)</span>
            <span class="n">ellipseProb</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnEllipseProb</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ellipseProb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
    
            <span class="n">ballScaleTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Ball scale: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ballScale&#39;</span><span class="p">]))</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ballScaleTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">ballScale</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ballScale&#39;</span><span class="p">]))</span>
            <span class="n">ballScale</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnBallScale</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ballScale</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
    
            <span class="n">bondRadiusTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Bond radius, A: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;bondRadius&#39;</span><span class="p">]))</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">bondRadiusTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">bondRadius</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;bondRadius&#39;</span><span class="p">]))</span>
            <span class="n">bondRadius</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">bondRadius</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnBondRadius</span><span class="p">)</span>
            <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">bondRadius</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">][</span><span class="s">&#39;rhoMax&#39;</span><span class="p">]:</span>
                <span class="n">contourLevelTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Contour level: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">][</span><span class="s">&#39;rhoMax&#39;</span><span class="p">]))</span>
                <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">contourLevelTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">contourLevel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]))</span>
                <span class="n">contourLevel</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">contourLevel</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnContourLevel</span><span class="p">)</span>
                <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">contourLevel</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
                <span class="n">mapSizeTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Map radius, A: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;mapSize&#39;</span><span class="p">]))</span>
                <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">mapSizeTxt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">mapSize</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;mapSize&#39;</span><span class="p">]))</span>
                <span class="n">mapSize</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
                <span class="n">mapSize</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnMapSize</span><span class="p">)</span>
                <span class="n">slideSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">mapSize</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
            
            <span class="n">slopSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">slideSizer</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
            <span class="n">slopSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">slopSizer</span><span class="o">.</span><span class="n">SetMinSize</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="mi">350</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">slopSizer</span>
            
        <span class="k">def</span> <span class="nf">ShowSizer</span><span class="p">():</span>
            
            <span class="k">def</span> <span class="nf">OnBackColor</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;backColor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    
            <span class="k">def</span> <span class="nf">OnShowABC</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showABC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">showABC</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    
            <span class="k">def</span> <span class="nf">OnShowUnitCell</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;unitCellBox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unitCellBox</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    
            <span class="k">def</span> <span class="nf">OnShowHyd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showHydrogen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">showHydrogen</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">FindBondsDraw</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnShowRB</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showRigidBodies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">showRB</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">FindBondsDraw</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnViewPoint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">viewPt</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">VP</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">viewPt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">):</span>
                    <span class="n">VP</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">VP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VP</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">VP</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">VP</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnViewDir</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">viewDir</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
                    <span class="n">VD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">viewDir</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)])</span>
                    <span class="n">VC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">VD</span><span class="p">)</span>
                    <span class="n">VC</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">VC</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">])</span>
                    <span class="n">VB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
                    <span class="n">VB</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">VB</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">VX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">VC</span><span class="p">,</span><span class="n">VB</span><span class="p">)</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="n">acosd</span><span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="mf">2.</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">VB</span><span class="o">-</span><span class="n">VC</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">))</span>
                    <span class="n">QV</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">VX</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
                    <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">QV</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">):</span>
                    <span class="n">VD</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">VD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">VD</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VD</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                                
            <span class="n">showSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>            
            <span class="n">lineSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Background color:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">backColor</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">ColourSelect</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">colour</span><span class="o">=</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;backColor&#39;</span><span class="p">],</span><span class="n">size</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">))</span>
            <span class="n">backColor</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wcs</span><span class="o">.</span><span class="n">EVT_COLOURSELECT</span><span class="p">,</span> <span class="n">OnBackColor</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">backColor</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; View Dir.:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">VD</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span>
            <span class="n">viewDir</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">VD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">VD</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;viewDir&#39;</span><span class="p">)</span>
            <span class="n">viewDir</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnViewDir</span><span class="p">)</span>
            <span class="n">viewDir</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnViewDir</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">viewDir</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">showSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">lineSizer</span><span class="p">)</span>
            <span class="n">showSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="n">lineSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">showABC</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Show view point?&#39;</span><span class="p">)</span>
            <span class="n">showABC</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnShowABC</span><span class="p">)</span>
            <span class="n">showABC</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showABC&#39;</span><span class="p">])</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">showABC</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; View Point:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">VP</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">viewPoint</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">VP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VP</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">VP</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;viewPoint&#39;</span><span class="p">)</span>
            <span class="n">viewPoint</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnViewPoint</span><span class="p">)</span>
            <span class="n">viewPoint</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnViewPoint</span><span class="p">)</span>
            <span class="n">lineSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">viewPoint</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">showSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">lineSizer</span><span class="p">)</span>
            <span class="n">showSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="n">line2Sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
    
            <span class="n">unitCellBox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Show unit cell?&#39;</span><span class="p">)</span>
            <span class="n">unitCellBox</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnShowUnitCell</span><span class="p">)</span>
            <span class="n">unitCellBox</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;unitCellBox&#39;</span><span class="p">])</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">unitCellBox</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
    
            <span class="n">showHydrogen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Show hydrogens?&#39;</span><span class="p">)</span>
            <span class="n">showHydrogen</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnShowHyd</span><span class="p">)</span>
            <span class="n">showHydrogen</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showHydrogen&#39;</span><span class="p">])</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">showHydrogen</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            
            <span class="n">showRB</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Show rigid Bodies?&#39;</span><span class="p">)</span>
            <span class="n">showRB</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnShowRB</span><span class="p">)</span>
            <span class="n">showRB</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showRigidBodies&#39;</span><span class="p">])</span>
            <span class="n">line2Sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">showRB</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            
            <span class="n">showSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">line2Sizer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">showSizer</span>
            
        <span class="k">def</span> <span class="nf">RadSizer</span><span class="p">():</span>
            
            <span class="k">def</span> <span class="nf">OnSizeHatoms</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">sizeH</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;sizeH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">sizeH</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnRadFactor</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">radFactor</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="mf">0.85</span>
                <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;radiusFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">radFactor</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%.2f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="n">FindBondsDraw</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
            <span class="n">radSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">radSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Hydrogen radius, A:  &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">sizeH</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;sizeH&#39;</span><span class="p">]),</span><span class="n">size</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">sizeH</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnSizeHatoms</span><span class="p">)</span>
            <span class="n">sizeH</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnSizeHatoms</span><span class="p">)</span>
            <span class="n">radSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">sizeH</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
    
            <span class="n">radSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Bond search factor:  &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">radFactor</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;radiusFactor&#39;</span><span class="p">]),</span><span class="n">size</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">Size</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">radFactor</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnRadFactor</span><span class="p">)</span>
            <span class="n">radFactor</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnRadFactor</span><span class="p">)</span>
            <span class="n">radSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">radFactor</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">radSizer</span>

        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">drawOptions</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">drawOptions</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dataDisplay</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Drawing controls:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>        
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">SlopSizer</span><span class="p">(),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ShowSizer</span><span class="p">(),</span><span class="mi">0</span><span class="p">,)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">RadSizer</span><span class="p">(),</span><span class="mi">0</span><span class="p">,)</span>

        <span class="n">dataDisplay</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">35</span>                           <span class="c">#compensate for status bar</span>
        <span class="n">dataDisplay</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>

<span class="c">################################################################################</span>
<span class="c">####  Texture routines</span>
<span class="c">################################################################################</span>
        
    <span class="k">def</span> <span class="nf">UpdateTexture</span><span class="p">():</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>        
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">textureData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>            <span class="c">#fix old files!</span>
            <span class="n">textureData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Order&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;Model&#39;</span><span class="p">:</span><span class="s">&#39;cylindrical&#39;</span><span class="p">,</span>
                <span class="s">&#39;Sample omega&#39;</span><span class="p">:[</span><span class="bp">False</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="s">&#39;Sample chi&#39;</span><span class="p">:[</span><span class="bp">False</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span><span class="s">&#39;Sample phi&#39;</span><span class="p">:[</span><span class="bp">False</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span>
                <span class="s">&#39;SH Coeff&#39;</span><span class="p">:[</span><span class="bp">False</span><span class="p">,{}],</span><span class="s">&#39;SHShow&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;PFhkl&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                <span class="s">&#39;PFxyz&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span><span class="s">&#39;PlotType&#39;</span><span class="p">:</span><span class="s">&#39;Pole figure&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="s">&#39;SHShow&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">textureData</span><span class="p">:</span>     <span class="c">#another fix</span>
            <span class="n">textureData</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;SHShow&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;PFhkl&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;PFxyz&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span><span class="s">&#39;PlotType&#39;</span><span class="p">:</span><span class="s">&#39;Pole figure&#39;</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>                        <span class="c">#another fix!</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">textureData</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;PFxyz&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span><span class="s">&#39;PlotType&#39;</span><span class="p">:</span><span class="s">&#39;Pole figure&#39;</span><span class="p">})</span>
        <span class="n">shModels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;cylindrical&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="s">&#39;shear - 2/m&#39;</span><span class="p">,</span><span class="s">&#39;rolling - mmm&#39;</span><span class="p">]</span>
        <span class="n">SamSym</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">shModels</span><span class="p">,[</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;-1&#39;</span><span class="p">,</span><span class="s">&#39;2/m&#39;</span><span class="p">,</span><span class="s">&#39;mmm&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;doPawley&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Sequental results&#39;</span><span class="p">):</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RefineTexture</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">shAngles</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;omega&#39;</span><span class="p">,</span><span class="s">&#39;chi&#39;</span><span class="p">,</span><span class="s">&#39;phi&#39;</span><span class="p">]</span>
        
        <span class="k">def</span> <span class="nf">SetSHCoef</span><span class="p">():</span>
            <span class="n">cofNames</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">GenSHCoeff</span><span class="p">(</span><span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">],</span><span class="n">SamSym</span><span class="p">[</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">]],</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Order&#39;</span><span class="p">])</span>
            <span class="n">newSHCoef</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cofNames</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cofNames</span><span class="p">))))</span>
            <span class="n">SHCoeff</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cofName</span> <span class="ow">in</span> <span class="n">SHCoeff</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cofName</span> <span class="ow">in</span>  <span class="n">cofNames</span><span class="p">:</span>
                    <span class="n">newSHCoef</span><span class="p">[</span><span class="n">cofName</span><span class="p">]</span> <span class="o">=</span> <span class="n">SHCoeff</span><span class="p">[</span><span class="n">cofName</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">newSHCoef</span>
        
        <span class="k">def</span> <span class="nf">OnShOrder</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
            <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetSHCoef</span><span class="p">()</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateTexture</span><span class="p">)</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                        
        <span class="k">def</span> <span class="nf">OnShModel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SetSHCoef</span><span class="p">()</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateTexture</span><span class="p">)</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">OnSHRefine</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            
        <span class="k">def</span> <span class="nf">OnSHShow</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SHShow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateTexture</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">OnProjSel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">Projection</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">OnColorSel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">OnAngRef</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">textureData</span><span class="p">[</span><span class="n">angIndx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            
        <span class="k">def</span> <span class="nf">OnAngValue</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span>  <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="n">valIndx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">textureData</span><span class="p">[</span><span class="n">valIndx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
        <span class="k">def</span> <span class="nf">OnODFValue</span><span class="p">(</span><span class="n">event</span><span class="p">):</span> 
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span>  <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">ODFIndx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]]</span>
            <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">ODFIndx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">OnPfType</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateTexture</span><span class="p">)</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">OnPFValue</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">Saxis</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Pole figure&#39;</span><span class="p">,</span><span class="s">&#39;Axial pole distribution&#39;</span><span class="p">]:</span>                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hkl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">Saxis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">):</span>
                    <span class="n">hkl</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PFhkl&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hkl</span><span class="p">)):</span>       <span class="c">#can&#39;t be all zeros!</span>
                    <span class="n">hkl</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PFhkl&#39;</span><span class="p">]</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hkl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">hkl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">hkl</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PFhkl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hkl</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">Saxis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">):</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PFxyz&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyz</span><span class="p">)):</span>       <span class="c">#can&#39;t be all zeros!</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PFxyz&#39;</span><span class="p">]</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%3.1f</span><span class="s"> </span><span class="si">%3.1f</span><span class="s"> </span><span class="si">%3.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PFxyz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Texture</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">():</span>
            <span class="n">Texture</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">()</span><span class="o">.</span><span class="n">Clear</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">titleSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
        <span class="n">titleSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Spherical harmonics texture data for &#39;</span><span class="o">+</span><span class="n">PhaseName</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">titleSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="s">&#39; Texture Index J = </span><span class="si">%7.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">G2lat</span><span class="o">.</span><span class="n">textureIndex</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))),</span>
            <span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">titleSizer</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">shSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">shSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Texture model: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">shModel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">shModels</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
        <span class="n">shModel</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnShModel</span><span class="p">)</span>
        <span class="n">shSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">shModel</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">shSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;  Harmonic order: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">shOrder</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Order&#39;</span><span class="p">]),</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">18</span><span class="p">)],</span>
            <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
        <span class="n">shOrder</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnShOrder</span><span class="p">)</span>
        <span class="n">shSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">shOrder</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">shRef</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Refine texture?&#39;</span><span class="p">)</span>
        <span class="n">shRef</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">shRef</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnSHRefine</span><span class="p">)</span>
        <span class="n">shSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">shRef</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">shShow</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Show coeff.?&#39;</span><span class="p">)</span>
        <span class="n">shShow</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SHShow&#39;</span><span class="p">])</span>
        <span class="n">shShow</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnSHShow</span><span class="p">)</span>
        <span class="n">shSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">shShow</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">shSizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">PTSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Texture plot type: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Axial pole distribution&#39;</span><span class="p">,</span><span class="s">&#39;Pole figure&#39;</span><span class="p">,</span><span class="s">&#39;Inverse pole figure&#39;</span><span class="p">]</span>            
        <span class="n">pfType</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]),</span><span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
        <span class="n">pfType</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnPfType</span><span class="p">)</span>
        <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pfType</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Axial&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]:</span>
            <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Projection type: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">projSel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Projection</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;equal area&#39;</span><span class="p">,</span><span class="s">&#39;stereographic&#39;</span><span class="p">,</span><span class="s">&#39;3D display&#39;</span><span class="p">],</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">projSel</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnProjSel</span><span class="p">)</span>
            <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">projSel</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Pole figure&#39;</span><span class="p">,</span><span class="s">&#39;Axial pole distribution&#39;</span><span class="p">]:</span>
            <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Pole figure HKL: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">PH</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PFhkl&#39;</span><span class="p">]</span>
            <span class="n">pfVal</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">PH</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">PH</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">PH</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Inverse pole figure XYZ: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">PX</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PFxyz&#39;</span><span class="p">]</span>
            <span class="n">pfVal</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%3.1f</span><span class="s"> </span><span class="si">%3.1f</span><span class="s"> </span><span class="si">%3.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">PX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">PX</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">PX</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
        <span class="n">pfVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnPFValue</span><span class="p">)</span>
        <span class="n">pfVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnPFValue</span><span class="p">)</span>
        <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">pfVal</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Axial&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]:</span>
            <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Color scheme&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">datad</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;_r&quot;</span><span class="p">)]</span>
            <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">colorSel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="n">choice</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">colorSel</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnColorSel</span><span class="p">)</span>
            <span class="n">PTSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">colorSel</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>        
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">PTSizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SHShow&#39;</span><span class="p">]:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Spherical harmonic coefficients: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ODFSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ODFIndx</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ODFkeys</span> <span class="o">=</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">ODFkeys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ODFkeys</span><span class="p">:</span>
                <span class="n">ODFSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">item</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">ODFval</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%8.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">item</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                <span class="n">ODFIndx</span><span class="p">[</span><span class="n">ODFval</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">item</span>
                <span class="n">ODFval</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnODFValue</span><span class="p">)</span>
                <span class="n">ODFval</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnODFValue</span><span class="p">)</span>
                <span class="n">ODFSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ODFval</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ODFSizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Sample orientation angles: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">angSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
        <span class="n">angIndx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">valIndx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Sample omega&#39;</span><span class="p">,</span><span class="s">&#39;Sample chi&#39;</span><span class="p">,</span><span class="s">&#39;Sample phi&#39;</span><span class="p">]:</span>
            <span class="n">angRef</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">item</span><span class="o">+</span><span class="s">&#39;: &#39;</span><span class="p">)</span>
            <span class="n">angRef</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">angIndx</span><span class="p">[</span><span class="n">angRef</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">angRef</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnAngRef</span><span class="p">)</span>
            <span class="n">angSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">angRef</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">angVal</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%8.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">valIndx</span><span class="p">[</span><span class="n">angVal</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">angVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnAngValue</span><span class="p">)</span>
            <span class="n">angVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnAngValue</span><span class="p">)</span>
            <span class="n">angSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">angVal</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">angSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">angSizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">Texture</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">GetMinSize</span><span class="p">()</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">40</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">250</span><span class="p">)</span> <span class="o">+</span> <span class="mi">35</span>
        <span class="n">Texture</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">Texture</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">450</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>

<span class="c">################################################################################</span>
<span class="c">##### DData routines - GUI stuff in GSASIIddataGUI.py</span>
<span class="c">################################################################################</span>
        
    <span class="k">def</span> <span class="nf">OnHklfAdd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">UseList</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span>
        <span class="n">keyList</span> <span class="o">=</span> <span class="n">UseList</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">TextList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetCount</span><span class="p">():</span>
            <span class="n">item</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetFirstChild</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyList</span> <span class="ow">and</span> <span class="s">&#39;HKLF&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">TextList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetNextChild</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>                        
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span> <span class="s">&#39;Which new data to use?&#39;</span><span class="p">,</span> <span class="s">&#39;Use data&#39;</span><span class="p">,</span> <span class="n">TextList</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CHOICEDLG_STYLE</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">histoName</span> <span class="o">=</span> <span class="n">TextList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">UseList</span><span class="p">[</span><span class="n">histoName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Histogram&#39;</span><span class="p">:</span><span class="n">histoName</span><span class="p">,</span><span class="s">&#39;Show&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;Scale&#39;</span><span class="p">:[</span><span class="mf">1.0</span><span class="p">,</span><span class="bp">True</span><span class="p">],</span>
                            <span class="s">&#39;Babinet&#39;</span><span class="p">:{</span><span class="s">&#39;BabA&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">False</span><span class="p">],</span><span class="s">&#39;BabU&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">False</span><span class="p">]},</span>
                            <span class="s">&#39;Extinction&#39;</span><span class="p">:[</span><span class="s">&#39;Lorentzian&#39;</span><span class="p">,</span><span class="s">&#39;None&#39;</span><span class="p">,</span>
                            <span class="p">{</span><span class="s">&#39;Tbar&#39;</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span><span class="s">&#39;Cos2TM&#39;</span><span class="p">:</span><span class="mf">0.955</span><span class="p">,</span><span class="s">&#39;Eg&#39;</span><span class="p">:[</span><span class="mf">1.e-10</span><span class="p">,</span><span class="bp">False</span><span class="p">],</span><span class="s">&#39;Es&#39;</span><span class="p">:[</span><span class="mf">1.e-10</span><span class="p">,</span><span class="bp">False</span><span class="p">],</span><span class="s">&#39;Ep&#39;</span><span class="p">:[</span><span class="mf">1.e-10</span><span class="p">,</span><span class="bp">False</span><span class="p">]},]}</span>                        
                        <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
                        <span class="n">UpdateHKLFdata</span><span class="p">(</span><span class="n">histoName</span><span class="p">)</span>
                        <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseList</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">G2ddG</span><span class="o">.</span><span class="n">UpdateDData</span><span class="p">,</span><span class="n">G2frame</span><span class="p">,</span><span class="n">DData</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">UpdateHKLFdata</span><span class="p">(</span><span class="n">histoName</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">histoName</span><span class="p">)</span>
        <span class="n">reflData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">Id</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">Cell</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">G</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2Gmat</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">reflData</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">G2lat</span><span class="o">.</span><span class="n">calc_rDsq2</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">G</span><span class="p">))</span>
            <span class="n">iabsnt</span><span class="p">,</span><span class="n">ref</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">ref</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span><span class="n">ref</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GenHKLf</span><span class="p">(</span><span class="n">H</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">SetItemPyData</span><span class="p">(</span><span class="n">Id</span><span class="p">,[</span><span class="n">histoName</span><span class="p">,</span><span class="n">reflData</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">OnPwdrAdd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">UseList</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span>
        <span class="n">newList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">NShkl</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">G2spc</span><span class="o">.</span><span class="n">MustrainNames</span><span class="p">(</span><span class="n">SGData</span><span class="p">))</span>
        <span class="n">NDij</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">G2spc</span><span class="o">.</span><span class="n">HStrainNames</span><span class="p">(</span><span class="n">SGData</span><span class="p">))</span>
        <span class="n">keyList</span> <span class="o">=</span> <span class="n">UseList</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">TextList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;All PWDR&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetCount</span><span class="p">():</span>
            <span class="n">item</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetFirstChild</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keyList</span> <span class="ow">and</span> <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">TextList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetNextChild</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span> <span class="s">&#39;Which new data to use?&#39;</span><span class="p">,</span> <span class="s">&#39;Use data&#39;</span><span class="p">,</span> <span class="n">TextList</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CHOICEDLG_STYLE</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span> <span class="n">newList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TextList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s">&#39;All PWDR&#39;</span> <span class="ow">in</span> <span class="n">newList</span><span class="p">:</span>
                        <span class="n">newList</span> <span class="o">=</span> <span class="n">TextList</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">for</span> <span class="n">histoName</span> <span class="ow">in</span> <span class="n">newList</span><span class="p">:</span>
                        <span class="n">pId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">histoName</span><span class="p">)</span>
                        <span class="n">UseList</span><span class="p">[</span><span class="n">histoName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Histogram&#39;</span><span class="p">:</span><span class="n">histoName</span><span class="p">,</span><span class="s">&#39;Show&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                            <span class="s">&#39;Scale&#39;</span><span class="p">:[</span><span class="mf">1.0</span><span class="p">,</span><span class="bp">False</span><span class="p">],</span><span class="s">&#39;Pref.Ori.&#39;</span><span class="p">:[</span><span class="s">&#39;MD&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="bp">False</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">,{}],</span>
                            <span class="s">&#39;Size&#39;</span><span class="p">:[</span><span class="s">&#39;isotropic&#39;</span><span class="p">,[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],[</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span><span class="mi">6</span><span class="o">*</span><span class="p">[</span><span class="bp">False</span><span class="p">,]],</span>
                            <span class="s">&#39;Mustrain&#39;</span><span class="p">:[</span><span class="s">&#39;isotropic&#39;</span><span class="p">,[</span><span class="mf">1000.0</span><span class="p">,</span><span class="mf">1000.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],[</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">NShkl</span><span class="o">*</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,],</span><span class="n">NShkl</span><span class="o">*</span><span class="p">[</span><span class="bp">False</span><span class="p">,]],</span>
                            <span class="s">&#39;HStrain&#39;</span><span class="p">:[</span><span class="n">NDij</span><span class="o">*</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,],</span><span class="n">NDij</span><span class="o">*</span><span class="p">[</span><span class="bp">False</span><span class="p">,]],</span>                          
                            <span class="s">&#39;Extinction&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">False</span><span class="p">],</span><span class="s">&#39;Babinet&#39;</span><span class="p">:{</span><span class="s">&#39;BabA&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">False</span><span class="p">],</span><span class="s">&#39;BabU&#39;</span><span class="p">:[</span><span class="mf">0.0</span><span class="p">,</span><span class="bp">False</span><span class="p">]}}</span>
                        <span class="n">refList</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">pId</span><span class="p">,</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">))</span>
                        <span class="n">refList</span><span class="p">[</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>                       
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UseList</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">G2ddG</span><span class="o">.</span><span class="n">UpdateDData</span><span class="p">,</span><span class="n">G2frame</span><span class="p">,</span><span class="n">DData</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">OnDataDelete</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">UseList</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span>
        <span class="n">keyList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;All&#39;</span><span class="p">,]</span><span class="o">+</span><span class="n">UseList</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">keyList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">DelList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">UseList</span><span class="p">:</span>
            <span class="n">DelList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span> 
                <span class="s">&#39;Which histogram to delete from this phase?&#39;</span><span class="p">,</span> <span class="s">&#39;Delete histogram&#39;</span><span class="p">,</span> 
                <span class="n">keyList</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CHOICEDLG_STYLE</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span> 
                        <span class="n">DelList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">keyList</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s">&#39;All&#39;</span> <span class="ow">in</span> <span class="n">DelList</span><span class="p">:</span>
                        <span class="n">DelList</span> <span class="o">=</span> <span class="n">keyList</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">DelList</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">UseList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">G2ddG</span><span class="o">.</span><span class="n">UpdateDData</span><span class="p">,</span><span class="n">G2frame</span><span class="p">,</span><span class="n">DData</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                
<span class="c">################################################################################</span>
<span class="c">##### Rigid bodies</span>
<span class="c">################################################################################</span>

    <span class="k">def</span> <span class="nf">FillRigidBodyGrid</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="n">RigidBodies</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">AtLookUp</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FillAtomLookUp</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">])</span>
        <span class="n">general</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">general</span><span class="p">[</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">general</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">RBData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>   
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Rigid bodies&#39;</span><span class="p">))</span>
        <span class="n">Indx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">atomStyle</span> <span class="o">=</span> <span class="s">&#39;balls &amp; sticks&#39;</span>
        <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">general</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
            <span class="n">atomStyle</span> <span class="o">=</span> <span class="s">&#39;sticks&#39;</span>
        
        <span class="k">def</span> <span class="nf">OnThermSel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>       <span class="c">#needs to be seen by VecRbSizer!</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">RBObj</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;Uiso&#39;</span><span class="p">:</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Uiso&#39;</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span><span class="p">:</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;T&#39;</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;TL&#39;</span><span class="p">:</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;TL&#39;</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;TLS&#39;</span><span class="p">:</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;TLS&#39;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">FillRigidBodyGrid</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">ThermDataSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">):</span>
            
            <span class="k">def</span> <span class="nf">OnThermval</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">item</span><span class="p">]))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnTLSRef</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            
            <span class="n">thermSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Uiso&#39;</span><span class="p">:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Uiso&#39;</span><span class="p">,]</span>
            <span class="k">elif</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;T11&#39;</span><span class="p">,</span><span class="s">&#39;T22&#39;</span><span class="p">,</span><span class="s">&#39;T33&#39;</span><span class="p">,</span><span class="s">&#39;T12&#39;</span><span class="p">,</span><span class="s">&#39;T13&#39;</span><span class="p">,</span><span class="s">&#39;T23&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;L&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;L11&#39;</span><span class="p">,</span><span class="s">&#39;L22&#39;</span><span class="p">,</span><span class="s">&#39;L33&#39;</span><span class="p">,</span><span class="s">&#39;L12&#39;</span><span class="p">,</span><span class="s">&#39;L13&#39;</span><span class="p">,</span><span class="s">&#39;L23&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;S12&#39;</span><span class="p">,</span><span class="s">&#39;S13&#39;</span><span class="p">,</span><span class="s">&#39;S21&#39;</span><span class="p">,</span><span class="s">&#39;S23&#39;</span><span class="p">,</span><span class="s">&#39;S31&#39;</span><span class="p">,</span><span class="s">&#39;S32&#39;</span><span class="p">,</span><span class="s">&#39;SAA&#39;</span><span class="p">,</span><span class="s">&#39;SBB&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">thermVal</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%8.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                <span class="n">thermVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnThermval</span><span class="p">)</span>
                <span class="n">thermVal</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnThermval</span><span class="p">)</span>
                <span class="n">Indx</span><span class="p">[</span><span class="n">thermVal</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">thermVal</span><span class="p">)</span>
                <span class="n">Tcheck</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Refine?&#39;</span><span class="p">)</span>
                <span class="n">Tcheck</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span><span class="n">OnTLSRef</span><span class="p">)</span>
                <span class="n">Tcheck</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                <span class="n">Indx</span><span class="p">[</span><span class="n">Tcheck</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Tcheck</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">thermSizer</span>
            
        <span class="k">def</span> <span class="nf">LocationSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">,</span><span class="n">rbType</span><span class="p">):</span>
            
            <span class="k">def</span> <span class="nf">OnOrigRef</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ocheck</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
             
            <span class="k">def</span> <span class="nf">OnOrienRef</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Qcheck</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                
            <span class="k">def</span> <span class="nf">OnOrigX</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="n">newXYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="n">rbType</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]):</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">][</span><span class="n">AtLookUp</span><span class="p">[</span><span class="nb">id</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">newXYZ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">UpdateDrawAtoms</span><span class="p">(</span><span class="n">atomStyle</span><span class="p">)</span>
                    <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                
            <span class="k">def</span> <span class="nf">OnOrien</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">A</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">Q2AVdeg</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
                        <span class="n">V</span><span class="p">[</span><span class="n">item</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">A</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">Q</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span>
                    <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>
                    <span class="n">newXYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="n">rbType</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]):</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">][</span><span class="n">AtLookUp</span><span class="p">[</span><span class="nb">id</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">newXYZ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">UpdateDrawAtoms</span><span class="p">(</span><span class="n">atomStyle</span><span class="p">)</span>
                    <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                
            <span class="n">topSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">Orig</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Orien</span><span class="p">,</span><span class="n">OrienV</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">Q2AVdeg</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Orien</span> <span class="o">=</span> <span class="p">[</span><span class="n">Orien</span><span class="p">,]</span>
            <span class="n">Orien</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">OrienV</span><span class="o">/</span><span class="n">nl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">OrienV</span><span class="p">))</span>
            <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Origin x,y,z:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Orig</span><span class="p">):</span>
                <span class="n">origX</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%8.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                <span class="n">origX</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnOrigX</span><span class="p">)</span>
                <span class="n">origX</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnOrigX</span><span class="p">)</span>
                <span class="n">Indx</span><span class="p">[</span><span class="n">origX</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ix</span>
                <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">origX</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">),)</span>
            <span class="n">Ocheck</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Refine?&#39;</span><span class="p">)</span>
            <span class="n">Ocheck</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span><span class="n">OnOrigRef</span><span class="p">)</span>
            <span class="n">Ocheck</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Ocheck</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Rotation angle, vector:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Orien</span><span class="p">):</span>
                <span class="n">orien</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%8.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                <span class="n">orien</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnOrien</span><span class="p">)</span>
                <span class="n">orien</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnOrien</span><span class="p">)</span>
                <span class="n">Indx</span><span class="p">[</span><span class="n">orien</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">ix</span>
                <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">orien</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">Qcheck</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;AV&#39;</span><span class="p">],</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">Qcheck</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnOrienRef</span><span class="p">)</span>
            <span class="n">Qcheck</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Qcheck</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">topSizer</span>
                         
        <span class="k">def</span> <span class="nf">ResrbSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">):</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;NB: Rotation vector is in crystallographic space&#39;</span><span class="p">)</span>
             
            <span class="k">def</span> <span class="nf">OnTorsionRef</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>                
                
            <span class="k">def</span> <span class="nf">OnTorsion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                    <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="n">newXYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]):</span>
                        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">][</span><span class="n">AtLookUp</span><span class="p">[</span><span class="nb">id</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">newXYZ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%10.3f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>                
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">UpdateDrawAtoms</span><span class="p">(</span><span class="n">atomStyle</span><span class="p">)</span>
                <span class="n">drawAtoms</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnDelResRB</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">RBId</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="n">RBId</span><span class="p">][</span><span class="s">&#39;useCount&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">RBObjs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">rbObj</span> <span class="ow">in</span> <span class="n">RBObjs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">RBId</span> <span class="o">==</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]:</span>
                       <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rbObj</span><span class="p">)</span>                 
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">FillRigidBodyGrid</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                
            <span class="n">resrbSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">resrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">120</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">))</span>
            <span class="n">topLine</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">topLine</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s">&#39;Name: &#39;</span><span class="o">+</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBname&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;numChain&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;   &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">rbId</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]</span>
            <span class="n">delRB</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Delete?&#39;</span><span class="p">)</span>
            <span class="n">delRB</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span><span class="n">OnDelResRB</span><span class="p">)</span>
            <span class="n">Indx</span><span class="p">[</span><span class="n">delRB</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">rbId</span>
            <span class="n">topLine</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">delRB</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">resrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">topLine</span><span class="p">)</span>
            <span class="n">resrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">LocationSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">))</span>
            <span class="n">resrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Torsions:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">torSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">itors</span><span class="p">,</span><span class="n">tors</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]):</span>
                <span class="n">torSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Torsion &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">itors</span><span class="p">)),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">torsTxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tors</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                <span class="n">torsTxt</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnTorsion</span><span class="p">)</span>
                <span class="n">torsTxt</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnTorsion</span><span class="p">)</span>
                <span class="n">Indx</span><span class="p">[</span><span class="n">torsTxt</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">itors</span>
                <span class="n">torSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">torsTxt</span><span class="p">)</span>
                <span class="n">torCheck</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Refine?&#39;</span><span class="p">)</span>
                <span class="n">torCheck</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span><span class="n">OnTorsionRef</span><span class="p">)</span>
                <span class="n">torCheck</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">tors</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">Indx</span><span class="p">[</span><span class="n">torCheck</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">itors</span>
                <span class="n">torSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">torCheck</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">resrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">torSizer</span><span class="p">)</span>
            <span class="n">tchoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;None&#39;</span><span class="p">,</span><span class="s">&#39;Uiso&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;TL&#39;</span><span class="p">,</span><span class="s">&#39;TLS&#39;</span><span class="p">]</span>
            <span class="n">thermSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Rigid body thermal motion model: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">thermSel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">tchoice</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">Indx</span><span class="p">[</span><span class="n">thermSel</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">RBObj</span>
            <span class="n">thermSel</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnThermSel</span><span class="p">)</span>
            <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">thermSel</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Units: T A^2, L deg^2, S deg-A&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">resrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">thermSizer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">resrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ThermDataSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">resrbSizer</span>
            
        <span class="k">def</span> <span class="nf">VecrbSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">):</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;NB: Rotation vector is in crystallographic space&#39;</span><span class="p">)</span>
                   
            <span class="k">def</span> <span class="nf">OnDelVecRB</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">RBId</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">][</span><span class="n">RBId</span><span class="p">][</span><span class="s">&#39;useCount&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>                
                <span class="n">RBObjs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Vector&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">rbObj</span> <span class="ow">in</span> <span class="n">RBObjs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">RBId</span> <span class="o">==</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]:</span>
                       <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Vector&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rbObj</span><span class="p">)</span>                 
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">FillRigidBodyGrid</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
             
            <span class="n">vecrbSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">vecrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">120</span><span class="o">*</span><span class="s">&#39;-&#39;</span><span class="p">))</span>
            <span class="n">topLine</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">topLine</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="s">&#39;Name: &#39;</span><span class="o">+</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBname&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;   &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">rbId</span> <span class="o">=</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]</span>
            <span class="n">delRB</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Delete?&#39;</span><span class="p">)</span>
            <span class="n">delRB</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span><span class="n">OnDelVecRB</span><span class="p">)</span>
            <span class="n">Indx</span><span class="p">[</span><span class="n">delRB</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">rbId</span>
            <span class="n">topLine</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">delRB</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">vecrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">topLine</span><span class="p">)</span>
            <span class="n">vecrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">LocationSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">,</span><span class="s">&#39;Vector&#39;</span><span class="p">))</span>
            <span class="n">tchoice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;None&#39;</span><span class="p">,</span><span class="s">&#39;Uiso&#39;</span><span class="p">,</span><span class="s">&#39;T&#39;</span><span class="p">,</span><span class="s">&#39;TL&#39;</span><span class="p">,</span><span class="s">&#39;TLS&#39;</span><span class="p">]</span>
            <span class="n">thermSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Rigid body thermal motion model: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">thermSel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">choices</span><span class="o">=</span><span class="n">tchoice</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
            <span class="n">Indx</span><span class="p">[</span><span class="n">thermSel</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">RBObj</span>
            <span class="n">thermSel</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span><span class="n">OnThermSel</span><span class="p">)</span>
            <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">thermSel</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">thermSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Units: T A^2, L deg^2, S deg-A&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">vecrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">thermSizer</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;None&#39;</span><span class="p">:</span>
                <span class="n">vecrbSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ThermDataSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">vecrbSizer</span>                
        
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No rigid body models:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Residue&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Residue rigid bodies:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">RBObj</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Residue&#39;</span><span class="p">]:</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ResrbSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">))</span>
        <span class="k">if</span> <span class="s">&#39;Vector&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Vector rigid bodies:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">RBObj</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Vector&#39;</span><span class="p">]:</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">VecrbSizer</span><span class="p">(</span><span class="n">RBObj</span><span class="p">))</span>

        <span class="n">RigidBodies</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">FitInside</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">GetMinSize</span><span class="p">()</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">40</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">290</span><span class="p">)</span> <span class="o">+</span> <span class="mi">35</span>
        <span class="n">RigidBodies</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">RigidBodies</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">450</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnRBCopyParms</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">RBObjs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rbType</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">]:</span>            
            <span class="n">RBObjs</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rbType</span><span class="p">,[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">RBObjs</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - no rigid bodies defined ****&#39;</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">RBObjs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** INFO - only one rigid body defined; nothing to copy to ****&#39;</span>
            <span class="k">return</span>
        <span class="n">Source</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sourceRB</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">RBObj</span> <span class="ow">in</span> <span class="n">RBObjs</span><span class="p">:</span>
            <span class="n">Source</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;RBname&#39;</span><span class="p">])</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select source&#39;</span><span class="p">,</span><span class="s">&#39;Copy rigid body parameters&#39;</span><span class="p">,</span><span class="n">Source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">Source</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">,</span><span class="s">&#39;Orient&#39;</span><span class="p">,</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">]:</span> 
                <span class="n">sourceRB</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">item</span><span class="p">:</span><span class="n">RBObjs</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="n">item</span><span class="p">],})</span>
        <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sourceRB</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select targets&#39;</span><span class="p">,</span><span class="s">&#39;Copy rigid body parameters&#39;</span><span class="p">,</span><span class="n">Source</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                <span class="n">RBObjs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">sourceRB</span><span class="p">))</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">FillRigidBodyGrid</span><span class="p">(</span><span class="bp">True</span><span class="p">))</span>
                
    <span class="k">def</span> <span class="nf">OnRBAssign</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">RBData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>   
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Rigid bodies&#39;</span><span class="p">))</span>
        <span class="n">rbNames</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">rbVec</span> <span class="ow">in</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rbVec</span> <span class="o">!=</span> <span class="s">&#39;AtInfo&#39;</span><span class="p">:</span>
                <span class="n">rbNames</span><span class="p">[</span><span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">][</span><span class="n">rbVec</span><span class="p">][</span><span class="s">&#39;RBname&#39;</span><span class="p">]]</span> <span class="o">=</span><span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">,</span><span class="n">rbVec</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">rbRes</span> <span class="ow">in</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rbRes</span> <span class="o">!=</span> <span class="s">&#39;AtInfo&#39;</span><span class="p">:</span>
                <span class="n">rbNames</span><span class="p">[</span><span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="n">rbRes</span><span class="p">][</span><span class="s">&#39;RBname&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">,</span><span class="n">rbRes</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rbNames</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - no rigid bodies defined ****&#39;</span>
            <span class="k">return</span>
        <span class="n">general</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">general</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span> <span class="o">=</span> <span class="n">general</span><span class="p">[</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">Indx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">atInd</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            
        <span class="k">def</span> <span class="nf">Draw</span><span class="p">():</span>
            
            <span class="k">def</span> <span class="nf">OnOk</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">rbType</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbType&#39;</span><span class="p">]</span>
                <span class="n">RBObjs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rbType</span><span class="p">,[])</span>
                <span class="n">rbObj</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">]</span>
                <span class="n">rbId</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]</span>
                <span class="n">newXYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">rbObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="n">rbType</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">dmax</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">oldXYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getAtomXYZ</span><span class="p">(</span><span class="n">atomData</span><span class="p">,</span><span class="n">cx</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="n">newXYZ</span><span class="p">:</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetXYZDist</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">oldXYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                    <span class="n">dmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dist</span><span class="p">))</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
                    <span class="n">Ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">atomData</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
                <span class="k">if</span> <span class="n">dmax</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;**** WARNING - some atoms not found or misidentified ****&#39;</span>
                    <span class="k">print</span> <span class="s">&#39;****           check torsion angles &amp; try again      ****&#39;</span>
                    <span class="n">OkBtn</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;Not Ready&#39;</span><span class="p">)</span>
                    <span class="n">OkBtn</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ids</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;None&#39;</span><span class="p">,[</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)],[</span><span class="bp">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]]</span> <span class="c">#type,values,flags</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBname&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;useCount&#39;</span><span class="p">])</span>
                <span class="n">RBObjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbObj</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="n">rbType</span><span class="p">]</span> <span class="o">=</span> <span class="n">RBObjs</span>
                <span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;useCount&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">]</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="n">FillRigidBodyGrid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnCancel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">]</span>
                <span class="n">FillRigidBodyGrid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnRBSel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">rbSel</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">rbType</span><span class="p">,</span><span class="n">rbId</span> <span class="o">=</span> <span class="n">rbNames</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbAtTypes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;rbTypes&#39;</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;AtInfo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="s">&#39;AtInfo&#39;</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbType</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RBData</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;Sizers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">rbRef</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;rbRef&#39;</span><span class="p">]</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbRef&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbRef</span>
                <span class="n">refType</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">refName</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">rbRef</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="n">reftype</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbAtTypes&#39;</span><span class="p">][</span><span class="n">ref</span><span class="p">]</span>
                    <span class="n">refType</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reftype</span><span class="p">)</span>
                    <span class="n">refName</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reftype</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">atNames</span><span class="p">,</span><span class="n">AtNames</span> <span class="o">=</span> <span class="n">fillAtNames</span><span class="p">(</span><span class="n">refType</span><span class="p">,</span><span class="n">atomData</span><span class="p">,</span><span class="n">ct</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;atNames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atNames</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;AtNames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">AtNames</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Orig&#39;</span><span class="p">:[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="bp">False</span><span class="p">],</span>
                    <span class="s">&#39;Orient&#39;</span><span class="p">:[[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span><span class="s">&#39; &#39;</span><span class="p">],</span><span class="s">&#39;Ids&#39;</span><span class="p">:[],</span><span class="s">&#39;RBId&#39;</span><span class="p">:</span><span class="n">rbId</span><span class="p">,</span><span class="s">&#39;Torsions&#39;</span><span class="p">:[],</span>
                    <span class="s">&#39;numChain&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;RBname&#39;</span><span class="p">:</span><span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;RBname&#39;</span><span class="p">]}</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;torAtms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>                
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="n">rbId</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;rbSeq&#39;</span><span class="p">,[]):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Torsions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="bp">False</span><span class="p">])</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;torAtms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">Draw</span><span class="p">()</span>
                
            <span class="k">def</span> <span class="nf">fillAtNames</span><span class="p">(</span><span class="n">refType</span><span class="p">,</span><span class="n">atomData</span><span class="p">,</span><span class="n">ct</span><span class="p">):</span>
                <span class="n">atNames</span> <span class="o">=</span> <span class="p">[{},{},{}]</span>
                <span class="n">AtNames</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">iatm</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomData</span><span class="p">):</span>
                    <span class="n">AtNames</span><span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iatm</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">reftype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">refType</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">==</span> <span class="n">reftype</span><span class="p">:</span>
                            <span class="n">atNames</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iatm</span>
                <span class="k">return</span> <span class="n">atNames</span><span class="p">,</span><span class="n">AtNames</span>
                
            <span class="k">def</span> <span class="nf">OnAtOrigPick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">atName</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">rbType</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbType&#39;</span><span class="p">]</span>
                <span class="n">atInd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">atNames</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">atName</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;Vector&#39;</span> <span class="ow">in</span> <span class="n">rbType</span><span class="p">:</span>
                    <span class="n">rbObj</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">]</span>
                    <span class="n">rbId</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]</span>
                    <span class="n">rbRef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbRef&#39;</span><span class="p">]</span>
                    <span class="n">rbXYZ</span> <span class="o">=</span> <span class="o">-</span><span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">]</span>
                    <span class="n">nref</span> <span class="o">=</span> <span class="n">atNames</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">atName</span><span class="p">]</span>
                    <span class="n">Oxyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rbXYZ</span><span class="p">[</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
                    <span class="n">Nxyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">nref</span><span class="p">][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">Orig</span> <span class="o">=</span> <span class="n">Nxyz</span><span class="o">-</span><span class="n">Oxyz</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Orig</span>   
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Orig</span> <span class="o">=</span> <span class="n">atomData</span><span class="p">[</span><span class="n">atNames</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">atName</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Orig</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Orig</span><span class="p">,</span><span class="n">Xsizers</span><span class="p">):</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%10.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnAtQPick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">atName</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="n">atInd</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">atNames</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">atName</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">x</span><span class="o">&lt;</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atInd</span><span class="p">]):</span>
                    <span class="k">return</span>
                <span class="n">OkBtn</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">)</span>
                <span class="n">OkBtn</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">rbType</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbType&#39;</span><span class="p">]</span>
                <span class="n">rbObj</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">]</span>
                <span class="n">rbId</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]</span>
                <span class="n">rbRef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbRef&#39;</span><span class="p">]</span>
                <span class="n">rbXYZ</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="n">rbType</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">]</span>
                <span class="n">rbOrig</span> <span class="o">=</span> <span class="n">rbXYZ</span><span class="p">[</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">VAR</span> <span class="o">=</span> <span class="n">rbXYZ</span><span class="p">[</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="n">rbOrig</span>
                <span class="n">VBR</span> <span class="o">=</span> <span class="n">rbXYZ</span><span class="p">[</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">-</span><span class="n">rbOrig</span>
                <span class="k">if</span> <span class="n">rbType</span> <span class="o">==</span> <span class="s">&#39;Vector&#39;</span><span class="p">:</span>
                    <span class="n">Orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">atInd</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>                
                <span class="n">VAC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">atInd</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="n">Orig</span><span class="p">)</span>
                <span class="n">VBC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">atInd</span><span class="p">[</span><span class="mi">2</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="n">Orig</span><span class="p">)</span>
                <span class="n">VCC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">VAR</span><span class="p">,</span><span class="n">VAC</span><span class="p">)</span>
                <span class="n">QuatA</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">makeQuat</span><span class="p">(</span><span class="n">VAR</span><span class="p">,</span><span class="n">VAC</span><span class="p">,</span><span class="n">VCC</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">VAR</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QuatA</span><span class="p">,</span><span class="n">VAR</span><span class="p">)</span>
                <span class="n">VBR</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QuatA</span><span class="p">,</span><span class="n">VBR</span><span class="p">)</span>
                <span class="n">QuatB</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">makeQuat</span><span class="p">(</span><span class="n">VBR</span><span class="p">,</span><span class="n">VBC</span><span class="p">,</span><span class="n">VAR</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">QuatC</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">QuatB</span><span class="p">,</span><span class="n">QuatA</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Orient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">QuatC</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">QuatC</span><span class="p">,</span><span class="n">Osizers</span><span class="p">):</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%10.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>                
                <span class="k">if</span> <span class="n">rbType</span> <span class="o">==</span> <span class="s">&#39;Vector&#39;</span><span class="p">:</span>
                    <span class="n">Oxyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QuatC</span><span class="p">,</span><span class="n">rbOrig</span><span class="p">))</span>
                    <span class="n">Nxyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atomData</span><span class="p">[</span><span class="n">atInd</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">Orig</span> <span class="o">=</span> <span class="n">Nxyz</span><span class="o">-</span><span class="n">Oxyz</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Orig</span>
                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Orig</span><span class="p">,</span><span class="n">Xsizers</span><span class="p">):</span>
                        <span class="n">item</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%10.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnTorAngle</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">OkBtn</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">)</span>
                <span class="n">OkBtn</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="p">[</span><span class="n">tor</span><span class="p">,</span><span class="n">torSlide</span><span class="p">]</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">Tors</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">tor</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">Tors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Tors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="n">torSlide</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="o">*</span><span class="mi">10</span><span class="p">))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
            <span class="k">def</span> <span class="nf">OnTorSlide</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">OkBtn</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">)</span>
                <span class="n">OkBtn</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
                <span class="n">tor</span><span class="p">,</span><span class="n">ang</span> <span class="o">=</span> <span class="n">Indx</span><span class="p">[</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span>
                <span class="n">Tors</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">tor</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span><span class="o">/</span><span class="mf">10.</span>
                <span class="n">Tors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">ang</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">]):</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                    
            <span class="n">RigidBodies</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
            <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">]:</span>
                <span class="n">Xsizers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">Osizers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">rbObj</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbObj&#39;</span><span class="p">]</span>
                <span class="n">rbName</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBname&#39;</span><span class="p">]</span>
                <span class="n">rbId</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]</span>
                <span class="n">Orig</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Orien</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">rbRef</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbRef&#39;</span><span class="p">]</span>
                <span class="n">Torsions</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]</span>
                <span class="n">refName</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">rbRef</span><span class="p">:</span>
                    <span class="n">refName</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbAtTypes&#39;</span><span class="p">][</span><span class="n">ref</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
                <span class="n">atNames</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;atNames&#39;</span><span class="p">]</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Locate rigid body : &#39;</span><span class="o">+</span><span class="n">rbName</span><span class="p">),</span>
                    <span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">OriSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                <span class="n">OriSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Origin x,y,z: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Orig</span><span class="p">):</span>
                    <span class="n">origX</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%10.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="n">OriSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">origX</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                    <span class="n">Xsizers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">origX</span><span class="p">)</span>
                <span class="n">OriSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">),)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">):</span>
                    <span class="n">choice</span> <span class="o">=</span> <span class="n">atNames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;Sizers&#39;</span><span class="p">][</span><span class="s">&#39;Xsizers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xsizers</span>
                <span class="n">OriSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Orientation quaternion: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ix</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Orien</span><span class="p">):</span>
                    <span class="n">orien</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%10.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
                    <span class="n">OriSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">orien</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                    <span class="n">Osizers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orien</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;Sizers&#39;</span><span class="p">][</span><span class="s">&#39;Osizers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Osizers</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">OriSizer</span><span class="p">)</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">RefSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomData</span><span class="p">):</span>
                    <span class="n">RefSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Location setting: Select match to&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,]</span><span class="o">+</span><span class="n">atNames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                        <span class="n">RefSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">refName</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                        <span class="n">atPick</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                            <span class="n">choices</span><span class="o">=</span><span class="n">choice</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span><span class="p">:</span>
                            <span class="n">atPick</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span> <span class="n">OnAtQPick</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atPick</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span> <span class="n">OnAtOrigPick</span><span class="p">)</span>                            
                        <span class="n">Indx</span><span class="p">[</span><span class="n">atPick</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="n">RefSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">atPick</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">RefSizer</span><span class="p">)</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Torsions</span><span class="p">:</span>                    
                    <span class="n">AtNames</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;AtNames&#39;</span><span class="p">]</span>
                    <span class="n">rbAtTypes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbAtTypes&#39;</span><span class="p">]</span>
                    <span class="n">rbSeq</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;rbSeq&#39;</span><span class="p">]</span>
                    <span class="n">TorSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FlexGridSizer</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">TorSizer</span><span class="o">.</span><span class="n">AddGrowableCol</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,[</span><span class="n">torsion</span><span class="p">,</span><span class="n">seq</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">Torsions</span><span class="p">,</span><span class="n">rbSeq</span><span class="p">)):</span>
                        <span class="n">torName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">seq</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]]:</span>
                            <span class="n">torName</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;testRBObj&#39;</span><span class="p">][</span><span class="s">&#39;rbAtTypes&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; &#39;</span>
                        <span class="n">TorSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Side chain torsion for rb seq: &#39;</span><span class="o">+</span><span class="n">torName</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                        <span class="n">torSlide</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SL_HORIZONTAL</span><span class="p">)</span>
                        <span class="n">torSlide</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3600</span><span class="p">)</span>
                        <span class="n">torSlide</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">10.</span><span class="p">))</span>
                        <span class="n">torSlide</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="n">OnTorSlide</span><span class="p">)</span>
                        <span class="n">TorSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">torSlide</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
                        <span class="n">TorSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; Angle: &#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                        <span class="n">ang</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%8.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">torsion</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
                        <span class="n">ang</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnTorAngle</span><span class="p">)</span>
                        <span class="n">ang</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnTorAngle</span><span class="p">)</span>
                        <span class="n">Indx</span><span class="p">[</span><span class="n">torSlide</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">ang</span><span class="p">]</span>
                        <span class="n">Indx</span><span class="p">[</span><span class="n">ang</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">torSlide</span><span class="p">]</span>
                        <span class="n">TorSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ang</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>                            
                    <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">TorSizer</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No side chain torsions&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Assign rigid body:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">topSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
                <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Select rigid body model&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">rbSel</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="n">rbNames</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="p">)</span>
                <span class="n">rbSel</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span> <span class="n">OnRBSel</span><span class="p">)</span>
                <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">topSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">rbSel</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
                <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">topSizer</span><span class="p">)</span>                
                
            <span class="n">OkBtn</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;Not ready&quot;</span><span class="p">)</span>
            <span class="n">OkBtn</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span> <span class="n">OnOk</span><span class="p">)</span>
            <span class="n">OkBtn</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">CancelBtn</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Cancel&#39;</span><span class="p">)</span>
            <span class="n">CancelBtn</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span> <span class="n">OnCancel</span><span class="p">)</span>
            <span class="n">btnSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">btnSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">btnSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">OkBtn</span><span class="p">)</span>
            <span class="n">btnSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">CancelBtn</span><span class="p">)</span>
            <span class="n">btnSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">btnSizer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">BOTTOM</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">TOP</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">RigidBodies</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
            <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">)</span>
            <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">40</span>
            <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">290</span><span class="p">)</span> <span class="o">+</span> <span class="mi">35</span><span class="p">,</span><span class="mi">560</span><span class="p">)</span>
            <span class="n">RigidBodies</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
            <span class="n">RigidBodies</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">Draw</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">OnAutoFindResRB</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">RBData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>   
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Rigid bodies&#39;</span><span class="p">))</span>
        <span class="n">rbKeys</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">rbKeys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;AtInfo&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbKeys</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - no residue rigid bodies are defined ****&#39;</span>
            <span class="k">return</span>
        <span class="n">RBNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;RBname&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rbKeys</span><span class="p">]</span>
        <span class="n">RBIds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">RBNames</span><span class="p">,</span><span class="n">rbKeys</span><span class="p">))</span>
        <span class="n">general</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">general</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">Atoms</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
        <span class="n">AtLookUp</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FillAtomLookUp</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">general</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - this phase is not a macromolecule ****&#39;</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">Atoms</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - this phase has no atoms ****&#39;</span>
            <span class="k">return</span>
        <span class="n">RBObjs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span> <span class="o">=</span> <span class="n">general</span><span class="p">[</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">iatm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">iatm</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">Atoms</span><span class="p">):</span>
                <span class="n">atom</span> <span class="o">=</span> <span class="n">Atoms</span><span class="p">[</span><span class="n">iatm</span><span class="p">]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">numChain</span> <span class="o">=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">res</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RBIds</span> <span class="ow">or</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;OXT&#39;</span><span class="p">:</span>
                    <span class="n">iatm</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>        <span class="c">#skip for OXT, water molecules, etc.</span>
                <span class="n">rbRes</span> <span class="o">=</span> <span class="n">RBData</span><span class="p">[</span><span class="s">&#39;Residue&#39;</span><span class="p">][</span><span class="n">RBIds</span><span class="p">[</span><span class="n">res</span><span class="p">]]</span>
                <span class="n">rbRef</span> <span class="o">=</span> <span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;rbRef&#39;</span><span class="p">]</span>
                <span class="n">VAR</span> <span class="o">=</span> <span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">][</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">][</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">VBR</span> <span class="o">=</span> <span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">][</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">-</span><span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">][</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">rbObj</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;RBname&#39;</span><span class="p">:</span><span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;RBname&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;useCount&#39;</span><span class="p">]),</span><span class="s">&#39;numChain&#39;</span><span class="p">:</span><span class="n">numChain</span><span class="p">}</span>
                <span class="n">rbAtoms</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">rbIds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">iratm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;atNames&#39;</span><span class="p">])):</span>
                    <span class="n">rbAtoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Atoms</span><span class="p">[</span><span class="n">iatm</span><span class="p">][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">rbIds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Atoms</span><span class="p">[</span><span class="n">iatm</span><span class="p">][</span><span class="mi">20</span><span class="p">])</span>
                    <span class="n">iatm</span> <span class="o">+=</span> <span class="mi">1</span>    <span class="c">#puts this at beginning of next residue?</span>
                <span class="n">Orig</span> <span class="o">=</span> <span class="n">rbAtoms</span><span class="p">[</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;RBId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RBIds</span><span class="p">[</span><span class="n">res</span><span class="p">]</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rbIds</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Orig</span><span class="p">,</span><span class="bp">False</span><span class="p">]</span>
<span class="c">#                print &#39; residue &#39;+rbRes[&#39;RBname&#39;]+str(atom[0]).strip()+ \</span>
<span class="c">#                    &#39; origin at: &#39;,&#39;%.5f %.5f %.5f&#39;%(Orig[0],Orig[1],Orig[2])</span>
                <span class="n">VAC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">rbAtoms</span><span class="p">[</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="n">Orig</span><span class="p">)</span>
                <span class="n">VBC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">rbAtoms</span><span class="p">[</span><span class="n">rbRef</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">-</span><span class="n">Orig</span><span class="p">)</span>
                <span class="n">VCC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">VAR</span><span class="p">,</span><span class="n">VAC</span><span class="p">)</span>
                <span class="n">QuatA</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">makeQuat</span><span class="p">(</span><span class="n">VAR</span><span class="p">,</span><span class="n">VAC</span><span class="p">,</span><span class="n">VCC</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">VAR</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QuatA</span><span class="p">,</span><span class="n">VAR</span><span class="p">)</span>
                <span class="n">VBR</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QuatA</span><span class="p">,</span><span class="n">VBR</span><span class="p">)</span>
                <span class="n">QuatB</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">makeQuat</span><span class="p">(</span><span class="n">VBR</span><span class="p">,</span><span class="n">VBC</span><span class="p">,</span><span class="n">VAR</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">QuatC</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">QuatB</span><span class="p">,</span><span class="n">QuatA</span><span class="p">)</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">QuatC</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">]</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;ThermalMotion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;None&#39;</span><span class="p">,[</span><span class="mf">0.</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)],[</span><span class="bp">False</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="p">)]]</span> <span class="c">#type,values,flags</span>
                <span class="n">SXYZ</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">TXYZ</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">]):</span>
                    <span class="n">SXYZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QuatC</span><span class="p">,</span><span class="n">xyz</span><span class="p">))</span>                
                    <span class="n">TXYZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">rbAtoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">Orig</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">Oatm</span><span class="p">,</span><span class="n">Patm</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">Riders</span> <span class="ow">in</span> <span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;rbSeq&#39;</span><span class="p">]:</span>
                    <span class="n">VBR</span> <span class="o">=</span> <span class="n">SXYZ</span><span class="p">[</span><span class="n">Oatm</span><span class="p">]</span><span class="o">-</span><span class="n">SXYZ</span><span class="p">[</span><span class="n">Patm</span><span class="p">]</span>
                    <span class="n">VAR</span> <span class="o">=</span> <span class="n">SXYZ</span><span class="p">[</span><span class="n">Riders</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">SXYZ</span><span class="p">[</span><span class="n">Patm</span><span class="p">]</span>
                    <span class="n">VAC</span> <span class="o">=</span> <span class="n">TXYZ</span><span class="p">[</span><span class="n">Riders</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">-</span><span class="n">TXYZ</span><span class="p">[</span><span class="n">Patm</span><span class="p">]</span>
                    <span class="n">QuatA</span><span class="p">,</span><span class="n">D</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">makeQuat</span><span class="p">(</span><span class="n">VAR</span><span class="p">,</span><span class="n">VAC</span><span class="p">,</span><span class="n">VBR</span><span class="p">)</span>
                    <span class="n">ang</span> <span class="o">=</span> <span class="mf">180.</span><span class="o">*</span><span class="n">D</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                    <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ang</span><span class="p">,</span><span class="bp">False</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">ride</span> <span class="ow">in</span> <span class="n">Riders</span><span class="p">:</span>
                        <span class="n">SXYZ</span><span class="p">[</span><span class="n">ride</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">QuatA</span><span class="p">,</span><span class="n">SXYZ</span><span class="p">[</span><span class="n">ride</span><span class="p">]</span><span class="o">-</span><span class="n">SXYZ</span><span class="p">[</span><span class="n">Patm</span><span class="p">])</span><span class="o">+</span><span class="n">SXYZ</span><span class="p">[</span><span class="n">Patm</span><span class="p">]</span>
                <span class="n">rbRes</span><span class="p">[</span><span class="s">&#39;useCount&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">RBObjs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rbObj</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RBObjs</span>
            <span class="k">for</span> <span class="n">RBObj</span> <span class="ow">in</span> <span class="n">RBObjs</span><span class="p">:</span>
                <span class="n">newXYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">RBObj</span><span class="p">,</span><span class="n">RBData</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RBObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">][</span><span class="n">AtLookUp</span><span class="p">[</span><span class="nb">id</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">newXYZ</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">FillRigidBodyGrid</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnRBRemoveAll</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Vector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">RBData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>   
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;Rigid bodies&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">RBType</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Vector&#39;</span><span class="p">,</span><span class="s">&#39;Residue&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">rbId</span> <span class="ow">in</span> <span class="n">RBData</span><span class="p">[</span><span class="n">RBType</span><span class="p">]:</span>
                <span class="n">RBData</span><span class="p">[</span><span class="n">RBType</span><span class="p">][</span><span class="n">rbId</span><span class="p">][</span><span class="s">&#39;useCount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>        
        <span class="n">FillRigidBodyGrid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnGlobalResRBRef</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">RBObjs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">][</span><span class="s">&#39;Residue&#39;</span><span class="p">]</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Origin&#39;</span><span class="p">,</span><span class="s">&#39;Orient. angle&#39;</span><span class="p">,</span><span class="s">&#39;Full Orient.&#39;</span><span class="p">]</span>
        <span class="n">nTor</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">rbObj</span> <span class="ow">in</span> <span class="n">RBObjs</span><span class="p">:</span>
            <span class="n">nTor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nTor</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]))</span>
        <span class="n">names</span> <span class="o">+=</span> <span class="p">[</span><span class="s">&#39;Torsion &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nTor</span><span class="p">)]</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Refinement controls&#39;</span><span class="p">,</span><span class="n">names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
            <span class="n">parms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                <span class="n">parms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rbObj</span> <span class="ow">in</span> <span class="n">RBObjs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;Origin&#39;</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">if</span> <span class="s">&#39;Full Orient.&#39;</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;AV&#39;</span>
                    <span class="k">elif</span> <span class="s">&#39;Orient. angle&#39;</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                        <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;A&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39; &#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="s">&#39;Torsion &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">parms</span><span class="p">:</span>
                            <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>            
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
            <span class="n">FillRigidBodyGrid</span><span class="p">()</span>
                       

<span class="c">################################################################################</span>
<span class="c">##### Pawley routines</span>
<span class="c">################################################################################</span>

    <span class="k">def</span> <span class="nf">FillPawleyReflectionsGrid</span><span class="p">():</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                        
        <span class="k">def</span> <span class="nf">KeyEditPawleyGrid</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">colList</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">GetSelectedCols</span><span class="p">()</span>
            <span class="n">PawleyPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Pawley ref&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">GetKeyCode</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">WXK_RETURN</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">GetKeyCode</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">WXK_CONTROL</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">GetKeyCode</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">WXK_SHIFT</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">colList</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetKeyCode</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">colList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">PawleyTable</span><span class="o">.</span><span class="n">GetTypeName</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_BOOL</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">89</span><span class="p">:</span> <span class="c">#&#39;Y&#39;</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PawleyTable</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span> <span class="n">PawleyPeaks</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
                        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="mi">78</span><span class="p">:</span>  <span class="c">#&#39;N&#39;</span>
                            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">PawleyTable</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span> <span class="n">PawleyPeaks</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span><span class="o">=</span><span class="bp">False</span>
                        <span class="n">FillPawleyReflectionsGrid</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="s">&#39;Pawley ref&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">PawleyPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Pawley ref&#39;</span><span class="p">]</span>                        
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">PawleyPeaks</span><span class="p">)):</span> <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;h&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="s">&#39;l&#39;</span><span class="p">,</span><span class="s">&#39;mul&#39;</span><span class="p">,</span><span class="s">&#39;d&#39;</span><span class="p">,</span><span class="s">&#39;refine&#39;</span><span class="p">,</span><span class="s">&#39;Fsq(hkl)&#39;</span><span class="p">,</span><span class="s">&#39;sig(Fsq)&#39;</span><span class="p">]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_LONG</span><span class="p">,]</span><span class="o">+</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,4&#39;</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_BOOL</span><span class="p">,]</span><span class="o">+</span> \
                <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">,]</span>
            <span class="n">PawleyTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">PawleyPeaks</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">PawleyTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KEY_DOWN</span><span class="p">,</span> <span class="n">KeyEditPawleyGrid</span><span class="p">)</span>                 
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">isReadOnly</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">SetMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">([</span><span class="mi">500</span><span class="p">,</span><span class="mi">300</span><span class="p">])</span>
                    
    <span class="k">def</span> <span class="nf">OnPawleyLoad</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">dmin</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Pawley dmin&#39;</span><span class="p">]</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2A</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
        <span class="n">HKLd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2lat</span><span class="o">.</span><span class="n">GenHLaue</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">A</span><span class="p">))</span>
        <span class="n">PawleyPeaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">HKLd</span><span class="p">:</span>
                <span class="n">ext</span><span class="p">,</span><span class="n">mul</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GenHKLf</span><span class="p">([</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">],</span><span class="n">SGData</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="p">:</span>
                    <span class="n">mul</span> <span class="o">*=</span> <span class="mi">2</span>        <span class="c">#for powder multiplicity</span>
                    <span class="n">PawleyPeaks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">mul</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">])</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Pawley ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">PawleyPeaks</span>
        <span class="n">FillPawleyReflectionsGrid</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">OnPawleyEstimate</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Refs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Pawley ref&#39;</span><span class="p">]</span>
            <span class="n">Histograms</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** Error - no histograms defined for this phase ****&#39;</span>
            <span class="k">return</span>
        <span class="n">HistoNames</span> <span class="o">=</span> <span class="n">Histograms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">HistoNames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Inst</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="s">&#39;Instrument Parameters&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Sample</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="s">&#39;Sample Parameters&#39;</span><span class="p">))</span>
        <span class="n">wave</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getWave</span><span class="p">(</span><span class="n">Inst</span><span class="p">)</span>
        <span class="n">posCorr</span> <span class="o">=</span> <span class="n">Inst</span><span class="p">[</span><span class="s">&#39;Zero&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">const</span> <span class="o">=</span> <span class="mf">9.e-2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Sample</span><span class="p">[</span><span class="s">&#39;Gonio. radius&#39;</span><span class="p">])</span>                  <span class="c">#shifts in microns</span>
        
        <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">Refs</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">asind</span><span class="p">(</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                <span class="k">if</span> <span class="s">&#39;Bragg&#39;</span> <span class="ow">in</span> <span class="n">Sample</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                    <span class="n">pos</span> <span class="o">-=</span> <span class="n">const</span><span class="o">*</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">Sample</span><span class="p">[</span><span class="s">&#39;Shift&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">pos</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">+</span> \
                        <span class="n">Sample</span><span class="p">[</span><span class="s">&#39;Transparency&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">*</span><span class="mf">100.0</span><span class="p">)</span>            <span class="c">#trans(=1/mueff) in cm</span>
                <span class="k">else</span><span class="p">:</span>               <span class="c">#Debye-Scherrer - simple but maybe not right</span>
                    <span class="n">pos</span> <span class="o">-=</span> <span class="n">const</span><span class="o">*</span><span class="p">(</span><span class="n">Sample</span><span class="p">[</span><span class="s">&#39;DisplaceX&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">+</span><span class="n">Sample</span><span class="p">[</span><span class="s">&#39;DisplaceY&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
                <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">FWHM</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span><span class="n">G2pwd</span><span class="o">.</span><span class="n">getFWHM</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">Inst</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">indx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">indx</span><span class="p">]</span>
                    <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">FWHM</span><span class="o">*</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">indx</span><span class="p">]</span><span class="o">-</span><span class="n">xdata</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">indx</span><span class="p">])</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">pos</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="n">dx</span>
                    <span class="n">Lorenz</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">indx</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">cosd</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">indx</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>           <span class="c">#Lorentz correction</span>
                    <span class="n">pola</span><span class="p">,</span><span class="n">dIdPola</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">Polarization</span><span class="p">(</span><span class="n">Inst</span><span class="p">[</span><span class="s">&#39;Polariz.&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">indx</span><span class="p">],</span><span class="n">Inst</span><span class="p">[</span><span class="s">&#39;Azimuth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">/=</span> <span class="p">(</span><span class="n">Lorenz</span><span class="o">*</span><span class="n">pola</span><span class="o">*</span><span class="n">ref</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
        <span class="n">FillPawleyReflectionsGrid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnPawleyUpdate</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Refs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Pawley ref&#39;</span><span class="p">]</span>
            <span class="n">Histograms</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** Error - no histograms defined for this phase ****&#39;</span>
            <span class="k">return</span>
        <span class="n">HistoNames</span> <span class="o">=</span> <span class="n">Histograms</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">HistoNames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">refData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">))[</span><span class="n">PhaseName</span><span class="p">]</span>

        <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">iref</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Refs</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">refData</span><span class="p">[</span><span class="n">iref</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">refData</span><span class="p">[</span><span class="n">iref</span><span class="p">][</span><span class="mi">9</span><span class="p">])</span>
                        <span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
        <span class="n">FillPawleyReflectionsGrid</span><span class="p">()</span>
                            
    <span class="k">def</span> <span class="nf">OnPawleyDelete</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>          <span class="c">#doesn&#39;t work</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Do you really want to delete selected Pawley reflections?&#39;</span><span class="p">,</span><span class="s">&#39;Delete&#39;</span><span class="p">,</span> 
            <span class="n">wx</span><span class="o">.</span><span class="n">YES_NO</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">ICON_QUESTION</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_YES</span><span class="p">:</span> 
                <span class="n">Refs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Pawley ref&#39;</span><span class="p">]</span>
                <span class="n">Ind</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
                <span class="n">Ind</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">Ind</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">:</span>
                    <span class="n">Refs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">Refs</span><span class="p">,</span><span class="n">ind</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;Pawley ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Refs</span>
                <span class="n">FillPawleyReflectionsGrid</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

<span class="c">################################################################################</span>
<span class="c">##### Fourier routines</span>
<span class="c">################################################################################</span>

    <span class="k">def</span> <span class="nf">FillMapPeaksGrid</span><span class="p">():</span>
                        
        <span class="k">def</span> <span class="nf">RowSelect</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">IsSelection</span><span class="p">():</span>
                    <span class="n">MapPeaks</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                        <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>                   <span class="c">#only row clicks</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ControlDown</span><span class="p">():</span>                    
                    <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">():</span>
                        <span class="n">MapPeaks</span><span class="o">.</span><span class="n">DeselectRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">ShiftDown</span><span class="p">():</span>
                    <span class="n">indxs</span> <span class="o">=</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
                    <span class="n">MapPeaks</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                    <span class="n">ibeg</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">indxs</span><span class="p">:</span>
                        <span class="n">ibeg</span> <span class="o">=</span> <span class="n">indxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ibeg</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">MapPeaks</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                    <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>                 <span class="c">#a column pick</span>
                <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">colLabels</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;mag&#39;</span><span class="p">:</span>
                    <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">sortArray</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">colLabels</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="s">&#39;dzero&#39;</span><span class="p">]:</span>
                    <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">sortArray</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapPeaks</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">FillMapPeaksGrid</span><span class="p">)</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>                    
            
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">setSizePosLeft</span><span class="p">([</span><span class="mi">450</span><span class="p">,</span><span class="mi">300</span><span class="p">])</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Map Peaks&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Select mag or dzero columns to sort&#39;</span><span class="p">)</span>
            <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span>                        
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">)):</span> <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;mag&#39;</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="s">&#39;z&#39;</span><span class="p">,</span><span class="s">&#39;dzero&#39;</span><span class="p">]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,4&#39;</span><span class="p">,]</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">MapPeaksTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">MapPeaksTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">MapPeaks</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span> <span class="n">RowSelect</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">()):</span>
                    <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SetMargins</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">MapPeaks</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                    
    <span class="k">def</span> <span class="nf">OnPeaksMove</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;Map Peaks&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">])</span>
            <span class="n">peakMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mapPeaks</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Ind</span> <span class="o">=</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">:</span>
                <span class="n">mag</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">mapPeaks</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">AtomAdd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;H&#39;</span><span class="p">,</span><span class="n">Name</span><span class="o">=</span><span class="s">&#39;M &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">mag</span><span class="o">/</span><span class="n">peakMax</span><span class="p">)))</span>
    
    <span class="k">def</span> <span class="nf">OnPeaksClear</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">FillMapPeaksGrid</span><span class="p">()</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnPeaksDelete</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;Map Peaks&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span>
            <span class="n">Ind</span> <span class="o">=</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="n">Ind</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">Ind</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">:</span>
                <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">,</span><span class="n">ind</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapPeaks</span>
        <span class="n">FillMapPeaksGrid</span><span class="p">()</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnPeaksEquiv</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;Map Peaks&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span>
            <span class="n">Ind</span> <span class="o">=</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Ind</span><span class="p">:</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Ind</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">PeaksEquiv</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">Ind</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">:</span>
                            <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">addToSelected</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">MapPeaks</span><span class="o">.</span><span class="n">DeselectRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnShowBonds</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Show bonds&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">):</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">][</span><span class="s">&#39;Show bonds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">MapPeaksEdit</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_SHOWBONDS</span><span class="p">,</span><span class="s">&#39;Show bonds&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">][</span><span class="s">&#39;Show bonds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">MapPeaksEdit</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_SHOWBONDS</span><span class="p">,</span><span class="s">&#39;Hide bonds&#39;</span><span class="p">)</span>
        <span class="n">FillMapPeaksGrid</span><span class="p">()</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">OnPeaksUnique</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;Map Peaks&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span>
            <span class="n">Ind</span> <span class="o">=</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Ind</span><span class="p">:</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">Ind</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">PeaksUnique</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">Ind</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Ind</span><span class="p">:</span>
                            <span class="n">MapPeaks</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">addToSelected</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">MapPeaks</span><span class="o">.</span><span class="n">DeselectRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
                <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">OnPeaksViewPoint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="c"># set view point</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;***** ERROR - no peaks selected&#39;</span>
            <span class="k">return</span>
        <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span>
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapPeaks</span><span class="p">[</span><span class="n">indx</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">OnPeaksDistVP</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="c"># distance to view point</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">indx</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;***** ERROR - no peaks selected&#39;</span>
            <span class="k">return</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>            
        <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span>
        <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>
        <span class="n">viewPt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span> <span class="s">&#39; Distance from view point at </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> to:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">viewPt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">viewPt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">viewPt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetColLabelValue</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetNumberCols</span><span class="p">())]</span>
        <span class="n">cx</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">colLabels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;mag&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">mapPeaks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">Dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span><span class="o">-</span><span class="n">viewPt</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">Dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">print</span> <span class="s">&#39;Peak: </span><span class="si">%5d</span><span class="s"> mag= </span><span class="si">%8.2f</span><span class="s"> distance = </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">peak</span><span class="p">[</span><span class="n">cm</span><span class="p">],</span><span class="n">dist</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnPeaksDA</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="c">#distance, angle </span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">MapPeaks</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - wrong number of atoms for distance or angle calculation&#39;</span>
            <span class="k">return</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>            
        <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indx</span><span class="p">:</span>
            <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39; distance for atoms </span><span class="si">%s</span><span class="s"> = </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">indx</span><span class="p">),</span><span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDist</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">Amat</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39; angle for atoms </span><span class="si">%s</span><span class="s"> = </span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">indx</span><span class="p">),</span><span class="n">G2mth</span><span class="o">.</span><span class="n">getRestAngle</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">Amat</span><span class="p">))</span>
                                    
    <span class="k">def</span> <span class="nf">OnFourierMaps</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">mapData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span>
        <span class="n">reflName</span> <span class="o">=</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;RefList&#39;</span><span class="p">]</span>
        <span class="n">phaseName</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">reflName</span><span class="p">:</span>
            <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">reflName</span><span class="p">)</span>
            <span class="n">reflSets</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">))</span>
            <span class="n">reflData</span> <span class="o">=</span> <span class="n">reflSets</span><span class="p">[</span><span class="n">phaseName</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&#39;HKLF&#39;</span> <span class="ow">in</span> <span class="n">reflName</span><span class="p">:</span>
            <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">reflName</span><span class="p">)</span>
            <span class="n">reflData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;MapType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Omit&#39;</span><span class="p">:</span>
            <span class="n">mapData</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">OmitMap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">reflData</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mapData</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">FourierMap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">reflData</span><span class="p">))</span>
        <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;Flip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">mapSig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>                 <span class="c">#if new drawing - no drawing data!</span>
            <span class="n">SetupDrawingData</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;mapSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.</span>
        <span class="k">print</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;MapType&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; computed: rhomax = </span><span class="si">%.3f</span><span class="s"> rhomin = </span><span class="si">%.3f</span><span class="s"> sigma = </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]),</span><span class="n">mapSig</span><span class="p">)</span>
        <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnFourClear</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapDefault</span>
        <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">printRho</span><span class="p">(</span><span class="n">SGLaue</span><span class="p">,</span><span class="n">rho</span><span class="p">,</span><span class="n">rhoMax</span><span class="p">):</span>                          
<span class="c"># map printing for testing purposes</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rho</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ix</span><span class="p">,</span><span class="n">jy</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jy</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">if</span> <span class="n">SGLaue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;3&#39;</span><span class="p">,</span><span class="s">&#39;3m1&#39;</span><span class="p">,</span><span class="s">&#39;31m&#39;</span><span class="p">,</span><span class="s">&#39;6/m&#39;</span><span class="p">,</span><span class="s">&#39;6/mmm&#39;</span><span class="p">]:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="n">jy</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="s">&#39;  &#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ix</span><span class="p">):</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">rhoMax</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%4d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">line</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ix</span><span class="p">,</span><span class="n">jy</span><span class="p">,</span><span class="n">kz</span> <span class="o">=</span> <span class="n">rho</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kz</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&#39;k = &#39;</span><span class="p">,</span><span class="n">k</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jy</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">SGLaue</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;3&#39;</span><span class="p">,</span><span class="s">&#39;3m1&#39;</span><span class="p">,</span><span class="s">&#39;31m&#39;</span><span class="p">,</span><span class="s">&#39;6/m&#39;</span><span class="p">,</span><span class="s">&#39;6/mmm&#39;</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="p">(</span><span class="n">jy</span><span class="o">-</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="s">&#39;  &#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ix</span><span class="p">):</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">rho</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="n">rhoMax</span><span class="p">)</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%4d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">line</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
<span class="c">## keep this                </span>
    
    <span class="k">def</span> <span class="nf">OnSearchMaps</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                                    
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">print</span> <span class="s">&#39; Begin fourier map search - can take some time&#39;</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">mapData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]):</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">peaks</span><span class="p">,</span><span class="n">mags</span><span class="p">,</span><span class="n">dzeros</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">SearchMap</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">):</span>
                <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">mags</span><span class="p">,</span><span class="n">peaks</span><span class="p">,</span><span class="n">dzeros</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">sortArray</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>            
            <span class="k">print</span> <span class="s">&#39; Map search finished, time = </span><span class="si">%.2f</span><span class="s">s&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">time0</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39; No.peaks found:&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>    
            <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">FindPage</span><span class="p">(</span><span class="s">&#39;Map peaks&#39;</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">ChangeSelection</span><span class="p">(</span><span class="n">Page</span><span class="p">)</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">MapPeaksMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksMove</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSMOVE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksDA</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSDA</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksUnique</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSUNIQUE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksDelete</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksClear</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSCLEAR</span><span class="p">)</span>
            <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
            <span class="n">FillMapPeaksGrid</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;No map available&#39;</span>
        
    <span class="k">def</span> <span class="nf">OnChargeFlip</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
        <span class="n">mapData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span>
        <span class="n">flipData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Flip&#39;</span><span class="p">]</span>
        <span class="n">reflName</span> <span class="o">=</span> <span class="n">flipData</span><span class="p">[</span><span class="s">&#39;RefList&#39;</span><span class="p">]</span>
        <span class="n">phaseName</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">reflName</span><span class="p">:</span>
            <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">reflName</span><span class="p">)</span>
            <span class="n">reflSets</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">))</span>
            <span class="n">reflData</span> <span class="o">=</span> <span class="n">reflSets</span><span class="p">[</span><span class="n">phaseName</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s">&#39;HKLF&#39;</span> <span class="ow">in</span> <span class="n">reflName</span><span class="p">:</span>
            <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">reflName</span><span class="p">)</span>
            <span class="n">reflData</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - No data defined for charge flipping&#39;</span>
            <span class="k">return</span>
        <span class="n">pgbar</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ProgressDialog</span><span class="p">(</span><span class="s">&#39;Charge flipping&#39;</span><span class="p">,</span><span class="s">&#39;Residual Rcf =&#39;</span><span class="p">,</span><span class="mf">101.0</span><span class="p">,</span> 
            <span class="n">style</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">PD_ELAPSED_TIME</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">PD_AUTO_HIDE</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">PD_CAN_ABORT</span><span class="p">)</span>
        <span class="n">screenSize</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ClientDisplayRect</span><span class="p">()</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">pgbar</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.2</span><span class="p">),</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c"># increase size a bit along x</span>
        <span class="n">pgbar</span><span class="o">.</span><span class="n">SetPosition</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">screenSize</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">305</span><span class="p">,</span><span class="n">screenSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">pgbar</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mapData</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ChargeFlip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">reflData</span><span class="p">,</span><span class="n">pgbar</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">pgbar</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;Flip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>        
        <span class="n">mapSig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]:</span>                 <span class="c">#if new drawing - no drawing data!</span>
            <span class="n">SetupDrawingData</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;mapSize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.</span>
        <span class="k">print</span> <span class="s">&#39; Charge flip map computed: rhomax = </span><span class="si">%.3f</span><span class="s"> rhomin = </span><span class="si">%.3f</span><span class="s"> sigma = </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]),</span><span class="n">mapSig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;Rcf&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">99.</span><span class="p">:</span>
            <span class="n">OnSearchMaps</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>             <span class="c">#does a plot structure at end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;Bad charge flip map - no peak search done&#39;</span>
                
    <span class="k">def</span> <span class="nf">OnTextureRefine</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;refine texture?&#39;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>        
            
    <span class="k">def</span> <span class="nf">OnTextureClear</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;clear texture?&#39;</span>
        <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnDataResize</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;Called when the data item window is resized by the user.&#39;</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">PhaseUserSize</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">&#39;Resize to&#39;</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">PhaseUserSize</span>
        <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnPageChanged</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This is called every time that a Notebook tab button is pressed</span>
<span class="sd">        on a Phase data item window</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">Unbind</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SIZE</span><span class="p">)</span> <span class="c"># ignore size events during this routine</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Atoms&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">AtomsMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnAtomAdd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSEDITADD</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnAtomViewAdd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSVIEWADD</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnRBAppend</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RBAPPEND</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnAtomInsert</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSEDITINSERT</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnAtomViewInsert</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMVIEWINSERT</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnAtomMove</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMMOVE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">AtomDelete</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSEDITDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">AtomRefine</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSREFINE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">AtomModify</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSMODIFY</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">AtomTransform</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSTRANSFORM</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnReloadDrawAtoms</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RELOADDRAWATOMS</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDistAngle</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ATOMSDISAGL</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">ReImportMenuId</span><span class="p">:</span>     <span class="c">#loop over submenu items</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnReImport</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
            
            <span class="n">FillAtomsGrid</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;General&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">DataGeneral</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnFourierMaps</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_FOURCALC</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnSearchMaps</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_FOURSEARCH</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChargeFlip</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_CHARGEFLIP</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnFourClear</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_FOURCLEAR</span><span class="p">)</span>
            <span class="n">UpdateGeneral</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Data&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">DataMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPwdrAdd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PWDRADD</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnHklfAdd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_HKLFADD</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDataDelete</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DATADELETE</span><span class="p">)</span>
            <span class="n">G2ddG</span><span class="o">.</span><span class="n">UpdateDData</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">DData</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotSizeStrainPO</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">Start</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Draw Options&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">DataDrawOptions</span><span class="p">)</span>
            <span class="n">UpdateDrawOptions</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Draw Atoms&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">DrawAtomsMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">DrawAtomStyle</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWATOMSTYLE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">DrawAtomLabel</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWATOMLABEL</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">DrawAtomColor</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWATOMCOLOR</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">ResetAtomColors</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWATOMRESETCOLOR</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">SetViewPoint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWVIEWPOINT</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">AddSymEquiv</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWADDEQUIV</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">TransformSymEquiv</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWTRANSFORM</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">FillCoordSphere</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWFILLCOORD</span><span class="p">)</span>            
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">FillUnitCell</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWFILLCELL</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">DrawAtomsDelete</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDrawDistVP</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWDISTVP</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDrawDAT</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWDISAGLTOR</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDrawPlane</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWPLANE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWRESTRBOND</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWRESTRANGLE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWRESTRPLANE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWRESTRCHIRAL</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDefineRB</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_DRAWDEFINERB</span><span class="p">)</span>
            <span class="n">UpdateDrawAtoms</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;RB Models&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RigidBodiesMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnAutoFindResRB</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_AUTOFINDRESRB</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnRBAssign</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_ASSIGNATMS2RB</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnRBCopyParms</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_COPYRBPARMS</span><span class="p">)</span>            
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnGlobalResRBRef</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_GLOBALRESREFINE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnRBRemoveAll</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RBREMOVEALL</span><span class="p">)</span>
            <span class="n">FillRigidBodyGrid</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Pawley reflections&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">PawleyMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPawleyLoad</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PAWLEYLOAD</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPawleyEstimate</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PAWLEYESTIMATE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPawleyUpdate</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PAWLEYUPDATE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPawleyDelete</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PAWLEYDELETE</span><span class="p">)</span>            
            <span class="n">FillPawleyReflectionsGrid</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Map peaks&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">MapPeaksMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksMove</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSMOVE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksViewPoint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSVIEWPT</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksDistVP</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSDISTVP</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksDA</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSDA</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnShowBonds</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_SHOWBONDS</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksEquiv</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_FINDEQVPEAKS</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksUnique</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSUNIQUE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksDelete</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPeaksClear</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_PEAKSCLEAR</span><span class="p">)</span>
            <span class="n">FillMapPeaksGrid</span><span class="p">()</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Texture&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">TextureMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnTextureRefine</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_REFINETEXTURE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnTextureClear</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_CLEARTEXTURE</span><span class="p">)</span>
            <span class="n">UpdateTexture</span><span class="p">()</span>                        
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">Start</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SIZE</span><span class="p">,</span><span class="n">OnDataResize</span><span class="p">)</span> <span class="c"># capture user resize events</span>
        <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>
        
    <span class="n">wx</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">Unbind</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SIZE</span><span class="p">)</span> <span class="c"># ignore size events during this routine</span>
    <span class="n">General</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Window</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="c"># General = wx.ScrolledWindow(G2frame.dataDisplay) # would like to change to this</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">General</span><span class="p">,</span><span class="s">&#39;General&#39;</span><span class="p">)</span>
    <span class="n">DData</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">DData</span><span class="p">,</span><span class="s">&#39;Data&#39;</span><span class="p">)</span>
    <span class="n">Atoms</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="s">&#39;Atoms&#39;</span><span class="p">)</span>
    <span class="n">drawOptions</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Window</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">drawOptions</span><span class="p">,</span><span class="s">&#39;Draw Options&#39;</span><span class="p">)</span>
    <span class="n">drawAtoms</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">drawAtoms</span><span class="p">,</span><span class="s">&#39;Draw Atoms&#39;</span><span class="p">)</span>
    <span class="n">RigidBodies</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">RigidBodies</span><span class="p">,</span><span class="s">&#39;RB Models&#39;</span><span class="p">)</span>
    <span class="n">MapPeaks</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">MapPeaks</span><span class="p">,</span><span class="s">&#39;Map peaks&#39;</span><span class="p">)</span>
    <span class="n">Texture</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">Texture</span><span class="p">,</span><span class="s">&#39;Texture&#39;</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PawleyRefl</span><span class="p">,</span><span class="s">&#39;Pawley reflections&#39;</span><span class="p">)</span>
    
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnFourierMaps</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_FOURCALC</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnSearchMaps</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_FOURSEARCH</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChargeFlip</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_CHARGEFLIP</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnFourClear</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_FOURCLEAR</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">aui</span><span class="o">.</span><span class="n">EVT_AUINOTEBOOK_PAGE_CHANGED</span><span class="p">,</span> <span class="n">OnPageChanged</span><span class="p">)</span>

    <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">DataGeneral</span><span class="p">)</span>
    <span class="n">SetupGeneral</span><span class="p">()</span> <span class="c"># this is done all over the place (including in</span>
    <span class="c"># UpdateGeneral). Why here too?</span>
    
    <span class="n">GeneralData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">oldPage</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># when entering a Phase data item from any other item,</span>
        <span class="c"># reset a saved size, if any.</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">PhaseUserSize</span> <span class="o">=</span> <span class="bp">None</span> 
        <span class="n">UpdateGeneral</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">oldPage</span><span class="p">:</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="n">oldPage</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">UpdateGeneral</span><span class="p">()</span>
    <span class="n">wx</span><span class="o">.</span><span class="n">Frame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SIZE</span><span class="p">,</span><span class="n">OnDataResize</span><span class="p">)</span> <span class="c"># capture user resizing</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Von Dreele and Toby for Argonne National Laboratory.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>