

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GSASIIrestrGUI &mdash; GSAS-II 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="GSAS-II 0.2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for GSASIIrestrGUI</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#GSASIIrestr - restraint GUI routines</span>
<span class="c">########### SVN repository information ###################</span>
<span class="c"># $Date: 2012-12-05 15:38:26 -0600 (Wed, 05 Dec 2012) $</span>
<span class="c"># $Author: vondreele $</span>
<span class="c"># $Revision: 810 $</span>
<span class="c"># $URL: https://subversion.xor.aps.anl.gov/pyGSAS/trunk/GSASIIrestrGUI.py $</span>
<span class="c"># $Id: GSASIIrestrGUI.py 810 2012-12-05 21:38:26Z vondreele $</span>
<span class="c">########### SVN repository information ###################</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">*GSASIIrestrGUI: Restraint GUI routines*</span>
<span class="sd">----------------------------------------</span>

<span class="sd">Used to define restraints.</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">wx.grid</span> <span class="kn">as</span> <span class="nn">wg</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">GSASIIpath</span>
<span class="n">GSASIIpath</span><span class="o">.</span><span class="n">SetVersionNumber</span><span class="p">(</span><span class="s">&quot;$Revision: 810 $&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">GSASIImath</span> <span class="kn">as</span> <span class="nn">G2mth</span>
<span class="kn">import</span> <span class="nn">GSASIIlattice</span> <span class="kn">as</span> <span class="nn">G2lat</span>
<span class="kn">import</span> <span class="nn">GSASIIspc</span> <span class="kn">as</span> <span class="nn">G2spc</span>
<span class="kn">import</span> <span class="nn">GSASIIgrid</span> <span class="kn">as</span> <span class="nn">G2gd</span>
<span class="kn">import</span> <span class="nn">GSASIIplot</span> <span class="kn">as</span> <span class="nn">G2plt</span>
<span class="kn">import</span> <span class="nn">GSASIIdata</span> <span class="kn">as</span> <span class="nn">G2data</span>

<span class="n">VERY_LIGHT_GREY</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">235</span><span class="p">,</span><span class="mi">235</span><span class="p">,</span><span class="mi">235</span><span class="p">)</span>

<span class="c">################################################################################</span>
<span class="c">#####  Restraints</span>
<span class="c">################################################################################           </span>
       
<div class="viewcode-block" id="UpdateRestraints"><a class="viewcode-back" href="../GSASIIGUI.html#GSASIIrestrGUI.UpdateRestraints">[docs]</a><span class="k">def</span> <span class="nf">UpdateRestraints</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">phaseName</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Respond to selection of the Restraints item on the</span>
<span class="sd">    data tree</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Phases</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;There are no phases to form restraints&#39;</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&#39;There are no phases to form restraints&#39;</span>
        <span class="k">return</span>
    <span class="n">phasedata</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phaseName</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">phaseName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">phaseName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">restrData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">phaseName</span><span class="p">]</span>
    <span class="k">if</span> <span class="s">&#39;Bond&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">:</span>
        <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Bond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Range&#39;</span><span class="p">:</span><span class="mf">1.1</span><span class="p">,</span><span class="s">&#39;Bonds&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;Angle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">:</span>
        <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Range&#39;</span><span class="p">:</span><span class="mf">0.85</span><span class="p">,</span><span class="s">&#39;Angles&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;Plane&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">:</span>
        <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Plane&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Planes&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;Chiral&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">:</span>
        <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Chiral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Volumes&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;Torsion&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">:</span>
        <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Coeff&#39;</span><span class="p">:{},</span><span class="s">&#39;Torsions&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;Rama&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">:</span>
        <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Rama&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Coeff&#39;</span><span class="p">:{},</span><span class="s">&#39;Ramas&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;Texture&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">:</span>
        <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Texture&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;HKLs&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="s">&#39;ChemComp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">:</span>
        <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;ChemComp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wtFactor&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;Sites&#39;</span><span class="p">:[],</span><span class="s">&#39;Use&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="n">General</span> <span class="o">=</span> <span class="n">phasedata</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
    <span class="n">Cell</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>          <span class="c">#skip flag &amp; volume    </span>
    <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">Cell</span><span class="p">)</span>
    <span class="n">SGData</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
    <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">Atoms</span> <span class="o">=</span> <span class="n">phasedata</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
    <span class="n">AtLookUp</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">FillAtomLookUp</span><span class="p">(</span><span class="n">Atoms</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
        <span class="n">Names</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="p">]</span>
        <span class="n">Ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">Names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;all &#39;</span><span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]]</span>
        <span class="n">iBeg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Names</span><span class="p">)</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]]</span>
        <span class="n">Coords</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[]</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">Types</span><span class="p">]</span>
        <span class="n">Ids</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">0</span> <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">Types</span><span class="p">]</span>
        <span class="n">Names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="p">]</span>
    <span class="n">Types</span> <span class="o">+=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="p">]</span>
    <span class="n">Coords</span> <span class="o">+=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="p">]</span>
    <span class="n">Ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">Atoms</span><span class="p">]</span>
    <span class="n">rama</span> <span class="o">=</span> <span class="n">G2data</span><span class="o">.</span><span class="n">ramachandranDist</span><span class="p">[</span><span class="s">&#39;All&#39;</span><span class="p">]</span>
    <span class="n">ramaName</span> <span class="o">=</span> <span class="s">&#39;All&#39;</span>
    
    <span class="k">def</span> <span class="nf">OnSelectPhase</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Phase&#39;</span><span class="p">,</span><span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">phaseName</span> <span class="o">=</span> <span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()]</span>
                <span class="n">UpdateRestraints</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">Phases</span><span class="p">,</span><span class="n">phaseName</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">getMacroFile</span><span class="p">(</span><span class="n">macName</span><span class="p">):</span>
        <span class="n">defDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;GSASIImacros&#39;</span><span class="p">)</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FileDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="s">&#39;Choose &#39;</span><span class="o">+</span><span class="n">macName</span><span class="o">+</span><span class="s">&#39; restraint macro file&#39;</span><span class="p">,</span>
            <span class="n">defaultDir</span><span class="o">=</span><span class="n">defDir</span><span class="p">,</span><span class="n">defaultFile</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">wildcard</span><span class="o">=</span><span class="s">&quot;GSAS-II macro file (*.mac)|*.mac&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">OPEN</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">CHANGE_DIR</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">macfile</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetPath</span><span class="p">()</span>
                <span class="n">macro</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">macfile</span><span class="p">,</span><span class="s">&#39;Ur&#39;</span><span class="p">)</span>
                <span class="n">head</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">macName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">head</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">head</span>
                    <span class="k">print</span> <span class="s">&#39;**** ERROR - wrong restraint macro file selected, try again ****&#39;</span>
                    <span class="n">macro</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># cancel was pressed</span>
                <span class="n">macxro</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">macro</span>        <span class="c">#advanced past 1st line</span>
        
    <span class="k">def</span> <span class="nf">OnPlotAARestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;Torsion&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">torNames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">torNames</span> <span class="o">+=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">][</span><span class="s">&#39;Coeff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Torsion data&#39;</span><span class="p">,</span><span class="n">torNames</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">torName</span> <span class="o">=</span> <span class="n">torNames</span><span class="p">[</span><span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()]</span>
                    <span class="n">torsion</span> <span class="o">=</span> <span class="n">G2data</span><span class="o">.</span><span class="n">torsionDist</span><span class="p">[</span><span class="n">torName</span><span class="p">]</span>
                    <span class="n">torCoeff</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">][</span><span class="s">&#39;Coeff&#39;</span><span class="p">][</span><span class="n">torName</span><span class="p">]</span>
                    <span class="n">torList</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">][</span><span class="s">&#39;Torsions&#39;</span><span class="p">]</span>
                    <span class="n">Names</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">Angles</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">cofName</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">torList</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">cofName</span> <span class="o">==</span> <span class="n">torName</span><span class="p">:</span>
                            <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
                            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                            <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                            <span class="n">angle</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestTorsion</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                            <span class="n">Angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
                            <span class="n">Names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
                    <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotTorsion</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">phaseName</span><span class="p">,</span><span class="n">torsion</span><span class="p">,</span><span class="n">torName</span><span class="p">,</span><span class="n">Names</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Angles</span><span class="p">),</span><span class="n">torCoeff</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            
        <span class="k">elif</span> <span class="s">&#39;Rama&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">ramaNames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;All&#39;</span><span class="p">,]</span>
            <span class="n">ramaNames</span> <span class="o">+=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Rama&#39;</span><span class="p">][</span><span class="s">&#39;Coeff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Ramachandran data&#39;</span><span class="p">,</span><span class="n">ramaNames</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">ramaName</span> <span class="o">=</span> <span class="n">ramaNames</span><span class="p">[</span><span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()]</span>
                    <span class="n">rama</span> <span class="o">=</span> <span class="n">G2data</span><span class="o">.</span><span class="n">ramachandranDist</span><span class="p">[</span><span class="n">ramaName</span><span class="p">]</span>
                    <span class="n">ramaCoeff</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">ramaName</span> <span class="o">!=</span> <span class="s">&#39;All&#39;</span><span class="p">:</span>
                        <span class="n">ramaCoeff</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Rama&#39;</span><span class="p">][</span><span class="s">&#39;Coeff&#39;</span><span class="p">][</span><span class="n">ramaName</span><span class="p">]</span>
                    <span class="n">ramaList</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Rama&#39;</span><span class="p">][</span><span class="s">&#39;Ramas&#39;</span><span class="p">]</span>
                    <span class="n">Names</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">PhiPsi</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">cofName</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ramaList</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">cofName</span> <span class="o">==</span> <span class="n">ramaName</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ramaName</span> <span class="o">==</span> <span class="s">&#39;All&#39;</span> <span class="ow">and</span> <span class="s">&#39;-1&#39;</span> <span class="ow">in</span> <span class="n">cofName</span><span class="p">):</span>
                            <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
                            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                            <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                            <span class="n">phi</span><span class="p">,</span><span class="n">psi</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestRama</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                            <span class="n">PhiPsi</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">phi</span><span class="p">,</span><span class="n">psi</span><span class="p">])</span>
                            <span class="n">Names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
                    <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotRama</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">phaseName</span><span class="p">,</span><span class="n">rama</span><span class="p">,</span><span class="n">ramaName</span><span class="p">,</span><span class="n">Names</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PhiPsi</span><span class="p">),</span><span class="n">ramaCoeff</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">OnAddRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;Bond&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddBondRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Bond&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Angle&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddAngleRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Angle&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Plane&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddPlaneRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Plane&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Chem&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddChemCompRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;ChemComp&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Texture&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddTextureRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Texture&#39;</span><span class="p">])</span>
            
    <span class="k">def</span> <span class="nf">OnAddAARestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="s">&#39;Bond&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddAABondRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Bond&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Angle&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddAAAngleRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Angle&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Plane&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddAAPlaneRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Plane&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Chiral&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddAAChiralRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Chiral&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Torsion&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddAATorsionRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s">&#39;Rama&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">):</span>
            <span class="n">AddAARamaRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Rama&#39;</span><span class="p">])</span>
            
    <span class="k">def</span> <span class="nf">AddBondRestraint</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">):</span>
        <span class="n">Lists</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;origin&#39;</span><span class="p">:[],</span><span class="s">&#39;target&#39;</span><span class="p">:[]}</span>
        <span class="k">for</span> <span class="n">listName</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">,</span><span class="s">&#39;target&#39;</span><span class="p">]:</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Bond restraint &#39;</span><span class="o">+</span><span class="n">listName</span><span class="o">+</span><span class="s">&#39; for &#39;</span><span class="o">+</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">],</span>
                    <span class="s">&#39;Select bond restraint &#39;</span><span class="o">+</span><span class="n">listName</span><span class="o">+</span><span class="s">&#39; atoms&#39;</span><span class="p">,</span><span class="n">Names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">Names</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
                        <span class="n">allType</span> <span class="o">=</span> <span class="n">Types</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">Type</span><span class="p">,</span><span class="n">coords</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Types</span><span class="p">,</span><span class="n">Coords</span><span class="p">,</span><span class="n">Ids</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="n">allType</span> <span class="ow">and</span> <span class="s">&#39;all&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                                <span class="n">Lists</span><span class="p">[</span><span class="n">listName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">id</span><span class="p">,</span><span class="n">Type</span><span class="p">,</span><span class="n">coords</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Lists</span><span class="p">[</span><span class="n">listName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Ids</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">Types</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">Coords</span><span class="p">[</span><span class="n">x</span><span class="p">],])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Lists</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Lists</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]):</span>
            <span class="n">bond</span> <span class="o">=</span> <span class="mf">1.54</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Distance&#39;</span><span class="p">,</span><span class="s">&#39;Enter restraint distance for bond&#39;</span><span class="p">,</span><span class="n">bond</span><span class="p">,[</span><span class="mf">0.01</span><span class="p">,</span><span class="mf">4.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.4f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">bond</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="n">Factor</span> <span class="o">=</span> <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Range&#39;</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Units</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
        <span class="n">origAtoms</span> <span class="o">=</span> <span class="n">Lists</span><span class="p">[</span><span class="s">&#39;origin&#39;</span><span class="p">]</span>
        <span class="n">targAtoms</span> <span class="o">=</span> <span class="n">Lists</span><span class="p">[</span><span class="s">&#39;target&#39;</span><span class="p">]</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ProgressDialog</span><span class="p">(</span><span class="s">&quot;Generating bond restraints&quot;</span><span class="p">,</span><span class="s">&quot;Processed origin atoms&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">origAtoms</span><span class="p">),</span> 
            <span class="n">style</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">PD_ELAPSED_TIME</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">PD_AUTO_HIDE</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">PD_REMAINING_TIME</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Norig</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">Oid</span><span class="p">,</span><span class="n">Otype</span><span class="p">,</span><span class="n">Ocoord</span> <span class="ow">in</span> <span class="n">origAtoms</span><span class="p">:</span>
                <span class="n">Norig</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">Norig</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">Tid</span><span class="p">,</span><span class="n">Ttype</span><span class="p">,</span><span class="n">Tcoord</span> <span class="ow">in</span> <span class="n">targAtoms</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Tcoord</span><span class="p">,</span><span class="mi">1</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GenAtom</span><span class="p">(</span><span class="n">Tcoord</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">Move</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">Txyz</span><span class="p">,</span><span class="n">Top</span><span class="p">,</span><span class="n">Tunit</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">Dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txyz</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Ocoord</span><span class="p">))</span><span class="o">+</span><span class="n">Units</span>
                        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">Dx</span><span class="p">)</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span><span class="n">bond</span><span class="o">/</span><span class="n">Factor</span><span class="p">)</span>
                        <span class="n">IndB</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">bond</span><span class="o">*</span><span class="n">Factor</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">IndB</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">indb</span> <span class="ow">in</span> <span class="n">IndB</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indb</span><span class="p">)):</span>
                                    <span class="n">unit</span> <span class="o">=</span> <span class="n">Units</span><span class="p">[</span><span class="n">indb</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">Tunit</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
                                        <span class="n">Topstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">+</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Top</span><span class="p">,</span><span class="n">unit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">unit</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">unit</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">Topstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Top</span><span class="p">)</span>
                                    <span class="n">newBond</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Oid</span><span class="p">,</span><span class="n">Tid</span><span class="p">],[</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="n">Topstr</span><span class="p">],</span><span class="n">bond</span><span class="p">,</span><span class="mf">0.01</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">newBond</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">]:</span>
                                        <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newBond</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="n">UpdateBondRestr</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">)</span>                

    <span class="k">def</span> <span class="nf">AddAABondRestraint</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">):</span>
        <span class="n">Radii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">],</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">]))</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">getMacroFile</span><span class="p">(</span><span class="s">&#39;bond&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">macro</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Coords</span><span class="p">,</span><span class="n">Ids</span><span class="p">)</span>
        
        <span class="n">Factor</span> <span class="o">=</span> <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Range&#39;</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">macStr</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">macStr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Bond&#39;</span><span class="p">][</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">oIds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">oCoords</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tIds</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tCoords</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">oAtm</span><span class="p">,</span><span class="n">tAtm</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">Name</span><span class="p">,</span><span class="n">coords</span><span class="p">,</span><span class="n">Id</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="n">Name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span> <span class="ow">or</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">oAtm</span> <span class="o">==</span> <span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">oIds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span>
                            <span class="n">oCoords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">tAtm</span> <span class="o">==</span> <span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">tIds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span>
                            <span class="n">tCoords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">oId</span><span class="p">,</span><span class="n">oCoord</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">oIds</span><span class="p">,</span><span class="n">oCoords</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">tId</span><span class="p">,</span><span class="n">tCoord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tIds</span><span class="p">,</span><span class="n">tCoords</span><span class="p">)[</span><span class="n">i</span><span class="p">:]:</span>
                        <span class="n">obsd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">tCoord</span><span class="o">-</span><span class="n">oCoord</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">dist</span><span class="o">/</span><span class="n">Factor</span> <span class="o">&lt;</span> <span class="n">obsd</span> <span class="o">&lt;</span> <span class="n">dist</span><span class="o">*</span><span class="n">Factor</span><span class="p">:</span>
                            <span class="n">newBond</span> <span class="o">=</span> <span class="p">[[</span><span class="n">oId</span><span class="p">,</span><span class="n">tId</span><span class="p">],[</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">],</span><span class="n">dist</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">newBond</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">]:</span>
                                <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newBond</span><span class="p">)</span>                          
            <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">macro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">UpdateBondRestr</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">)</span>                
            
    <span class="k">def</span> <span class="nf">AddAngleRestraint</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">):</span>
        <span class="n">Radii</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">],</span><span class="nb">zip</span><span class="p">(</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">],</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;AngleRadii&#39;</span><span class="p">])))</span>
        <span class="n">Lists</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;A-atom&#39;</span><span class="p">:[],</span><span class="s">&#39;B-atom&#39;</span><span class="p">:[],</span><span class="s">&#39;C-atom&#39;</span><span class="p">:[]}</span>
        <span class="k">for</span> <span class="n">listName</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;A-atom&#39;</span><span class="p">,</span><span class="s">&#39;B-atom&#39;</span><span class="p">]:</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select &#39;</span><span class="o">+</span><span class="n">listName</span><span class="o">+</span><span class="s">&#39; for angle A-B-C for &#39;</span><span class="o">+</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span>                                                                           <span class="p">,</span>
                    <span class="s">&#39;Select angle restraint &#39;</span><span class="o">+</span><span class="n">listName</span><span class="p">,</span><span class="n">Names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">Names</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
                        <span class="n">allType</span> <span class="o">=</span> <span class="n">Types</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">Type</span><span class="p">,</span><span class="n">coords</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Types</span><span class="p">,</span><span class="n">Coords</span><span class="p">,</span><span class="n">Ids</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="n">allType</span> <span class="ow">and</span> <span class="s">&#39;all&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">listName</span><span class="p">:</span>
                                    <span class="n">Lists</span><span class="p">[</span><span class="n">listName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Type</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">Lists</span><span class="p">[</span><span class="n">listName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">id</span><span class="p">,</span><span class="n">Type</span><span class="p">,</span><span class="n">coords</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">listName</span><span class="p">:</span>
                            <span class="n">Lists</span><span class="p">[</span><span class="n">listName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Types</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">Lists</span><span class="p">[</span><span class="n">listName</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Ids</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">Types</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">Coords</span><span class="p">[</span><span class="n">x</span><span class="p">],])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">targAtoms</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ids</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">iBeg</span><span class="p">],</span><span class="n">Types</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">iBeg</span><span class="p">],</span><span class="n">Coords</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">iBeg</span><span class="p">]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Names</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:]))]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Lists</span><span class="p">[</span><span class="s">&#39;B-atom&#39;</span><span class="p">]):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="mf">109.54</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Angle&#39;</span><span class="p">,</span><span class="s">&#39;Enter restraint angle &#39;</span><span class="p">,</span><span class="n">value</span><span class="p">,[</span><span class="mf">30.</span><span class="p">,</span><span class="mf">180.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

        <span class="n">Factor</span> <span class="o">=</span> <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Range&#39;</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Units</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">indices</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">])</span>
        <span class="n">VectA</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">Oid</span><span class="p">,</span><span class="n">Otype</span><span class="p">,</span><span class="n">Ocoord</span> <span class="ow">in</span> <span class="n">Lists</span><span class="p">[</span><span class="s">&#39;B-atom&#39;</span><span class="p">]:</span>
            <span class="n">IndBlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">VectB</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">Tid</span><span class="p">,</span><span class="n">Ttype</span><span class="p">,</span><span class="n">Tcoord</span> <span class="ow">in</span> <span class="n">targAtoms</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GenAtom</span><span class="p">(</span><span class="n">Tcoord</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">Move</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">BsumR</span> <span class="o">=</span> <span class="p">(</span><span class="n">Radii</span><span class="p">[</span><span class="n">Otype</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">Radii</span><span class="p">[</span><span class="n">Ttype</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">Factor</span>
                <span class="n">AsumR</span> <span class="o">=</span> <span class="p">(</span><span class="n">Radii</span><span class="p">[</span><span class="n">Otype</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Radii</span><span class="p">[</span><span class="n">Ttype</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">Factor</span>
                <span class="k">for</span> <span class="n">Txyz</span><span class="p">,</span><span class="n">Top</span><span class="p">,</span><span class="n">Tunit</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">Dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">Txyz</span><span class="o">-</span><span class="n">Ocoord</span><span class="p">)</span><span class="o">+</span><span class="n">Units</span>
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">Dx</span><span class="p">)</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)),</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">IndB</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">BsumR</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">IndB</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">indb</span> <span class="ow">in</span> <span class="n">IndB</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indb</span><span class="p">)):</span>
                                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">dx</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">indb</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IndBlist</span><span class="p">:</span>
                                    <span class="n">IndBlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dx</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">indb</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                                    <span class="n">unit</span> <span class="o">=</span> <span class="n">Units</span><span class="p">[</span><span class="n">indb</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">Tunit</span>
                                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">unit</span><span class="p">):</span>
                                    <span class="n">Topstr</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">+</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Top</span><span class="p">,</span><span class="n">unit</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">unit</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">unit</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">Topstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Top</span><span class="p">)</span>
                                <span class="n">Dist</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">indb</span><span class="p">])[</span><span class="n">i</span><span class="p">]</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">Dist</span><span class="o">-</span><span class="n">AsumR</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
                                    <span class="n">VectB</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Oid</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="n">Ocoord</span><span class="p">,</span><span class="n">Ttype</span><span class="p">,</span><span class="n">Tid</span><span class="p">,</span><span class="n">Topstr</span><span class="p">,</span><span class="n">Tcoord</span><span class="p">,</span><span class="n">Dist</span><span class="p">])</span>
            <span class="n">VectA</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VectB</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">Vects</span> <span class="ow">in</span> <span class="n">VectA</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">vecta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Vects</span><span class="p">):</span>                    
                <span class="k">for</span> <span class="n">vectb</span> <span class="ow">in</span> <span class="n">Vects</span><span class="p">[:</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">vecta</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="n">Lists</span><span class="p">[</span><span class="s">&#39;A-atom&#39;</span><span class="p">]:</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">vecta</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">vecta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vectb</span><span class="p">[</span><span class="mi">4</span><span class="p">]]</span>
                        <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="n">vecta</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">vecta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">vectb</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vecta</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">vecta</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">vectb</span><span class="p">[</span><span class="mi">6</span><span class="p">]])</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">angle</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">]:</span>
                            <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">UpdateAngleRestr</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">)</span>                

    <span class="k">def</span> <span class="nf">AddAAAngleRestraint</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">getMacroFile</span><span class="p">(</span><span class="s">&#39;angle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">macro</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Ids</span><span class="p">)</span>
        <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">macStr</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">macStr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Angle&#39;</span><span class="p">][</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">Atms</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
                <span class="n">pAtms</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">atm</span><span class="p">:</span>
                        <span class="n">pAtms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">rNum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">tNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                                <span class="n">rNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">tNum</span> <span class="o">==</span> <span class="n">rNum</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                                    <span class="n">ipos</span> <span class="o">=</span> <span class="n">pAtms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                    <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                        <span class="n">angle</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">),[</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">],</span><span class="n">value</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">angle</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">]:</span>
                            <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">macro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">UpdateAngleRestr</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">)</span>                
        
    <span class="k">def</span> <span class="nf">AddPlaneRestraint</span><span class="p">(</span><span class="n">restrData</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select 4 or more atoms for plane in &#39;</span><span class="o">+</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">],</span>
                <span class="s">&#39;Select 4+ atoms&#39;</span><span class="p">,</span><span class="n">Names</span><span class="p">[</span><span class="n">iBeg</span><span class="p">:])</span>
        <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ids</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">iBeg</span><span class="p">])</span>
                <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;1&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">))]</span>
                <span class="n">plane</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.01</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">]:</span>
                    <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;**** ERROR - not enough atoms for a plane restraint - try again ****&#39;</span>
        <span class="n">UpdatePlaneRestr</span><span class="p">(</span><span class="n">restrData</span><span class="p">)</span>                

    <span class="k">def</span> <span class="nf">AddAAPlaneRestraint</span><span class="p">(</span><span class="n">planeRestData</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">getMacroFile</span><span class="p">(</span><span class="s">&#39;plane&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">macro</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Ids</span><span class="p">)</span>
        <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">macStr</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">macStr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Plane&#39;</span><span class="p">][</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">Atms</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
                <span class="n">pAtms</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Atms</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">atm</span><span class="p">:</span>
                        <span class="n">pAtms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
                <span class="n">rNum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Atms</span><span class="p">))</span>
                <span class="n">ops</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;1&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Atms</span><span class="p">))]</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">tNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">res</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                                <span class="n">rNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">tNum</span> <span class="o">==</span> <span class="n">rNum</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                                    <span class="n">ipos</span> <span class="o">=</span> <span class="n">pAtms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                    <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                        <span class="n">plane</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span><span class="n">ops</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">planeRestData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">]:</span>
                            <span class="n">planeRestData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plane</span><span class="p">)</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Atms</span><span class="p">))</span>
            <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">macro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">UpdatePlaneRestr</span><span class="p">(</span><span class="n">planeRestData</span><span class="p">)</span>                

    <span class="k">def</span> <span class="nf">AddAAChiralRestraint</span><span class="p">(</span><span class="n">chiralRestData</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">getMacroFile</span><span class="p">(</span><span class="s">&#39;chiral&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">macro</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Ids</span><span class="p">)</span>
        <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">macStr</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">macStr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Chiral&#39;</span><span class="p">][</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">Atms</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                            <span class="n">chiral</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">),[</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">],</span><span class="n">value</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">chiral</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chiralRestData</span><span class="p">[</span><span class="s">&#39;Volumes&#39;</span><span class="p">]:</span>
                                <span class="n">chiralRestData</span><span class="p">[</span><span class="s">&#39;Volumes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chiral</span><span class="p">)</span>
                            <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">macro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">UpdateChiralRestr</span><span class="p">(</span><span class="n">chiralRestData</span><span class="p">)</span>                
        
    <span class="k">def</span> <span class="nf">makeChains</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Ids</span><span class="p">):</span>
        <span class="n">Chains</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">rnum</span><span class="p">,</span><span class="n">res</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Chains</span><span class="p">:</span>
                <span class="n">Residues</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">Chains</span><span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Residues</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">rnum</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Residues</span><span class="p">:</span>
                <span class="n">Residues</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rnum</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Residues</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">rnum</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">res</span><span class="p">,</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">id</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Chains</span>
        
    <span class="k">def</span> <span class="nf">AddAATorsionRestraint</span><span class="p">(</span><span class="n">torsionRestData</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">getMacroFile</span><span class="p">(</span><span class="s">&#39;torsion&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">macro</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">Chains</span> <span class="o">=</span> <span class="n">makeChains</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Ids</span><span class="p">)</span>            
        <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">macStr</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">macStr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">][</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">]):</span>
                    <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">torsionRestData</span><span class="p">[</span><span class="s">&#39;Coeff&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff</span>
            <span class="k">elif</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">Name</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Res</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">Esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">Atms</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
                <span class="n">pAtms</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">atm</span><span class="p">:</span>
                        <span class="n">pAtms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">chains</span> <span class="o">=</span> <span class="n">Chains</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">chains</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
                    <span class="n">residues</span> <span class="o">=</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="n">residues</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">residue</span> <span class="o">==</span> <span class="n">residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">Res</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">Res</span> <span class="o">!=</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">residue</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">Res</span> <span class="o">==</span> <span class="n">res</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                        <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                        <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">residue</span><span class="p">]:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                    <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="k">continue</span>
                            <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">residue</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">ipos</span> <span class="o">=</span> <span class="n">pAtms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                    <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                            <span class="n">torsion</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">),[</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">],</span><span class="n">Name</span><span class="p">,</span><span class="n">Esd</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">torsion</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">torsionRestData</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]:</span>
                                <span class="n">torsionRestData</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
                            <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>                            
            <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">macro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">UpdateTorsionRestr</span><span class="p">(</span><span class="n">torsionRestData</span><span class="p">)</span>                        
       
    <span class="k">def</span> <span class="nf">AddAARamaRestraint</span><span class="p">(</span><span class="n">ramaRestData</span><span class="p">):</span>
        <span class="n">macro</span> <span class="o">=</span> <span class="n">getMacroFile</span><span class="p">(</span><span class="s">&#39;Ramachandran&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">macro</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">Chains</span> <span class="o">=</span> <span class="n">makeChains</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Ids</span><span class="p">)</span>            
        <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">macStr</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">macStr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Rama&#39;</span><span class="p">][</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">nTerms</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nTerms</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nTerms</span><span class="p">):</span>
                    <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="n">items</span> <span class="o">=</span> <span class="n">macStr</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
                        <span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Coeff&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">coeff</span>
            <span class="k">elif</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">Name</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Res</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">Esd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">Atms</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
                <span class="n">mAtms</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span>
                <span class="n">pAtms</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">atm</span><span class="p">:</span>
                        <span class="n">pAtms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">atm</span><span class="p">:</span>
                        <span class="n">mAtms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">chains</span> <span class="o">=</span> <span class="n">Chains</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="n">chains</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chains</span><span class="p">:</span>
                    <span class="n">residues</span> <span class="o">=</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="n">residues</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">mAtms</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">pAtms</span><span class="p">)):</span>
                        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">residue</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">Res</span> <span class="o">==</span> <span class="n">res</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                        <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                        <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                                <span class="n">rama</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">),[</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">],</span><span class="n">Name</span><span class="p">,</span><span class="n">Esd</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">rama</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Ramas&#39;</span><span class="p">]:</span>
                                    <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Ramas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rama</span><span class="p">)</span>
                                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">residue</span> <span class="ow">in</span> <span class="n">residues</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">residue</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">ipos</span> <span class="o">=</span> <span class="n">mAtms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                    <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="k">continue</span>
                            <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">residue</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">ipos</span> <span class="o">=</span> <span class="n">pAtms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                    <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                    <span class="k">continue</span>
                            <span class="k">for</span> <span class="n">res</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="n">Chains</span><span class="p">[</span><span class="n">chain</span><span class="p">][</span><span class="n">residue</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">Res</span> <span class="o">==</span> <span class="n">res</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">ipos</span> <span class="o">=</span> <span class="n">Atms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                                        <span class="n">ids</span><span class="p">[</span><span class="n">ipos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
                                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                        <span class="k">continue</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                                <span class="n">rama</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">ids</span><span class="p">),[</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">],</span><span class="n">Name</span><span class="p">,</span><span class="n">Esd</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">rama</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Ramas&#39;</span><span class="p">]:</span>
                                    <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Ramas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rama</span><span class="p">)</span>
                                <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">macStr</span> <span class="o">=</span> <span class="n">macro</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">macro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">UpdateRamaRestr</span><span class="p">(</span><span class="n">ramaRestData</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">AddChemCompRestraint</span><span class="p">(</span><span class="n">chemcompRestData</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MultiChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select atoms for chemical restraint in &#39;</span><span class="o">+</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">],</span>
                <span class="s">&#39;Select atoms&#39;</span><span class="p">,</span><span class="n">Names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelections</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">Names</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
                    <span class="n">allType</span> <span class="o">=</span> <span class="n">Types</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">Type</span><span class="p">,</span><span class="nb">id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Names</span><span class="p">,</span><span class="n">Types</span><span class="p">,</span><span class="n">Ids</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="n">allType</span> <span class="ow">and</span> <span class="s">&#39;all&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                            <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
                            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ids</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Angle&#39;</span><span class="p">,</span><span class="s">&#39;Enter unit cell sum &#39;</span><span class="p">,</span><span class="n">value</span><span class="p">,[</span><span class="o">-</span><span class="mf">1.e6</span><span class="p">,</span><span class="mf">1.e6</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>                
                    <span class="n">comp</span> <span class="o">=</span> <span class="p">[</span><span class="n">ids</span><span class="p">,</span><span class="n">factors</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="mf">0.01</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">comp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chemcompRestData</span><span class="p">[</span><span class="s">&#39;Sites&#39;</span><span class="p">]:</span>
                        <span class="n">chemcompRestData</span><span class="p">[</span><span class="s">&#39;Sites&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
                <span class="n">UpdateChemcompRestr</span><span class="p">(</span><span class="n">chemcompRestData</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&#39;**** ERROR - not enough atoms for a composition restraint - try again ****&#39;</span>
        
    <span class="k">def</span> <span class="nf">AddTextureRestraint</span><span class="p">(</span><span class="n">textureRestData</span><span class="p">):</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextEntryDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Enter h k l for pole figure restraint&#39;</span><span class="p">,</span><span class="s">&#39;Enter HKL&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hkl</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
                <span class="n">texture</span> <span class="o">=</span> <span class="p">[</span><span class="n">hkl</span><span class="p">,</span><span class="mi">24</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">texture</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">textureRestData</span><span class="p">[</span><span class="s">&#39;HKLs&#39;</span><span class="p">]:</span>
                        <span class="n">textureRestData</span><span class="p">[</span><span class="s">&#39;HKLs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">texture</span><span class="p">)</span>
                <span class="n">UpdateTextureRestr</span><span class="p">(</span><span class="n">textureRestData</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span><span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&#39;**** ERROR - bad input of h k l - try again ****&#39;</span>
        <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
               
    <span class="k">def</span> <span class="nf">WtBox</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span><span class="n">restData</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;Range&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">restData</span><span class="p">:</span> <span class="n">restData</span><span class="p">[</span><span class="s">&#39;Range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span>     <span class="c">#patch</span>
        
        <span class="k">def</span> <span class="nf">OnWtFactor</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">wtfactor</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">restData</span><span class="p">[</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">wtfactor</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            
        <span class="k">def</span> <span class="nf">OnRange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sRange</span><span class="o">.</span><span class="n">GetValue</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">restData</span><span class="p">[</span><span class="s">&#39;Range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">sRange</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            
        <span class="k">def</span> <span class="nf">OnUseData</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">restData</span><span class="p">[</span><span class="s">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>

        <span class="n">wtBox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
        <span class="n">wtBox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Restraint weight factor:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">wtfactor</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">restData</span><span class="p">[</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
        <span class="n">wtfactor</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnWtFactor</span><span class="p">)</span>
        <span class="n">wtfactor</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnWtFactor</span><span class="p">)</span>
        <span class="n">wtBox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wtfactor</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">useData</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39; Use?&#39;</span><span class="p">)</span>
        <span class="n">useData</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="n">OnUseData</span><span class="p">)</span>
        <span class="n">useData</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">restData</span><span class="p">[</span><span class="s">&#39;Use&#39;</span><span class="p">])</span>        
        <span class="n">wtBox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">useData</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;Bonds&#39;</span> <span class="ow">in</span> <span class="n">restData</span> <span class="ow">or</span> <span class="s">&#39;Angles&#39;</span> <span class="ow">in</span> <span class="n">restData</span><span class="p">:</span>
            <span class="n">wtBox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Search range:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">sRange</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="n">wind</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">restData</span><span class="p">[</span><span class="s">&#39;Range&#39;</span><span class="p">]),</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">)</span>
            <span class="n">sRange</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT_ENTER</span><span class="p">,</span><span class="n">OnRange</span><span class="p">)</span>
            <span class="n">sRange</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KILL_FOCUS</span><span class="p">,</span><span class="n">OnRange</span><span class="p">)</span>
            <span class="n">wtBox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">sRange</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">wtBox</span>
        
    <span class="k">def</span> <span class="nf">OnRowSelect</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
        <span class="n">Obj</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Obj</span><span class="o">.</span><span class="n">IsSelection</span><span class="p">():</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Obj</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                    <span class="n">Obj</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>                   <span class="c">#only row clicks</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ControlDown</span><span class="p">():</span>                    
                <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">():</span>
                    <span class="n">Obj</span><span class="o">.</span><span class="n">DeselectRow</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Obj</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">ShiftDown</span><span class="p">():</span>
                <span class="n">indxs</span> <span class="o">=</span> <span class="n">Obj</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                <span class="n">ibeg</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">indxs</span><span class="p">:</span>
                    <span class="n">ibeg</span> <span class="o">=</span> <span class="n">indxs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ibeg</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">Obj</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
                <span class="n">Obj</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                
                    
    <span class="k">def</span> <span class="nf">UpdateBondRestr</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bondTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>            
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateBondRestr</span><span class="p">,</span><span class="n">bondRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnChangeValue</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Bonds</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Bonds</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">bondList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new value for bond&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">5.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.4f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateBondRestr</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">)</span>                

        <span class="k">def</span> <span class="nf">OnChangeEsd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Bonds</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Bonds</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">bondList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new esd for bond&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.4f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateBondRestr</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">)</span>                
                                
        <span class="k">def</span> <span class="nf">OnDeleteRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Bonds</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Bonds</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">bondList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">bondList</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
            <span class="n">UpdateBondRestr</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">)</span>                
            
        <span class="n">BondRestr</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">BondRestr</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WtBox</span><span class="p">(</span><span class="n">BondRestr</span><span class="p">,</span><span class="n">bondRestData</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>

        <span class="n">bondList</span> <span class="o">=</span> <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bondList</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">bondList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>   <span class="c">#patch</span>
            <span class="n">bondList</span> <span class="o">=</span> <span class="n">bondRestData</span><span class="p">[</span><span class="s">&#39;Bonds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bondList</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,3&#39;</span><span class="p">,]</span>
            <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;(res) A - (res) B&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">,</span><span class="s">&#39;delt/sig&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bondList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; - &#39;</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDist</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span><span class="n">calc</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">,(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span><span class="o">/</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>                
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A+SymOp - B+SymOp&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">,</span><span class="s">&#39;delt/sig&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bondList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">names</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getSyXYZ</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestDist</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) - &#39;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;)&#39;</span><span class="p">,</span><span class="n">calc</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">,(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span><span class="o">/</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                <span class="n">bad</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ibad</span> <span class="ow">in</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">bondList</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span>
            <span class="n">bondTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Bonds</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">BondRestr</span><span class="p">)</span>
            <span class="n">Bonds</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">bondTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Bonds</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bondList</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
                    <span class="n">Bonds</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Bonds</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Bonds</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span><span class="n">OnRowSelect</span><span class="p">)</span>
            <span class="n">Bonds</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">OnCellChange</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDeleteRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeValue</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeEsd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTCHANGEESD</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Bonds</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">BondRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No bond distance restraints for this phase&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,)</span>

        <span class="n">BondRestr</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">50</span>       <span class="c">#make room for tab</span>
        <span class="n">BondRestr</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">BondRestr</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">UpdateAngleRestr</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">angleTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">new</span> <span class="o">&gt;</span> <span class="mf">180.</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>            
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateAngleRestr</span><span class="p">,</span><span class="n">angleRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnChangeValue</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Angles</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Angles</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">angleList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new value for angle&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateAngleRestr</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">)</span>                

        <span class="k">def</span> <span class="nf">OnChangeEsd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Angles</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Angles</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">angleList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new esd for angle&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">5.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateAngleRestr</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">)</span>                
                                            
        <span class="k">def</span> <span class="nf">OnDeleteRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Angles</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">angleList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">angleList</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
            <span class="n">UpdateAngleRestr</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">)</span>                
            
        <span class="n">AngleRestr</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">AngleRestr</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WtBox</span><span class="p">(</span><span class="n">AngleRestr</span><span class="p">,</span><span class="n">angleRestData</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>

        <span class="n">angleList</span> <span class="o">=</span> <span class="n">angleRestData</span><span class="p">[</span><span class="s">&#39;Angles&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">angleList</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">,]</span>
            <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;(res) A - (res) B - (res) C&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">,</span><span class="s">&#39;delt/sig&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angleList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; - &#39;</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestAngle</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span><span class="n">calc</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">,(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span><span class="o">/</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>                                
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A+SymOp - B+SymOp - C+SymOp&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">,</span><span class="s">&#39;delt/sig&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">angleList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) - &#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) - &#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span> \
                        <span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getSyXYZ</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestAngle</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="n">calc</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">,(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span><span class="o">/</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                <span class="n">bad</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ibad</span> <span class="ow">in</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">angleList</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span>
            <span class="n">angleTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Angles</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">AngleRestr</span><span class="p">)</span>
            <span class="n">Angles</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">angleTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Angles</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">angleList</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
                    <span class="n">Angles</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Angles</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Angles</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span><span class="n">OnRowSelect</span><span class="p">)</span>
            <span class="n">Angles</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">OnCellChange</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDeleteRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeValue</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeEsd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTCHANGEESD</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Angles</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">AngleRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No bond angle restraints for this phase&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,)</span>

        <span class="n">AngleRestr</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">50</span>      <span class="c">#make room for tab</span>
        <span class="n">AngleRestr</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">AngleRestr</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">UpdatePlaneRestr</span><span class="p">(</span><span class="n">planeRestData</span><span class="p">):</span>
        
        <span class="n">items</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">GetMenuItems</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">GetLabel</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Change value&#39;</span><span class="p">]:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">planeRestData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">planeTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">planeRestData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>            
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdatePlaneRestr</span><span class="p">,</span><span class="n">planeRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnChangeEsd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Planes</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Planes</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">planeList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new esd for plane&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">5.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">planeRestData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdatePlaneRestr</span><span class="p">(</span><span class="n">planeRestData</span><span class="p">)</span>                
                                            
        <span class="k">def</span> <span class="nf">OnDeleteRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Planes</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">planeList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">planeList</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
            <span class="n">UpdatePlaneRestr</span><span class="p">(</span><span class="n">planeRestData</span><span class="p">)</span>                
            
        <span class="n">PlaneRestr</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">PlaneRestr</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WtBox</span><span class="p">(</span><span class="n">PlaneRestr</span><span class="p">,</span><span class="n">planeRestData</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>

        <span class="n">planeList</span> <span class="o">=</span> <span class="n">planeRestData</span><span class="p">[</span><span class="s">&#39;Planes&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">planeList</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">,]</span>
            <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;(res) atom&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">planeList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
                            <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; - &#39;</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestPlane</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span><span class="n">calc</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                                
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;atom+SymOp&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">planeList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getSyXYZ</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestPlane</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atoms</span><span class="p">):</span>
                            <span class="n">name</span> <span class="o">+=</span> <span class="n">atom</span><span class="o">+</span><span class="s">&#39;+ (&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;),&#39;</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">calc</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                <span class="n">bad</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ibad</span> <span class="ow">in</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">planeList</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span>
            <span class="n">planeTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Planes</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">PlaneRestr</span><span class="p">)</span>
            <span class="n">Planes</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">planeTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Planes</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">Planes</span><span class="o">.</span><span class="n">AutoSizeRows</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">planeList</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">Planes</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Planes</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Planes</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span><span class="n">OnRowSelect</span><span class="p">)</span>
            <span class="n">Planes</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">OnCellChange</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDeleteRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeEsd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTCHANGEESD</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Planes</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">PlaneRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No plane restraints for this phase&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,)</span>

        <span class="n">PlaneRestr</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">50</span>       <span class="c">#make room for tab</span>
        <span class="n">PlaneRestr</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">PlaneRestr</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
<span class="c">#        G2frame.dataFrame.setSizePosLeft(Size)</span>
    
    <span class="k">def</span> <span class="nf">UpdateChiralRestr</span><span class="p">(</span><span class="n">chiralRestData</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">chiralRestData</span><span class="p">[</span><span class="s">&#39;Volumes&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">volumeTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">chiralRestData</span><span class="p">[</span><span class="s">&#39;Volumes&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>            
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateChiralRestr</span><span class="p">,</span><span class="n">chiralRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnDeleteRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Volumes</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">volumeList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">volumeList</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
            <span class="n">UpdateChiralRestr</span><span class="p">(</span><span class="n">chiralRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnChangeValue</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Volumes</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Volumes</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">volumeList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new value for chiral volume&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">chiralRestData</span><span class="p">[</span><span class="s">&#39;Volumes&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateChiralRestr</span><span class="p">(</span><span class="n">chiralRestData</span><span class="p">)</span>                

        <span class="k">def</span> <span class="nf">OnChangeEsd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Volumes</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Volumes</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">volumeList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new esd for chiral volume&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">5.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">chiralRestData</span><span class="p">[</span><span class="s">&#39;Volumes&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateChiralRestr</span><span class="p">(</span><span class="n">chiralRestData</span><span class="p">)</span>                
                                            
        <span class="n">ChiralRestr</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">ChiralRestr</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WtBox</span><span class="p">(</span><span class="n">ChiralRestr</span><span class="p">,</span><span class="n">chiralRestData</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>

        <span class="n">volumeList</span> <span class="o">=</span> <span class="n">chiralRestData</span><span class="p">[</span><span class="s">&#39;Volumes&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumeList</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">,]</span>
            <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;(res) O (res) A (res) B (res) C&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">,</span><span class="s">&#39;delt/sig&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">volumeList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; &#39;</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestChiral</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="n">calc</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">,(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span><span class="o">/</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;O+SymOp  A+SymOp  B+SymOp  C+SymOp)&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">,</span><span class="s">&#39;delt/sig&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">volumeList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) &#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) &#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span> \
                            <span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;) &#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+(&#39;</span><span class="o">+</span><span class="n">ops</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getSyXYZ</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                        <span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestChiral</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="n">calc</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">,(</span><span class="n">obs</span><span class="o">-</span><span class="n">calc</span><span class="p">)</span><span class="o">/</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                <span class="n">bad</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ibad</span> <span class="ow">in</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">volumeList</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span>
            <span class="n">volumeTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Volumes</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">ChiralRestr</span><span class="p">)</span>
            <span class="n">Volumes</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">volumeTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Volumes</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">volumeList</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
                    <span class="n">Volumes</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Volumes</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Volumes</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span><span class="n">OnRowSelect</span><span class="p">)</span>
            <span class="n">Volumes</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">OnCellChange</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDeleteRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeValue</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeEsd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTCHANGEESD</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Volumes</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">ChiralRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No chiral volume restraints for this phase&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,)</span>

        <span class="n">ChiralRestr</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">50</span>       <span class="c">#make room for tab</span>
        <span class="n">ChiralRestr</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">ChiralRestr</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">UpdateTorsionRestr</span><span class="p">(</span><span class="n">torsionRestData</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">torsionRestData</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">torsionTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">new</span> <span class="o">&gt;</span> <span class="mf">5.</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">torsionRestData</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>     <span class="c">#only esd is editable</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>            
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateTorsionRestr</span><span class="p">,</span><span class="n">torsionRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnDeleteRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Torsions</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">torsionList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">torsionList</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
            <span class="n">UpdateTorsionRestr</span><span class="p">(</span><span class="n">torsionRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnChangeEsd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Torsions</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Torsions</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">torsionList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new esd for torsion restraints&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">5.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">torsionRestData</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateTorsionRestr</span><span class="p">(</span><span class="n">torsionRestData</span><span class="p">)</span>                
                                            
        <span class="n">TorsionRestr</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">TorsionRestr</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WtBox</span><span class="p">(</span><span class="n">TorsionRestr</span><span class="p">,</span><span class="n">torsionRestData</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        
        <span class="n">coeffDict</span> <span class="o">=</span> <span class="n">torsionRestData</span><span class="p">[</span><span class="s">&#39;Coeff&#39;</span><span class="p">]</span>
        <span class="n">torsionList</span> <span class="o">=</span> <span class="n">torsionRestData</span><span class="p">[</span><span class="s">&#39;Torsions&#39;</span><span class="p">]</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">TorsionRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Torsion restraints:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">torsionList</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">,]</span>
            <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;(res) A  B  C  D&#39;</span><span class="p">,</span><span class="s">&#39;coef name&#39;</span><span class="p">,</span><span class="s">&#39;torsion&#39;</span><span class="p">,</span><span class="s">&#39;obs E&#39;</span><span class="p">,</span><span class="s">&#39;restr&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">cofName</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">torsionList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
                        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">tor</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestTorsion</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">restr</span><span class="p">,</span><span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">calcTorsionEnergy</span><span class="p">(</span><span class="n">tor</span><span class="p">,</span><span class="n">coeffDict</span><span class="p">[</span><span class="n">cofName</span><span class="p">])</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="n">cofName</span><span class="p">,</span><span class="n">tor</span><span class="p">,</span><span class="n">calc</span><span class="p">,</span><span class="n">restr</span><span class="p">,</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                <span class="n">bad</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ibad</span> <span class="ow">in</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">torsionList</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span>
            <span class="n">torsionTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Torsions</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">TorsionRestr</span><span class="p">)</span>
            <span class="n">Torsions</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">torsionTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Torsions</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">torsionList</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                    <span class="n">Torsions</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Torsions</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Torsions</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span><span class="n">OnRowSelect</span><span class="p">)</span>
            <span class="n">Torsions</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">OnCellChange</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDeleteRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeEsd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTCHANGEESD</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Torsions</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
            
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">TorsionRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Torsion function coefficients:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="mi">9</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,4&#39;</span><span class="p">,]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Mag A&#39;</span><span class="p">,</span><span class="s">&#39;Pos A&#39;</span><span class="p">,</span><span class="s">&#39;Width A&#39;</span><span class="p">,</span><span class="s">&#39;Mag B&#39;</span><span class="p">,</span><span class="s">&#39;Pos B&#39;</span><span class="p">,</span><span class="s">&#39;Width B&#39;</span><span class="p">,</span><span class="s">&#39;Mag C&#39;</span><span class="p">,</span><span class="s">&#39;Pos C&#39;</span><span class="p">,</span><span class="s">&#39;Width C&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">coeffDict</span><span class="p">:</span>
                <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coeffDict</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="n">coeffTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Coeff</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">TorsionRestr</span><span class="p">)</span>
            <span class="n">Coeff</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">coeffTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Coeff</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffDict</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">):</span>
                    <span class="n">Coeff</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Coeff</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Coeff</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">TorsionRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No torsion restraints for this phase&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,)</span>

        <span class="n">TorsionRestr</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">50</span>       <span class="c">#make room for tab</span>
        <span class="n">TorsionRestr</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">TorsionRestr</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">UpdateRamaRestr</span><span class="p">(</span><span class="n">ramaRestData</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Ramas&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ramaTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;=</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">new</span> <span class="o">&gt;</span> <span class="mf">5.</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Ramas&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>     <span class="c">#only esd is editable</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>            
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateRamaRestr</span><span class="p">,</span><span class="n">ramaRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnDeleteRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Ramas</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">ramaList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ramaList</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
            <span class="n">UpdateRamaRestr</span><span class="p">(</span><span class="n">ramaRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnChangeEsd</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Ramas</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">Ramas</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ramaList</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span><span class="s">&#39;Enter new esd for energy&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">,[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">5.</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Ramas&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateRamaRestr</span><span class="p">(</span><span class="n">ramaRestData</span><span class="p">)</span>                
                                            
        <span class="n">RamaRestr</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">RamaRestr</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WtBox</span><span class="p">(</span><span class="n">RamaRestr</span><span class="p">,</span><span class="n">ramaRestData</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>

        <span class="n">ramaList</span> <span class="o">=</span> <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Ramas&#39;</span><span class="p">]</span>
        <span class="n">coeffDict</span> <span class="o">=</span> <span class="n">ramaRestData</span><span class="p">[</span><span class="s">&#39;Coeff&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ramaList</span><span class="p">):</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RamaRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Ramachandran restraints:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">,]</span>
            <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
                <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;(res) A  B  C  D  E&#39;</span><span class="p">,</span><span class="s">&#39;coef name&#39;</span><span class="p">,</span><span class="s">&#39;phi&#39;</span><span class="p">,</span><span class="s">&#39;psi&#39;</span><span class="p">,</span><span class="s">&#39;obs E&#39;</span><span class="p">,</span><span class="s">&#39;restr&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">ops</span><span class="p">,</span><span class="n">cofName</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ramaList</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;(&#39;</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">+</span><span class="n">atoms</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
                        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">+=</span> <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cx</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
                        <span class="n">phi</span><span class="p">,</span><span class="n">psi</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getRestRama</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span>
                        <span class="n">restr</span><span class="p">,</span><span class="n">calc</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">calcRamaEnergy</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="n">psi</span><span class="p">,</span><span class="n">coeffDict</span><span class="p">[</span><span class="n">cofName</span><span class="p">])</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span><span class="n">cofName</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">psi</span><span class="p">,</span><span class="n">calc</span><span class="p">,</span><span class="n">restr</span><span class="p">,</span><span class="n">esd</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                        <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                <span class="n">bad</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ibad</span> <span class="ow">in</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ramaList</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span>
            <span class="n">ramaTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Ramas</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">RamaRestr</span><span class="p">)</span>
            <span class="n">Ramas</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">ramaTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Ramas</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ramaList</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                    <span class="n">Ramas</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Ramas</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Ramas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span><span class="n">OnRowSelect</span><span class="p">)</span>
            <span class="n">Ramas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">OnCellChange</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDeleteRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeEsd</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTCHANGEESD</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Ramas</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RamaRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No Ramachandran restraints for this phase&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">RamaRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;Ramachandran function coefficients:&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coeffDict</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="mi">6</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,4&#39;</span><span class="p">,]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Mag&#39;</span><span class="p">,</span><span class="s">&#39;Pos phi&#39;</span><span class="p">,</span><span class="s">&#39;Pos psi&#39;</span><span class="p">,</span><span class="s">&#39;sig(phi)&#39;</span><span class="p">,</span><span class="s">&#39;sig(psi)&#39;</span><span class="p">,</span><span class="s">&#39;sig(cov)&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">coeffDict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">coeffDict</span><span class="p">[</span><span class="n">item</span><span class="p">]):</span>
                    <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">+</span><span class="s">&#39; term:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
            <span class="n">coeffTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Coeff</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">RamaRestr</span><span class="p">)</span>
            <span class="n">Coeff</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">coeffTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Coeff</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Coeff</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                    <span class="n">Coeff</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Coeff</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Coeff</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>

        <span class="n">RamaRestr</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">50</span>       <span class="c">#make room for tab</span>
        <span class="n">RamaRestr</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">RamaRestr</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">UpdateChemcompRestr</span><span class="p">(</span><span class="n">chemcompRestData</span><span class="p">):</span>
        
        <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span>  <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="n">rowLabl</span> <span class="o">=</span> <span class="n">ChemComps</span><span class="o">.</span><span class="n">GetRowLabelValue</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rowLabl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Restr&#39;</span> <span class="ow">in</span> <span class="n">rowLabl</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">chemcompTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">chemcompRestData</span><span class="p">[</span><span class="s">&#39;Sites&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">][</span><span class="n">c</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>         <span class="c">#obsd or esd</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">chemcompTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rowLabl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">chemcompRestData</span><span class="p">[</span><span class="s">&#39;Sites&#39;</span><span class="p">][</span><span class="n">row</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="nb">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>     <span class="c">#only factor</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateChemcompRestr</span><span class="p">,</span><span class="n">chemcompRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnDeleteRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">ChemComps</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">rowLabl</span> <span class="o">=</span> <span class="n">ChemComps</span><span class="o">.</span><span class="n">GetRowLabelValue</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rowLabl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Restr&#39;</span> <span class="ow">in</span> <span class="n">rowLabl</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">chemcompList</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rowLabl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">chemcompList</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">term</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">chemcompList</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">term</span><span class="p">]</span>
            <span class="n">UpdateChemcompRestr</span><span class="p">(</span><span class="n">chemcompRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnChangeValue</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">ChemComps</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">ChemComps</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleFloatDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;New value&#39;</span><span class="p">,</span>
                <span class="s">&#39;Enter new value for restraint multiplier&#39;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,[</span><span class="o">-</span><span class="mf">1.e6</span><span class="p">,</span><span class="mf">1.e6</span><span class="p">],</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">parm</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="n">rowLabl</span> <span class="o">=</span> <span class="n">ChemComps</span><span class="o">.</span><span class="n">GetRowLabelValue</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;term&#39;</span> <span class="ow">in</span> <span class="n">rowLabl</span><span class="p">:</span>
                        <span class="n">items</span> <span class="o">=</span> <span class="n">rowLabl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                        <span class="n">chemcompRestData</span><span class="p">[</span><span class="s">&#39;Sites&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">1</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span> <span class="o">=</span> <span class="n">parm</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">UpdateChemcompRestr</span><span class="p">(</span><span class="n">chemcompRestData</span><span class="p">)</span>                

        <span class="n">ChemCompRestr</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">ChemCompRestr</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WtBox</span><span class="p">(</span><span class="n">ChemCompRestr</span><span class="p">,</span><span class="n">chemcompRestData</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">ChemCompRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
            <span class="s">&#39;NB: The chemical restraint sum is over the unit cell contents&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">chemcompList</span> <span class="o">=</span> <span class="n">chemcompRestData</span><span class="p">[</span><span class="s">&#39;Sites&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chemcompList</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">bad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,]</span><span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">,]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">,</span><span class="s">&#39;mul*frac&#39;</span><span class="p">,</span><span class="s">&#39;factor&#39;</span><span class="p">,</span><span class="s">&#39;calc&#39;</span><span class="p">,</span><span class="s">&#39;obs&#39;</span><span class="p">,</span><span class="s">&#39;esd&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">indx</span><span class="p">,</span><span class="n">factors</span><span class="p">,</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chemcompList</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">atoms</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">mul</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">GetAtomItemsById</span><span class="p">(</span><span class="n">Atoms</span><span class="p">,</span><span class="n">AtLookUp</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">cs</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">mulfrac</span> <span class="o">=</span> <span class="n">mul</span><span class="o">*</span><span class="n">frac</span>
                    <span class="n">calcs</span> <span class="o">=</span> <span class="n">mul</span><span class="o">*</span><span class="n">frac</span><span class="o">*</span><span class="n">factors</span>
                    <span class="k">for</span> <span class="n">iatm</span><span class="p">,[</span><span class="n">atom</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">clc</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span><span class="n">mulfrac</span><span class="p">,</span><span class="n">factors</span><span class="p">,</span><span class="n">calcs</span><span class="p">)):</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">atom</span><span class="p">,</span><span class="n">mf</span><span class="p">,</span><span class="n">fr</span><span class="p">,</span><span class="n">clc</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">])</span>
                        <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;term:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iatm</span><span class="p">))</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&#39;Sum&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">calcs</span><span class="p">),</span><span class="n">obs</span><span class="p">,</span><span class="n">esd</span><span class="p">])</span>
                    <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Restr:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;**** WARNING - missing atom - restraint deleted ****&#39;</span>
                    <span class="n">bad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad</span><span class="p">):</span>
                <span class="n">bad</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ibad</span> <span class="ow">in</span> <span class="n">bad</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">chemcompList</span><span class="p">[</span><span class="n">ibad</span><span class="p">]</span>
            <span class="n">chemcompTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">ChemComps</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">ChemCompRestr</span><span class="p">)</span>
            <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">chemcompTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">ChemComps</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">chemcompTable</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;Restr&#39;</span> <span class="ow">in</span> <span class="n">ChemComps</span><span class="o">.</span><span class="n">GetRowLabelValue</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                        <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>
                        <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>
                        <span class="n">ChemComps</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
                        
            <span class="n">ChemComps</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span><span class="n">OnRowSelect</span><span class="p">)</span>
            <span class="n">ChemComps</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">OnCellChange</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDeleteRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTDELETE</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnChangeValue</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ChemComps</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">ChemCompRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No chemical composition restraints for this phase&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,)</span>

        <span class="n">ChemCompRestr</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">50</span>       <span class="c">#make room for tab</span>
        <span class="n">ChemCompRestr</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">ChemCompRestr</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
    
        
    <span class="k">def</span> <span class="nf">UpdateTextureRestr</span><span class="p">(</span><span class="n">textureRestData</span><span class="p">):</span>
            
        <span class="k">def</span> <span class="nf">OnDeleteRestraint</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">Textures</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="n">textureList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">textureList</span><span class="p">[</span><span class="n">row</span><span class="p">])</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateTextureRestr</span><span class="p">,</span><span class="n">textureRestData</span><span class="p">)</span>                
            
        <span class="k">def</span> <span class="nf">OnCellChange</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetRow</span><span class="p">(),</span><span class="n">event</span><span class="o">.</span><span class="n">GetCol</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">textureRestData</span><span class="p">[</span><span class="s">&#39;HKLs&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c">#grid size</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">textureTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">new</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">valueError</span>
                <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>   <span class="c">#esds</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">textureTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.</span> <span class="ow">or</span> <span class="n">new</span> <span class="o">&gt;</span> <span class="mf">2.</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new</span> <span class="o">=</span> <span class="n">textureTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
                <span class="n">textureRestData</span><span class="p">[</span><span class="s">&#39;HKLs&#39;</span><span class="p">][</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>            
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">UpdateTextureRestr</span><span class="p">,</span><span class="n">textureRestData</span><span class="p">)</span>                

        <span class="n">TextureRestr</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        <span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">(</span><span class="n">TextureRestr</span><span class="p">)</span>
        <span class="n">mainSizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">WtBox</span><span class="p">(</span><span class="n">TextureRestr</span><span class="p">,</span><span class="n">textureRestData</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">TextureRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> 
            <span class="s">&#39;NB: The texture restraints suppress negative pole figure values for the selected HKLs</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="s">&#39;    &quot;unit esd&quot; gives a bias toward a flatter polefigure&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span><span class="p">)</span>
        <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">textureList</span> <span class="o">=</span> <span class="n">textureRestData</span><span class="p">[</span><span class="s">&#39;HKLs&#39;</span><span class="p">]</span>
        <span class="n">textureData</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">textureList</span><span class="p">):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rowLabels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Types</span> <span class="o">=</span> <span class="p">[</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_STRING</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_LONG</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">,</span>
                <span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_BOOL</span><span class="p">,</span><span class="n">wg</span><span class="o">.</span><span class="n">GRID_VALUE_FLOAT</span><span class="o">+</span><span class="s">&#39;:10,2&#39;</span><span class="p">]</span>
            <span class="n">colLabels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;HKL&#39;</span><span class="p">,</span><span class="s">&#39;grid&#39;</span><span class="p">,</span><span class="s">&#39;neg esd&#39;</span><span class="p">,</span><span class="s">&#39;use unit?&#39;</span><span class="p">,</span><span class="s">&#39;unit esd&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,[</span><span class="n">hkl</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">esd1</span><span class="p">,</span><span class="n">ifesd2</span><span class="p">,</span><span class="n">esd2</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">textureList</span><span class="p">):</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s"> </span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hkl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">hkl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">hkl</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span><span class="n">grid</span><span class="p">,</span><span class="n">esd1</span><span class="p">,</span><span class="n">ifesd2</span><span class="p">,</span><span class="n">esd2</span><span class="p">])</span>
                <span class="n">rowLabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">textureTable</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="n">rowLabels</span><span class="o">=</span><span class="n">rowLabels</span><span class="p">,</span><span class="n">colLabels</span><span class="o">=</span><span class="n">colLabels</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">Types</span><span class="p">)</span>
            <span class="n">Textures</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSGrid</span><span class="p">(</span><span class="n">TextureRestr</span><span class="p">)</span>
            <span class="n">Textures</span><span class="o">.</span><span class="n">SetTable</span><span class="p">(</span><span class="n">textureTable</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">Textures</span><span class="o">.</span><span class="n">AutoSizeColumns</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">textureList</span><span class="p">)):</span>
                <span class="n">Textures</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">Textures</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">textureTable</span><span class="o">.</span><span class="n">GetValue</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
                    <span class="n">Textures</span><span class="o">.</span><span class="n">SetReadOnly</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Textures</span><span class="o">.</span><span class="n">SetCellStyle</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">Textures</span><span class="o">.</span><span class="n">SetCellTextColour</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">VERY_LIGHT_GREY</span><span class="p">)</span>
            <span class="n">Textures</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_LABEL_LEFT_CLICK</span><span class="p">,</span><span class="n">OnRowSelect</span><span class="p">)</span>
            <span class="n">Textures</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">EVT_GRID_CELL_CHANGE</span><span class="p">,</span> <span class="n">OnCellChange</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnDeleteRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTDELETE</span><span class="p">)</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">Textures</span><span class="p">,</span><span class="mi">0</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mainSizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">TextureRestr</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;No texture restraints for this phase&#39;</span><span class="p">),</span><span class="mi">0</span><span class="p">,)</span>
        <span class="n">TextureRestr</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">mainSizer</span><span class="p">)</span>
        <span class="n">Size</span> <span class="o">=</span> <span class="n">mainSizer</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">)</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>
        <span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">50</span>       <span class="c">#make room for tab</span>
        <span class="n">TextureRestr</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
        <span class="n">TextureRestr</span><span class="o">.</span><span class="n">SetScrollbars</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">OnPageChanged</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="s">&#39;Change value&#39;</span><span class="p">)</span>
        <span class="n">SetStatusLine</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Bond restraints&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">bondRestData</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Bond&#39;</span><span class="p">]</span>
            <span class="n">UpdateBondRestr</span><span class="p">(</span><span class="n">bondRestData</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Angle restraints&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">angleRestData</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Angle&#39;</span><span class="p">]</span>
            <span class="n">UpdateAngleRestr</span><span class="p">(</span><span class="n">angleRestData</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Plane restraints&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">planeRestData</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Plane&#39;</span><span class="p">]</span>
            <span class="n">UpdatePlaneRestr</span><span class="p">(</span><span class="n">planeRestData</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Chiral restraints&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">chiralRestData</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Chiral&#39;</span><span class="p">]</span>
            <span class="n">UpdateChiralRestr</span><span class="p">(</span><span class="n">chiralRestData</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Torsion restraints&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_AARESTRAINTPLOT</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">torsionRestData</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Torsion&#39;</span><span class="p">]</span>
            <span class="n">UpdateTorsionRestr</span><span class="p">(</span><span class="n">torsionRestData</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Ramachandran restraints&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_AARESTRAINTPLOT</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ramaRestData</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Rama&#39;</span><span class="p">]</span>
            <span class="n">UpdateRamaRestr</span><span class="p">(</span><span class="n">ramaRestData</span><span class="p">)</span>
            <span class="n">G2plt</span><span class="o">.</span><span class="n">PlotRama</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">phaseName</span><span class="p">,</span><span class="n">rama</span><span class="p">,</span><span class="n">ramaName</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Chem. comp. restraints&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="s">&#39;Change factor&#39;</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTCHANGEESD</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">chemcompRestData</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;ChemComp&#39;</span><span class="p">]</span>
            <span class="n">UpdateChemcompRestr</span><span class="p">(</span><span class="n">chemcompRestData</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span> <span class="o">==</span> <span class="s">&#39;Texture restraints&#39;</span><span class="p">:</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESRCHANGEVAL</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">textureRestData</span> <span class="o">=</span> <span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Texture&#39;</span><span class="p">]</span>
            <span class="n">UpdateTextureRestr</span><span class="p">(</span><span class="n">textureRestData</span><span class="p">)</span>
            
        <span class="n">event</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">SetStatusLine</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="n">Status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>                                      
        
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">:</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        
    <span class="n">G2gd</span><span class="o">.</span><span class="n">SetDataMenuBar</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintMenu</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;restraints for &#39;</span><span class="o">+</span><span class="n">phaseName</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">GetStatusBar</span><span class="p">():</span>
        <span class="n">Status</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">CreateStatusBar</span><span class="p">()</span>
    <span class="n">SetStatusLine</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTSELPHASE</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTSELPHASE</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnSelectPhase</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTSELPHASE</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnAddRestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_RESTRAINTADD</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">phasedata</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">RestraintEdit</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_AARESTRAINTADD</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnAddAARestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_AARESTRAINTADD</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="n">OnPlotAARestraint</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">G2gd</span><span class="o">.</span><span class="n">wxID_AARESTRAINTPLOT</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GSNoteBook</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">GetClientSize</span><span class="p">())</span>
    
    <span class="n">BondRestr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">BondRestr</span><span class="p">,</span><span class="s">&#39;Bond restraints&#39;</span><span class="p">)</span>
    <span class="n">AngleRestr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">AngleRestr</span><span class="p">,</span><span class="s">&#39;Angle restraints&#39;</span><span class="p">)</span>
    <span class="n">PlaneRestr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">PlaneRestr</span><span class="p">,</span><span class="s">&#39;Plane restraints&#39;</span><span class="p">)</span>
    <span class="n">ChiralRestr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">ChiralRestr</span><span class="p">,</span><span class="s">&#39;Chiral restraints&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;macro&#39;</span> <span class="ow">in</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]:</span>
        <span class="n">TorsionRestr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">TorsionRestr</span><span class="p">,</span><span class="s">&#39;Torsion restraints&#39;</span><span class="p">)</span>
        <span class="n">RamaRestr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">RamaRestr</span><span class="p">,</span><span class="s">&#39;Ramachandran restraints&#39;</span><span class="p">)</span>
    <span class="n">ChemCompRestr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">ChemCompRestr</span><span class="p">,</span><span class="s">&#39;Chem. comp. restraints&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;SH Texture&#39;</span><span class="p">][</span><span class="s">&#39;Order&#39;</span><span class="p">]:</span>
        <span class="n">TextureRestr</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">TextureRestr</span><span class="p">,</span><span class="s">&#39;Texture restraints&#39;</span><span class="p">)</span>
    
    <span class="n">UpdateBondRestr</span><span class="p">(</span><span class="n">restrData</span><span class="p">[</span><span class="s">&#39;Bond&#39;</span><span class="p">])</span>

    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">aui</span><span class="o">.</span><span class="n">EVT_AUINOTEBOOK_PAGE_CHANGED</span><span class="p">,</span> <span class="n">OnPageChanged</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Von Dreele and Toby for Argonne National Laboratory.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>