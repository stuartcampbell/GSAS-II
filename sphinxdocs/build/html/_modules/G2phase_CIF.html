

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>G2phase_CIF &mdash; GSAS-II 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="GSAS-II 0.2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for G2phase_CIF</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">########### SVN repository information ###################</span>
<span class="c"># $Date: 2013-12-16 10:43:01 -0600 (Mon, 16 Dec 2013) $</span>
<span class="c"># $Author: toby $</span>
<span class="c"># $Revision: 1168 $</span>
<span class="c"># $URL: https://subversion.xor.aps.anl.gov/pyGSAS/trunk/imports/G2phase_CIF.py $</span>
<span class="c"># $Id: G2phase_CIF.py 1168 2013-12-16 16:43:01Z toby $</span>
<span class="c">########### SVN repository information ###################</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">*Module G2phase_CIF: Coordinates from CIF*</span>
<span class="sd">------------------------------------------</span>

<span class="sd">Parses a CIF using  PyCifRW from James Hester and pulls out the</span>
<span class="sd">structural information.</span>

<span class="sd">If a CIF generated by ISODISTORT is encountered, extra information is</span>
<span class="sd">added to the phase entry and constraints are generated. </span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="c"># Routines to import Phase information from CIF files</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">random</span> <span class="kn">as</span> <span class="nn">ran</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">GSASIIIO</span> <span class="kn">as</span> <span class="nn">G2IO</span>
<span class="kn">import</span> <span class="nn">GSASIIobj</span> <span class="kn">as</span> <span class="nn">G2obj</span>
<span class="kn">import</span> <span class="nn">GSASIIspc</span> <span class="kn">as</span> <span class="nn">G2spc</span>
<span class="kn">import</span> <span class="nn">GSASIIElem</span> <span class="kn">as</span> <span class="nn">G2elem</span>
<span class="kn">import</span> <span class="nn">GSASIIlattice</span> <span class="kn">as</span> <span class="nn">G2lat</span>
<span class="kn">import</span> <span class="nn">GSASIIpy3</span> <span class="kn">as</span> <span class="nn">G2p3</span>
<span class="kn">import</span> <span class="nn">GSASIIpath</span>
<span class="n">GSASIIpath</span><span class="o">.</span><span class="n">SetVersionNumber</span><span class="p">(</span><span class="s">&quot;$Revision: 1168 $&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">CifFile</span> <span class="kn">as</span> <span class="nn">cif</span> <span class="c"># PyCifRW from James Hester</span>

<div class="viewcode-block" id="CIFPhaseReader"><a class="viewcode-back" href="../imports.html#G2phase_CIF.CIFPhaseReader">[docs]</a><span class="k">class</span> <span class="nc">CIFPhaseReader</span><span class="p">(</span><span class="n">G2IO</span><span class="o">.</span><span class="n">ImportPhase</span><span class="p">):</span>
    <span class="s">&#39;Implements a phase importer from a possibly multi-block CIF file&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="c"># fancy way to say ImportPhase.__init__</span>
            <span class="n">extensionlist</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;.CIF&#39;</span><span class="p">,</span><span class="s">&#39;.cif&#39;</span><span class="p">,</span><span class="s">&#39;.txt&#39;</span><span class="p">),</span>
            <span class="n">strictExtension</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">formatName</span> <span class="o">=</span> <span class="s">&#39;CIF&#39;</span><span class="p">,</span>
            <span class="n">longFormatName</span> <span class="o">=</span> <span class="s">&#39;Crystallographic Information File import&#39;</span>
            <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">ContentsValidator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepointer</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIFValidator</span><span class="p">(</span><span class="n">filepointer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">filepointer</span><span class="p">,</span> <span class="n">ParentFrame</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">usedRanIdList</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">unused</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isodistort_warnings</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span> <span class="o">=</span> <span class="n">G2IO</span><span class="o">.</span><span class="n">SetNewPhase</span><span class="p">(</span><span class="n">Name</span><span class="o">=</span><span class="s">&#39;new phase&#39;</span><span class="p">,</span><span class="n">SGData</span><span class="o">=</span><span class="n">G2IO</span><span class="o">.</span><span class="n">P1SGData</span><span class="p">)</span> <span class="c"># create a new empty phase dict</span>
        <span class="c"># make sure the ranId is really unique!</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;ranId&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">usedRanIdList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;ranId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ran</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">)</span>
        <span class="n">returnstat</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">cellitems</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;_cell_length_a&#39;</span><span class="p">,</span><span class="s">&#39;_cell_length_b&#39;</span><span class="p">,</span><span class="s">&#39;_cell_length_c&#39;</span><span class="p">,</span>
            <span class="s">&#39;_cell_angle_alpha&#39;</span><span class="p">,</span><span class="s">&#39;_cell_angle_beta&#39;</span><span class="p">,</span><span class="s">&#39;_cell_angle_gamma&#39;</span><span class="p">,)</span>
        <span class="n">reqitems</span> <span class="o">=</span> <span class="p">(</span>
             <span class="s">&#39;_atom_site_fract_x&#39;</span><span class="p">,</span>
             <span class="s">&#39;_atom_site_fract_y&#39;</span><span class="p">,</span>
             <span class="s">&#39;_atom_site_fract_z&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">phasenamefields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;_chemical_name_common&#39;</span><span class="p">,</span>
            <span class="s">&#39;_pd_phase_name&#39;</span><span class="p">,</span>
            <span class="s">&#39;_chemical_formula_sum&#39;</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ShowBusy</span><span class="p">()</span> <span class="c"># this can take a while</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cf</span> <span class="o">=</span> <span class="n">G2IO</span><span class="o">.</span><span class="n">ReadCIF</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="s">&quot;Parse or reading of file failed in pyCifRW; check syntax of file in enCIFer or CheckCIF&quot;</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">DoneBusy</span><span class="p">()</span>
            <span class="c"># scan blocks for structural info</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;Error during scan of blocks for datasets&#39;</span>
            <span class="n">str_blklist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">blk</span> <span class="ow">in</span> <span class="n">cf</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reqitems</span><span class="o">+</span><span class="n">cellitems</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="n">blk</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">str_blklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blk</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">str_blklist</span><span class="p">:</span>
                <span class="n">selblk</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># no block to choose</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">str_blklist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># only one choice</span>
                <span class="n">selblk</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>                       <span class="c"># choose from options</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">blknm</span> <span class="ow">in</span> <span class="n">str_blklist</span><span class="p">:</span>
                    <span class="n">choice</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="c"># accumumlate some info about this phase</span>
                    <span class="n">choice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">blknm</span> <span class="o">+</span> <span class="s">&#39;: &#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">phasenamefields</span><span class="p">:</span> <span class="c"># get a name for the phase</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="n">blknm</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">choice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">20</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;, &#39;</span>
                            <span class="k">break</span>
                    <span class="n">na</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="n">blknm</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;_atom_site_fract_x&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">na</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">choice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;1 atom&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">choice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">nd</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; atoms&#39;</span>
                    <span class="n">choice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;, cell: &#39;</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%.2f</span><span class="s">,&quot;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cellitems</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;%.f,&quot;</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span> <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;%.f&quot;</span>
                        <span class="n">choice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="n">cif</span><span class="o">.</span><span class="n">get_number_with_esd</span><span class="p">(</span>
                            <span class="n">cf</span><span class="p">[</span><span class="n">blknm</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">sg</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="n">blknm</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;_symmetry_space_group_name_H-M&quot;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sg</span><span class="p">:</span> <span class="n">sg</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="n">blknm</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;_space_group_name_H-M_alt&quot;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sg</span><span class="p">:</span> <span class="n">choice</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;, (&#39;</span> <span class="o">+</span> <span class="n">sg</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;)&#39;</span>
                <span class="n">selblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PhaseSelector</span><span class="p">(</span>
                    <span class="n">choice</span><span class="p">,</span>
                    <span class="n">ParentFrame</span><span class="o">=</span><span class="n">ParentFrame</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span> <span class="s">&#39;Select a phase from one the CIF data_ blocks below&#39;</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;Error during reading of selected block&#39;</span>
            <span class="k">if</span> <span class="n">selblk</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">returnstat</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># no block selected or available</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blknm</span> <span class="o">=</span> <span class="n">str_blklist</span><span class="p">[</span><span class="n">selblk</span><span class="p">]</span>
                <span class="n">blk</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="n">str_blklist</span><span class="p">[</span><span class="n">selblk</span><span class="p">]]</span>
                <span class="n">E</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">SpGrp</span> <span class="o">=</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;_symmetry_space_group_name_H-M&quot;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">SpGrp</span><span class="p">:</span>
                    <span class="n">SpGrp</span> <span class="o">=</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;_space_group_name_H-M_alt&quot;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="c"># try normalizing the space group, to see if we can pick the space group out of a table</span>
                <span class="n">SpGrpNorm</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">StandardizeSpcName</span><span class="p">(</span><span class="n">SpGrp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">SpGrpNorm</span><span class="p">:</span>
                    <span class="n">E</span><span class="p">,</span><span class="n">SGData</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SpcGroup</span><span class="p">(</span><span class="n">SpGrpNorm</span><span class="p">)</span>
                <span class="c"># nope, try the space group &quot;out of the Box&quot;</span>
                <span class="k">if</span> <span class="n">E</span> <span class="ow">and</span> <span class="n">SpGrp</span><span class="p">:</span>
                    <span class="n">E</span><span class="p">,</span><span class="n">SGData</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SpcGroup</span><span class="p">(</span><span class="n">SpGrp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">E</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">SpGrp</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39;No space group name was found in the CIF.&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">The space group has been set to &quot;P 1&quot;. &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&quot;Change this in phase&#39;s General tab.&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39;ERROR in space group symbol &#39;</span><span class="o">+</span><span class="n">SpGrp</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">The space group has been set to &quot;P 1&quot;. &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&quot;Change this in phase&#39;s General tab.&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Are there spaces separating axial fields?</span><span class="se">\n\n</span><span class="s">Error msg: &#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SGErrors</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
                    <span class="n">SGData</span> <span class="o">=</span> <span class="n">G2IO</span><span class="o">.</span><span class="n">SGData</span> <span class="c"># P 1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SGData</span>
                <span class="c"># cell parameters</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">cellitems</span><span class="p">:</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cif</span><span class="o">.</span><span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">blk</span><span class="p">[</span><span class="n">lbl</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">Volume</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">calc_V</span><span class="p">(</span><span class="n">G2lat</span><span class="o">.</span><span class="n">cell2A</span><span class="p">(</span><span class="n">cell</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span><span class="p">,]</span><span class="o">+</span><span class="n">cell</span><span class="o">+</span><span class="p">[</span><span class="n">Volume</span><span class="p">,]</span>
                <span class="c"># read in atoms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;Error during reading of atoms&#39;</span>
                <span class="n">atomlbllist</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># table to look up atom IDs</span>
                <span class="n">atomloop</span> <span class="o">=</span> <span class="n">blk</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s">&#39;_atom_site_label&#39;</span><span class="p">)</span>
                <span class="n">atomkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">atomloop</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_atom_site_type_symbol&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">isodistort_warnings</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">lack of atom types prevents ISODISTORT processing&#39;</span>
                <span class="k">if</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_atom_site_aniso_label&#39;</span><span class="p">):</span>
                    <span class="n">anisoloop</span> <span class="o">=</span> <span class="n">blk</span><span class="o">.</span><span class="n">GetLoop</span><span class="p">(</span><span class="s">&#39;_atom_site_aniso_label&#39;</span><span class="p">)</span>
                    <span class="n">anisokeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">anisoloop</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anisoloop</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">anisokeys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">G2AtomDict</span> <span class="o">=</span> <span class="p">{</span>  <span class="s">&#39;_atom_site_type_symbol&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_label&#39;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_fract_x&#39;</span> <span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_fract_y&#39;</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_fract_z&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_occupancy&#39;</span> <span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_aniso_u_11&#39;</span> <span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_aniso_u_22&#39;</span> <span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_aniso_u_33&#39;</span> <span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_aniso_u_12&#39;</span> <span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_aniso_u_13&#39;</span> <span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                                <span class="s">&#39;_atom_site_aniso_u_23&#39;</span> <span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="p">}</span>
                <span class="n">ranIdlookup</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">aitem</span> <span class="ow">in</span> <span class="n">atomloop</span><span class="p">:</span>
                    <span class="n">atomlist</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;I&#39;</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">atomlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ran</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">)</span> <span class="c"># add a random Id</span>
                    <span class="k">while</span> <span class="n">atomlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ranIdlookup</span><span class="p">:</span>
                        <span class="n">atomlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ran</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">)</span> <span class="c"># make it unique</span>
                    <span class="k">for</span> <span class="n">val</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">aitem</span><span class="p">,</span><span class="n">atomkeys</span><span class="p">):</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="n">G2AtomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">col</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">atomlist</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">cif</span><span class="o">.</span><span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">atomlist</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;_atom_site_thermal_displace_type&#39;</span><span class="p">,</span>
                                   <span class="s">&#39;_atom_site_adp_type&#39;</span><span class="p">):</span>   <span class="c">#Iso or Aniso?</span>
                            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;uani&#39;</span><span class="p">:</span>
                                <span class="n">atomlist</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;A&#39;</span>
                        <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;_atom_site_u_iso_or_equiv&#39;</span><span class="p">:</span>
                            <span class="n">atomlist</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span><span class="n">cif</span><span class="o">.</span><span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">atomlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="n">atomlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">typ</span> <span class="o">=</span> <span class="n">atomlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">G2elem</span><span class="o">.</span><span class="n">CheckElement</span><span class="p">(</span><span class="n">typ</span><span class="p">):</span>
                                <span class="n">atomlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">typ</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">atomlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">atomlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Xe&#39;</span>
                    <span class="n">ulbl</span> <span class="o">=</span> <span class="s">&#39;_atom_site_aniso_label&#39;</span>
                    <span class="k">if</span>  <span class="n">atomlist</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span> <span class="ow">and</span> <span class="n">atomlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ulbl</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">val</span><span class="p">,</span><span class="n">key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">anisoloop</span><span class="o">.</span><span class="n">GetKeyedPacket</span><span class="p">(</span><span class="n">ulbl</span><span class="p">,</span><span class="n">atomlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                           <span class="n">anisokeys</span><span class="p">):</span>
                            <span class="n">col</span> <span class="o">=</span> <span class="n">G2AtomDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">col</span><span class="p">:</span>
                                <span class="n">atomlist</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">cif</span><span class="o">.</span><span class="n">get_number_with_esd</span><span class="p">(</span><span class="n">val</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">atomlist</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">atomlist</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">SytSym</span><span class="p">(</span><span class="n">atomlist</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span><span class="n">SGData</span><span class="p">)</span>
                    <span class="n">atomlist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2elem</span><span class="o">.</span><span class="n">FixValence</span><span class="p">(</span><span class="n">atomlist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomlist</span><span class="p">)</span>
                    <span class="n">ranIdlookup</span><span class="p">[</span><span class="n">atomlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">atomlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">atomlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">atomlbllist</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: repeated atom label: &#39;</span><span class="o">+</span><span class="n">atomlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">atomlbllist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atomlbllist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">isodistort_warnings</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">Repeated atom labels prevents ISODISTORT decode&#39;</span>
                <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">phasenamefields</span><span class="p">:</span> <span class="c"># get a name for the phase</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># no name found, use block name for lack of a better choice</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">blknm</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">20</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isodistort_warnings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_displacivemode_label&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_occupancymode_label&#39;</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="s">&quot;Error while processing ISODISTORT constraints&quot;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ISODISTORT_proc</span><span class="p">(</span><span class="n">blk</span><span class="p">,</span><span class="n">atomlbllist</span><span class="p">,</span><span class="n">ranIdlookup</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isodistort_warnings</span>
                <span class="n">returnstat</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;CIF error:&#39;</span><span class="p">,</span><span class="n">detail</span> <span class="c"># for testing</span>
            <span class="k">print</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># for testing</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="k">print</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">returnstat</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">returnstat</span>

<div class="viewcode-block" id="CIFPhaseReader.ISODISTORT_proc"><a class="viewcode-back" href="../imports.html#G2phase_CIF.CIFPhaseReader.ISODISTORT_proc">[docs]</a>    <span class="k">def</span> <span class="nf">ISODISTORT_proc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">blk</span><span class="p">,</span><span class="n">atomlbllist</span><span class="p">,</span><span class="n">ranIdlookup</span><span class="p">):</span>
        <span class="s">&#39;Process ISODISTORT items to create constraints etc.&#39;</span>
        <span class="n">varLookup</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;dx&#39;</span><span class="p">:</span><span class="s">&#39;dAx&#39;</span><span class="p">,</span><span class="s">&#39;dy&#39;</span><span class="p">:</span><span class="s">&#39;dAy&#39;</span><span class="p">,</span><span class="s">&#39;dz&#39;</span><span class="p">:</span><span class="s">&#39;dAz&#39;</span><span class="p">,</span><span class="s">&#39;do&#39;</span><span class="p">:</span><span class="s">&#39;Afrac&#39;</span><span class="p">}</span>
        <span class="s">&#39;Maps ISODISTORT parm names to GSAS-II names&#39;</span>
        <span class="c">#----------------------------------------------------------------------</span>
        <span class="c"># read in the ISODISTORT displacement modes</span>
        <span class="c">#----------------------------------------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Constraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">explaination</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_displacivemode_label&#39;</span><span class="p">):</span>
            <span class="n">modelist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">shortmodelist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_displacivemode_label&#39;</span><span class="p">):</span>
                <span class="n">modelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
                <span class="c"># assume lbl is of form SSSSS[x,y,z]AAAA(a,b,...)BBBBB</span>
                <span class="c"># where SSSSS is the parent spacegroup, [x,y,z] is a location </span>
                <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;.*?\[.*?\](.*?)\(.*?\)(.*)&#39;</span><span class="p">,</span><span class="n">lbl</span><span class="p">)</span>
                <span class="c"># this extracts the AAAAA and BBBBB parts of the string</span>
                <span class="k">if</span> <span class="n">regexp</span><span class="p">:</span>
                    <span class="n">lbl</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="s">r&#39;\1\2&#39;</span><span class="p">)</span> <span class="c"># parse succeeded, make a short version</span>
                <span class="n">G2obj</span><span class="o">.</span><span class="n">MakeUniqueLabel</span><span class="p">(</span><span class="n">lbl</span><span class="p">,</span><span class="n">shortmodelist</span><span class="p">)</span> <span class="c"># make unique and add to list</span>
            <span class="c"># read in the coordinate offset variables names and map them to G2 names/objects</span>
            <span class="n">coordVarLbl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">G2varLbl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">G2varObj</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_deltacoordinate_label&#39;</span><span class="p">):</span>
                <span class="n">coordVarLbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">lbl</span><span class="p">:</span>
                    <span class="n">albl</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[:</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
                    <span class="n">vlbl</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_deltacoordinate_label not parsed: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">albl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomlbllist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_deltacoordinate_label atom not found: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anum</span> <span class="o">=</span> <span class="n">atomlbllist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">albl</span><span class="p">)</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">varLookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vlbl</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_deltacoordinate_label variable not found: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="n">G2varLbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="o">+</span><span class="n">var</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">anum</span><span class="p">))</span> <span class="c"># variable name, less phase ID</span>
                <span class="n">G2varObj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2obj</span><span class="o">.</span><span class="n">G2VarObj</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;ranId&#39;</span><span class="p">],</span><span class="bp">None</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">ranIdlookup</span><span class="p">[</span><span class="n">albl</span><span class="p">])</span>
                    <span class="p">))</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s">&quot;Error decoding variable labels&quot;</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">G2varObj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modelist</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;non-square input&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s">&quot;Rank of _iso_displacivemode != _iso_deltacoordinate&quot;</span>

            <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ParentCoordinates</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span><span class="n">exp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_coordinate_label&#39;</span><span class="p">),</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_coordinate_formula&#39;</span><span class="p">),</span>
                <span class="p">):</span>
                <span class="k">if</span> <span class="s">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">lbl</span><span class="p">:</span>
                    <span class="n">albl</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[:</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
                    <span class="n">vlbl</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_coordinate_label not parsed: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">vlbl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&#39;xyz&#39;</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">vlbl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_coordinate_label coordinate not parsed: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="n">i</span> <span class="o">=</span> <span class="s">&#39;xyz&#39;</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">vlbl</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ParentCoordinates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">albl</span><span class="p">):</span>
                    <span class="n">ParentCoordinates</span><span class="p">[</span><span class="n">albl</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">G2p3</span><span class="o">.</span><span class="n">FormulaEval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_coordinate_formula coordinate not interpreted: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">continue</span>
                    <span class="n">ParentCoordinates</span><span class="p">[</span><span class="n">albl</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ParentCoordinates</span><span class="p">[</span><span class="n">albl</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2p3</span><span class="o">.</span><span class="n">FormulaEval</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s">&quot;Error decoding variable labels&quot;</span>
            <span class="c"># get mapping of modes to atomic coordinate displacements</span>
            <span class="n">displacivemodematrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">G2varObj</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">G2varObj</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_displacivemodematrix_row&#39;</span><span class="p">),</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_displacivemodematrix_col&#39;</span><span class="p">),</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_displacivemodematrix_value&#39;</span><span class="p">),):</span>
                <span class="n">displacivemodematrix</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="c"># Invert to get mapping of atom displacements to modes</span>
            <span class="n">displacivemodeInvmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">displacivemodematrix</span><span class="p">)</span>
            <span class="c"># create the constraints</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displacivemodeInvmatrix</span><span class="p">):</span>
                <span class="n">constraint</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,(</span><span class="n">lbl</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">coordVarLbl</span><span class="p">,</span><span class="n">row</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">constraint</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">G2varObj</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
                <span class="n">constraint</span> <span class="o">+=</span> <span class="p">[</span><span class="n">shortmodelist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;f&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
            <span class="c">#----------------------------------------------------------------------</span>
            <span class="c"># save the ISODISTORT info for &quot;mode analysis&quot;</span>
            <span class="k">if</span> <span class="s">&#39;ISODISTORT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;ISODISTORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;ISODISTORT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s">&#39;IsoModeList&#39;</span> <span class="p">:</span> <span class="n">modelist</span><span class="p">,</span>
                <span class="s">&#39;G2ModeList&#39;</span> <span class="p">:</span> <span class="n">shortmodelist</span><span class="p">,</span>
                <span class="s">&#39;IsoVarList&#39;</span> <span class="p">:</span> <span class="n">coordVarLbl</span><span class="p">,</span>
                <span class="s">&#39;G2VarList&#39;</span> <span class="p">:</span> <span class="n">G2varObj</span><span class="p">,</span>
                <span class="s">&#39;ParentStructure&#39;</span> <span class="p">:</span> <span class="n">ParentCoordinates</span><span class="p">,</span>
                <span class="s">&#39;Var2ModeMatrix&#39;</span> <span class="p">:</span> <span class="n">displacivemodeInvmatrix</span><span class="p">,</span>
                <span class="s">&#39;Mode2VarMatrix&#39;</span> <span class="p">:</span> <span class="n">displacivemodematrix</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="c"># make explaination dictionary</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span><span class="n">shortmode</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">modelist</span><span class="p">,</span><span class="n">shortmodelist</span><span class="p">):</span>
                <span class="n">explaination</span><span class="p">[</span><span class="n">shortmode</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ISODISTORT full name &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="c">#----------------------------------------------------------------------</span>
        <span class="c"># now read in the ISODISTORT occupancy modes</span>
        <span class="c">#----------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_occupancymode_label&#39;</span><span class="p">):</span>
            <span class="n">modelist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">shortmodelist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_occupancymode_label&#39;</span><span class="p">):</span>
                <span class="n">modelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
                <span class="c"># assume lbl is of form SSSSS[x,y,z]AAAA(a,b,...)BBBBB</span>
                <span class="c"># where SSSSS is the parent spacegroup, [x,y,z] is a location </span>
                <span class="n">regexp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;.*?\[.*?\](.*?)\(.*?\)(.*)&#39;</span><span class="p">,</span><span class="n">lbl</span><span class="p">)</span>
                <span class="c"># this extracts the AAAAA and BBBBB parts of the string</span>
                <span class="k">if</span> <span class="n">regexp</span><span class="p">:</span>
                    <span class="n">lbl</span> <span class="o">=</span> <span class="n">regexp</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="s">r&#39;\1\2&#39;</span><span class="p">)</span> <span class="c"># parse succeeded, make a short version</span>
                <span class="n">lbl</span> <span class="o">=</span> <span class="n">lbl</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;order&#39;</span><span class="p">,</span><span class="s">&#39;o&#39;</span><span class="p">)</span>
                <span class="n">G2obj</span><span class="o">.</span><span class="n">MakeUniqueLabel</span><span class="p">(</span><span class="n">lbl</span><span class="p">,</span><span class="n">shortmodelist</span><span class="p">)</span> <span class="c"># make unique and add to list</span>
            <span class="c"># read in the coordinate offset variables names and map them to G2 names/objects</span>
            <span class="n">occVarLbl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">G2varLbl</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">G2varObj</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_deltaoccupancy_label&#39;</span><span class="p">):</span>
                <span class="n">occVarLbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">lbl</span><span class="p">:</span>
                    <span class="n">albl</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[:</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
                    <span class="n">vlbl</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_deltaoccupancy_label not parsed: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">albl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atomlbllist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_deltaoccupancy_label atom not found: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anum</span> <span class="o">=</span> <span class="n">atomlbllist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">albl</span><span class="p">)</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">varLookup</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vlbl</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_deltaoccupancy_label variable not found: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="n">G2varLbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="o">+</span><span class="n">var</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">anum</span><span class="p">))</span> <span class="c"># variable name, less phase ID</span>
                <span class="n">G2varObj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2obj</span><span class="o">.</span><span class="n">G2VarObj</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;ranId&#39;</span><span class="p">],</span><span class="bp">None</span><span class="p">,</span><span class="n">var</span><span class="p">,</span><span class="n">ranIdlookup</span><span class="p">[</span><span class="n">albl</span><span class="p">])</span>
                    <span class="p">))</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s">&quot;Error decoding variable labels&quot;</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">G2varObj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">modelist</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;non-square input&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s">&quot;Rank of _iso_occupancymode != _iso_deltaoccupancy&quot;</span>

            <span class="n">error</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">ParentCoordinates</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span><span class="n">exp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_occupancy_label&#39;</span><span class="p">),</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_occupancy_formula&#39;</span><span class="p">),</span>
                <span class="p">):</span>
                <span class="k">if</span> <span class="s">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">lbl</span><span class="p">:</span>
                    <span class="n">albl</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[:</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
                    <span class="n">vlbl</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_occupancy_label not parsed: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">vlbl</span> <span class="o">!=</span> <span class="s">&#39;occ&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_occupancy_label coordinate not parsed: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">exp</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">G2p3</span><span class="o">.</span><span class="n">FormulaEval</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">+=</span> <span class="s">&#39; ERROR: _iso_occupancy_formula coordinate not interpreted: &#39;</span><span class="o">+</span><span class="n">lbl</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">continue</span>
                    <span class="n">ParentCoordinates</span><span class="p">[</span><span class="n">albl</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s">&quot;Error decoding occupancy labels&quot;</span>
            <span class="c"># get mapping of modes to atomic coordinate displacements</span>
            <span class="n">occupancymodematrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">G2varObj</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">G2varObj</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_occupancymodematrix_row&#39;</span><span class="p">),</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_occupancymodematrix_col&#39;</span><span class="p">),</span>
                <span class="n">blk</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_iso_occupancymodematrix_value&#39;</span><span class="p">),):</span>
                <span class="n">occupancymodematrix</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="c"># Invert to get mapping of atom displacements to modes</span>
            <span class="n">occupancymodeInvmatrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">occupancymodematrix</span><span class="p">)</span>
            <span class="c"># create the constraints</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">occupancymodeInvmatrix</span><span class="p">):</span>
                <span class="n">constraint</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,(</span><span class="n">lbl</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">occVarLbl</span><span class="p">,</span><span class="n">row</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">constraint</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">k</span><span class="p">,</span><span class="n">G2varObj</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
                <span class="n">constraint</span> <span class="o">+=</span> <span class="p">[</span><span class="n">shortmodelist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;f&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span>
            <span class="c">#----------------------------------------------------------------------</span>
            <span class="c"># save the ISODISTORT info for &quot;mode analysis&quot;</span>
            <span class="k">if</span> <span class="s">&#39;ISODISTORT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;ISODISTORT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Phase</span><span class="p">[</span><span class="s">&#39;ISODISTORT&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s">&#39;OccModeList&#39;</span> <span class="p">:</span> <span class="n">modelist</span><span class="p">,</span>
                <span class="s">&#39;G2OccModeList&#39;</span> <span class="p">:</span> <span class="n">shortmodelist</span><span class="p">,</span>
                <span class="s">&#39;OccVarList&#39;</span> <span class="p">:</span> <span class="n">occVarLbl</span><span class="p">,</span>
                <span class="s">&#39;G2OccVarList&#39;</span> <span class="p">:</span> <span class="n">G2varObj</span><span class="p">,</span>
                <span class="s">&#39;BaseOcc&#39;</span> <span class="p">:</span> <span class="n">ParentCoordinates</span><span class="p">,</span>
                <span class="s">&#39;Var2OccMatrix&#39;</span> <span class="p">:</span> <span class="n">occupancymodeInvmatrix</span><span class="p">,</span>
                <span class="s">&#39;Occ2VarMatrix&#39;</span> <span class="p">:</span> <span class="n">occupancymodematrix</span><span class="p">,</span>
                <span class="p">})</span>
            <span class="c"># make explaination dictionary</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span><span class="n">shortmode</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">modelist</span><span class="p">,</span><span class="n">shortmodelist</span><span class="p">):</span>
                <span class="n">explaination</span><span class="p">[</span><span class="n">shortmode</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ISODISTORT full name &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="c">#----------------------------------------------------------------------</span>
        <span class="c"># done with read</span>
        <span class="c">#----------------------------------------------------------------------</span>
        <span class="k">if</span> <span class="n">explaination</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">explaination</span><span class="p">)</span>

        <span class="c"># # debug: show the mode var to mode relations</span>
        <span class="c"># for i,row in enumerate(displacivemodeInvmatrix):</span>
        <span class="c">#     l = &#39;&#39;</span>
        <span class="c">#     for j,(lbl,k) in enumerate(zip(coordVarLbl,row)):</span>
        <span class="c">#         if k == 0: continue</span>
        <span class="c">#         if l: l += &#39; + &#39;</span>
        <span class="c">#         #l += lbl+&#39; * &#39;+str(k)</span>
        <span class="c">#         l += G2varLbl[j]+&#39; * &#39;+str(k)</span>
        <span class="c">#     print str(i) + &#39;: &#39;+shortmodelist[i]+&#39; = &#39;+l</span>
        <span class="c"># print 70*&#39;=&#39;</span>

        <span class="c"># # debug: Get the ISODISTORT offset values</span>
        <span class="c"># coordVarDelta = {}</span>
        <span class="c"># for lbl,val in zip(</span>
        <span class="c">#     blk.get(&#39;_iso_deltacoordinate_label&#39;),</span>
        <span class="c">#     blk.get(&#39;_iso_deltacoordinate_value&#39;),):</span>
        <span class="c">#     coordVarDelta[lbl] = float(val)</span>
        <span class="c"># modeVarDelta = {}</span>
        <span class="c"># for lbl,val in zip(</span>
        <span class="c">#     blk.get(&#39;_iso_displacivemode_label&#39;),</span>
        <span class="c">#     blk.get(&#39;_iso_displacivemode_value&#39;),):</span>
        <span class="c">#     modeVarDelta[lbl] = cif.get_number_with_esd(val)[0]</span>

        <span class="c"># print 70*&#39;=&#39;</span>
        <span class="c"># # compute the mode values from the reported coordinate deltas</span>
        <span class="c"># for i,row in enumerate(displacivemodeInvmatrix):</span>
        <span class="c">#     l = &#39;&#39;</span>
        <span class="c">#     sl = &#39;&#39;</span>
        <span class="c">#     s = 0.</span>
        <span class="c">#     for lbl,k in zip(coordVarLbl,row):</span>
        <span class="c">#         if k == 0: continue</span>
        <span class="c">#         if l: l += &#39; + &#39;</span>
        <span class="c">#         l += lbl+&#39; * &#39;+str(k)</span>
        <span class="c">#         if sl: sl += &#39; + &#39;</span>
        <span class="c">#         sl += str(coordVarDelta[lbl])+&#39; * &#39;+str(k)</span>
        <span class="c">#         s += coordVarDelta[lbl] * k</span>
        <span class="c">#     print &#39;a&#39;+str(i)+&#39; = &#39;+l</span>
        <span class="c">#     print &#39;\t= &#39;+sl</span>
        <span class="c">#     print  modelist[i],shortmodelist[i],modeVarDelta[modelist[i]],s</span>
        <span class="c">#     print</span>

        <span class="c"># print 70*&#39;=&#39;</span>
        <span class="c"># # compute the coordinate displacements from the reported mode values</span>
        <span class="c"># for i,lbl,row in zip(range(len(coordVarLbl)),coordVarLbl,displacivemodematrix):</span>
        <span class="c">#     l = &#39;&#39;</span>
        <span class="c">#     sl = &#39;&#39;</span>
        <span class="c">#     s = 0.0</span>
        <span class="c">#     for j,k in enumerate(row):</span>
        <span class="c">#         if k == 0: continue</span>
        <span class="c">#         if l: l += &#39; + &#39;</span>
        <span class="c">#         l += &#39;a&#39;+str(j+1)+&#39; * &#39;+str(k)</span>
        <span class="c">#         if sl: sl += &#39; + &#39;</span>
        <span class="c">#         sl += str(shortmodelist[j]) +&#39; = &#39;+ str(modeVarDelta[modelist[j]]) + &#39; * &#39;+str(k)</span>
        <span class="c">#         s += modeVarDelta[modelist[j]] * k</span>
        <span class="c">#     print lbl+&#39; = &#39;+l</span>
        <span class="c">#     print &#39;\t= &#39;+sl</span>
        <span class="c">#     print lbl,G2varLbl[i],coordVarDelta[lbl],s</span>
        <span class="c">#     print</span>

        <span class="c"># determine the coordinate delta values from deviations from the parent structure</span>
        <span class="c"># for atmline in self.Phase[&#39;Atoms&#39;]:</span>
        <span class="c">#     lbl = atmline[0]</span>
        <span class="c">#     x,y,z = atmline[3:6]</span>
        <span class="c">#     if lbl not in ParentCoordinates:</span>
        <span class="c">#         print lbl,x,y,z</span>
        <span class="c">#         continue</span>
        <span class="c">#     px,py,pz = ParentCoordinates[lbl]</span>
        <span class="c">#     print lbl,x,y,z,x-px,y-py,z-pz</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/G2_html_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Von Dreele and Toby for Argonne National Laboratory.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>