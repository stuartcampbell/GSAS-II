

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>GSASIIplot &mdash; GSAS-II 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="GSAS-II 0.2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for GSASIIplot</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">*GSASIIplot: plotting routines*</span>
<span class="sd">===============================</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="c">########### SVN repository information ###################</span>
<span class="c"># $Date: 2013-10-15 15:01:21 -0500 (Tue, 15 Oct 2013) $</span>
<span class="c"># $Author: vondreele $</span>
<span class="c"># $Revision: 1107 $</span>
<span class="c"># $URL: https://subversion.xray.aps.anl.gov/pyGSAS/trunk/GSASIIplot.py $</span>
<span class="c"># $Id: GSASIIplot.py 1107 2013-10-15 20:01:21Z vondreele $</span>
<span class="c">########### SVN repository information ###################</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">nl</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">wx.aui</span>
<span class="kn">import</span> <span class="nn">wx.glcanvas</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">mpl_toolkits.mplot3d.axes3d</span> <span class="kn">as</span> <span class="nn">mp3d</span>
<span class="kn">import</span> <span class="nn">GSASIIpath</span>
<span class="n">GSASIIpath</span><span class="o">.</span><span class="n">SetVersionNumber</span><span class="p">(</span><span class="s">&quot;$Revision: 1107 $&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">GSASIIgrid</span> <span class="kn">as</span> <span class="nn">G2gd</span>
<span class="kn">import</span> <span class="nn">GSASIIimage</span> <span class="kn">as</span> <span class="nn">G2img</span>
<span class="kn">import</span> <span class="nn">GSASIIpwd</span> <span class="kn">as</span> <span class="nn">G2pwd</span>
<span class="kn">import</span> <span class="nn">GSASIIIO</span> <span class="kn">as</span> <span class="nn">G2IO</span>
<span class="kn">import</span> <span class="nn">GSASIIpwdGUI</span> <span class="kn">as</span> <span class="nn">G2pdG</span>
<span class="kn">import</span> <span class="nn">GSASIIimgGUI</span> <span class="kn">as</span> <span class="nn">G2imG</span>
<span class="kn">import</span> <span class="nn">GSASIIphsGUI</span> <span class="kn">as</span> <span class="nn">G2phG</span>
<span class="kn">import</span> <span class="nn">GSASIIlattice</span> <span class="kn">as</span> <span class="nn">G2lat</span>
<span class="kn">import</span> <span class="nn">GSASIIspc</span> <span class="kn">as</span> <span class="nn">G2spc</span>
<span class="kn">import</span> <span class="nn">GSASIImath</span> <span class="kn">as</span> <span class="nn">G2mth</span>
<span class="kn">import</span> <span class="nn">pytexture</span> <span class="kn">as</span> <span class="nn">ptx</span>
<span class="kn">from</span>  <span class="nn">OpenGL.GL</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">OpenGL.GLU</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">OpenGL.GLE</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">gltext</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_wx</span> <span class="kn">import</span> <span class="n">_load_bitmap</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_wxagg</span> <span class="kn">import</span> <span class="n">FigureCanvasWxAgg</span> <span class="k">as</span> <span class="n">Canvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_wxagg</span> <span class="kn">import</span> <span class="n">NavigationToolbar2Wx</span> <span class="k">as</span> <span class="n">Toolbar</span>

<span class="c"># useful degree trig functions</span>
<span class="n">sind</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">cosd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">tand</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">asind</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">asin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="n">acosd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">acos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="n">atan2d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="n">atand</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="c"># numpy versions</span>
<span class="n">npsind</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">npcosd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">nptand</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.</span><span class="p">)</span>
<span class="n">npacosd</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">npasind</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">npatand</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">npatan2d</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="mf">180.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    
<div class="viewcode-block" id="G2PlotMpl"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotMpl">[docs]</a><span class="k">class</span> <span class="nc">G2PlotMpl</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">):</span>    
    <span class="s">&#39;needs a doc string&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="nb">id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">&#39;legend.fontsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span> <span class="o">=</span> <span class="n">GSASIItoolbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">Realize</span><span class="p">()</span>
        
        <span class="n">sizer</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">sizer</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="G2PlotOgl"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotOgl">[docs]</a><span class="k">class</span> <span class="nc">G2PlotOgl</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">):</span>
    <span class="s">&#39;needs a doc string&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="nb">id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;win&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">:</span>           <span class="c">#Windows already double buffered</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">glcanvas</span><span class="o">.</span><span class="n">GLCanvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>                               <span class="c">#fix from Jim Hester for X systems</span>
            <span class="n">attribs</span> <span class="o">=</span> <span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">glcanvas</span><span class="o">.</span><span class="n">WX_GL_DOUBLEBUFFER</span><span class="p">,)</span>         
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">glcanvas</span><span class="o">.</span><span class="n">GLCanvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">attribList</span><span class="o">=</span><span class="n">attribs</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sizer</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">sizer</span><span class="p">)</span>
        </div>
<div class="viewcode-block" id="G2Plot3D"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2Plot3D">[docs]</a><span class="k">class</span> <span class="nc">G2Plot3D</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">):</span>
    <span class="s">&#39;needs a doc string&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="nb">id</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">Canvas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span> <span class="o">=</span> <span class="n">GSASIItoolbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">Realize</span><span class="p">()</span>
        
        <span class="n">sizer</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">sizer</span><span class="p">)</span>
                              </div>
<div class="viewcode-block" id="G2PlotNoteBook"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook">[docs]</a><span class="k">class</span> <span class="nc">G2PlotNoteBook</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="p">):</span>
    <span class="s">&#39;create a tabbed window for plotting&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="nb">id</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">Panel</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="c">#so one can&#39;t delete a plot page!!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">aui</span><span class="o">.</span><span class="n">AuiNotebook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> \
            <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">aui</span><span class="o">.</span><span class="n">AUI_NB_DEFAULT_STYLE</span> <span class="o">^</span> <span class="n">wx</span><span class="o">.</span><span class="n">aui</span><span class="o">.</span><span class="n">AUI_NB_CLOSE_ON_ACTIVE_TAB</span><span class="p">)</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">()</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">sizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">CreateStatusBar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFieldsCount</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusWidths</span><span class="p">([</span><span class="mi">150</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">aui</span><span class="o">.</span><span class="n">EVT_AUINOTEBOOK_PAGE_CHANGED</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnPageChanged</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KEY_UP</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">OnNotebookKey</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span> <span class="o">=</span> <span class="p">[]</span>
            
<div class="viewcode-block" id="G2PlotNoteBook.OnNotebookKey"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook.OnNotebookKey">[docs]</a>    <span class="k">def</span> <span class="nf">OnNotebookKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Called when a keystroke event gets picked up by the notebook window</span>
<span class="sd">        rather the child. This is not expected, but somehow it does sometimes</span>
<span class="sd">        on the Mac and perhaps Linux.</span>

<span class="sd">        Assume that the page associated with the currently displayed tab</span>
<span class="sd">        has a child, .canvas; give that child the focus and pass it the event.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># occurs with no plot tabs</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">PostEvent</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span><span class="n">event</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="G2PlotNoteBook.addMpl"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook.addMpl">[docs]</a>    <span class="k">def</span> <span class="nf">addMpl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="s">&#39;Add a tabbed page with a matplotlib plot&#39;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">G2PlotMpl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">page</span><span class="o">.</span><span class="n">figure</span>
        </div>
<div class="viewcode-block" id="G2PlotNoteBook.add3D"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook.add3D">[docs]</a>    <span class="k">def</span> <span class="nf">add3D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="s">&#39;Add a tabbed page with a 3D plot&#39;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">G2Plot3D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">page</span><span class="o">.</span><span class="n">figure</span>
        </div>
<div class="viewcode-block" id="G2PlotNoteBook.addOgl"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook.addOgl">[docs]</a>    <span class="k">def</span> <span class="nf">addOgl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="s">&#39;Add a tabbed page with an openGL plot&#39;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">G2PlotOgl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">AddPage</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">page</span><span class="o">.</span><span class="n">figure</span>
        </div>
<div class="viewcode-block" id="G2PlotNoteBook.Delete"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook.Delete">[docs]</a>    <span class="k">def</span> <span class="nf">Delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="s">&#39;delete a tabbed page&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">DeletePage</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>          <span class="c">#no plot of this name - do nothing</span>
            <span class="k">return</span>      
                </div>
<div class="viewcode-block" id="G2PlotNoteBook.clear"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&#39;clear all pages from plot window&#39;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPageCount</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">DeletePage</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
        </div>
<div class="viewcode-block" id="G2PlotNoteBook.Rename"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook.Rename">[docs]</a>    <span class="k">def</span> <span class="nf">Rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldName</span><span class="p">,</span><span class="n">newName</span><span class="p">):</span>
        <span class="s">&#39;rename a tab&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">oldName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">newName</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">SetPageText</span><span class="p">(</span><span class="n">item</span><span class="p">,</span><span class="n">newName</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>          <span class="c">#no plot of this name - do nothing</span>
            <span class="k">return</span>      
        </div>
<div class="viewcode-block" id="G2PlotNoteBook.OnPageChanged"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.G2PlotNoteBook.OnPageChanged">[docs]</a>    <span class="k">def</span> <span class="nf">OnPageChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;respond to someone pressing a tab on the plot window&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plotList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Better to select this from GSAS-II data tree&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>                           <span class="c">#get rid of special stuff on status bar</span>
        </div></div>
<div class="viewcode-block" id="GSASIItoolbar"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.GSASIItoolbar">[docs]</a><span class="k">class</span> <span class="nc">GSASIItoolbar</span><span class="p">(</span><span class="n">Toolbar</span><span class="p">):</span>
    <span class="s">&#39;needs a doc string&#39;</span>
    <span class="n">ON_MPL_HELP</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
    <span class="n">ON_MPL_KEY</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">NewId</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plotCanvas</span><span class="p">):</span>
        <span class="n">Toolbar</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">plotCanvas</span><span class="p">)</span>
        <span class="n">POSITION_OF_CONFIGURE_SUBPLOTS_BTN</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DeleteToolByPos</span><span class="p">(</span><span class="n">POSITION_OF_CONFIGURE_SUBPLOTS_BTN</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetParent</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;key.ico&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddSimpleTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ON_MPL_KEY</span><span class="p">,</span><span class="n">_load_bitmap</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="s">&#39;Key press&#39;</span><span class="p">,</span><span class="s">&#39;Select key press&#39;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_TOOL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ON_MPL_KEY</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">OnKey</span><span class="p">)</span>
        <span class="n">help</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;help.ico&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddSimpleTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ON_MPL_HELP</span><span class="p">,</span><span class="n">_load_bitmap</span><span class="p">(</span><span class="n">help</span><span class="p">),</span><span class="s">&#39;Help on&#39;</span><span class="p">,</span><span class="s">&#39;Show help on&#39;</span><span class="p">)</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EVT_TOOL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ON_MPL_HELP</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">OnHelp</span><span class="p">)</span>
<div class="viewcode-block" id="GSASIItoolbar.OnHelp"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.GSASIItoolbar.OnHelp">[docs]</a>    <span class="k">def</span> <span class="nf">OnHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;needs a doc string&#39;</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetParent</span><span class="p">()</span><span class="o">.</span><span class="n">GetParent</span><span class="p">()</span>
        <span class="n">pageNo</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="n">bookmark</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">pageNo</span><span class="p">)</span>
        <span class="n">bookmark</span> <span class="o">=</span> <span class="n">bookmark</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">ShowHelp</span><span class="p">(</span><span class="n">bookmark</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">TopLevelParent</span><span class="p">)</span></div>
<div class="viewcode-block" id="GSASIItoolbar.OnKey"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.GSASIItoolbar.OnKey">[docs]</a>    <span class="k">def</span> <span class="nf">OnKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;needs a doc string&#39;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetParent</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">Choice</span><span class="p">:</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Key press&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">Choice</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">Choice</span><span class="p">[</span><span class="n">sel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">keyPress</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            
<span class="c">################################################################################</span>
<span class="c">##### PlotSngl</span>
<span class="c">################################################################################</span>
            </div></div>
<div class="viewcode-block" id="PlotSngl"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotSngl">[docs]</a><span class="k">def</span> <span class="nf">PlotSngl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Single crystal structure factor plotting package - displays zone of reflections as rings proportional</span>
<span class="sd">        to F, F**2, etc. as requested</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Circle</span>
    <span class="k">global</span> <span class="n">HKL</span><span class="p">,</span><span class="n">HKLF</span>

    <span class="k">def</span> <span class="nf">OnSCMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="k">if</span> <span class="n">xpos</span><span class="p">:</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">xpos</span><span class="p">)</span>                                        <span class="c">#avoid out of frame mouse position</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">)</span>
            <span class="n">zpos</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Layer&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;100&#39;</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Zone&#39;</span><span class="p">]:</span>
                <span class="n">HKLtxt</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">zpos</span><span class="p">,</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s">&#39;010&#39;</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Zone&#39;</span><span class="p">]:</span>
                <span class="n">HKLtxt</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">zpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s">&#39;001&#39;</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Zone&#39;</span><span class="p">]:</span>
                <span class="n">HKLtxt</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">zpos</span><span class="p">)</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">HKLtxt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;HKL = &#39;</span><span class="o">+</span><span class="n">HKLtxt</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">])</span>
                
    <span class="k">def</span> <span class="nf">OnSCPick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">zpos</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Layer&#39;</span><span class="p">]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">artist</span><span class="o">.</span><span class="n">center</span>
        <span class="k">if</span> <span class="s">&#39;100&#39;</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Zone&#39;</span><span class="p">]:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;(picked:(</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">))&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">zpos</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">zpos</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="s">&#39;010&#39;</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Zone&#39;</span><span class="p">]:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;(picked:(</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">))&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zpos</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zpos</span><span class="p">,</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="s">&#39;001&#39;</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Zone&#39;</span><span class="p">]:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;(picked:(</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">))&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zpos</span><span class="p">))</span>
            <span class="n">hkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zpos</span><span class="p">])</span>
        <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">hkl</span>
        <span class="n">hklf</span> <span class="o">=</span> <span class="n">HKLF</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">HKL</span><span class="o">-</span><span class="n">hkl</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hklf</span><span class="p">):</span>
            <span class="n">Fosq</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">Fcsq</span> <span class="o">=</span> <span class="n">hklf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">HKLtxt</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s">,</span><span class="si">%3d</span><span class="s"> </span><span class="si">%.2f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.2f</span><span class="s"> </span><span class="si">%.2f</span><span class="s">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">Fosq</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">Fcsq</span><span class="p">,(</span><span class="n">Fosq</span><span class="o">-</span><span class="n">Fcsq</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">scale</span><span class="o">*</span><span class="n">sig</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;HKL, Fosq, sig, Fcsq, delFsq/sig = &#39;</span><span class="o">+</span><span class="n">HKLtxt</span><span class="p">])</span>
                                 
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Structure Factors&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get previous powder plot &amp; get limits</span>
            <span class="n">xylim</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get a fresh plot after clf()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Structure Factors&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Structure Factors&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;pick_event&#39;</span><span class="p">,</span> <span class="n">OnSCPick</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnSCMotion</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">HKLref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sngl</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;RefList&#39;</span><span class="p">]</span>
    <span class="n">Data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span> 
        <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Sngl</span><span class="p">,</span> <span class="s">&#39;HKL Plot Controls&#39;</span><span class="p">))</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">]</span>            
    <span class="n">scale</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span>
    <span class="n">HKLmax</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;HKLmax&#39;</span><span class="p">]</span>
    <span class="n">HKLmin</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;HKLmin&#39;</span><span class="p">]</span>
    <span class="n">FosqMax</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;FoMax&#39;</span><span class="p">]</span>
    <span class="n">FoMax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">FosqMax</span><span class="p">)</span>
    <span class="n">xlabel</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;k, h=&#39;</span><span class="p">,</span><span class="s">&#39;h, k=&#39;</span><span class="p">,</span><span class="s">&#39;h, l=&#39;</span><span class="p">]</span>
    <span class="n">ylabel</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;l&#39;</span><span class="p">,</span><span class="s">&#39;l&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">zones</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;100&#39;</span><span class="p">,</span><span class="s">&#39;010&#39;</span><span class="p">,</span><span class="s">&#39;001&#39;</span><span class="p">]</span>
    <span class="n">pzone</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">izone</span> <span class="o">=</span> <span class="n">zones</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;Zone&#39;</span><span class="p">])</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Sngl</span><span class="p">)[</span><span class="mi">5</span><span class="p">:])</span>
    <span class="n">HKL</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">HKLF</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">refl</span> <span class="ow">in</span> <span class="n">HKLref</span><span class="p">:</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">refl</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">Fosq</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">Fcsq</span> <span class="o">=</span> <span class="n">refl</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="n">HKL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
        <span class="n">HKLF</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Fosq</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">Fcsq</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">H</span><span class="p">[</span><span class="n">izone</span><span class="p">]</span> <span class="o">==</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;Layer&#39;</span><span class="p">]:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="o">==</span> <span class="s">&#39;Fosq&#39;</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">Fosq</span><span class="o">/</span><span class="n">FosqMax</span>
                <span class="n">B</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">Fcsq</span><span class="o">/</span><span class="n">FosqMax</span>
                <span class="n">C</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="n">B</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">Type</span> <span class="o">==</span> <span class="s">&#39;Fo&#39;</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Fosq</span><span class="p">))</span><span class="o">/</span><span class="n">FoMax</span>
                <span class="n">B</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Fcsq</span><span class="p">))</span><span class="o">/</span><span class="n">FoMax</span>
                <span class="n">C</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="o">-</span><span class="n">B</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">Type</span> <span class="o">==</span> <span class="s">&#39;|DFsq|/sig&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sig</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="p">(</span><span class="n">Fosq</span><span class="o">-</span><span class="n">Fcsq</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">Type</span> <span class="o">==</span> <span class="s">&#39;|DFsq|&gt;sig&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sig</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fosq</span><span class="o">-</span><span class="n">Fcsq</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">A</span> <span class="o">*=</span> <span class="n">scale</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span>                    
            <span class="k">elif</span> <span class="n">Type</span> <span class="o">==</span> <span class="s">&#39;|DFsq|&gt;3sig&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sig</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">Fosq</span><span class="o">-</span><span class="n">Fcsq</span><span class="p">)</span><span class="o">/</span><span class="n">sig</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">3.0</span><span class="p">:</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">A</span> <span class="o">*=</span> <span class="n">scale</span>
                <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span>                    
            <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">H</span><span class="p">[</span><span class="n">pzone</span><span class="p">[</span><span class="n">izone</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="n">H</span><span class="p">[</span><span class="n">pzone</span><span class="p">[</span><span class="n">izone</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">Type</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;|DFsq|/sig&#39;</span><span class="p">,</span><span class="s">&#39;|DFsq|&gt;sig&#39;</span><span class="p">,</span><span class="s">&#39;|DFsq|&gt;3sig&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">A</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Circle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">A</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Circle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">radius</span><span class="o">=-</span><span class="n">A</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">A</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">A</span> <span class="o">&gt;</span> <span class="n">B</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Circle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">A</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">B</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Circle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">B</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">A</span> <span class="o">&lt;</span> <span class="n">B</span><span class="p">:</span>
                        <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Circle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">A</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="n">C</span>
                    <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">A</span> <span class="o">&gt;</span> <span class="n">B</span><span class="p">:</span>
                            <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Circle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>                    
                            <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Circle</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">radius</span><span class="o">=</span><span class="n">radius</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">))</span>
    <span class="n">HKL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HKL</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
    <span class="n">HKLF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HKLF</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">[</span><span class="n">izone</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;Layer&#39;</span><span class="p">]),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">[</span><span class="n">izone</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">HKLmin</span><span class="p">[</span><span class="n">pzone</span><span class="p">[</span><span class="n">izone</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span><span class="n">HKLmax</span><span class="p">[</span><span class="n">pzone</span><span class="p">[</span><span class="n">izone</span><span class="p">][</span><span class="mi">0</span><span class="p">]]))</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">HKLmin</span><span class="p">[</span><span class="n">pzone</span><span class="p">[</span><span class="n">izone</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span><span class="n">HKLmax</span><span class="p">[</span><span class="n">pzone</span><span class="p">[</span><span class="n">izone</span><span class="p">][</span><span class="mi">1</span><span class="p">]]))</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
<span class="c">#    if not newPlot:</span>
<span class="c">#        Page.toolbar.push_current()</span>
<span class="c">#        Plot.set_xlim(xylim[0])</span>
<span class="c">#        Plot.set_ylim(xylim[1])</span>
<span class="c">#        xylim = []</span>
<span class="c">#        Page.toolbar.push_current()</span>
<span class="c">#        Page.toolbar.draw()</span>
<span class="c">#    else:</span>
<span class="c">#        Page.canvas.draw()</span>
       
<span class="c">################################################################################</span>
<span class="c">##### PlotPatterns</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotPatterns"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotPatterns">[docs]</a><span class="k">def</span> <span class="nf">PlotPatterns</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Powder pattern plotting package - displays single or multiple powder patterns as intensity vs</span>
<span class="sd">    2-theta, q or TOF. Can display multiple patterns as &quot;waterfall plots&quot; or contour plots. Log I </span>
<span class="sd">    plotting available.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">HKL</span>
    <span class="k">global</span> <span class="n">exclLines</span>
    <span class="k">def</span> <span class="nf">OnPlotKeyPress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;w&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Weight</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Weight</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Weight</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">SubBack</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">SubBack</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">SubBack</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span> <span class="o">=</span> <span class="bp">True</span>                
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;u&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span><span class="o">*</span><span class="mf">1.2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">100.</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span><span class="o">*</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;o&#39;</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;q&#39;</span><span class="p">:</span>
            <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">datad</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;_r&quot;</span><span class="p">)]</span>
                <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Color scheme&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span> <span class="o">=</span> <span class="s">&#39;Paired&#39;</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>                
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>                  <span class="c">#for smoothing contour plot</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span><span class="s">&#39;bilinear&#39;</span><span class="p">,</span><span class="s">&#39;bicubic&#39;</span><span class="p">,</span><span class="s">&#39;spline16&#39;</span><span class="p">,</span><span class="s">&#39;spline36&#39;</span><span class="p">,</span><span class="s">&#39;hanning&#39;</span><span class="p">,</span>
               <span class="s">&#39;hamming&#39;</span><span class="p">,</span><span class="s">&#39;hermite&#39;</span><span class="p">,</span><span class="s">&#39;kaiser&#39;</span><span class="p">,</span><span class="s">&#39;quadric&#39;</span><span class="p">,</span><span class="s">&#39;catrom&#39;</span><span class="p">,</span><span class="s">&#39;gaussian&#39;</span><span class="p">,</span><span class="s">&#39;bessel&#39;</span><span class="p">,</span>
               <span class="s">&#39;mitchell&#39;</span><span class="p">,</span><span class="s">&#39;sinc&#39;</span><span class="p">,</span><span class="s">&#39;lanczos&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Interpolation&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Interpolate</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Interpolate</span> <span class="o">=</span> <span class="s">&#39;nearest&#39;</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            
        <span class="n">PlotPatterns</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="n">newPlot</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="k">if</span> <span class="n">xpos</span><span class="p">:</span>                                        <span class="c">#avoid out of frame mouse position</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CROSS_CURSOR</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Instrument Parameters&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">wave</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getWave</span><span class="p">(</span><span class="n">Parms</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">xpos</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">asind</span><span class="p">(</span><span class="n">xpos</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>      <span class="c">#avoid bad value in asin beyond upper limit</span>
                            <span class="k">pass</span>
                    <span class="n">dsp</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">xpos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>                  <span class="c">#avoid possible singularity at beam center</span>
                        <span class="n">dsp</span> <span class="o">=</span> <span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">xpos</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;2-theta =</span><span class="si">%9.3f</span><span class="s"> d =</span><span class="si">%9.5f</span><span class="s"> pattern ID =</span><span class="si">%5d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">dsp</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">ypos</span><span class="p">)),</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;2-theta =</span><span class="si">%9.3f</span><span class="s"> d =</span><span class="si">%9.5f</span><span class="s"> Intensity =</span><span class="si">%9.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">dsp</span><span class="p">,</span><span class="n">ypos</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>       <span class="c">#TOF neutrons</span>
                    <span class="n">dsp</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">difC</span> <span class="o">=</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;difC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">dsp</span> <span class="o">=</span> <span class="n">xpos</span><span class="o">/</span><span class="n">difC</span>             <span class="c">#rough approx.!</span>
                    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;TOF =</span><span class="si">%9.3f</span><span class="s"> d =</span><span class="si">%9.5f</span><span class="s"> pattern ID =</span><span class="si">%5d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">dsp</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">ypos</span><span class="p">)),</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;TOF =</span><span class="si">%9.3f</span><span class="s"> d =</span><span class="si">%9.5f</span><span class="s"> Intensity =</span><span class="si">%9.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">dsp</span><span class="p">,</span><span class="n">ypos</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span><span class="p">:</span>
                    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%9.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Index Peak List&#39;</span><span class="p">,</span><span class="s">&#39;Unit Cells List&#39;</span><span class="p">,</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]</span> <span class="ow">or</span> \
                        <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">HKL</span><span class="p">):</span>
                            <span class="n">view</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">_views</span><span class="o">.</span><span class="n">forward</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">wid</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="n">HKL</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">HKL</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">xpos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.002</span><span class="o">*</span><span class="n">wid</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">):</span>
                            <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> 
                            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Select PWDR powder pattern first&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                                                   
    <span class="k">def</span> <span class="nf">OnPick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Instrument Parameters&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getWave</span><span class="p">(</span><span class="n">Parms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">difC</span> <span class="o">=</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;difC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">PickId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span>
        <span class="n">pick</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">artist</span>
        <span class="n">mouse</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span>       
        <span class="n">xpos</span> <span class="o">=</span> <span class="n">pick</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()</span>
        <span class="n">ypos</span> <span class="o">=</span> <span class="n">pick</span><span class="o">.</span><span class="n">get_ydata</span><span class="p">()</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ind</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ind</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">ypos</span><span class="p">,</span><span class="n">ind</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Peak List&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>                                    <span class="c">#picked a data point</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span>
                <span class="n">XY</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">setPeakparms</span><span class="p">(</span><span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span><span class="p">,</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>           <span class="c">#what happens for a q-plot???</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">XY</span><span class="p">)</span>
                <span class="n">G2pdG</span><span class="o">.</span><span class="n">UpdatePeakGrid</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="n">PlotPatterns</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                                                   <span class="c">#picked a peak list line</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="o">=</span> <span class="n">pick</span>
        <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Limits&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>                                    <span class="c">#picked a data point</span>
                <span class="n">LimitId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Limits&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">LimitId</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>                            <span class="c">#CW data - TOF later in an elif</span>
                    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>                              <span class="c">#qplot - convert back to 2-theta</span>
                        <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">asind</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">ifGetExclude</span><span class="p">:</span>
                    <span class="n">excl</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">excl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="nb">min</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">excl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">excl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.1</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">excl</span><span class="p">)</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">ifGetExclude</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mouse</span><span class="o">.</span><span class="n">button</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">mouse</span><span class="o">.</span><span class="n">button</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">SetItemPyData</span><span class="p">(</span><span class="n">LimitId</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="n">G2pdG</span><span class="o">.</span><span class="n">UpdateLimitsGrid</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">PlotPatterns</span><span class="p">,</span><span class="n">G2frame</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>                                                   <span class="c">#picked a limit line</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="o">=</span> <span class="n">pick</span>
        <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Reflection Lists&#39;</span> <span class="ow">or</span> \
            <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">):</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="o">=</span> <span class="n">pick</span>
            <span class="n">pick</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pick</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnRelease</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Instrument Parameters&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getWave</span><span class="p">(</span><span class="n">Parms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">difC</span> <span class="o">=</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;difC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="n">PickId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Peak List&#39;</span><span class="p">,</span><span class="s">&#39;Limits&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">xpos</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Lines</span><span class="p">:</span> 
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="c">#            print G2frame.itemPicked.get_xdata()</span>
            <span class="n">lineNo</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span><span class="o">.</span><span class="n">get_xdata</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span>  <span class="n">lineNo</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">lineNo</span> <span class="ow">in</span> <span class="n">exclLines</span><span class="p">:</span>
                <span class="n">LimitId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Limits&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">LimitId</span><span class="p">)</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">lineNo</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">id2</span> <span class="o">=</span> <span class="n">lineNo</span><span class="o">%</span><span class="mi">2</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">data</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="n">id2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">asind</span><span class="p">(</span><span class="n">wave</span><span class="o">*</span><span class="n">xpos</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="n">id2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Parms</span><span class="p">[</span><span class="s">&#39;difC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">xpos</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="n">id2</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpos</span>
                <span class="k">if</span> <span class="nb">id</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">data</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">data</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">SetItemPyData</span><span class="p">(</span><span class="n">LimitId</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Limits&#39;</span><span class="p">:</span>
                    <span class="n">G2pdG</span><span class="o">.</span><span class="n">UpdateLimitsGrid</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">PeakId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Peak List&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">PeakId</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">lineNo</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">lineNo</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">asind</span><span class="p">(</span><span class="n">wave</span><span class="o">*</span><span class="n">xpos</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">lineNo</span><span class="o">-</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpos</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">SetItemPyData</span><span class="p">(</span><span class="n">PeakId</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
                <span class="n">G2pdG</span><span class="o">.</span><span class="n">UpdatePeakGrid</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Reflection Lists&#39;</span> <span class="ow">or</span> \
            <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">))</span> <span class="ow">and</span> <span class="n">xpos</span><span class="p">:</span>
            <span class="n">Phases</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">))</span>
            <span class="n">pick</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;line&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pick</span><span class="p">:</span>       <span class="c">#avoid data points, etc.</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pick</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">num</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">refDelt</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="o">-</span><span class="n">G2frame</span><span class="o">.</span><span class="n">refOffset</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">num</span><span class="o">*</span><span class="n">Ymax</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>       <span class="c">#1st row of refl ticks</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">refOffset</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">PlotPatterns</span><span class="p">(</span><span class="n">G2frame</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="o">=</span> <span class="bp">None</span>    

    <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Powder Patterns&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get previous powder plot &amp; get limits</span>
            <span class="n">xylim</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get a fresh plot after clf()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Powder Patterns&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Powder Patterns&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">OnPlotKeyPress</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;pick_event&#39;</span><span class="p">,</span> <span class="n">OnPick</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;button_release_event&#39;</span><span class="p">,</span> <span class="n">OnRelease</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; key press&#39;</span><span class="p">,</span><span class="s">&#39;d: lower contour max&#39;</span><span class="p">,</span><span class="s">&#39;u: raise contour max&#39;</span><span class="p">,</span>
            <span class="s">&#39;i: interpolation method&#39;</span><span class="p">,</span><span class="s">&#39;s: color scheme&#39;</span><span class="p">,</span><span class="s">&#39;c: contour off&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; key press&#39;</span><span class="p">,</span><span class="s">&#39;n: log(I) off&#39;</span><span class="p">,</span><span class="s">&#39;l: offset left&#39;</span><span class="p">,</span><span class="s">&#39;r: offset right&#39;</span><span class="p">,</span>
                <span class="s">&#39;c: contour on&#39;</span><span class="p">,</span><span class="s">&#39;q: toggle q plot&#39;</span><span class="p">,</span><span class="s">&#39;s: toggle single plot&#39;</span><span class="p">,</span><span class="s">&#39;+: no selection&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; key press&#39;</span><span class="p">,</span><span class="s">&#39;l: offset left&#39;</span><span class="p">,</span><span class="s">&#39;r: offset right&#39;</span><span class="p">,</span><span class="s">&#39;d: offset down&#39;</span><span class="p">,</span>
                <span class="s">&#39;u: offset up&#39;</span><span class="p">,</span><span class="s">&#39;o: reset offset&#39;</span><span class="p">,</span><span class="s">&#39;b: toggle subtract background&#39;</span><span class="p">,</span><span class="s">&#39;n: log(I) on&#39;</span><span class="p">,</span><span class="s">&#39;c: contour on&#39;</span><span class="p">,</span>
                <span class="s">&#39;q: toggle q plot&#39;</span><span class="p">,</span><span class="s">&#39;s: toggle single plot&#39;</span><span class="p">,</span><span class="s">&#39;w: toggle divide by sig&#39;</span><span class="p">,</span><span class="s">&#39;+: no selection&#39;</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">keyPress</span> <span class="o">=</span> <span class="n">OnPlotKeyPress</span>
    
    <span class="n">PickId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span>
    <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">Lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">exclLines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span><span class="p">:</span>
        <span class="n">Pattern</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)</span>
        <span class="n">Pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PatternId</span><span class="p">))</span>
        <span class="n">PlotList</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pattern</span><span class="p">,]</span>
        <span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Instrument Parameters&#39;</span><span class="p">))</span>
        <span class="n">ParmList</span> <span class="o">=</span> <span class="p">[</span><span class="n">Parms</span><span class="p">,]</span>
        <span class="n">Title</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>        
        <span class="n">Title</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">GSASprojectfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">PlotList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ParmList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetFirstChild</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">Pattern</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Pattern</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>                    <span class="c"># put name on end if needed</span>
                    <span class="n">Pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="n">PlotList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pattern</span><span class="p">)</span>
                <span class="n">ParmList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span>
                    <span class="n">item</span><span class="p">,</span><span class="s">&#39;Instrument Parameters&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">item</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetNextChild</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>                
    <span class="n">lenX</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">PickId</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]:</span>
            <span class="n">Phases</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">))</span>
            <span class="n">HKL</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">Phases</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">Phases</span><span class="p">[</span><span class="n">G2frame</span><span class="o">.</span><span class="n">RefList</span><span class="p">][</span><span class="s">&#39;RefList&#39;</span><span class="p">]:</span>
                        <span class="n">HKL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">Phases</span><span class="p">[</span><span class="n">G2frame</span><span class="o">.</span><span class="n">RefList</span><span class="p">]:</span>
                        <span class="n">HKL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>                    
                <span class="n">HKL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HKL</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">HKL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">HKL</span><span class="p">)</span>
    <span class="n">Ymax</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">Pattern</span> <span class="ow">in</span> <span class="n">PlotList</span><span class="p">:</span>
        <span class="n">xye</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xye</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">if</span> <span class="n">Ymax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">Ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Ymax</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">Ymax</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="c"># nothing to plot</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ymax</span><span class="o">/</span><span class="mf">100.0</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
        <span class="n">Title</span> <span class="o">=</span> <span class="s">&#39;log(&#39;</span><span class="o">+</span><span class="n">Title</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">Title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$Q, \AA^{-1}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">ParmList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>        
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$\mathsf{2\theta}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;TOF, $\mathsf{\mu}$s&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>            
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Weight</span><span class="p">:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\mathsf{I/\sigma(I)}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">ParmList</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Intensity&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Normalized intensity&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
        <span class="n">ContourZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ContourY</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Nseq</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PlotList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">for</span> <span class="n">N</span><span class="p">,</span><span class="n">Pattern</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PlotList</span><span class="p">):</span>
        <span class="n">Parms</span> <span class="o">=</span> <span class="n">ParmList</span><span class="p">[</span><span class="n">N</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getWave</span><span class="p">(</span><span class="n">Parms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">difC</span> <span class="o">=</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;difC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ifpicked</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">LimitId</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># skip over uncomputed simulations</span>
        <span class="n">xye</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">Pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">PickId</span><span class="p">:</span>
            <span class="n">ifpicked</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)</span>
            <span class="n">LimitId</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Limits&#39;</span><span class="p">)</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">LimitId</span><span class="p">))</span>
            <span class="n">excls</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">excl</span> <span class="ow">in</span> <span class="n">excls</span><span class="p">:</span>
                <span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_inside</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">excl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">excl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
            <span class="n">Id</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">npsind</span><span class="p">((</span><span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Zero&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="n">wave</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">Parms</span><span class="p">[</span><span class="s">&#39;difC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Zero&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Zero&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lenX</span><span class="p">:</span>
            <span class="n">lenX</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="o">*</span><span class="n">N</span>
        <span class="k">if</span> <span class="n">LimitId</span><span class="p">:</span>
            <span class="n">limits</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">LimitId</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">limits</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">npsind</span><span class="p">(</span><span class="n">limits</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="n">wave</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">limits</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">difC</span><span class="o">/</span><span class="n">limits</span>
            <span class="n">Lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">))</span>    
            <span class="n">Lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">limits</span><span class="p">[</span><span class="mi">2</span><span class="p">:]):</span>
                <span class="n">Lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">))</span>    
                <span class="n">Lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">))</span>
                <span class="n">exclLines</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">lenX</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                <span class="n">ContourY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                <span class="n">ContourZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="n">ContourX</span> <span class="o">=</span> <span class="n">X</span>
                <span class="n">Nseq</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Data sequence&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">+=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*.</span><span class="mo">005</span><span class="o">*</span><span class="n">N</span>
            <span class="n">Xum</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">getdata</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ifpicked</span><span class="p">:</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="o">*</span><span class="n">N</span>
                <span class="n">W</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="o">*</span><span class="n">N</span>
                <span class="n">D</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">Ymax</span><span class="o">*</span><span class="n">G2frame</span><span class="o">.</span><span class="n">delOffset</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">clip_on</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">nonposy</span><span class="o">=</span><span class="s">&#39;mask&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">colors</span><span class="p">[(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">nonposy</span><span class="o">=</span><span class="s">&#39;mask&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="n">colors</span><span class="p">[(</span><span class="n">N</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">nonposy</span><span class="o">=</span><span class="s">&#39;mask&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Weight</span><span class="p">:</span>
                    <span class="n">DY</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">DYmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">DY</span><span class="p">)</span>
                    <span class="n">DZ</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">DS</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">DYmax</span><span class="o">*</span><span class="n">G2frame</span><span class="o">.</span><span class="n">delOffset</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">DY</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">clip_on</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">DZ</span><span class="p">,</span><span class="n">colors</span><span class="p">[(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">DS</span><span class="p">,</span><span class="n">colors</span><span class="p">[(</span><span class="n">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">SubBack</span><span class="p">:</span>
                        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Xum</span><span class="p">,</span><span class="n">Y</span><span class="o">-</span><span class="n">W</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">clip_on</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="o">-</span><span class="n">W</span><span class="p">,</span><span class="n">colors</span><span class="p">[(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Xum</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">clip_on</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">colors</span><span class="p">[(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="n">colors</span><span class="p">[(</span><span class="n">N</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">colors</span><span class="p">[(</span><span class="n">N</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
                <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Peak List&#39;</span><span class="p">:</span>
                    <span class="n">tip</span> <span class="o">=</span> <span class="s">&#39;On data point: Pick peak - L or R MB. On line: L-move, R-delete&#39;</span>
                    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">tip</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Peak List&#39;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">Lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">wave</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="mf">2.</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">Lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">difC</span><span class="o">/</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="mf">2.</span><span class="p">))</span>                                
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">Lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="mf">2.</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Limits&#39;</span><span class="p">:</span>
                    <span class="n">tip</span> <span class="o">=</span> <span class="s">&#39;On data point: Lower limit - L MB; Upper limit - R MB. On limit: MB down to move&#39;</span>
                    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">tip</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">LimitsTable</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">nonposy</span><span class="o">=</span><span class="s">&#39;clip&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">PickId</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
        <span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Instrument Parameters&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getWave</span><span class="p">(</span><span class="n">Parms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">difC</span> <span class="o">=</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;difC&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Index Peak List&#39;</span><span class="p">,</span><span class="s">&#39;Unit Cells List&#39;</span><span class="p">]:</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Index Peak List&#39;</span><span class="p">))))</span>
            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="n">wave</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">hkl</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">HKL</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">hkl</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="n">wave</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">hkl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]</span> <span class="ow">or</span> \
            <span class="s">&#39;PWDR&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PickId</span><span class="p">):</span>
            <span class="n">refColors</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
            <span class="n">Phases</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">pId</span><span class="p">,</span><span class="n">phase</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Phases</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>    <span class="c">#patch for old style reflection lists</span>
                    <span class="n">peaks</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">][</span><span class="s">&#39;RefList&#39;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">peaks</span> <span class="o">=</span> <span class="n">Phases</span><span class="p">[</span><span class="n">phase</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">peak</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">peak</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">])</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">refOffset</span><span class="o">-</span><span class="n">pId</span><span class="o">*</span><span class="n">Ymax</span><span class="o">*</span><span class="n">G2frame</span><span class="o">.</span><span class="n">refDelt</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">peak</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">qPlot</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">peak</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">pos</span><span class="p">,</span><span class="n">refColors</span><span class="p">[</span><span class="n">pId</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;|&#39;</span><span class="p">,</span><span class="n">mew</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">phase</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pos</span><span class="p">,</span><span class="n">refColors</span><span class="p">[</span><span class="n">pId</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;|&#39;</span><span class="p">,</span><span class="n">mew</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">phase</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Phases</span><span class="p">):</span>
                <span class="n">handles</span><span class="p">,</span><span class="n">legends</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>  <span class="c">#got double entries in the legends for some reason</span>
                <span class="k">if</span> <span class="n">handles</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span><span class="n">legends</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Phases&#39;</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>    <span class="c">#skip every other one</span>
            
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
        <span class="n">acolor</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span><span class="p">)</span>
        <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ContourZ</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">acolor</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">Ymax</span><span class="o">*</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Interpolate</span><span class="p">,</span> 
            <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">ContourX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ContourX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ContourY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ContourY</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">Img</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">Lines</span> <span class="o">=</span> <span class="n">Lines</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
<span class="c">#    G2frame.Pwdr = True</span>
    
<span class="c">################################################################################</span>
<span class="c">##### PlotDeltSig</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotDeltSig"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotDeltSig">[docs]</a><span class="k">def</span> <span class="nf">PlotDeltSig</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>
    <span class="s">&#39;needs a doc string&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Error analysis&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get a fresh plot after clf()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Error analysis&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Error analysis&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span>
    <span class="n">Pattern</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)</span>
    <span class="n">Pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PatternId</span><span class="p">))</span>
    <span class="n">wtFactor</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;wtFactor&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;PWDR&#39;</span><span class="p">:</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Limits&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">DS</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wtFactor</span><span class="o">*</span><span class="n">xye</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;HKLF&#39;</span><span class="p">:</span>
        <span class="n">refl</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">DS</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">refl</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">DS</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">ref</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
    <span class="n">DS</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">EDS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">DS</span><span class="p">)</span>
    <span class="n">DX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">DS</span><span class="p">),</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">oldErr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>    <span class="c">#avoid problem at DX==0</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">DX</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">top</span> <span class="o">=</span> <span class="mf">2.515517</span><span class="o">+</span><span class="mf">0.802853</span><span class="o">*</span><span class="n">T</span><span class="o">+</span><span class="mf">0.010328</span><span class="o">*</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">bot</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">+</span><span class="mf">1.432788</span><span class="o">*</span><span class="n">T</span><span class="o">+</span><span class="mf">0.189269</span><span class="o">*</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">0.001308</span><span class="o">*</span><span class="n">T</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">EDS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DX</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">top</span><span class="o">/</span><span class="n">bot</span><span class="p">),(</span><span class="n">T</span><span class="o">-</span><span class="n">top</span><span class="o">/</span><span class="n">bot</span><span class="p">))</span>
    <span class="n">low1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">EDS</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">hi1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">EDS</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">slp</span><span class="p">,</span><span class="n">intcp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">EDS</span><span class="p">[</span><span class="n">low1</span><span class="p">:</span><span class="n">hi1</span><span class="p">],</span><span class="n">DS</span><span class="p">[</span><span class="n">low1</span><span class="p">:</span><span class="n">hi1</span><span class="p">],</span><span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="p">(</span><span class="n">hi1</span><span class="o">-</span><span class="n">low1</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">DS</span><span class="p">)</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span>  \
        <span class="s">&#39;Over range -1. to 1. :&#39;</span><span class="o">+</span><span class="s">&#39; slope = </span><span class="si">%.3f</span><span class="s">, intercept = </span><span class="si">%.3f</span><span class="s"> for </span><span class="si">%.2f%%</span><span class="s"> of the fitted data&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">slp</span><span class="p">,</span><span class="n">intcp</span><span class="p">,</span><span class="n">frac</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Normal probability for &#39;</span><span class="o">+</span><span class="n">Pattern</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;expected $\mathsf{\Delta/\sigma}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;observed $\mathsf{\Delta/\sigma}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">EDS</span><span class="p">,</span><span class="n">DS</span><span class="p">,</span><span class="s">&#39;r+&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;result&#39;</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;ideal&#39;</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s">&#39;warn&#39;</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
       
<span class="c">################################################################################</span>
<span class="c">##### PlotISFG</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotISFG"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotISFG">[docs]</a><span class="k">def</span> <span class="nf">PlotISFG</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; PLotting package for PDF analysis; displays I(q), S(q), F(q) and G(r) as single </span>
<span class="sd">    or multiple plots with waterfall and contour plots as options</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">:</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="p">[</span><span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;I(Q)&#39;</span><span class="p">,</span><span class="s">&#39;S(Q)&#39;</span><span class="p">,</span><span class="s">&#39;F(Q)&#39;</span><span class="p">,</span><span class="s">&#39;G(R)&#39;</span><span class="p">]:</span>
        <span class="k">return</span>
    <span class="n">superMinusOne</span> <span class="o">=</span> <span class="nb">unichr</span><span class="p">(</span><span class="mh">0xaf</span><span class="p">)</span><span class="o">+</span><span class="nb">unichr</span><span class="p">(</span><span class="mh">0xb9</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">OnPlotKeyPress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;u&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span><span class="o">*</span><span class="mf">1.2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">100.</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span><span class="o">*</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;o&#39;</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
            <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">datad</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;_r&quot;</span><span class="p">)]</span>
                <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Color scheme&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span> <span class="o">=</span> <span class="s">&#39;Paired&#39;</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>                
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>                  <span class="c">#for smoothing contour plot</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span><span class="s">&#39;bilinear&#39;</span><span class="p">,</span><span class="s">&#39;bicubic&#39;</span><span class="p">,</span><span class="s">&#39;spline16&#39;</span><span class="p">,</span><span class="s">&#39;spline36&#39;</span><span class="p">,</span><span class="s">&#39;hanning&#39;</span><span class="p">,</span>
               <span class="s">&#39;hamming&#39;</span><span class="p">,</span><span class="s">&#39;hermite&#39;</span><span class="p">,</span><span class="s">&#39;kaiser&#39;</span><span class="p">,</span><span class="s">&#39;quadric&#39;</span><span class="p">,</span><span class="s">&#39;catrom&#39;</span><span class="p">,</span><span class="s">&#39;gaussian&#39;</span><span class="p">,</span><span class="s">&#39;bessel&#39;</span><span class="p">,</span>
               <span class="s">&#39;mitchell&#39;</span><span class="p">,</span><span class="s">&#39;sinc&#39;</span><span class="p">,</span><span class="s">&#39;lanczos&#39;</span><span class="p">]</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Interpolation&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Interpolate</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Interpolate</span> <span class="o">=</span> <span class="s">&#39;nearest&#39;</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Legend</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Legend</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">Legend</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">PlotISFG</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="n">newPlot</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnKeyBox</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span> <span class="o">==</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39; key press&#39;</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">OnPlotKeyPress</span><span class="p">,</span><span class="n">event</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span> <span class="c"># redirect the Focus from the button back to the plot</span>
                        
    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="k">if</span> <span class="n">xpos</span><span class="p">:</span>                                        <span class="c">#avoid out of frame mouse position</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CROSS_CURSOR</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;R =</span><span class="si">%.3f</span><span class="s">A pattern ID =</span><span class="si">%5d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">ypos</span><span class="p">)),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;R =</span><span class="si">%.3f</span><span class="s">A </span><span class="si">%s</span><span class="s"> =</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">ypos</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>                   
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Select &#39;</span><span class="o">+</span><span class="nb">type</span><span class="o">+</span><span class="s">&#39; pattern first&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get previous plot &amp; get limits</span>
            <span class="n">xylim</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">OnPlotKeyPress</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
    
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; key press&#39;</span><span class="p">,</span><span class="s">&#39;d: lower contour max&#39;</span><span class="p">,</span><span class="s">&#39;u: raise contour max&#39;</span><span class="p">,</span>
            <span class="s">&#39;i: interpolation method&#39;</span><span class="p">,</span><span class="s">&#39;s: color scheme&#39;</span><span class="p">,</span><span class="s">&#39;c: contour off&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; key press&#39;</span><span class="p">,</span><span class="s">&#39;l: offset left&#39;</span><span class="p">,</span><span class="s">&#39;r: offset right&#39;</span><span class="p">,</span><span class="s">&#39;d: offset down&#39;</span><span class="p">,</span><span class="s">&#39;u: offset up&#39;</span><span class="p">,</span>
            <span class="s">&#39;o: reset offset&#39;</span><span class="p">,</span><span class="s">&#39;t: toggle legend&#39;</span><span class="p">,</span><span class="s">&#39;c: contour on&#39;</span><span class="p">,</span><span class="s">&#39;s: toggle single plot&#39;</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">keyPress</span> <span class="o">=</span> <span class="n">OnPlotKeyPress</span>
    <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span>
    <span class="n">PickId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;G(R)&#39;</span><span class="p">:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$R,\AA$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$Q,\AA$&#39;</span><span class="o">+</span><span class="n">superMinusOne</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;&#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">Pattern</span> <span class="o">=</span> <span class="p">[]</span>    
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">SinglePlot</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="o">+</span><span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
        <span class="n">Id</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="n">Pattern</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Pattern</span><span class="p">:</span>
            <span class="n">Pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">PlotList</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pattern</span><span class="p">,]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PlotList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">item</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetFirstChild</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;PDF&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">type</span><span class="o">+</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">item</span><span class="p">)[</span><span class="mi">4</span><span class="p">:]</span>
                <span class="n">Id</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
                <span class="n">Pattern</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">Id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Pattern</span><span class="p">:</span>
                    <span class="n">Pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">PlotList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Pattern</span><span class="p">)</span>
            <span class="n">item</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetNextChild</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
    <span class="n">PDFdata</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;PDF Controls&#39;</span><span class="p">))</span>
    <span class="n">numbDen</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">GetNumDensity</span><span class="p">(</span><span class="n">PDFdata</span><span class="p">[</span><span class="s">&#39;ElList&#39;</span><span class="p">],</span><span class="n">PDFdata</span><span class="p">[</span><span class="s">&#39;Form Vol&#39;</span><span class="p">])</span>
    <span class="n">Xb</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">10.</span><span class="p">]</span>
    <span class="n">Yb</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="o">-</span><span class="mf">40.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">numbDen</span><span class="p">]</span>
    <span class="n">Ymax</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lenX</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">Pattern</span> <span class="ow">in</span> <span class="n">PlotList</span><span class="p">:</span>
        <span class="n">xye</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">Ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Ymax</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">xye</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">Ymax</span><span class="o">/</span><span class="mf">100.0</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
        <span class="n">ContourZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ContourY</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Nseq</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">N</span><span class="p">,</span><span class="n">Pattern</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">PlotList</span><span class="p">):</span>
        <span class="n">xye</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">PickId</span><span class="p">:</span>
            <span class="n">ifpicked</span> <span class="o">=</span> <span class="n">Pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">PatternId</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lenX</span><span class="p">:</span>
            <span class="n">lenX</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>           
        <span class="n">Y</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="o">*</span><span class="n">N</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lenX</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                <span class="n">ContourY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
                <span class="n">ContourZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
                <span class="n">ContourX</span> <span class="o">=</span> <span class="n">X</span>
                <span class="n">Nseq</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Data sequence&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">xye</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*.</span><span class="mo">005</span><span class="o">*</span><span class="n">N</span>
            <span class="k">if</span> <span class="n">ifpicked</span><span class="p">:</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">clip_on</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Legend</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Azm:&#39;</span><span class="o">+</span><span class="n">Pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">],</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;G(R)&#39;</span><span class="p">:</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Xb</span><span class="p">,</span><span class="n">Yb</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;F(Q)&#39;</span><span class="p">:</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;S(Q)&#39;</span><span class="p">:</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Contour</span><span class="p">:</span>
        <span class="n">acolor</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span><span class="p">)</span>
        <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ContourZ</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">acolor</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">Ymax</span><span class="o">*</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Cmax</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Interpolate</span><span class="p">,</span> 
            <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">ContourX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ContourX</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">ContourY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ContourY</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">Img</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Legend</span><span class="p">:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        
<span class="c">################################################################################</span>
<span class="c">##### PlotXY</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotXY"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotXY">[docs]</a><span class="k">def</span> <span class="nf">PlotXY</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">XY</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;simple plot of xy data, used for diagnostic purposes</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="k">if</span> <span class="n">xpos</span><span class="p">:</span>                                        <span class="c">#avoid out of frame mouse position</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CROSS_CURSOR</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;X =</span><span class="si">%9.3f</span><span class="s"> </span><span class="si">%s</span><span class="s"> =</span><span class="si">%9.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="nb">type</span><span class="p">,</span><span class="n">ypos</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>                   
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Select &#39;</span><span class="o">+</span><span class="nb">type</span><span class="o">+</span><span class="s">&#39; pattern first&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="n">xylim</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
    
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;X&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;&#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">Ymax</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">lenX</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">XY</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Ymax</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

<span class="c">################################################################################</span>
<span class="c">##### PlotPowderLines</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotPowderLines"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotPowderLines">[docs]</a><span class="k">def</span> <span class="nf">PlotPowderLines</span><span class="p">(</span><span class="n">G2frame</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; plotting of powder lines (i.e. no powder pattern) as sticks</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">HKL</span>

    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="k">if</span> <span class="n">xpos</span><span class="p">:</span>                                        <span class="c">#avoid out of frame mouse position</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CROSS_CURSOR</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;2-theta =</span><span class="si">%9.3f</span><span class="s"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,)])</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span> <span class="ow">and</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Index Peak List&#39;</span><span class="p">,</span><span class="s">&#39;Unit Cells List&#39;</span><span class="p">]:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">HKL</span><span class="p">):</span>
                    <span class="n">view</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">_views</span><span class="o">.</span><span class="n">forward</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">wid</span> <span class="o">=</span> <span class="n">view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">HKL</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">HKL</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="n">xpos</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.002</span><span class="o">*</span><span class="n">wid</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">):</span>
                    <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">3</span><span class="p">]</span> 
                    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">,</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Powder Lines&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Powder Lines&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Powder Lines&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
        
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Powder Pattern Lines&#39;</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$\mathsf{2\theta}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">PickId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span>
    <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Index Peak List&#39;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">HKL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">HKL</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">hkl</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">HKL</span><span class="p">:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">hkl</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">delt</span> <span class="o">=</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xmin</span><span class="o">-</span><span class="n">delt</span><span class="o">/</span><span class="mf">20.</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="mf">180.</span><span class="p">,</span><span class="n">xmax</span><span class="o">+</span><span class="n">delt</span><span class="o">/</span><span class="mf">20.</span><span class="p">)]</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>

<span class="c">################################################################################</span>
<span class="c">##### PlotPeakWidths</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotPeakWidths"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotPeakWidths">[docs]</a><span class="k">def</span> <span class="nf">PlotPeakWidths</span><span class="p">(</span><span class="n">G2frame</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Plotting of instrument broadening terms as function of 2-theta</span>
<span class="sd">    Seen when &quot;Instrument Parameters&quot; chosen from powder pattern data tree</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="c">#    sig = lambda Th,U,V,W: 1.17741*math.sqrt(U*tand(Th)**2+V*tand(Th)+W)*math.pi/18000.</span>
<span class="c">#    gam = lambda Th,X,Y: (X/cosd(Th)+Y*tand(Th))*math.pi/18000.</span>
    <span class="n">gamFW</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">,</span><span class="n">g</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">5</span><span class="o">+</span><span class="mf">2.69269</span><span class="o">*</span><span class="n">s</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="n">g</span><span class="o">+</span><span class="mf">2.42843</span><span class="o">*</span><span class="n">s</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">g</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">4.47163</span><span class="o">*</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">g</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="mf">0.07842</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">g</span><span class="o">**</span><span class="mi">4</span><span class="o">+</span><span class="n">g</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span>
<span class="c">#    gamFW2 = lambda s,g: math.sqrt(s**2+(0.4654996*g)**2)+.5345004*g  #Ubaldo Bafile - private communication</span>
    <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span>
    <span class="n">limitID</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Limits&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limitID</span><span class="p">:</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">limitID</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span> \
        <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Instrument Parameters&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">lam</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">getWave</span><span class="p">(</span><span class="n">Parms</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">difC</span> <span class="o">=</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;difC&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">peakID</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">PatternId</span><span class="p">,</span> <span class="s">&#39;Peak List&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">peakID</span><span class="p">:</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">peakID</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Peak Widths&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Peak Widths&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Peak Widths&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">W</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">Parms</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Instrument and sample peak widths&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$Q, \AA^{-1}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\Delta Q/Q, \Delta d/d$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Xmin</span><span class="p">,</span><span class="n">Xmax</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Xmin</span><span class="p">,</span><span class="n">Xmax</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">npsind</span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">lam</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">setPeakparms</span><span class="p">(</span><span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="mf">1.17741</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">18000.</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">18000.</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getgamFW</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">s</span><span class="o">/</span><span class="n">nptand</span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">g</span><span class="o">/</span><span class="n">nptand</span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">W</span> <span class="o">=</span> <span class="n">G</span><span class="o">/</span><span class="n">nptand</span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Gaussian&#39;</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Lorentzian&#39;</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;G+L&#39;</span><span class="p">)</span>
            
            <span class="n">fit</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">setPeakparms</span><span class="p">(</span><span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">useFit</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">sf</span> <span class="o">=</span> <span class="mf">1.17741</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">18000.</span>
            <span class="n">gf</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">18000.</span>
            <span class="n">Gf</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getgamFW</span><span class="p">(</span><span class="n">gf</span><span class="p">,</span><span class="n">sf</span><span class="p">)</span>
            <span class="n">Yf</span> <span class="o">=</span> <span class="n">sf</span><span class="o">/</span><span class="n">nptand</span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">Zf</span> <span class="o">=</span> <span class="n">gf</span><span class="o">/</span><span class="n">nptand</span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">Wf</span> <span class="o">=</span> <span class="n">Gf</span><span class="o">/</span><span class="n">nptand</span><span class="p">(</span><span class="n">X</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Yf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Gaussian fit&#39;</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Zf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Lorentzian fit&#39;</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Wf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;G+L fit&#39;</span><span class="p">)</span>
            
            <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">W</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">V</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
                <span class="n">X</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">4.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="n">lam</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="mf">1.17741</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">18000.</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="mf">0.01</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">peak</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">18000.</span>
                <span class="n">G</span> <span class="o">=</span> <span class="n">G2pwd</span><span class="o">.</span><span class="n">getgamFW</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">tand</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
                <span class="n">Z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">/</span><span class="n">tand</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
                <span class="n">W</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="o">/</span><span class="n">tand</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">):</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;G peak&#39;</span><span class="p">)</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;L peak&#39;</span><span class="p">)</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">W</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;G+L peak&#39;</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;**** ERROR - default U,V,W profile coefficients yield sqrt of negative value at 2theta =&#39;</span><span class="p">,</span> \
                <span class="s">&#39;</span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="s">&#39;Peak Widths&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Instrument and sample peak coefficients&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$Q, \AA^{-1}$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\alpha, \beta, \Delta Q/Q, \Delta d/d$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">Xmin</span><span class="p">,</span><span class="n">Xmax</span> <span class="o">=</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Xmin</span><span class="p">,</span><span class="n">Xmax</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span><span class="n">endpoint</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">setPeakparms</span><span class="p">(</span><span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">difC</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">ds</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">S</span> <span class="o">=</span> <span class="mf">1.17741</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">/</span><span class="n">T</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">/</span><span class="n">T</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Alpha&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Beta&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Gaussian&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Lorentzian&#39;</span><span class="p">)</span>

        <span class="n">fit</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">setPeakparms</span><span class="p">(</span><span class="n">Parms</span><span class="p">,</span><span class="n">Parms2</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">T</span><span class="o">/</span><span class="n">difC</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">ds</span>
        <span class="n">Af</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">Bf</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">Sf</span> <span class="o">=</span> <span class="mf">1.17741</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">/</span><span class="n">T</span>
        <span class="n">Gf</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">/</span><span class="n">T</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Af</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Alpha fit&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Bf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Beta fit&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Sf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Gaussian fit&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Gf</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Lorentzian fit&#39;</span><span class="p">)</span>
        
        <span class="n">T</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">S</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">G</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">:</span>
            <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
            <span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">difC</span><span class="o">/</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.17741</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span><span class="o">/</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">G</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peak</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">/</span><span class="n">peak</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            
        
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Alpha peak&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Beta peak&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Gaussian peak&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Lorentzian peak&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    
<span class="c">################################################################################</span>
<span class="c">##### PlotSizeStrainPO</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotSizeStrainPO"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotSizeStrainPO">[docs]</a><span class="k">def</span> <span class="nf">PlotSizeStrainPO</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">Start</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Plot 3D mustrain/size/preferred orientation figure. In this instance data is for a phase</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span>
    <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
    <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
    <span class="n">SGLaue</span> <span class="o">=</span> <span class="n">SGData</span><span class="p">[</span><span class="s">&#39;SGLaue&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">Start</span><span class="p">:</span>                   <span class="c">#initialize the spherical harmonics qlmn arrays</span>
        <span class="n">ptx</span><span class="o">.</span><span class="n">pyqlmninit</span><span class="p">()</span>
        <span class="n">Start</span> <span class="o">=</span> <span class="bp">False</span>
<span class="c">#    MuStrKeys = G2spc.MustrainNames(SGData)</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">A</span><span class="p">,</span><span class="n">B</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">cell</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
    <span class="n">Vol</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">useList</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span>
    <span class="n">plotType</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Data plot type&#39;</span><span class="p">]</span>
    <span class="n">plotDict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Mustrain&#39;</span><span class="p">:</span><span class="s">&#39;Mustrain&#39;</span><span class="p">,</span><span class="s">&#39;Size&#39;</span><span class="p">:</span><span class="s">&#39;Size&#39;</span><span class="p">,</span><span class="s">&#39;Preferred orientation&#39;</span><span class="p">:</span><span class="s">&#39;Pref.Ori.&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">plotDict</span><span class="p">:</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plotType</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;None&#39;</span><span class="p">]:</span>
        <span class="k">return</span>        

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">useList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">useList</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="s">&#39;Show&#39;</span><span class="p">]:</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span>            <span class="c">#nothing to show!!</span>
    
    <span class="n">numPlots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">useList</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plotType</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Mustrain&#39;</span><span class="p">,</span><span class="s">&#39;Size&#39;</span><span class="p">]:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">mp3d</span><span class="o">.</span><span class="n">Axes3D</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">add3D</span><span class="p">(</span><span class="n">plotType</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="n">plotType</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>        
    <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">plotType</span><span class="p">)</span>
    <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Page</span><span class="o">.</span><span class="n">IsShown</span><span class="p">():</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">useList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">useList</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="s">&#39;Show&#39;</span><span class="p">]:</span>
            <span class="n">PHI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">PSI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">180.</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">npsind</span><span class="p">(</span><span class="n">PHI</span><span class="p">),</span><span class="n">npsind</span><span class="p">(</span><span class="n">PSI</span><span class="p">))</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">npcosd</span><span class="p">(</span><span class="n">PHI</span><span class="p">),</span><span class="n">npsind</span><span class="p">(</span><span class="n">PSI</span><span class="p">))</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">PHI</span><span class="p">)),</span><span class="n">npcosd</span><span class="p">(</span><span class="n">PSI</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>        <span class="c">#temp patch instead of &#39;mustrain&#39; for old files with &#39;microstrain&#39;</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">useList</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">plotDict</span><span class="p">[</span><span class="n">plotType</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">plotType</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Mustrain&#39;</span><span class="p">,</span><span class="s">&#39;Size&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;isotropic&#39;</span><span class="p">:</span>
                    <span class="n">X</span> <span class="o">*=</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">Y</span> <span class="o">*=</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">Z</span> <span class="o">*=</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>                                
                <span class="k">elif</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;uniaxial&#39;</span><span class="p">:</span>
                    
                    <span class="k">def</span> <span class="nf">uniaxCalc</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span><span class="n">aniso</span><span class="p">,</span><span class="n">axes</span><span class="p">):</span>
                        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
                        <span class="n">cp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>
                        <span class="n">sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">cp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">R</span> <span class="o">=</span> <span class="n">iso</span><span class="o">*</span><span class="n">aniso</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">iso</span><span class="o">*</span><span class="n">cp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">aniso</span><span class="o">*</span><span class="n">sp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">R</span><span class="o">*</span><span class="n">xyz</span>
                        
                    <span class="n">iso</span><span class="p">,</span><span class="n">aniso</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">axes</span> <span class="o">/=</span> <span class="n">nl</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
                    <span class="n">Shkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>
                    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">uniaxCalc</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">iso</span><span class="p">,</span><span class="n">aniso</span><span class="p">,</span><span class="n">axes</span><span class="p">))</span>
                    <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dsplit</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="k">elif</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ellipsoidal&#39;</span><span class="p">:</span>
                    
                    <span class="k">def</span> <span class="nf">ellipseCalc</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">R</span><span class="p">):</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">*</span><span class="n">E</span><span class="o">.</span><span class="n">T</span>
                        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">XYZ</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">R</span><span class="p">)</span>
                        
                    <span class="n">S6</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">Sij</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">U6toUij</span><span class="p">(</span><span class="n">S6</span><span class="p">)</span>
                    <span class="n">E</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">Sij</span><span class="p">)</span>
                    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>
                    <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">ellipseCalc</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">R</span><span class="p">))</span>
                    <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dsplit</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                    
                <span class="k">elif</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;generalized&#39;</span><span class="p">:</span>
                    
                    <span class="k">def</span> <span class="nf">genMustrain</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">Shkl</span><span class="p">):</span>
                        <span class="n">uvw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">xyz</span><span class="p">)</span>
                        <span class="n">Strm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2spc</span><span class="o">.</span><span class="n">MustrainCoeff</span><span class="p">(</span><span class="n">uvw</span><span class="p">,</span><span class="n">SGData</span><span class="p">))</span>
                        <span class="nb">sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">Shkl</span><span class="p">,</span><span class="n">Strm</span><span class="p">))</span>
                        <span class="nb">sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">sum</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">,</span><span class="nb">sum</span><span class="p">,</span><span class="mf">0.01</span><span class="p">)</span>
                        <span class="nb">sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/.</span><span class="mi">18</span>      <span class="c">#centidegrees to radians!</span>
                        <span class="k">return</span> <span class="nb">sum</span><span class="o">*</span><span class="n">xyz</span>
                        
                    <span class="n">Shkl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Shkl</span><span class="p">):</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">))</span>
                        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">genMustrain</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">XYZ</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">Shkl</span><span class="p">))</span>
                        <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dsplit</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">Z</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span>
                            
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Z</span><span class="p">):</span>
                    <span class="n">errFlags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">rstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">cstride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>
                    <span class="n">xyzlim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_xlim3d</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_ylim3d</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_zlim3d</span><span class="p">()])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">XYZlim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">xyzlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">max</span><span class="p">(</span><span class="n">xyzlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim3d</span><span class="p">(</span><span class="n">XYZlim</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim3d</span><span class="p">(</span><span class="n">XYZlim</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_zlim3d</span><span class="p">(</span><span class="n">XYZlim</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s">&#39;equal&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plotType</span> <span class="o">==</span> <span class="s">&#39;Size&#39;</span><span class="p">:</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Crystallite size for &#39;</span><span class="o">+</span><span class="n">phase</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; model&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;X, $\mu$m&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;Y, $\mu$m&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s">r&#39;Z, $\mu$m&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">r&#39;$\mu$strain for &#39;</span><span class="o">+</span><span class="n">phase</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39; model&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;X, $\mu$strain&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;Y, $\mu$strain&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s">r&#39;Z, $\mu$strain&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">h</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;POhkl&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;MD&#39;</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s">&#39;March-Dollase preferred orientation plot&#39;</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;POhkl&#39;</span><span class="p">])</span>
                    <span class="n">phi</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CrsAng</span><span class="p">(</span><span class="n">PH</span><span class="p">,</span><span class="n">cell</span><span class="p">[:</span><span class="mi">6</span><span class="p">],</span><span class="n">SGData</span><span class="p">)</span>
                    <span class="n">SHCoef</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
                        <span class="n">L</span><span class="p">,</span><span class="n">N</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">))</span>
                        <span class="n">SHCoef</span><span class="p">[</span><span class="s">&#39;C</span><span class="si">%d</span><span class="s">,0,</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">)]</span> <span class="o">=</span> <span class="n">coeff</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>                        
                    <span class="n">ODFln</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Flnh</span><span class="p">(</span><span class="n">Start</span><span class="p">,</span><span class="n">SHCoef</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
                    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">90.0</span><span class="p">,</span><span class="mi">26</span><span class="p">)</span>
                    <span class="n">Y</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">polfcal</span><span class="p">(</span><span class="n">ODFln</span><span class="p">,</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">PH</span><span class="p">))</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Axial distribution for HKL=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">PH</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; in &#39;</span><span class="o">+</span><span class="n">phase</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$\psi$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;MRD&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
<span class="c">################################################################################</span>
<span class="c">##### PlotTexture</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotTexture"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotTexture">[docs]</a><span class="k">def</span> <span class="nf">PlotTexture</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">Start</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Pole figure, inverse pole figure, 3D pole distribution and 3D inverse pole distribution</span>
<span class="sd">    plotting.</span>
<span class="sd">    dict generalData contains all phase info needed which is in data</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">shModels</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;cylindrical&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="s">&#39;shear - 2/m&#39;</span><span class="p">,</span><span class="s">&#39;rolling - mmm&#39;</span><span class="p">]</span>
    <span class="n">SamSym</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">shModels</span><span class="p">,[</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;-1&#39;</span><span class="p">,</span><span class="s">&#39;2/m&#39;</span><span class="p">,</span><span class="s">&#39;mmm&#39;</span><span class="p">]))</span>
    <span class="n">PatternId</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternId</span>
    <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
    <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
    <span class="n">textureData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="s">&#39;Texture&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Order&#39;</span><span class="p">]:</span>
        <span class="k">return</span>                  <span class="c">#no plot!!</span>
    <span class="n">SHData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span>
    <span class="n">SHCoef</span> <span class="o">=</span> <span class="n">SHData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="n">sq2</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">rp2xyz</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">npcosd</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xy</span><span class="o">*</span><span class="n">npsind</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">xy</span><span class="o">*</span><span class="n">npcosd</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">z</span>
            
    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">SHData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">:</span>                 <span class="c">#avoid out of frame errors</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
            <span class="k">if</span> <span class="s">&#39;Inverse&#39;</span> <span class="ow">in</span> <span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">xpos</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ypos</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;equal&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Projection</span><span class="p">:</span> 
                        <span class="n">r</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">npasind</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">*</span><span class="n">sq2</span><span class="p">),</span><span class="n">npatan2d</span><span class="p">(</span><span class="n">ypos</span><span class="p">,</span><span class="n">xpos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">npatand</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r</span><span class="p">)),</span><span class="n">npatan2d</span><span class="p">(</span><span class="n">ypos</span><span class="p">,</span><span class="n">xpos</span><span class="p">)</span>
                    <span class="n">ipf</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">invpolfcal</span><span class="p">(</span><span class="n">IODFln</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">,]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">,]))</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rp2xyz</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">)]))</span>
                    <span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">xyz</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xyz</span><span class="p">)))</span>
                    
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                        <span class="s">&#39;psi =</span><span class="si">%9.3f</span><span class="s">, beta =</span><span class="si">%9.3f</span><span class="s">, MRD =</span><span class="si">%9.3f</span><span class="s"> hkl=</span><span class="si">%5.2f</span><span class="s">,</span><span class="si">%5.2f</span><span class="s">,</span><span class="si">%5.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ipf</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)])</span>
                                    
            <span class="k">elif</span> <span class="s">&#39;Axial&#39;</span> <span class="ow">in</span> <span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]:</span>
                <span class="k">pass</span>
                
            <span class="k">else</span><span class="p">:</span>                       <span class="c">#ordinary pole figure</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">xpos</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ypos</span><span class="o">**</span><span class="mi">2</span>
                <span class="k">if</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;equal&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Projection</span><span class="p">:</span> 
                        <span class="n">r</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">npasind</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">sq2</span><span class="p">),</span><span class="n">npatan2d</span><span class="p">(</span><span class="n">ypos</span><span class="p">,</span><span class="n">xpos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">npatand</span><span class="p">(</span><span class="n">z</span><span class="p">),</span><span class="n">npatan2d</span><span class="p">(</span><span class="n">ypos</span><span class="p">,</span><span class="n">xpos</span><span class="p">)</span>
                    <span class="n">pf</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">polfcal</span><span class="p">(</span><span class="n">ODFln</span><span class="p">,</span><span class="n">SamSym</span><span class="p">[</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">]],</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">,]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">p</span><span class="p">,]))</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;phi =</span><span class="si">%9.3f</span><span class="s">, gam =</span><span class="si">%9.3f</span><span class="s">, MRD =</span><span class="si">%9.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">pf</span><span class="p">)])</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Texture&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Page</span><span class="o">.</span><span class="n">IsShown</span><span class="p">():</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Texture&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Texture&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>

    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">])</span>    
    <span class="n">PH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PFhkl&#39;</span><span class="p">])</span>
    <span class="n">phi</span><span class="p">,</span><span class="n">beta</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">CrsAng</span><span class="p">(</span><span class="n">PH</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
    <span class="n">ODFln</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Flnh</span><span class="p">(</span><span class="n">Start</span><span class="p">,</span><span class="n">SHCoef</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">beta</span><span class="p">,</span><span class="n">SGData</span><span class="p">)</span>
    <span class="n">PX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PFxyz&#39;</span><span class="p">])</span>
    <span class="n">gam</span> <span class="o">=</span> <span class="n">atan2d</span><span class="p">(</span><span class="n">PX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">PX</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">PX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">PX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">PX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">PX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">PX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">asind</span><span class="p">(</span><span class="n">xy</span><span class="o">/</span><span class="n">xyz</span><span class="p">)</span>
    <span class="n">IODFln</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">Glnh</span><span class="p">(</span><span class="n">Start</span><span class="p">,</span><span class="n">SHCoef</span><span class="p">,</span><span class="n">psi</span><span class="p">,</span><span class="n">gam</span><span class="p">,</span><span class="n">SamSym</span><span class="p">[</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">]])</span>
    <span class="k">if</span> <span class="s">&#39;Axial&#39;</span> <span class="ow">in</span> <span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">90.0</span><span class="p">,</span><span class="mi">26</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">polfcal</span><span class="p">(</span><span class="n">ODFln</span><span class="p">,</span><span class="n">SamSym</span><span class="p">[</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">]],</span><span class="n">X</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PFhkl&#39;</span><span class="p">]))</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Axial distribution for HKL=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PFhkl&#39;</span><span class="p">]))</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$\psi$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;MRD&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>       
        <span class="n">npts</span> <span class="o">=</span> <span class="mi">201</span>
        <span class="k">if</span> <span class="s">&#39;Inverse&#39;</span> <span class="ow">in</span> <span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PlotType&#39;</span><span class="p">]:</span>
            <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="n">npts</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">npts</span><span class="p">))</span>
            <span class="n">R</span><span class="p">,</span><span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">npatan2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;equal&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Projection</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">npasind</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">sq2</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">npatand</span><span class="p">(</span><span class="n">R</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">invpolfcal</span><span class="p">(</span><span class="n">IODFln</span><span class="p">,</span><span class="n">SGData</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">P</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Z</span><span class="p">,(</span><span class="n">npts</span><span class="p">,</span><span class="n">npts</span><span class="p">))</span>
            <span class="n">CS</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">Img</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Inverse pole figure for XYZ=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PFxyz&#39;</span><span class="p">]))</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Projection</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="o">+</span><span class="s">&#39; projection&#39;</span><span class="p">)</span>
                        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="n">npts</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="n">npts</span><span class="p">))</span>
            <span class="n">R</span><span class="p">,</span><span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">npatan2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;equal&#39;</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Projection</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">npasind</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="n">sq2</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">R</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span><span class="mf">2.</span><span class="o">*</span><span class="n">npatand</span><span class="p">(</span><span class="n">R</span><span class="p">),</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">polfcal</span><span class="p">(</span><span class="n">ODFln</span><span class="p">,</span><span class="n">SamSym</span><span class="p">[</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">]],</span><span class="n">R</span><span class="p">,</span><span class="n">P</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Z</span><span class="p">,(</span><span class="n">npts</span><span class="p">,</span><span class="n">npts</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">CS</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">)</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">CS</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ContourColor</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">Img</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Pole figure for HKL=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">SHData</span><span class="p">[</span><span class="s">&#39;PFhkl&#39;</span><span class="p">]))</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Projection</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="o">+</span><span class="s">&#39; projection&#39;</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

<span class="c">################################################################################</span>
<span class="c">##### PlotCovariance</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotCovariance"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotCovariance">[docs]</a><span class="k">def</span> <span class="nf">PlotCovariance</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Data</span><span class="p">):</span>
    <span class="s">&#39;needs a doc string&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Data</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&#39;No covariance matrix available&#39;</span>
        <span class="k">return</span>
    <span class="n">varyList</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;varyList&#39;</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;variables&#39;</span><span class="p">]</span>
    <span class="n">Xmax</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">varyList</span><span class="p">)</span>
    <span class="n">covMatrix</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;covMatrix&#39;</span><span class="p">]</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">covMatrix</span><span class="p">))</span>
    <span class="n">xvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span>
    <span class="n">covArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">covMatrix</span><span class="p">,</span><span class="n">xvar</span><span class="p">),</span><span class="n">xvar</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s">&#39; for</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
    <span class="n">newAtomDict</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;newAtomDict&#39;</span><span class="p">]</span>
    

    <span class="k">def</span> <span class="nf">OnPlotKeyPress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">datad</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;_r&quot;</span><span class="p">)]</span>
            <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Color scheme&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">VcovColor</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">VcovColor</span> <span class="o">=</span> <span class="s">&#39;RdYlGn&#39;</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="n">PlotCovariance</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="c">#there is a problem here - reports wrong values</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">:</span>
            <span class="n">ytics</span> <span class="o">=</span> <span class="n">imgAx</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
            <span class="n">ytics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ytics</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">varyList</span><span class="p">),</span><span class="n">ytics</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ylabs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;=</span><span class="n">i</span> <span class="p">,</span><span class="n">varyList</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)],</span><span class="s">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ytics</span><span class="p">]</span>
            <span class="n">imgAx</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ylabs</span><span class="p">)</span>            
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">:</span>                 <span class="c">#avoid out of frame errors</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="o">+.</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">xpos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">varyList</span><span class="p">)</span> <span class="ow">and</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">ypos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">varyList</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">xpos</span> <span class="o">==</span> <span class="n">ypos</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">xpos</span><span class="p">]</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">varyList</span><span class="p">[</span><span class="n">xpos</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">varyList</span><span class="p">[</span><span class="n">xpos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">newAtomDict</span><span class="p">:</span>
                        <span class="n">name</span><span class="p">,</span><span class="n">value</span> <span class="o">=</span> <span class="n">newAtomDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>                        
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> value = </span><span class="si">%.4g</span><span class="s">, esd = </span><span class="si">%.4g</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">sig</span><span class="p">[</span><span class="n">xpos</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> - </span><span class="si">%s</span><span class="s">: </span><span class="si">%5.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">varyList</span><span class="p">[</span><span class="n">xpos</span><span class="p">],</span><span class="n">varyList</span><span class="p">[</span><span class="n">ypos</span><span class="p">],</span><span class="n">covArray</span><span class="p">[</span><span class="n">xpos</span><span class="p">][</span><span class="n">ypos</span><span class="p">])</span>
                <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">msg</span><span class="p">])</span>
                
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Covariance&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Page</span><span class="o">.</span><span class="n">IsShown</span><span class="p">():</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Covariance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Covariance&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">OnPlotKeyPress</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;s: to change colors&#39;</span><span class="p">]</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">keyPress</span> <span class="o">=</span> <span class="n">OnPlotKeyPress</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">])</span>    
    <span class="n">acolor</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">VcovColor</span><span class="p">)</span>
    <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">covArray</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">acolor</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">imgAx</span> <span class="o">=</span> <span class="n">Img</span><span class="o">.</span><span class="n">get_axes</span><span class="p">()</span>
    <span class="n">ytics</span> <span class="o">=</span> <span class="n">imgAx</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">()</span>
    <span class="n">ylabs</span> <span class="o">=</span> <span class="p">[</span><span class="n">varyList</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ytics</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">imgAx</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">ylabs</span><span class="p">)</span>
    <span class="n">colorBar</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">Img</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;V-Cov matrix&#39;</span><span class="o">+</span><span class="n">title</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Variable number&#39;</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Variable name&#39;</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
<span class="c">################################################################################</span>
<span class="c">##### PlotTorsion</span>
<span class="c">################################################################################</span>
</div>
<div class="viewcode-block" id="PlotTorsion"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotTorsion">[docs]</a><span class="k">def</span> <span class="nf">PlotTorsion</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">phaseName</span><span class="p">,</span><span class="n">Torsion</span><span class="p">,</span><span class="n">TorName</span><span class="p">,</span><span class="n">Names</span><span class="o">=</span><span class="p">[],</span><span class="n">Angles</span><span class="o">=</span><span class="p">[],</span><span class="n">Coeff</span><span class="o">=</span><span class="p">[]):</span>
    <span class="s">&#39;needs a doc string&#39;</span>
    
    <span class="k">global</span> <span class="n">names</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">Names</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Torsion</span><span class="p">)</span>
    <span class="n">torsion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Torsion</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="nb">sum</span>
    <span class="n">tMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
    <span class="n">tMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">torsion</span><span class="p">)</span>
    <span class="n">torsion</span> <span class="o">=</span> <span class="mf">3.</span><span class="o">*</span><span class="p">(</span><span class="n">torsion</span><span class="o">-</span><span class="n">tMin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tMax</span><span class="o">-</span><span class="n">tMin</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">OnPick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;atoms:&#39;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Torsion restraints&#39;</span><span class="p">:</span>
            <span class="n">torGrid</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">Torsions</span>
            <span class="n">torGrid</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">torGrid</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="ow">in</span> <span class="n">torGrid</span><span class="o">.</span><span class="n">GetCellValue</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">torGrid</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">torGrid</span><span class="o">.</span><span class="n">ForceRefresh</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">:</span>                 <span class="c">#avoid out of frame errors</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;torsion,energy: </span><span class="si">%5.3f</span><span class="s"> </span><span class="si">%5.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">)</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Torsion&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Page</span><span class="o">.</span><span class="n">IsShown</span><span class="p">():</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Torsion&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Torsion&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;pick_event&#39;</span><span class="p">,</span> <span class="n">OnPick</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
    
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Use mouse LB to identify torsion atoms&#39;</span><span class="p">])</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">torsion</span><span class="p">,</span><span class="s">&#39;b+&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Coeff</span><span class="p">):</span>
        <span class="n">X2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">,</span><span class="mi">45</span><span class="p">)</span>
        <span class="n">Y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">G2mth</span><span class="o">.</span><span class="n">calcTorsionEnergy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Coeff</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X2</span><span class="p">])</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X2</span><span class="p">,</span><span class="n">Y2</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Angles</span><span class="p">):</span>
        <span class="n">Eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">G2mth</span><span class="o">.</span><span class="n">calcTorsionEnergy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Coeff</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Angles</span><span class="p">])</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Angles</span><span class="p">,</span><span class="n">Eval</span><span class="p">,</span><span class="s">&#39;ro&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">))</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Torsion angles for &#39;</span><span class="o">+</span><span class="n">TorName</span><span class="o">+</span><span class="s">&#39; in &#39;</span><span class="o">+</span><span class="n">phaseName</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;angle&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Energy&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
<span class="c">################################################################################</span>
<span class="c">##### PlotRama</span>
<span class="c">################################################################################</span>
</div>
<div class="viewcode-block" id="PlotRama"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotRama">[docs]</a><span class="k">def</span> <span class="nf">PlotRama</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">phaseName</span><span class="p">,</span><span class="n">Rama</span><span class="p">,</span><span class="n">RamaName</span><span class="p">,</span><span class="n">Names</span><span class="o">=</span><span class="p">[],</span><span class="n">PhiPsi</span><span class="o">=</span><span class="p">[],</span><span class="n">Coeff</span><span class="o">=</span><span class="p">[]):</span>
    <span class="s">&#39;needs a doc string&#39;</span>

    <span class="k">global</span> <span class="n">names</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">Names</span>
    <span class="n">rama</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">Rama</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span>
    <span class="n">ramaMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rama</span><span class="p">)</span>
    <span class="n">rama</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rama</span><span class="p">,(</span><span class="mi">45</span><span class="p">,</span><span class="mi">45</span><span class="p">))</span>
    <span class="k">global</span> <span class="n">Phi</span><span class="p">,</span><span class="n">Psi</span>
    <span class="n">Phi</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Psi</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">OnPlotKeyPress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">newPlot</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
            <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">datad</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;_r&quot;</span><span class="p">)]</span>
            <span class="n">choice</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SingleChoiceDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Select&#39;</span><span class="p">,</span><span class="s">&#39;Color scheme&#39;</span><span class="p">,</span><span class="n">choice</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">RamaColor</span> <span class="o">=</span> <span class="n">choice</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">RamaColor</span> <span class="o">=</span> <span class="s">&#39;RdYlGn&#39;</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="n">PlotRama</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">phaseName</span><span class="p">,</span><span class="n">Rama</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnPick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ind</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;atoms:&#39;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Ramachandran restraints&#39;</span><span class="p">:</span>
            <span class="n">ramaGrid</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">Ramas</span>
            <span class="n">ramaGrid</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ramaGrid</span><span class="o">.</span><span class="n">GetNumberRows</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">names</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ramaGrid</span><span class="o">.</span><span class="n">GetCellValue</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">ramaGrid</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">ramaGrid</span><span class="o">.</span><span class="n">ForceRefresh</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">:</span>                 <span class="c">#avoid out of frame errors</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
            <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;phi/psi: </span><span class="si">%5.3f</span><span class="s"> </span><span class="si">%5.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">)</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Ramachandran&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Page</span><span class="o">.</span><span class="n">IsShown</span><span class="p">():</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Ramachandran&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Ramachandran&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;pick_event&#39;</span><span class="p">,</span> <span class="n">OnPick</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">OnPlotKeyPress</span><span class="p">)</span>

    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;s: to change colors&#39;</span><span class="p">]</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">keyPress</span> <span class="o">=</span> <span class="n">OnPlotKeyPress</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Use mouse LB to identify phi/psi atoms&#39;</span><span class="p">])</span>
    <span class="n">acolor</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">RamaColor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">RamaName</span> <span class="o">==</span> <span class="s">&#39;All&#39;</span> <span class="ow">or</span> <span class="s">&#39;-1&#39;</span> <span class="ow">in</span> <span class="n">RamaName</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Coeff</span><span class="p">):</span> 
            <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span><span class="mf">180.</span><span class="p">,</span><span class="mi">45</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span><span class="mf">180.</span><span class="p">,</span><span class="mi">45</span><span class="p">))</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">G2mth</span><span class="o">.</span><span class="n">calcRamaEnergy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Coeff</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())])</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Z</span><span class="p">,(</span><span class="mi">45</span><span class="p">,</span><span class="mi">45</span><span class="p">)))</span>
        <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rama</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">acolor</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">],</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PhiPsi</span><span class="p">):</span>
            <span class="n">Phi</span><span class="p">,</span><span class="n">Psi</span> <span class="o">=</span> <span class="n">PhiPsi</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Phi</span><span class="o">&gt;</span><span class="mf">180.</span><span class="p">,</span><span class="n">Phi</span><span class="o">-</span><span class="mf">360.</span><span class="p">,</span><span class="n">Phi</span><span class="p">)</span>
            <span class="n">Psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Psi</span><span class="o">&gt;</span><span class="mf">180.</span><span class="p">,</span><span class="n">Psi</span><span class="o">-</span><span class="mf">360.</span><span class="p">,</span><span class="n">Psi</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">Psi</span><span class="p">,</span><span class="s">&#39;ro&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span><span class="mf">180.</span><span class="p">))</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span><span class="mf">180.</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Coeff</span><span class="p">):</span> 
            <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">,</span><span class="mi">45</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">,</span><span class="mi">45</span><span class="p">))</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">G2mth</span><span class="o">.</span><span class="n">calcRamaEnergy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Coeff</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">())])</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Z</span><span class="p">,(</span><span class="mi">45</span><span class="p">,</span><span class="mi">45</span><span class="p">)))</span>
        <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rama</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">acolor</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span>
            <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">],</span><span class="n">origin</span><span class="o">=</span><span class="s">&#39;lower&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PhiPsi</span><span class="p">):</span>
            <span class="n">Phi</span><span class="p">,</span><span class="n">Psi</span> <span class="o">=</span> <span class="n">PhiPsi</span><span class="o">.</span><span class="n">T</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="n">Psi</span><span class="p">,</span><span class="s">&#39;ro&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">))</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span><span class="mf">360.</span><span class="p">))</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Ramachandran for &#39;</span><span class="o">+</span><span class="n">RamaName</span><span class="o">+</span><span class="s">&#39; in &#39;</span><span class="o">+</span><span class="n">phaseName</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">r&#39;$\phi$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">r&#39;$\psi$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">colorBar</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">Img</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="c">################################################################################</span>
<span class="c">##### PlotSeq</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotSeq"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotSeq">[docs]</a><span class="k">def</span> <span class="nf">PlotSeq</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">SeqData</span><span class="p">,</span><span class="n">SeqSig</span><span class="p">,</span><span class="n">SeqNames</span><span class="p">,</span><span class="n">sampleParm</span><span class="p">):</span>
    <span class="s">&#39;needs a doc string&#39;</span>
    
    <span class="k">def</span> <span class="nf">OnKeyPress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span> <span class="ow">and</span> <span class="n">sampleParm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">xAxis</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">xAxis</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">xAxis</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">Draw</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Sequential refinement&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Page</span><span class="o">.</span><span class="n">IsShown</span><span class="p">():</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;Sequential refinement&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Sequential refinement&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">OnKeyPress</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">xAxis</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;s to toggle x-axis = sample environment parameter&#39;</span><span class="p">]</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">keyPress</span> <span class="o">=</span> <span class="n">OnKeyPress</span>
        
    <span class="k">def</span> <span class="nf">Draw</span><span class="p">(</span><span class="n">newPlot</span><span class="p">):</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;press &#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">SeqData</span><span class="p">):</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">xAxis</span><span class="p">:</span>    
                <span class="n">xName</span> <span class="o">=</span> <span class="n">sampleParm</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">sampleParm</span><span class="p">[</span><span class="n">xName</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">SeqData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">xName</span> <span class="o">=</span> <span class="s">&#39;Data sequence number&#39;</span>
            <span class="k">for</span> <span class="n">Y</span><span class="p">,</span><span class="n">sig</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">SeqData</span><span class="p">,</span><span class="n">SeqSig</span><span class="p">,</span><span class="n">SeqNames</span><span class="p">):</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">sig</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>        
            <span class="n">Plot</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">&#39;best&#39;</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Parameter values&#39;</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xName</span><span class="p">)</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>            
    <span class="n">Draw</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            
<span class="c">################################################################################</span>
<span class="c">##### PlotExposedImage &amp; PlotImage</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotExposedImage"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotExposedImage">[docs]</a><span class="k">def</span> <span class="nf">PlotExposedImage</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;General access module for 2D image plotting</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">plotNo</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">plotNo</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;2D Powder Image&#39;</span><span class="p">:</span>
        <span class="n">PlotImage</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">newImage</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">plotNo</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;2D Integration&#39;</span><span class="p">:</span>
        <span class="n">PlotIntegration</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="p">,</span><span class="n">event</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PlotImage"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotImage">[docs]</a><span class="k">def</span> <span class="nf">PlotImage</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">newImage</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Plot of 2D detector images as contoured plot. Also plot calibration ellipses,</span>
<span class="sd">    masks, etc.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Ellipse</span><span class="p">,</span><span class="n">Arc</span><span class="p">,</span><span class="n">Circle</span><span class="p">,</span><span class="n">Polygon</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
    <span class="n">Dsp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">tth</span><span class="p">,</span><span class="n">wave</span><span class="p">:</span> <span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">tth</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span>
    <span class="k">global</span> <span class="n">Data</span><span class="p">,</span><span class="n">Masks</span>
    <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;b&#39;</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;m&#39;</span><span class="p">,</span><span class="s">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">Data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="s">&#39;Image Controls&#39;</span><span class="p">))</span>
    <span class="n">Masks</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="s">&#39;Masks&#39;</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>    <span class="c">#may be absent</span>
        <span class="n">StrSta</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="s">&#39;Stress/Strain&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>   <span class="c">#is missing</span>
        <span class="n">StrSta</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">OnImMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">sizexy</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ImageZ</span><span class="p">):</span>                 <span class="c">#avoid out of frame errors</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CROSS_CURSOR</span><span class="p">)</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span>
            <span class="n">pixelSize</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;pixelSize&#39;</span><span class="p">]</span>
            <span class="n">scalex</span> <span class="o">=</span> <span class="mf">1000.</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">scaley</span> <span class="o">=</span> <span class="mf">1000.</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">and</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Image Controls&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;Text&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.3f</span><span class="s"> </span><span class="si">%8.3f</span><span class="s">mm&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xcent</span><span class="p">,</span><span class="n">ycent</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span>
                    <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="o">-</span><span class="n">xcent</span>
                    <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="o">-</span><span class="n">ycent</span>
                    <span class="n">tth</span><span class="p">,</span><span class="n">azm</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTthAzm</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span><span class="n">event</span><span class="o">.</span><span class="n">ydata</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;line3&#39;</span> <span class="ow">in</span>  <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;line4&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;fullIntegrate&#39;</span><span class="p">]:</span>
                        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%6d</span><span class="s"> deg&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">azm</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="s">&#39;line1&#39;</span> <span class="ow">in</span>  <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;line2&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.3f</span><span class="s">deg&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tth</span><span class="p">))</span>                           
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
                <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
                <span class="n">xpix</span> <span class="o">=</span> <span class="n">xpos</span><span class="o">*</span><span class="n">scalex</span>
                <span class="n">ypix</span> <span class="o">=</span> <span class="n">ypos</span><span class="o">*</span><span class="n">scaley</span>
                <span class="n">Int</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">xpix</span> <span class="o">&lt;=</span> <span class="n">sizexy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ypix</span> <span class="o">&lt;=</span> <span class="n">sizexy</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">Int</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">ImageZ</span><span class="p">[</span><span class="n">ypix</span><span class="p">][</span><span class="n">xpix</span><span class="p">]</span>
                <span class="n">tth</span><span class="p">,</span><span class="n">azm</span><span class="p">,</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTthAzmDsp</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">dsp</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">setPoly</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Polygon mask pick - LB next point, RB close polygon&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">(</span>\
                        <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Detector 2-th =</span><span class="si">%9.3f</span><span class="s">deg, dsp =</span><span class="si">%9.3f</span><span class="s">A, Q = </span><span class="si">%6.5f</span><span class="s">A-1, azm = </span><span class="si">%7.2f</span><span class="s">deg, I = </span><span class="si">%6d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tth</span><span class="p">,</span><span class="n">dsp</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">azm</span><span class="p">,</span><span class="n">Int</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">OnImPlotKeyPress</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PickName</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">PickName</span> <span class="o">==</span> <span class="s">&#39;Masks&#39;</span><span class="p">:</span>
            <span class="n">Xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Xpos</span><span class="p">:</span>            <span class="c">#got point out of frame</span>
                <span class="k">return</span>
            <span class="n">Ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
                <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Points&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Xpos</span><span class="p">,</span><span class="n">Ypos</span><span class="p">,</span><span class="mf">1.</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">:</span>
                <span class="n">tth</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTth</span><span class="p">(</span><span class="n">Xpos</span><span class="p">,</span><span class="n">Ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>
                <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Rings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tth</span><span class="p">,</span><span class="mf">0.1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
                <span class="n">tth</span><span class="p">,</span><span class="n">azm</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTthAzm</span><span class="p">(</span><span class="n">Xpos</span><span class="p">,</span><span class="n">Ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>
                <span class="n">azm</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">azm</span><span class="p">)</span>                
                <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Arcs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">tth</span><span class="p">,[</span><span class="n">azm</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="n">azm</span><span class="o">+</span><span class="mi">5</span><span class="p">],</span><span class="mf">0.1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">setPoly</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Polygons&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Polygon mask active - LB pick next point, RB close polygon&#39;</span><span class="p">])</span>
            <span class="n">G2imG</span><span class="o">.</span><span class="n">UpdateMasks</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Masks</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">PickName</span> <span class="o">==</span> <span class="s">&#39;Image Controls&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
                <span class="n">Xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Xpos</span><span class="p">:</span>            <span class="c">#got point out of frame</span>
                    <span class="k">return</span>
                <span class="n">Ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="s">&#39;Are you sure you want to change the center?&#39;</span><span class="p">,</span>
                    <span class="s">&#39;Center change&#39;</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">OK</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CANCEL</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;move center to: &#39;</span><span class="p">,</span><span class="n">Xpos</span><span class="p">,</span><span class="n">Ypos</span>
                        <span class="n">Data</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">Xpos</span><span class="p">,</span><span class="n">Ypos</span><span class="p">]</span>
                        <span class="n">G2imG</span><span class="o">.</span><span class="n">UpdateImageControls</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Data</span><span class="p">,</span><span class="n">Masks</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">PlotImage</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newImage</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">OnKeyBox</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span> <span class="o">==</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;2D Powder Image&#39;</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39; key press&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
                <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">OnImPlotKeyPress</span><span class="p">,</span><span class="n">event</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span> <span class="c"># redirect the Focus from the button back to the plot</span>
                        
    <span class="k">def</span> <span class="nf">OnImPick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Image Controls&#39;</span><span class="p">,</span><span class="s">&#39;Masks&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">setPoly</span><span class="p">:</span>
            <span class="n">polygon</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Polygons&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span><span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span><span class="o">.</span><span class="n">ydata</span>
            <span class="k">if</span> <span class="n">xpos</span> <span class="ow">and</span> <span class="n">ypos</span><span class="p">:</span>                       <span class="c">#point inside image</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polygon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="o">=</span> <span class="n">polygon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">polygon</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">])</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">setPoly</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Polygon closed - RB drag a vertex to change shape&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;New polygon point: </span><span class="si">%.1f</span><span class="s">,</span><span class="si">%.1f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">)])</span>
                    <span class="n">polygon</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">])</span>
                <span class="n">G2imG</span><span class="o">.</span><span class="n">UpdateMasks</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Masks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">artist</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">mousePicked</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">mouseevent</span>
        
    <span class="k">def</span> <span class="nf">OnImRelease</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PickName</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">PickName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Image Controls&#39;</span><span class="p">,</span><span class="s">&#39;Masks&#39;</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">pixelSize</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;pixelSize&#39;</span><span class="p">]</span>
        <span class="n">scalex</span> <span class="o">=</span> <span class="mf">1000.</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scaley</span> <span class="o">=</span> <span class="mf">1000.</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pixLimit</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;pixLimit&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">PickName</span> <span class="o">==</span> <span class="s">&#39;Image Controls&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ImageZ</span><span class="p">):</span>
<span class="c">#            sizexy = Data[&#39;size&#39;]</span>
            <span class="n">Xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">Xpos</span> <span class="ow">and</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">ifGetRing</span><span class="p">):</span>                   <span class="c">#got point out of frame</span>
                <span class="k">return</span>
            <span class="n">Ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
            <span class="k">if</span> <span class="n">Ypos</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">_active</span><span class="p">:</span>         <span class="c">#make sure zoom/pan not selected</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">Xpix</span> <span class="o">=</span> <span class="n">Xpos</span><span class="o">*</span><span class="n">scalex</span>
                    <span class="n">Ypix</span> <span class="o">=</span> <span class="n">Ypos</span><span class="o">*</span><span class="n">scaley</span>
                    <span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">I</span><span class="p">,</span><span class="n">J</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">ImageLocalMax</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ImageZ</span><span class="p">,</span><span class="n">pixLimit</span><span class="p">,</span><span class="n">Xpix</span><span class="p">,</span><span class="n">Ypix</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">I</span> <span class="ow">and</span> <span class="n">J</span><span class="p">:</span>
                        <span class="n">xpos</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span>                              <span class="c">#shift to pixel center</span>
                        <span class="n">ypos</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span>
                        <span class="n">xpos</span> <span class="o">/=</span> <span class="n">scalex</span>                          <span class="c">#convert to mm</span>
                        <span class="n">ypos</span> <span class="o">/=</span> <span class="n">scaley</span>
                        <span class="n">Data</span><span class="p">[</span><span class="s">&#39;ring&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">GetStatusBar</span><span class="p">()</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Calibrating...&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">G2img</span><span class="o">.</span><span class="n">ImageCalibrate</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Data</span><span class="p">):</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">GetStatusBar</span><span class="p">()</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Calibration successful - Show ring picks to check&#39;</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s">&#39;Calibration successful&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataFrame</span><span class="o">.</span><span class="n">GetStatusBar</span><span class="p">()</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Calibration failed - Show ring picks to diagnose&#39;</span><span class="p">)</span>
                        <span class="k">print</span> <span class="s">&#39;Calibration failed&#39;</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">ifGetRing</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">G2imG</span><span class="o">.</span><span class="n">UpdateImageControls</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Data</span><span class="p">,</span><span class="n">Masks</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">PlotImage</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newImage</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xpos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
            <span class="k">if</span> <span class="n">xpos</span><span class="p">:</span>                                        <span class="c">#avoid out of frame mouse position</span>
                <span class="n">ypos</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
                <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">ifGetRing</span><span class="p">:</span>                          <span class="c">#delete a calibration ring pick</span>
                    <span class="n">xypos</span> <span class="o">=</span> <span class="p">[</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">]</span>
                    <span class="n">rings</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;ring&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span><span class="n">xypos</span><span class="p">,</span><span class="o">.</span><span class="mo">01</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                            <span class="n">rings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span>                                                                       
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tth</span><span class="p">,</span><span class="n">azm</span><span class="p">,</span><span class="n">dsp</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTthAzmDsp</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>
                    <span class="n">itemPicked</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;Line2D&#39;</span> <span class="ow">in</span> <span class="n">itemPicked</span> <span class="ow">and</span> <span class="n">PickName</span> <span class="o">==</span> <span class="s">&#39;Image Controls&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s">&#39;line1&#39;</span> <span class="ow">in</span> <span class="n">itemPicked</span><span class="p">:</span>
                            <span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tth</span><span class="p">,</span><span class="mf">0.001</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s">&#39;line2&#39;</span> <span class="ow">in</span> <span class="n">itemPicked</span><span class="p">:</span>
                            <span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tth</span>
                        <span class="k">elif</span> <span class="s">&#39;line3&#39;</span> <span class="ow">in</span> <span class="n">itemPicked</span><span class="p">:</span>
                            <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">azm</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;fullIntegrate&#39;</span><span class="p">]:</span>
                                <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">360</span>
                        <span class="k">elif</span> <span class="s">&#39;line4&#39;</span> <span class="ow">in</span> <span class="n">itemPicked</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;fullIntegrate&#39;</span><span class="p">]:</span>
                            <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">azm</span><span class="p">)</span>
                            
                        <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">360</span>
                            
                        <span class="n">azLim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">])</span>    
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">azLim</span><span class="o">&gt;</span><span class="mi">360</span><span class="p">):</span>
                            <span class="n">azLim</span> <span class="o">-=</span> <span class="mi">360</span>
                            <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">azLim</span><span class="p">)</span>
                            
                        <span class="k">if</span>  <span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">InnerTth</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%8.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">OuterTth</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%8.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">Lazim</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%6d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">Razim</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%6d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="k">elif</span> <span class="s">&#39;Circle&#39;</span> <span class="ow">in</span> <span class="n">itemPicked</span> <span class="ow">and</span> <span class="n">PickName</span> <span class="o">==</span> <span class="s">&#39;Masks&#39;</span><span class="p">:</span>
                        <span class="n">spots</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Points&#39;</span><span class="p">]</span>
                        <span class="n">newPos</span> <span class="o">=</span> <span class="n">itemPicked</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                        <span class="n">newPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">newPos</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">float</span><span class="p">(</span><span class="n">newPos</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                        <span class="k">for</span> <span class="n">spot</span> <span class="ow">in</span> <span class="n">spots</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">spot</span><span class="p">[:</span><span class="mi">2</span><span class="p">]]),</span><span class="n">newPos</span><span class="p">):</span>
                                <span class="n">spot</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span>
                        <span class="n">G2imG</span><span class="o">.</span><span class="n">UpdateMasks</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Masks</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="s">&#39;Line2D&#39;</span> <span class="ow">in</span> <span class="n">itemPicked</span> <span class="ow">and</span> <span class="n">PickName</span> <span class="o">==</span> <span class="s">&#39;Masks&#39;</span><span class="p">:</span>
                        <span class="n">Obj</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span><span class="o">.</span><span class="n">findobj</span><span class="p">()</span>
                        <span class="n">rings</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Rings&#39;</span><span class="p">]</span>
                        <span class="n">arcs</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Arcs&#39;</span><span class="p">]</span>
                        <span class="n">polygons</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Polygons&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">ringList</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">Obj</span> <span class="o">==</span> <span class="n">ring</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">rN</span> <span class="o">=</span> <span class="n">ring</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">ring</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;o&#39;</span><span class="p">:</span>
                                    <span class="n">rings</span><span class="p">[</span><span class="n">rN</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTth</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span><span class="o">-</span><span class="n">rings</span><span class="p">[</span><span class="n">rN</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">rings</span><span class="p">[</span><span class="n">rN</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTth</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span><span class="o">+</span><span class="n">rings</span><span class="p">[</span><span class="n">rN</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
                        <span class="k">for</span> <span class="n">arc</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">arcList</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">Obj</span> <span class="o">==</span> <span class="n">arc</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">aN</span> <span class="o">=</span> <span class="n">arc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">arc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;o&#39;</span><span class="p">:</span>
                                    <span class="n">arcs</span><span class="p">[</span><span class="n">aN</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTth</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span><span class="o">-</span><span class="n">arcs</span><span class="p">[</span><span class="n">aN</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                                <span class="k">elif</span> <span class="n">arc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>
                                    <span class="n">arcs</span><span class="p">[</span><span class="n">aN</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTth</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span><span class="o">+</span><span class="n">arcs</span><span class="p">[</span><span class="n">aN</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                                <span class="k">elif</span> <span class="n">arc</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;l&#39;</span><span class="p">:</span>
                                    <span class="n">arcs</span><span class="p">[</span><span class="n">aN</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">GetAzm</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">arcs</span><span class="p">[</span><span class="n">aN</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">GetAzm</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">Data</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">poly</span> <span class="ow">in</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">polyList</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">Obj</span> <span class="o">==</span> <span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                <span class="n">ind</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">mousePicked</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;ind&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">oldPos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">G2frame</span><span class="o">.</span><span class="n">mousePicked</span><span class="o">.</span><span class="n">xdata</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">mousePicked</span><span class="o">.</span><span class="n">ydata</span><span class="p">])</span>
                                <span class="n">pN</span> <span class="o">=</span> <span class="n">poly</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polygons</span><span class="p">[</span><span class="n">pN</span><span class="p">]):</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xy</span><span class="p">]),</span><span class="n">oldPos</span><span class="p">,</span><span class="n">atol</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
                                        <span class="n">polygons</span><span class="p">[</span><span class="n">pN</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span>
                        <span class="n">G2imG</span><span class="o">.</span><span class="n">UpdateMasks</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">Masks</span><span class="p">)</span>
<span class="c">#                    else:                  #keep for future debugging</span>
<span class="c">#                        print str(G2frame.itemPicked),event.xdata,event.ydata,event.button</span>
                <span class="n">PlotImage</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newImage</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">itemPicked</span> <span class="o">=</span> <span class="bp">None</span>
            
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;2D Powder Image&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get previous powder plot &amp; get limits</span>
            <span class="n">xylim</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">newImage</span><span class="p">:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get a fresh plot after clf()</span>
        
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;2D Powder Image&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;2D Powder Image&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;key_press_event&#39;</span><span class="p">,</span> <span class="n">OnImPlotKeyPress</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnImMotion</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;pick_event&#39;</span><span class="p">,</span> <span class="n">OnImPick</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;button_release_event&#39;</span><span class="p">,</span> <span class="n">OnImRelease</span><span class="p">)</span>
        <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>                       <span class="c">#event from GUI TextCtrl - don&#39;t want focus to change to plot!!!</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">Title</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">)[</span><span class="mi">4</span><span class="p">:]</span>
    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
        <span class="n">Title</span> <span class="o">=</span> <span class="s">&#39;log(&#39;</span><span class="o">+</span><span class="n">Title</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">Title</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;Image Controls&#39;</span><span class="p">,]:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39; key press&#39;</span><span class="p">,</span><span class="s">&#39;l: log(I) on&#39;</span><span class="p">,)</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
                <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;l: log(I) off&#39;</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">keyPress</span> <span class="o">=</span> <span class="n">OnImPlotKeyPress</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">size</span><span class="p">,</span><span class="n">imagefile</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">imagefile</span> <span class="o">!=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">oldImagefile</span><span class="p">:</span>
        <span class="n">imagefile</span> <span class="o">=</span> <span class="n">G2IO</span><span class="o">.</span><span class="n">CheckImageFile</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">imagefile</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">imagefile</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="s">&#39;2D Powder Image&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">SetItemPyData</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">,[</span><span class="n">size</span><span class="p">,</span><span class="n">imagefile</span><span class="p">])</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">ImageZ</span> <span class="o">=</span> <span class="n">G2IO</span><span class="o">.</span><span class="n">GetImageData</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">imagefile</span><span class="p">,</span><span class="n">imageOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">oldImagefile</span> <span class="o">=</span> <span class="n">imagefile</span>

    <span class="n">imScale</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ImageZ</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">:</span>
        <span class="n">imScale</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ImageZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span>
    <span class="n">sizexy</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span>
    <span class="n">pixelSize</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;pixelSize&#39;</span><span class="p">]</span>
    <span class="n">scalex</span> <span class="o">=</span> <span class="mf">1000.</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">scaley</span> <span class="o">=</span> <span class="mf">1000.</span><span class="o">/</span><span class="n">pixelSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Xmax</span> <span class="o">=</span> <span class="n">sizexy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pixelSize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1000.</span>
    <span class="n">Ymax</span> <span class="o">=</span> <span class="n">sizexy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pixelSize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">1000.</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Xmax</span><span class="p">)</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="p">(</span><span class="n">Ymax</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Imin</span><span class="p">,</span><span class="n">Imax</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">acolor</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">])</span>
    <span class="n">xcent</span><span class="p">,</span><span class="n">ycent</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;center&#39;</span><span class="p">]</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;Image x-axis, mm&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;Image y-axis, mm&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="c">#do threshold mask - &quot;real&quot; mask - others are just bondaries</span>
    <span class="n">Zlim</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Thresholds&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
            
        <span class="k">if</span> <span class="n">newImage</span><span class="p">:</span>                    
            <span class="n">MA</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_less</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ImageZ</span><span class="p">,</span><span class="n">Zlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">Zlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">MaskA</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">MA</span><span class="p">)</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">ImageCompress</span><span class="p">(</span><span class="n">MA</span><span class="p">,</span><span class="n">imScale</span><span class="p">)</span>
            <span class="n">AM</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">ImageCompress</span><span class="p">(</span><span class="n">MaskA</span><span class="p">,</span><span class="n">imScale</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">logPlot</span><span class="p">:</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">A</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">AM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AM</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">AM</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">Imin</span><span class="p">,</span><span class="n">Imax</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">A</span><span class="p">)]</span>
            <span class="n">ImgM</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">AM</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s">&#39;Reds&#39;</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">Xmax</span><span class="p">,</span><span class="n">Ymax</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;equal&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">acolor</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">Imin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">Imax</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">Xmax</span><span class="p">,</span><span class="n">Ymax</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">setPoly</span><span class="p">:</span>
                <span class="n">Img</span><span class="o">.</span><span class="n">set_picker</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xcent</span><span class="p">,</span><span class="n">ycent</span><span class="p">,</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
        <span class="c">#G2frame.PatternTree.GetItemText(item)</span>
        <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;showLines&#39;</span><span class="p">]:</span>
            <span class="n">LRAzim</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">]</span>                  <span class="c">#NB: integers</span>
            <span class="n">Nazm</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;outAzimuths&#39;</span><span class="p">]</span>
            <span class="n">delAzm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">Nazm</span>
            <span class="n">AzmthOff</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;azmthOff&#39;</span><span class="p">]</span>
            <span class="n">IOtth</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">]</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">]</span>
            <span class="n">dspI</span> <span class="o">=</span> <span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span>
            <span class="n">ellI</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetEllipse</span><span class="p">(</span><span class="n">dspI</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>           <span class="c">#=False if dsp didn&#39;t yield an ellipse (ugh! a parabola or a hyperbola)</span>
            <span class="n">dspO</span> <span class="o">=</span> <span class="n">wave</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">sind</span><span class="p">(</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span>
            <span class="n">ellO</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetEllipse</span><span class="p">(</span><span class="n">dspO</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>           <span class="c">#Ditto &amp; more likely for outer ellipse</span>
            <span class="n">Azm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">AzmthOff</span>
            <span class="k">if</span> <span class="n">ellI</span><span class="p">:</span>
                <span class="n">xyI</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">azm</span> <span class="ow">in</span> <span class="n">Azm</span><span class="p">:</span>
                    <span class="n">xyI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">GetDetectorXY</span><span class="p">(</span><span class="n">dspI</span><span class="p">,</span><span class="n">azm</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span><span class="n">Data</span><span class="p">))</span>
                <span class="n">xyI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyI</span><span class="p">)</span>
                <span class="n">arcxI</span><span class="p">,</span><span class="n">arcyI</span> <span class="o">=</span> <span class="n">xyI</span><span class="o">.</span><span class="n">T</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">arcxI</span><span class="p">,</span><span class="n">arcyI</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ellO</span><span class="p">:</span>
                <span class="n">xyO</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">azm</span> <span class="ow">in</span> <span class="n">Azm</span><span class="p">:</span>
                    <span class="n">xyO</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">GetDetectorXY</span><span class="p">(</span><span class="n">dspO</span><span class="p">,</span><span class="n">azm</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span><span class="n">Data</span><span class="p">))</span>
                <span class="n">xyO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xyO</span><span class="p">)</span>
                <span class="n">arcxO</span><span class="p">,</span><span class="n">arcyO</span> <span class="o">=</span> <span class="n">xyO</span><span class="o">.</span><span class="n">T</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">arcxO</span><span class="p">,</span><span class="n">arcyO</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ellO</span> <span class="ow">and</span> <span class="n">ellI</span><span class="p">:</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">arcxI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">arcxO</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">arcyI</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">arcyO</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">arcxI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">arcxO</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],[</span><span class="n">arcyI</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">arcyO</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nazm</span><span class="p">):</span>
                <span class="n">cake</span> <span class="o">=</span> <span class="n">LRAzim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">delAzm</span><span class="o">-</span><span class="n">AzmthOff</span>
                <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;centerAzm&#39;</span><span class="p">]:</span>
                    <span class="n">cake</span> <span class="o">+=</span> <span class="n">delAzm</span><span class="o">/</span><span class="mf">2.</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">Azm</span><span class="p">,</span><span class="n">cake</span><span class="p">)</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">arcxI</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">arcxO</span><span class="p">[</span><span class="n">ind</span><span class="p">]],[</span><span class="n">arcyI</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">arcyO</span><span class="p">[</span><span class="n">ind</span><span class="p">]],</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;k&#39;</span><span class="p">,</span><span class="n">dashes</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
                    
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="s">&#39;Image Controls&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">xring</span><span class="p">,</span><span class="n">yring</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;ring&#39;</span><span class="p">]:</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xring</span><span class="p">,</span><span class="n">yring</span><span class="p">,</span><span class="s">&#39;r+&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;setRings&#39;</span><span class="p">]:</span>
    <span class="c">#            rings = np.concatenate((Data[&#39;rings&#39;]),axis=0)</span>
                <span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;rings&#39;</span><span class="p">]:</span>
                    <span class="n">xring</span><span class="p">,</span><span class="n">yring</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xring</span><span class="p">,</span><span class="n">yring</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">N</span><span class="o">%</span><span class="mi">6</span><span class="p">])</span>
                    <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>            
            <span class="k">for</span> <span class="n">ellipse</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;ellipses&#39;</span><span class="p">]:</span>
                <span class="n">cent</span><span class="p">,</span><span class="n">phi</span><span class="p">,[</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">],</span><span class="n">col</span> <span class="o">=</span> <span class="n">ellipse</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Ellipse</span><span class="p">([</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="mi">2</span><span class="o">*</span><span class="n">width</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">height</span><span class="p">,</span><span class="n">phi</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="n">col</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">))</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s">&#39;center&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PickId</span><span class="p">)</span> <span class="ow">in</span> <span class="s">&#39;Stress/Strain&#39;</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;plot stress/strain stuff&#39;</span>
            <span class="k">for</span> <span class="n">ring</span> <span class="ow">in</span> <span class="n">StrSta</span><span class="p">[</span><span class="s">&#39;d-zero&#39;</span><span class="p">]:</span>
                <span class="n">xring</span><span class="p">,</span><span class="n">yring</span> <span class="o">=</span> <span class="n">ring</span><span class="p">[</span><span class="s">&#39;ImxyObs&#39;</span><span class="p">]</span>
                <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xring</span><span class="p">,</span><span class="n">yring</span><span class="p">,</span><span class="s">&#39;r+&#39;</span><span class="p">)</span>
<span class="c">#                for xring,yring in ring[&#39;ImxyCalc&#39;].T:</span>
<span class="c">#                    Plot.add_artist(Polygon(ring[&#39;ImxyCalc&#39;].T,ec=&#39;b&#39;,fc=&#39;none&#39;))</span>
<span class="c">#                    Plot.plot(xring,yring)</span>
        <span class="c">#masks - mask lines numbered after integration limit lines</span>
        <span class="n">spots</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Points&#39;</span><span class="p">]</span>
        <span class="n">rings</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Rings&#39;</span><span class="p">]</span>
        <span class="n">arcs</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Arcs&#39;</span><span class="p">]</span>
        <span class="n">polygons</span> <span class="o">=</span> <span class="n">Masks</span><span class="p">[</span><span class="s">&#39;Polygons&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">spots</span><span class="p">:</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">Circle</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span><span class="n">radius</span><span class="o">=</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">fc</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="n">ec</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">ringList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iring</span><span class="p">,(</span><span class="n">tth</span><span class="p">,</span><span class="n">thick</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rings</span><span class="p">):</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">]</span>
            <span class="n">x1</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">makeIdealRing</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">GetEllipse</span><span class="p">(</span><span class="n">Dsp</span><span class="p">(</span><span class="n">tth</span><span class="o">+</span><span class="n">thick</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">wave</span><span class="p">),</span><span class="n">Data</span><span class="p">))),</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">x2</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">makeIdealRing</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">GetEllipse</span><span class="p">(</span><span class="n">Dsp</span><span class="p">(</span><span class="n">tth</span><span class="o">-</span><span class="n">thick</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">wave</span><span class="p">),</span><span class="n">Data</span><span class="p">))),</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">ringList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="n">iring</span><span class="p">,</span><span class="s">&#39;o&#39;</span><span class="p">])</span>            
            <span class="n">G2frame</span><span class="o">.</span><span class="n">ringList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="n">iring</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">])</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">arcList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iarc</span><span class="p">,(</span><span class="n">tth</span><span class="p">,</span><span class="n">azm</span><span class="p">,</span><span class="n">thick</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">arcs</span><span class="p">):</span>            
            <span class="n">wave</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;wavelength&#39;</span><span class="p">]</span>
            <span class="n">x1</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">makeIdealRing</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">GetEllipse</span><span class="p">(</span><span class="n">Dsp</span><span class="p">(</span><span class="n">tth</span><span class="o">+</span><span class="n">thick</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">wave</span><span class="p">),</span><span class="n">Data</span><span class="p">),</span><span class="n">azm</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">x2</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">makeIdealRing</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">GetEllipse</span><span class="p">(</span><span class="n">Dsp</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span><span class="n">tth</span><span class="o">-</span><span class="n">thick</span><span class="o">/</span><span class="mf">2.</span><span class="p">),</span><span class="n">wave</span><span class="p">),</span><span class="n">Data</span><span class="p">),</span><span class="n">azm</span><span class="p">)),</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">arcList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="n">iarc</span><span class="p">,</span><span class="s">&#39;o&#39;</span><span class="p">])</span>            
            <span class="n">G2frame</span><span class="o">.</span><span class="n">arcList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="n">iarc</span><span class="p">,</span><span class="s">&#39;i&#39;</span><span class="p">])</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">arcList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">y1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">y2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="n">iarc</span><span class="p">,</span><span class="s">&#39;l&#39;</span><span class="p">])</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">arcList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">x2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],[</span><span class="n">y1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">y2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span><span class="s">&#39;r&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span><span class="n">iarc</span><span class="p">,</span><span class="s">&#39;u&#39;</span><span class="p">])</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">polyList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ipoly</span><span class="p">,</span><span class="n">polygon</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polygons</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">polygon</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">polyList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;r+&#39;</span><span class="p">,</span><span class="n">picker</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span><span class="n">ipoly</span><span class="p">])</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>            
        <span class="k">if</span> <span class="n">newImage</span><span class="p">:</span>
            <span class="n">colorBar</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">Img</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span> <span class="ow">and</span> <span class="n">xylim</span><span class="p">:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
        
<span class="c">################################################################################</span>
<span class="c">##### PlotIntegration</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotIntegration"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotIntegration">[docs]</a><span class="k">def</span> <span class="nf">PlotIntegration</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Plot of 2D image after image integration with 2-theta and azimuth as coordinates</span>
<span class="sd">    &#39;&#39;&#39;</span>
            
    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CROSS_CURSOR</span><span class="p">)</span>
        <span class="n">azm</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
        <span class="n">tth</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="k">if</span> <span class="n">azm</span> <span class="ow">and</span> <span class="n">tth</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">(</span>\
                <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Detector 2-th =</span><span class="si">%9.3f</span><span class="s">deg, azm = </span><span class="si">%7.2f</span><span class="s">deg&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tth</span><span class="p">,</span><span class="n">azm</span><span class="p">)])</span>
                                
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;2D Integration&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get previous plot &amp; get limits</span>
            <span class="n">xylim</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get a fresh plot after clf()</span>
        
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;2D Integration&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;2D Integration&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
        
    <span class="n">Data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="s">&#39;Image Controls&#39;</span><span class="p">))</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Integrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">xsc</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Integrate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ysc</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">Integrate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">Imin</span><span class="p">,</span><span class="n">Imax</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">acolor</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">])</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">)[</span><span class="mi">4</span><span class="p">:])</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;azimuth&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;2-theta&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">Img</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">acolor</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">Imin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">Imax</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;nearest&#39;</span><span class="p">,</span> \
        <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">ysc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ysc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">xsc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">xsc</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">aspect</span><span class="o">=</span><span class="s">&#39;auto&#39;</span><span class="p">)</span>
    <span class="n">colorBar</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">Img</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;ellipses&#39;</span><span class="p">]:</span>            
        <span class="k">for</span> <span class="n">ellipse</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;ellipses&#39;</span><span class="p">]:</span>
            <span class="n">ring</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">makeIdealRing</span><span class="p">(</span><span class="n">ellipse</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span> <span class="c">#skip color</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">tth</span><span class="p">,</span><span class="n">azm</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTthAzm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>
<span class="c">#            azm = np.where(azm &lt; 0.,azm+360,azm)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tth</span><span class="p">,</span><span class="n">azm</span><span class="p">,</span><span class="s">&#39;b,&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                
<span class="c">################################################################################</span>
<span class="c">##### PlotTRImage</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotTRImage"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotTRImage">[docs]</a><span class="k">def</span> <span class="nf">PlotTRImage</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">tax</span><span class="p">,</span><span class="n">tay</span><span class="p">,</span><span class="n">taz</span><span class="p">,</span><span class="n">newPlot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;a test plot routine - not normally used</span>
<span class="sd">    &#39;&#39;&#39;</span> 
            
    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CROSS_CURSOR</span><span class="p">)</span>
        <span class="n">azm</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="n">tth</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">ydata</span>
        <span class="k">if</span> <span class="n">azm</span> <span class="ow">and</span> <span class="n">tth</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetFields</span><span class="p">(</span>\
                <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;Detector 2-th =</span><span class="si">%9.3f</span><span class="s">deg, azm = </span><span class="si">%7.2f</span><span class="s">deg&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">tth</span><span class="p">,</span><span class="n">azm</span><span class="p">)])</span>
                                
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;2D Transformed Powder Image&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get previous plot &amp; get limits</span>
            <span class="n">xylim</span> <span class="o">=</span> <span class="n">Plot</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">(),</span><span class="n">Plot</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>          <span class="c">#get a fresh plot after clf()</span>
        
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addMpl</span><span class="p">(</span><span class="s">&#39;2D Transformed Powder Image&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;2D Transformed Powder Image&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">OnMotion</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
        
    <span class="n">Data</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemPyData</span><span class="p">(</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">GetPatternTreeItemId</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="s">&#39;Image Controls&#39;</span><span class="p">))</span>
    <span class="n">Imin</span><span class="p">,</span><span class="n">Imax</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">step</span> <span class="o">=</span> <span class="p">(</span><span class="n">Imax</span><span class="o">-</span><span class="n">Imin</span><span class="p">)</span><span class="o">/</span><span class="mf">5.</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Imin</span><span class="p">,</span><span class="n">Imax</span><span class="p">,</span><span class="n">step</span><span class="p">)</span>
    <span class="n">acolor</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">])</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">PatternTree</span><span class="o">.</span><span class="n">GetItemText</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">Image</span><span class="p">)[</span><span class="mi">4</span><span class="p">:])</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;azimuth&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;2-theta&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">Plot</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">tax</span><span class="p">,</span><span class="n">tay</span><span class="p">,</span><span class="n">taz</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">acolor</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;showLines&#39;</span><span class="p">]:</span>
        <span class="n">IOtth</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;IOtth&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;fullIntegrate&#39;</span><span class="p">]:</span>
            <span class="n">LRAzim</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">180</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LRAzim</span> <span class="o">=</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;LRazimuth&#39;</span><span class="p">]</span>                  <span class="c">#NB: integers</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">picker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">picker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;fullIntegrate&#39;</span><span class="p">]:</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">picker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">LRAzim</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">IOtth</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span><span class="n">picker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;setRings&#39;</span><span class="p">]:</span>
        <span class="n">rings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Data</span><span class="p">[</span><span class="s">&#39;rings&#39;</span><span class="p">]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">xring</span><span class="p">,</span><span class="n">yring</span><span class="p">,</span><span class="n">dsp</span> <span class="ow">in</span> <span class="n">rings</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTthAzm</span><span class="p">(</span><span class="n">xring</span><span class="p">,</span><span class="n">yring</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="s">&#39;r+&#39;</span><span class="p">)</span>            
    <span class="k">if</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;ellipses&#39;</span><span class="p">]:</span>            
        <span class="k">for</span> <span class="n">ellipse</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">[</span><span class="s">&#39;ellipses&#39;</span><span class="p">]:</span>
            <span class="n">ring</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G2img</span><span class="o">.</span><span class="n">makeIdealRing</span><span class="p">(</span><span class="n">ellipse</span><span class="p">[:</span><span class="mi">3</span><span class="p">]))</span> <span class="c">#skip color</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hsplit</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">tth</span><span class="p">,</span><span class="n">azm</span> <span class="o">=</span> <span class="n">G2img</span><span class="o">.</span><span class="n">GetTthAzm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">Data</span><span class="p">)</span>
            <span class="n">Plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">azm</span><span class="p">,</span><span class="n">tth</span><span class="p">,</span><span class="s">&#39;b,&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">newPlot</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Plot</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">xylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xylim</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">push_current</span><span class="p">()</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
        
<span class="c">################################################################################</span>
<span class="c">##### PlotStructure</span>
<span class="c">################################################################################</span>
            </div>
<div class="viewcode-block" id="PlotStructure"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotStructure">[docs]</a><span class="k">def</span> <span class="nf">PlotStructure</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Crystal structure plotting package. Can show structures as balls, sticks, lines,</span>
<span class="sd">    thermal motion ellipsoids and polyhedra</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">FindPeaksBonds</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
        <span class="n">rFact</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">][</span><span class="s">&#39;radiusFactor&#39;</span><span class="p">]</span>
        <span class="n">Bonds</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">XYZ</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
            <span class="n">Dx</span> <span class="o">=</span> <span class="n">XYZ</span><span class="o">-</span><span class="n">xyz</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Dx</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">IndB</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="n">rFact</span><span class="o">*</span><span class="mf">2.2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">IndB</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">Bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Dx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
                <span class="n">Bonds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">Dx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Bonds</span>

    <span class="n">ForthirdPI</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">3.0</span>
    <span class="n">generalData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span>
    <span class="n">Vol</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">7</span><span class="p">:</span><span class="mi">8</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Amat</span><span class="p">,</span><span class="n">Bmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2AB</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>         <span class="c">#Amat - crystal to cartesian, Bmat - inverse</span>
    <span class="n">Gmat</span><span class="p">,</span><span class="n">gmat</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2Gmat</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="n">A4mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Amat</span><span class="p">,[[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">B4mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">Bmat</span><span class="p">,[[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">SGData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>
    <span class="n">Mydir</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Mydir&#39;</span><span class="p">]</span>
    <span class="n">atomData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
    <span class="n">mapPeaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">drawingData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Drawing&#39;</span><span class="p">]</span>    
    <span class="k">if</span> <span class="s">&#39;Map Peaks&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">mapPeaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;Map Peaks&#39;</span><span class="p">])</span>
        <span class="n">peakMax</span> <span class="o">=</span> <span class="mf">100.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">):</span>
            <span class="n">peakMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mapPeaks</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">resRBData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Residue&#39;</span><span class="p">,[])</span>
    <span class="n">vecRBData</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;RBModels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Vector&#39;</span><span class="p">,[])</span>
    <span class="n">rbAtmDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">rbObj</span> <span class="ow">in</span> <span class="n">resRBData</span><span class="o">+</span><span class="n">vecRBData</span><span class="p">:</span>
        <span class="n">exclList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;X&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">]))]</span>
        <span class="n">rbAtmDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Ids&#39;</span><span class="p">],</span><span class="n">exclList</span><span class="p">)))</span>
    <span class="n">testRBObj</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;testRBObj&#39;</span><span class="p">,{})</span>
    <span class="n">rbObj</span> <span class="o">=</span> <span class="n">testRBObj</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;rbObj&#39;</span><span class="p">,{})</span>
    <span class="n">MCSA</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;MCSA&#39;</span><span class="p">,{})</span>
    <span class="n">mcsaModels</span> <span class="o">=</span> <span class="n">MCSA</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Models&#39;</span><span class="p">,[])</span>
    <span class="k">if</span> <span class="n">mcsaModels</span><span class="p">:</span>
        <span class="n">XYZs</span><span class="p">,</span><span class="n">Types</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateMCSAxyz</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">MCSA</span><span class="p">)</span>
        <span class="n">mcsaXYZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mcsaTypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span><span class="n">atyp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">XYZs</span><span class="p">,</span><span class="n">Types</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">GenAtom</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span><span class="n">SGData</span><span class="p">):</span>
                <span class="n">mcsaXYZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
                <span class="n">mcsaTypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atyp</span><span class="p">)</span>
        <span class="n">mcsaBonds</span> <span class="o">=</span> <span class="n">FindPeaksBonds</span><span class="p">(</span><span class="n">mcsaXYZ</span><span class="p">)</span>        
    <span class="n">drawAtoms</span> <span class="o">=</span> <span class="n">drawingData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Atoms&#39;</span><span class="p">,[])</span>
    <span class="n">mapData</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">flipData</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rhoXYZ</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">showBonds</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="s">&#39;Map&#39;</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
        <span class="n">mapData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span>
        <span class="n">showBonds</span> <span class="o">=</span> <span class="n">mapData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Show bonds&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;Flip&#39;</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
        <span class="n">flipData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Flip&#39;</span><span class="p">]</span>                        
        <span class="n">flipData</span><span class="p">[</span><span class="s">&#39;mapRoll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">])</span>
    <span class="n">Rd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Gr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">wxGreen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">Bl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">])</span>
    <span class="n">Or</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">wxOrange</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">uBox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">uEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">3</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">4</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> 
        <span class="p">[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">3</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">5</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">6</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">7</span><span class="p">]],</span> 
        <span class="p">[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">5</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">6</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">7</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">4</span><span class="p">]]])</span>
    <span class="n">mD</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">mV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="o">-</span><span class="n">mD</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="n">mD</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">mD</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">mD</span><span class="p">,</span><span class="mi">0</span><span class="p">]],[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">mD</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">mD</span><span class="p">]]])</span>
    <span class="n">mapPeakVecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">mV</span><span class="p">,</span><span class="n">Bmat</span><span class="p">)</span>

    <span class="n">uColors</span> <span class="o">=</span> <span class="p">[</span><span class="n">Rd</span><span class="p">,</span><span class="n">Gr</span><span class="p">,</span><span class="n">Bl</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span> <span class="n">Wt</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span> <span class="n">Wt</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span><span class="n">Wt</span><span class="p">]</span>
    <span class="n">altDown</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">shiftDown</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">ctrlDown</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">OnKeyBox</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">Image</span>
<span class="c">#        Draw()                          #make sure plot is fresh!!</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;jpeg&#39;</span><span class="p">,</span><span class="s">&#39;bmp&#39;</span><span class="p">,</span><span class="s">&#39;tiff&#39;</span><span class="p">,]:</span>
            <span class="n">Fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Mydir</span><span class="p">,</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.&#39;</span><span class="o">+</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()</span>
            <span class="n">glPixelStorei</span><span class="p">(</span><span class="n">GL_UNPACK_ALIGNMENT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;jpeg&#39;</span><span class="p">,]:</span>
                <span class="n">Pix</span> <span class="o">=</span> <span class="n">glReadPixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">GL_RGBA</span><span class="p">,</span> <span class="n">GL_UNSIGNED_BYTE</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;RGBA&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Pix</span> <span class="o">=</span> <span class="n">glReadPixels</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">GL_RGB</span><span class="p">,</span> <span class="n">GL_UNSIGNED_BYTE</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">im</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">Pix</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Fname</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39; save as/key:&#39;</span><span class="p">)</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Drawing saved to: &#39;</span><span class="o">+</span><span class="n">Fname</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39; save as/key:&#39;</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="n">OnKey</span><span class="p">,</span><span class="n">event</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span> <span class="c"># redirect the Focus from the button back to the plot</span>

    <span class="k">def</span> <span class="nf">OnKey</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>           <span class="c">#on key UP!!</span>
<span class="c">#        Draw()                          #make sure plot is fresh!!</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">keyCode</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetKeyCode</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">keyCode</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">:</span>
                <span class="n">keyCode</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">keyCode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>       <span class="c">#if from OnKeyBox above</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">indx</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;selectedAtoms&#39;</span><span class="p">]</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">]:</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">V0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">V0</span><span class="p">)</span>
            <span class="n">V</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">V</span><span class="o">*</span><span class="n">V0</span><span class="p">))</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AV2Q</span><span class="p">(</span><span class="n">A</span><span class="p">,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>
            <span class="n">SetViewPointText</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">SetViewDirText</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">])</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New quaternion: </span><span class="si">%.2f</span><span class="s">+, </span><span class="si">%.2f</span><span class="s">i+ ,</span><span class="si">%.2f</span><span class="s">j+, </span><span class="si">%.2f</span><span class="s">k&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;N&#39;</span><span class="p">]:</span>
            <span class="n">drawAtoms</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">drawAtoms</span><span class="p">):</span>      <span class="c">#no atoms</span>
                <span class="k">return</span>
            <span class="n">pI</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">pI</span><span class="p">):</span>
                <span class="n">pI</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
                <span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">pI</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="p">[</span><span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">pI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">pI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">):</span>
                    <span class="n">pI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="p">[</span><span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>                
                <span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drawAtoms</span><span class="p">):</span>
                    <span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span><span class="p">],</span><span class="n">pI</span><span class="p">]</span>
            <span class="n">SetViewPointText</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;View point at atom &#39;</span><span class="o">+</span><span class="n">drawAtoms</span><span class="p">[</span><span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pI</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;P&#39;</span><span class="p">]:</span>
            <span class="n">drawAtoms</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">drawAtoms</span><span class="p">):</span>      <span class="c">#no atoms</span>
                <span class="k">return</span>
            <span class="n">pI</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">pI</span><span class="p">):</span>
                <span class="n">pI</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">indx</span><span class="p">:</span>
                <span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">pI</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="p">[</span><span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">pI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">pI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pI</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indx</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="p">[</span><span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>                
                <span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">drawAtoms</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span><span class="p">],</span><span class="n">pI</span><span class="p">]</span>
            <span class="n">SetViewPointText</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>            
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;View point at atom &#39;</span><span class="o">+</span><span class="n">drawAtoms</span><span class="p">[</span><span class="n">pI</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pI</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;U&#39;</span><span class="p">,</span><span class="s">&#39;D&#39;</span><span class="p">,</span><span class="s">&#39;L&#39;</span><span class="p">,</span><span class="s">&#39;R&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;Flip&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">dirDict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;U&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;D&#39;</span><span class="p">:[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="s">&#39;L&#39;</span><span class="p">:[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="s">&#39;R&#39;</span><span class="p">:[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]}</span>
            <span class="n">SetMapRoll</span><span class="p">(</span><span class="n">dirDict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">SetPeakRoll</span><span class="p">(</span><span class="n">dirDict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">SetMapPeaksText</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">)</span>
        <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">GetTruePosition</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">Add</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">View</span> <span class="o">=</span> <span class="n">glGetIntegerv</span><span class="p">(</span><span class="n">GL_VIEWPORT</span><span class="p">)</span>
        <span class="n">Proj</span> <span class="o">=</span> <span class="n">glGetDoublev</span><span class="p">(</span><span class="n">GL_PROJECTION_MATRIX</span><span class="p">)</span>
        <span class="n">Model</span> <span class="o">=</span> <span class="n">glGetDoublev</span><span class="p">(</span><span class="n">GL_MODELVIEW_MATRIX</span><span class="p">)</span>
        <span class="n">Zmax</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">if</span> <span class="n">Add</span><span class="p">:</span>
            <span class="n">Indx</span> <span class="o">=</span> <span class="n">GetSelectedAtoms</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">getSelection</span><span class="p">())</span> <span class="o">==</span> <span class="s">&#39;Map peaks&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">peak</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">):</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
                <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">gluProject</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Model</span><span class="p">,</span><span class="n">Proj</span><span class="p">,</span><span class="n">View</span><span class="p">)</span>
                <span class="n">XY</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">View</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">Y</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">XY</span><span class="p">,</span><span class="n">atol</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Z</span> <span class="o">&lt;</span> <span class="n">Zmax</span><span class="p">:</span>
                    <span class="n">Zmax</span> <span class="o">=</span> <span class="n">Z</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">Indx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">ClearSelectedAtoms</span><span class="p">()</span>
                        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">Indx</span><span class="p">:</span>
                            <span class="n">SetSelectedAtoms</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">Add</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">SetSelectedAtoms</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">Add</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drawAtoms</span><span class="p">):</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Z</span> <span class="o">=</span> <span class="n">gluProject</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Model</span><span class="p">,</span><span class="n">Proj</span><span class="p">,</span><span class="n">View</span><span class="p">)</span>
                <span class="n">XY</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">X</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">View</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="n">Y</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="n">XY</span><span class="p">,</span><span class="n">atol</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Z</span> <span class="o">&lt;</span> <span class="n">Zmax</span><span class="p">:</span>
                    <span class="n">Zmax</span> <span class="o">=</span> <span class="n">Z</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">Indx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">ClearSelectedAtoms</span><span class="p">()</span>
                        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">Indx</span><span class="p">:</span>
                            <span class="n">SetSelectedAtoms</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span><span class="n">Add</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">SetSelectedAtoms</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">Add</span><span class="p">)</span>
                                       
    <span class="k">def</span> <span class="nf">OnMouseDown</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ShiftDown</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">LeftIsDown</span><span class="p">():</span>
                <span class="n">GetTruePosition</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">RightIsDown</span><span class="p">():</span>
                <span class="n">GetTruePosition</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnMouseMove</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ShiftDown</span><span class="p">():</span>           <span class="c">#don&#39;t want any inadvertant moves when picking</span>
            <span class="k">return</span>
        <span class="n">newxy</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
                                
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">Dragging</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">AltDown</span><span class="p">()</span> <span class="ow">and</span> <span class="n">rbObj</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">LeftIsDown</span><span class="p">():</span>
                    <span class="n">SetRBRotation</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New quaternion: </span><span class="si">%.2f</span><span class="s">+, </span><span class="si">%.2f</span><span class="s">i+ ,</span><span class="si">%.2f</span><span class="s">j+, </span><span class="si">%.2f</span><span class="s">k&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">RightIsDown</span><span class="p">():</span>
                    <span class="n">SetRBTranslation</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
                    <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New view point: </span><span class="si">%.4f</span><span class="s">, </span><span class="si">%.4f</span><span class="s">, </span><span class="si">%.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">MiddleIsDown</span><span class="p">():</span>
                    <span class="n">SetRBRotationZ</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New quaternion: </span><span class="si">%.2f</span><span class="s">+, </span><span class="si">%.2f</span><span class="s">i+ ,</span><span class="si">%.2f</span><span class="s">j+, </span><span class="si">%.2f</span><span class="s">k&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;move&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">ControlDown</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">LeftIsDown</span><span class="p">():</span>
                    <span class="n">SetRotation</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New quaternion: </span><span class="si">%.2f</span><span class="s">+, </span><span class="si">%.2f</span><span class="s">i+ ,</span><span class="si">%.2f</span><span class="s">j+, </span><span class="si">%.2f</span><span class="s">k&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">RightIsDown</span><span class="p">():</span>
                    <span class="n">SetTranslation</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
                    <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New view point: </span><span class="si">%.4f</span><span class="s">, </span><span class="si">%.4f</span><span class="s">, </span><span class="si">%.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">MiddleIsDown</span><span class="p">():</span>
                    <span class="n">SetRotationZ</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
                    <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
                    <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New quaternion: </span><span class="si">%.2f</span><span class="s">+, </span><span class="si">%.2f</span><span class="s">i+ ,</span><span class="si">%.2f</span><span class="s">j+, </span><span class="si">%.2f</span><span class="s">k&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;move&#39;</span><span class="p">)</span>
            
        
    <span class="k">def</span> <span class="nf">OnMouseWheel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">ShiftDown</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetWheelRotation</span><span class="p">()</span><span class="o">/</span><span class="mf">24.</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]))</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New camera distance: </span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Draw Options&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">cameraPosTxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;Camera Position: &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]))</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">cameraSlider</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">])</span>
            <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;wheel&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">getSelection</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;Select this from Phase data window!&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
            
    <span class="k">def</span> <span class="nf">SetViewPointText</span><span class="p">(</span><span class="n">VP</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Draw Options&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">viewPoint</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">VP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VP</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">VP</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                
    <span class="k">def</span> <span class="nf">SetRBOrigText</span><span class="p">():</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;RB Models&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">sizer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;Sizers&#39;</span><span class="p">][</span><span class="s">&#39;Xsizers&#39;</span><span class="p">]):</span>
                    <span class="n">sizer</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                    
    <span class="k">def</span> <span class="nf">SetRBOrienText</span><span class="p">():</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;RB Models&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">sizer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;Sizers&#39;</span><span class="p">][</span><span class="s">&#39;Osizers&#39;</span><span class="p">]):</span>
                    <span class="n">sizer</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;rbObj&#39;</span><span class="p">][</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span>
                
    <span class="k">def</span> <span class="nf">SetViewDirText</span><span class="p">(</span><span class="n">VD</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Draw Options&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">viewDir</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s"> </span><span class="si">%.3f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">VD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VD</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">VD</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                
    <span class="k">def</span> <span class="nf">SetMapPeaksText</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Map peaks&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">MapPeaksTable</span><span class="o">.</span><span class="n">SetData</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">)</span>
                <span class="n">panel</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">GetChildren</span><span class="p">()</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">GetName</span><span class="p">()</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">panel</span><span class="p">]</span>
                <span class="n">panel</span><span class="p">[</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;grid window&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">Refresh</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">ClearSelectedAtoms</span><span class="p">():</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Draw Atoms&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>      <span class="c">#this is the Atoms grid in Draw Atoms</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Map peaks&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>      <span class="c">#this is the Atoms grid in Atoms</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Atoms&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">ClearSelection</span><span class="p">()</span>      <span class="c">#this is the Atoms grid in Atoms</span>
                
                    
    <span class="k">def</span> <span class="nf">SetSelectedAtoms</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">Add</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Draw Atoms&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">Add</span><span class="p">)</span>      <span class="c">#this is the Atoms grid in Draw Atoms</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Map peaks&#39;</span><span class="p">:</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span><span class="n">Add</span><span class="p">)</span>                  
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Atoms&#39;</span><span class="p">:</span>
                <span class="n">Id</span> <span class="o">=</span> <span class="n">drawAtoms</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atomData</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">Id</span><span class="p">:</span>
                        <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">SelectRow</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>      <span class="c">#this is the Atoms grid in Atoms</span>
                  
    <span class="k">def</span> <span class="nf">GetSelectedAtoms</span><span class="p">():</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="n">Ind</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Draw Atoms&#39;</span><span class="p">:</span>
                <span class="n">Ind</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>      <span class="c">#this is the Atoms grid in Draw Atoms</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Map peaks&#39;</span><span class="p">:</span>
                <span class="n">Ind</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Atoms&#39;</span><span class="p">:</span>
                <span class="n">Ind</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">GetSelectedRows</span><span class="p">()</span>      <span class="c">#this is the Atoms grid in Atoms</span>
        <span class="k">return</span> <span class="n">Ind</span>
                                       
    <span class="k">def</span> <span class="nf">SetBackground</span><span class="p">():</span>
        <span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">A</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s">&#39;backColor&#39;</span><span class="p">]</span>
        <span class="n">glClearColor</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
        <span class="n">glClear</span><span class="p">(</span><span class="n">GL_COLOR_BUFFER_BIT</span> <span class="o">|</span> <span class="n">GL_DEPTH_BUFFER_BIT</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">SetLights</span><span class="p">():</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_DEPTH_TEST</span><span class="p">)</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_SMOOTH</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_LIGHTING</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_LIGHT0</span><span class="p">)</span>
        <span class="n">glLightModeli</span><span class="p">(</span><span class="n">GL_LIGHT_MODEL_TWO_SIDE</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">glLightfv</span><span class="p">(</span><span class="n">GL_LIGHT0</span><span class="p">,</span><span class="n">GL_AMBIENT</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">glLightfv</span><span class="p">(</span><span class="n">GL_LIGHT0</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">GetRoll</span><span class="p">(</span><span class="n">newxy</span><span class="p">,</span><span class="n">rho</span><span class="p">):</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">invQ</span><span class="p">(</span><span class="n">Q</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">newxy</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">,]))</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dxy</span><span class="o">*</span><span class="n">rho</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>        
        <span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dxy</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dxy</span><span class="o">&lt;-.</span><span class="mi">5</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">roll</span>
                
    <span class="k">def</span> <span class="nf">SetMapRoll</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">GetRoll</span><span class="p">(</span><span class="n">newxy</span><span class="p">,</span><span class="n">rho</span><span class="p">)</span>
        <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span><span class="n">roll</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">roll</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">roll</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">SetPeakRoll</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]</span>
        <span class="n">roll</span> <span class="o">=</span> <span class="n">GetRoll</span><span class="p">(</span><span class="n">newxy</span><span class="p">,</span><span class="n">rho</span><span class="p">)</span>
        <span class="n">steps</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rho</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">roll</span><span class="o">*</span><span class="n">steps</span>
        <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">mapPeaks</span><span class="p">:</span>
            <span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dxy</span>
            <span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">%=</span> <span class="mf">1.</span>
            <span class="n">peak</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">peak</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                
    <span class="k">def</span> <span class="nf">SetTranslation</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>
<span class="c">#first get translation vector in screen coords.       </span>
        <span class="n">oldxy</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldxy</span><span class="p">):</span> <span class="n">oldxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">newxy</span><span class="o">-</span><span class="n">oldxy</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.</span><span class="p">])</span>
<span class="c">#then transform to rotated crystal coordinates &amp; apply to view point        </span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">invQ</span><span class="p">(</span><span class="n">Q</span><span class="p">),</span><span class="n">V</span><span class="p">))</span>
        <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Tx</span> <span class="o">+=</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span>
        <span class="n">Ty</span> <span class="o">+=</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span>
        <span class="n">Tz</span> <span class="o">+=</span> <span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span>
        <span class="n">SetViewPointText</span><span class="p">([</span><span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span><span class="p">])</span>
        
    <span class="k">def</span> <span class="nf">SetRBTranslation</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>
<span class="c">#first get translation vector in screen coords.       </span>
        <span class="n">oldxy</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldxy</span><span class="p">):</span> <span class="n">oldxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">newxy</span><span class="o">-</span><span class="n">oldxy</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mf">0.</span><span class="p">])</span>
<span class="c">#then transform to rotated crystal coordinates &amp; apply to RB origin        </span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">invQ</span><span class="p">(</span><span class="n">Q</span><span class="p">),</span><span class="n">V</span><span class="p">))</span>
        <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">Tx</span> <span class="o">-=</span> <span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span>
        <span class="n">Ty</span> <span class="o">-=</span> <span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span>
        <span class="n">Tz</span> <span class="o">-=</span> <span class="n">V</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">0.01</span>
        <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orig&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span>
        <span class="n">SetRBOrigText</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">SetRotation</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>
<span class="c">#first get rotation vector in screen coords. &amp; angle increment        </span>
        <span class="n">oldxy</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldxy</span><span class="p">):</span> <span class="n">oldxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">newxy</span><span class="o">-</span><span class="n">oldxy</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.</span><span class="p">])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c"># next transform vector back to xtal coordinates via inverse quaternion</span>
<span class="c"># &amp; make new quaternion</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">invQ</span><span class="p">(</span><span class="n">Q</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">V</span><span class="p">))</span>
        <span class="n">DQ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">DQ</span><span class="p">)</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>
<span class="c"># finally get new view vector - last row of rotation matrix</span>
        <span class="n">VD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">G2mth</span><span class="o">.</span><span class="n">Q2Mat</span><span class="p">(</span><span class="n">Q</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">VD</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">VD</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VD</span>
        <span class="n">SetViewDirText</span><span class="p">(</span><span class="n">VD</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">SetRotationZ</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>                        
<span class="c">#first get rotation vector (= view vector) in screen coords. &amp; angle increment        </span>
        <span class="n">View</span> <span class="o">=</span> <span class="n">glGetIntegerv</span><span class="p">(</span><span class="n">GL_VIEWPORT</span><span class="p">)</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">View</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">View</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">oldxy</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldxy</span><span class="p">):</span> <span class="n">oldxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">newxy</span><span class="o">-</span><span class="n">oldxy</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*.</span><span class="mi">25</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*.</span><span class="mi">25</span>
        <span class="k">if</span> <span class="n">newxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">newxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>        
<span class="c"># next transform vector back to xtal coordinates &amp; make new quaternion</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Qx</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Qy</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Qx</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Qy</span><span class="p">)</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>

    <span class="k">def</span> <span class="nf">SetRBRotation</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>
<span class="c">#first get rotation vector in screen coords. &amp; angle increment        </span>
        <span class="n">oldxy</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldxy</span><span class="p">):</span> <span class="n">oldxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">newxy</span><span class="o">-</span><span class="n">oldxy</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.</span><span class="p">])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c"># next transform vector back to xtal coordinates via inverse quaternion</span>
<span class="c"># &amp; make new quaternion</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>              <span class="c">#rotate RB to Cart</span>
        <span class="n">QC</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>      <span class="c">#rotate Cart to drawing</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">invQ</span><span class="p">(</span><span class="n">QC</span><span class="p">),</span><span class="n">V</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">invQ</span><span class="p">(</span><span class="n">Q</span><span class="p">),</span><span class="n">V</span><span class="p">)</span>
        <span class="n">DQ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">DQ</span><span class="p">)</span>
        <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>
        <span class="n">SetRBOrienText</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">SetRBRotationZ</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>                        
<span class="c">#first get rotation vector (= view vector) in screen coords. &amp; angle increment        </span>
        <span class="n">View</span> <span class="o">=</span> <span class="n">glGetIntegerv</span><span class="p">(</span><span class="n">GL_VIEWPORT</span><span class="p">)</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">View</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">View</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">oldxy</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldxy</span><span class="p">):</span> <span class="n">oldxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">newxy</span><span class="o">-</span><span class="n">oldxy</span>
        <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*.</span><span class="mi">25</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*.</span><span class="mi">25</span>
        <span class="k">if</span> <span class="n">newxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">newxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>        
<span class="c"># next transform vector back to RB coordinates &amp; make new quaternion</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>              <span class="c">#rotate RB to cart</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="o">-</span><span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">invQ</span><span class="p">(</span><span class="n">Q</span><span class="p">),</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Qx</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Qy</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Qx</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Qy</span><span class="p">)</span>
        <span class="n">rbObj</span><span class="p">[</span><span class="s">&#39;Orient&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>
        <span class="n">SetRBOrienText</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">RenderBox</span><span class="p">():</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">glLineWidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_BLEND</span><span class="p">)</span>
        <span class="n">glBlendFunc</span><span class="p">(</span><span class="n">GL_SRC_ALPHA</span><span class="p">,</span><span class="n">GL_ONE_MINUS_SRC_ALPHA</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_LINE_SMOOTH</span><span class="p">)</span>
        <span class="n">glBegin</span><span class="p">(</span><span class="n">GL_LINES</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uEdges</span><span class="p">,</span><span class="n">uColors</span><span class="p">):</span>
            <span class="n">glColor3ubv</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">glEnd</span><span class="p">()</span>
        <span class="n">glColor4ubv</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_LINE_SMOOTH</span><span class="p">)</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_BLEND</span><span class="p">)</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">RenderUnitVectors</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">glLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glScalef</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="o">/</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="o">/</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">glBegin</span><span class="p">(</span><span class="n">GL_LINES</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uEdges</span><span class="p">,</span><span class="n">uColors</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">glColor3ubv</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
        <span class="n">glEnd</span><span class="p">()</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">glColor4ubv</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">RenderSphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">color</span><span class="p">):</span>
        <span class="n">glMaterialfv</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">B4mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">gluNewQuadric</span><span class="p">()</span>
        <span class="n">gluSphere</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">RenderDots</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">RC</span><span class="p">):</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">xyz</span><span class="p">,</span><span class="n">rc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">RC</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">rc</span>
            <span class="n">glColor3ubv</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">glPointSize</span><span class="p">(</span><span class="n">r</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">glBegin</span><span class="p">(</span><span class="n">GL_POINTS</span><span class="p">)</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
            <span class="n">glEnd</span><span class="p">()</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">glColor4ubv</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">RenderSmallSphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">color</span><span class="p">):</span>
        <span class="n">glMaterialfv</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">B4mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">gluNewQuadric</span><span class="p">()</span>
        <span class="n">gluSphere</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">RenderEllipsoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">ellipseProb</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">R4</span><span class="p">,</span><span class="n">color</span><span class="p">):</span>
        <span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span> <span class="o">=</span> <span class="n">E</span>
        <span class="n">glMaterialfv</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">B4mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">R4</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_NORMALIZE</span><span class="p">)</span>
        <span class="n">glScale</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">gluNewQuadric</span><span class="p">()</span>
        <span class="n">gluSphere</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">ellipseProb</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_NORMALIZE</span><span class="p">)</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">RenderBonds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Bonds</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="nb">slice</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">glMaterialfv</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">B4mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">Bonds</span><span class="p">:</span>
            <span class="n">glPushMatrix</span><span class="p">()</span>
            <span class="n">Dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">bond</span><span class="p">)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">Z</span><span class="p">:</span>
                <span class="n">azm</span> <span class="o">=</span> <span class="n">atan2d</span><span class="p">(</span><span class="o">-</span><span class="n">Dx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="n">Dx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="n">acosd</span><span class="p">(</span><span class="n">Dx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Z</span><span class="p">)</span>
                <span class="n">glRotate</span><span class="p">(</span><span class="o">-</span><span class="n">azm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">glRotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">gluNewQuadric</span><span class="p">()</span>
                <span class="n">gluCylinder</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="nb">slice</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">glPopMatrix</span><span class="p">()</span>            
        <span class="n">glPopMatrix</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">RenderLines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Bonds</span><span class="p">,</span><span class="n">color</span><span class="p">):</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_FLAT</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">glLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">glColor3fv</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glBegin</span><span class="p">(</span><span class="n">GL_LINES</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">Bonds</span><span class="p">:</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">xyz</span><span class="o">+</span><span class="n">bond</span><span class="p">)</span>
        <span class="n">glEnd</span><span class="p">()</span>
        <span class="n">glColor4ubv</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_SMOOTH</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">RenderPolyhedra</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Faces</span><span class="p">,</span><span class="n">color</span><span class="p">):</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_FLAT</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glMaterialfv</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_SMOOTH</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">B4mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">face</span><span class="p">,</span><span class="n">norm</span> <span class="ow">in</span> <span class="n">Faces</span><span class="p">:</span>
            <span class="n">glPolygonMode</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span><span class="n">GL_FILL</span><span class="p">)</span>
            <span class="n">glFrontFace</span><span class="p">(</span><span class="n">GL_CW</span><span class="p">)</span>
            <span class="n">glNormal3fv</span><span class="p">(</span><span class="n">norm</span><span class="p">)</span>
            <span class="n">glBegin</span><span class="p">(</span><span class="n">GL_TRIANGLES</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">vert</span> <span class="ow">in</span> <span class="n">face</span><span class="p">:</span>
                <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">vert</span><span class="p">)</span>
            <span class="n">glEnd</span><span class="p">()</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_SMOOTH</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RenderMapPeak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">den</span><span class="p">):</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_FLAT</span><span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">glLineWidth</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">glColor3fv</span><span class="p">(</span><span class="n">color</span><span class="o">*</span><span class="n">den</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glBegin</span><span class="p">(</span><span class="n">GL_LINES</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vec</span> <span class="ow">in</span> <span class="n">mapPeakVecs</span><span class="p">:</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">xyz</span><span class="p">)</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">xyz</span><span class="p">)</span>
        <span class="n">glEnd</span><span class="p">()</span>
        <span class="n">glColor4ubv</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_SMOOTH</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">RenderBackbone</span><span class="p">(</span><span class="n">Backbone</span><span class="p">,</span><span class="n">BackboneColor</span><span class="p">,</span><span class="n">radius</span><span class="p">):</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">B4mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_SMOOTH</span><span class="p">)</span>
        <span class="n">gleSetJoinStyle</span><span class="p">(</span><span class="n">TUBE_NORM_EDGE</span> <span class="o">|</span> <span class="n">TUBE_JN_ANGLE</span> <span class="o">|</span> <span class="n">TUBE_JN_CAP</span><span class="p">)</span>
        <span class="n">glePolyCylinder</span><span class="p">(</span><span class="n">Backbone</span><span class="p">,</span><span class="n">BackboneColor</span><span class="p">,</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>        
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">matRot</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        color wx.Color object</span>
<span class="sd">        &#39;&#39;&#39;</span>       
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">B4mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_LIGHTING</span><span class="p">)</span>
        <span class="n">glRasterPos3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">matRot</span><span class="p">)</span>
        <span class="n">glRotate</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>             <span class="c">#fix to flip about x-axis</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">gltext</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="n">Font</span><span class="p">,</span><span class="n">foreground</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.025</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_LIGHTING</span><span class="p">)</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">RenderMap</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span><span class="n">rhoXYZ</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">Rok</span><span class="p">):</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_FLAT</span><span class="p">)</span>
        <span class="n">cLevel</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]</span>
        <span class="n">XYZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">RC</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rhoXYZ</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Rok</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">xyz</span>
                <span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span> <span class="o">=</span> <span class="n">indx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">if</span> <span class="n">cLevel</span> <span class="o">&lt;</span> <span class="mf">1.</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rho</span><span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">])</span><span class="o">/</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rhoMax&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">cLevel</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">cLevel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rho</span><span class="p">[</span><span class="n">I</span><span class="p">,</span><span class="n">J</span><span class="p">,</span><span class="n">K</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">XYZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
                    <span class="n">RC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.1</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span><span class="n">Rd</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">XYZ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
                    <span class="n">RC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.1</span><span class="o">*</span><span class="n">alpha</span><span class="p">,</span><span class="n">Gr</span><span class="p">])</span>
        <span class="n">RenderDots</span><span class="p">(</span><span class="n">XYZ</span><span class="p">,</span><span class="n">RC</span><span class="p">)</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_SMOOTH</span><span class="p">)</span>
                            
    <span class="k">def</span> <span class="nf">Draw</span><span class="p">(</span><span class="n">caller</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
<span class="c">#useful debug?        </span>
<span class="c">#        if caller:</span>
<span class="c">#            print caller</span>
<span class="c"># end of useful debug</span>
        <span class="n">mapData</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Map&#39;</span><span class="p">]</span>
        <span class="n">pageName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="n">getSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">page</span><span class="p">:</span>
            <span class="n">pageName</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
        <span class="n">rhoXYZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]):</span>
            <span class="n">VP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">contLevel</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;contourLevel&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rhoMax&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s">&#39;delt-F&#39;</span> <span class="ow">in</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;MapType&#39;</span><span class="p">]:</span>
                <span class="n">rho</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">],</span><span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">])</span><span class="o">&lt;</span><span class="n">contLevel</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rho</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">],</span><span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">mapData</span><span class="p">[</span><span class="s">&#39;rho&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">contLevel</span><span class="p">))</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rho</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">incre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">VP</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">,</span><span class="n">VP</span><span class="o">%</span><span class="n">steps</span><span class="p">,</span><span class="n">VP</span><span class="o">%</span><span class="n">steps</span><span class="o">-</span><span class="n">steps</span><span class="p">)</span>
            <span class="n">Vsteps</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">VP</span><span class="o">/</span><span class="n">steps</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s">&#39;i&#39;</span><span class="p">)</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span><span class="n">Vsteps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span><span class="n">Vsteps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="n">Vsteps</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">rho</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">rhoXYZ</span> <span class="o">=</span> <span class="n">indx</span><span class="o">*</span><span class="n">steps</span><span class="o">+</span><span class="n">VP</span><span class="o">-</span><span class="n">incre</span>
            <span class="n">Nc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhoXYZ</span><span class="p">)</span>
            <span class="n">rcube</span> <span class="o">=</span> <span class="mf">2000.</span><span class="o">*</span><span class="n">Vol</span><span class="o">/</span><span class="p">(</span><span class="n">ForthirdPI</span><span class="o">*</span><span class="n">Nc</span><span class="p">)</span>
            <span class="n">rmax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rcube</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;mapSize&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">rmax</span><span class="p">)</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">Rok</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">rhoXYZ</span><span class="o">-</span><span class="n">view</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="n">radius</span>
        <span class="n">Ind</span> <span class="o">=</span> <span class="n">GetSelectedAtoms</span><span class="p">()</span>
        <span class="n">VS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">GetSize</span><span class="p">())</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">VS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">VS</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cPos</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span>
        <span class="n">Zclip</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Zclip&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">cPos</span><span class="o">/</span><span class="mf">200.</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">Tx</span><span class="p">,</span><span class="n">Ty</span><span class="p">,</span><span class="n">Tz</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ci</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;atomPtrs&#39;</span><span class="p">]</span>
        <span class="n">bondR</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;bondRadius&#39;</span><span class="p">]</span>
        <span class="n">G</span><span class="p">,</span><span class="n">g</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">cell2Gmat</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">GS</span> <span class="o">=</span> <span class="n">G</span>
        <span class="n">GS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">GS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">GS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">GS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">GS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">GS</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">GS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">GS</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">GS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">GS</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">GS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">GS</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ellipseProb</span> <span class="o">=</span> <span class="n">G2lat</span><span class="o">.</span><span class="n">criticalEllipse</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ellipseProb&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
        
        <span class="n">SetBackground</span><span class="p">()</span>
        <span class="n">glInitNames</span><span class="p">()</span>
        <span class="n">glPushName</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL_PROJECTION</span><span class="p">)</span>
        <span class="n">glLoadIdentity</span><span class="p">()</span>
        <span class="n">glViewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">VS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VS</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">gluPerspective</span><span class="p">(</span><span class="mf">20.</span><span class="p">,</span><span class="n">aspect</span><span class="p">,</span><span class="n">cPos</span><span class="o">-</span><span class="n">Zclip</span><span class="p">,</span><span class="n">cPos</span><span class="o">+</span><span class="n">Zclip</span><span class="p">)</span>
        <span class="n">gluLookAt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cPos</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">SetLights</span><span class="p">()</span>            
            
        <span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL_MODELVIEW</span><span class="p">)</span>
        <span class="n">glLoadIdentity</span><span class="p">()</span>
        <span class="n">matRot</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">Q2Mat</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">matRot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">matRot</span><span class="p">,[[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">matRot</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">A4mat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="o">-</span><span class="n">Tx</span><span class="p">,</span><span class="o">-</span><span class="n">Ty</span><span class="p">,</span><span class="o">-</span><span class="n">Tz</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;unitCellBox&#39;</span><span class="p">]:</span>
            <span class="n">RenderBox</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showABC&#39;</span><span class="p">]:</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">RenderUnitVectors</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">Backbones</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">BackboneColor</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c">#        glEnable(GL_BLEND)</span>
<span class="c">#        glBlendFunc(GL_SRC_ALPHA,GL_ONE_MINUS_SRC_ALPHA)</span>
        <span class="k">for</span> <span class="n">iat</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]):</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">Bonds</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">Faces</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atNum</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">atNum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">CL</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">atColor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">CL</span><span class="p">)</span><span class="o">/</span><span class="mf">255.</span>
            <span class="k">if</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showRigidBodies&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">atom</span><span class="p">[</span><span class="n">ci</span><span class="p">]</span> <span class="ow">in</span> <span class="n">rbAtmDict</span><span class="p">:</span>
                <span class="n">bndColor</span> <span class="o">=</span> <span class="n">Or</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bndColor</span> <span class="o">=</span> <span class="n">atColor</span>
            <span class="k">if</span> <span class="n">iat</span> <span class="ow">in</span> <span class="n">Ind</span> <span class="ow">and</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">dataDisplay</span><span class="o">.</span><span class="n">GetPageText</span><span class="p">(</span><span class="n">getSelection</span><span class="p">())</span> <span class="o">!=</span> <span class="s">&#39;Map peaks&#39;</span><span class="p">:</span>
                <span class="n">atColor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Gr</span><span class="p">)</span><span class="o">/</span><span class="mf">255.</span>
<span class="c">#            color += [.25,]</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">glLoadName</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span> <span class="c">#problem with old files - missing code</span>
                    <span class="k">pass</span>                    
            <span class="k">if</span> <span class="s">&#39;balls&#39;</span> <span class="ow">in</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]:</span>
                <span class="n">vdwScale</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;vdwScale&#39;</span><span class="p">]</span>
                <span class="n">ballScale</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;ballScale&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atNum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.2</span>
                <span class="k">elif</span> <span class="s">&#39;H&#39;</span> <span class="o">==</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showHydrogen&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s">&#39;vdW&#39;</span> <span class="ow">in</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="ow">and</span> <span class="n">atNum</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">radius</span> <span class="o">=</span> <span class="n">vdwScale</span><span class="o">*</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;vdWRadii&#39;</span><span class="p">][</span><span class="n">atNum</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">radius</span> <span class="o">=</span> <span class="n">ballScale</span><span class="o">*</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;sizeH&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s">&#39;vdW&#39;</span> <span class="ow">in</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]:</span>
                        <span class="n">radius</span> <span class="o">=</span> <span class="n">vdwScale</span><span class="o">*</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;vdWRadii&#39;</span><span class="p">][</span><span class="n">atNum</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">radius</span> <span class="o">=</span> <span class="n">ballScale</span><span class="o">*</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;BondRadii&#39;</span><span class="p">][</span><span class="n">atNum</span><span class="p">]</span>
                <span class="n">RenderSphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">atColor</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;sticks&#39;</span> <span class="ow">in</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]:</span>
                    <span class="n">RenderBonds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Bonds</span><span class="p">,</span><span class="n">bondR</span><span class="p">,</span><span class="n">bndColor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s">&#39;ellipsoids&#39;</span> <span class="ow">in</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]:</span>
                <span class="n">RenderBonds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Bonds</span><span class="p">,</span><span class="n">bondR</span><span class="p">,</span><span class="n">bndColor</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>                    
                    <span class="n">Uij</span> <span class="o">=</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">5</span><span class="p">:</span><span class="n">cs</span><span class="o">+</span><span class="mi">11</span><span class="p">]</span>
                    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">G2spc</span><span class="o">.</span><span class="n">Uij2U</span><span class="p">(</span><span class="n">Uij</span><span class="p">),</span><span class="n">GS</span><span class="p">)</span>
                    <span class="n">U</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">U</span><span class="p">,</span><span class="n">Amat</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">E</span><span class="p">,</span><span class="n">R</span> <span class="o">=</span> <span class="n">nl</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
                    <span class="n">R4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">R</span><span class="p">,[[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;H&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showHydrogen&#39;</span><span class="p">]:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">RenderEllipsoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">ellipseProb</span><span class="p">,</span><span class="n">E</span><span class="p">,</span><span class="n">R4</span><span class="p">,</span><span class="n">atColor</span><span class="p">)</span>                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;H&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;showHydrogen&#39;</span><span class="p">]:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">radius</span> <span class="o">=</span> <span class="n">ellipseProb</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">4</span><span class="p">]))</span>
                        <span class="n">RenderSphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">atColor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s">&#39;lines&#39;</span> <span class="ow">in</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">RenderLines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Bonds</span><span class="p">,</span><span class="n">bndColor</span><span class="p">)</span>
<span class="c">#                RenderBonds(x,y,z,Bonds,0.05,color,6)</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;sticks&#39;</span><span class="p">:</span>
                <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">RenderBonds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Bonds</span><span class="p">,</span><span class="n">bondR</span><span class="p">,</span><span class="n">bndColor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;polyhedra&#39;</span><span class="p">:</span>
                <span class="n">RenderPolyhedra</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Faces</span><span class="p">,</span><span class="n">atColor</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;backbone&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;N&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Backbones</span><span class="p">:</span>
                        <span class="n">Backbones</span><span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">Backbones</span><span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]))))</span>
                    <span class="n">BackboneColor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">atColor</span><span class="p">))</span>
                    
            <span class="k">if</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;type&#39;</span><span class="p">:</span>
                <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="p">],</span><span class="n">radius</span><span class="p">,</span><span class="n">wxGreen</span><span class="p">,</span><span class="n">matRot</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;name&#39;</span><span class="p">:</span>
                <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">radius</span><span class="p">,</span><span class="n">wxGreen</span><span class="p">,</span><span class="n">matRot</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;number&#39;</span><span class="p">:</span>
                <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iat</span><span class="p">),</span><span class="n">radius</span><span class="p">,</span><span class="n">wxGreen</span><span class="p">,</span><span class="n">matRot</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;residue&#39;</span> <span class="ow">and</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CA&#39;</span><span class="p">:</span>
                <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span><span class="n">radius</span><span class="p">,</span><span class="n">wxGreen</span><span class="p">,</span><span class="n">matRot</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;1-letter&#39;</span> <span class="ow">and</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CA&#39;</span><span class="p">:</span>
                <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span><span class="n">radius</span><span class="p">,</span><span class="n">wxGreen</span><span class="p">,</span><span class="n">matRot</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;chain&#39;</span> <span class="ow">and</span> <span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CA&#39;</span><span class="p">:</span>
                <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span><span class="n">radius</span><span class="p">,</span><span class="n">wxGreen</span><span class="p">,</span><span class="n">matRot</span><span class="p">)</span>
<span class="c">#        glDisable(GL_BLEND)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhoXYZ</span><span class="p">):</span>
            <span class="n">RenderMap</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span><span class="n">rhoXYZ</span><span class="p">,</span><span class="n">indx</span><span class="p">,</span><span class="n">Rok</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">):</span>
            <span class="n">XYZ</span> <span class="o">=</span> <span class="n">mapPeaks</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
            <span class="n">mapBonds</span> <span class="o">=</span> <span class="n">FindPeaksBonds</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,[</span><span class="n">mag</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mapPeaks</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">Ind</span> <span class="ow">and</span> <span class="n">pageName</span> <span class="o">==</span> <span class="s">&#39;Map peaks&#39;</span><span class="p">:</span>
                    <span class="n">RenderMapPeak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Gr</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">RenderMapPeak</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Wt</span><span class="p">,</span><span class="n">mag</span><span class="o">/</span><span class="n">peakMax</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">showBonds</span><span class="p">:</span>
                    <span class="n">RenderLines</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">mapBonds</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="n">Wt</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">testRBObj</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pageName</span> <span class="o">==</span> <span class="s">&#39;RB Models&#39;</span><span class="p">:</span>
            <span class="n">XYZ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">UpdateRBXYZ</span><span class="p">(</span><span class="n">Bmat</span><span class="p">,</span><span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;rbObj&#39;</span><span class="p">],</span><span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;rbData&#39;</span><span class="p">],</span><span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;rbType&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rbBonds</span> <span class="o">=</span> <span class="n">FindPeaksBonds</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
                <span class="n">aType</span> <span class="o">=</span> <span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;rbAtTypes&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">aType</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">testRBObj</span><span class="p">[</span><span class="s">&#39;AtInfo&#39;</span><span class="p">][</span><span class="n">aType</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">RenderSphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="n">color</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
                <span class="n">RenderBonds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">rbBonds</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="mf">0.03</span><span class="p">,</span><span class="n">Gr</span><span class="p">)</span>
                <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="n">wxOrange</span><span class="p">,</span><span class="n">matRot</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mcsaModels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pageName</span> <span class="o">==</span> <span class="s">&#39;MC/SA&#39;</span><span class="p">:</span>             <span class="c">#skip the default MD entry</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mcsaXYZ</span><span class="p">):</span>
                <span class="n">aType</span> <span class="o">=</span> <span class="n">mcsaTypes</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">aType</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">MCSA</span><span class="p">[</span><span class="s">&#39;AtInfo&#39;</span><span class="p">][</span><span class="n">aType</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">RenderSphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="n">color</span><span class="o">/</span><span class="mf">255.</span><span class="p">)</span>
                <span class="n">RenderBonds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">mcsaBonds</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="mf">0.03</span><span class="p">,</span><span class="n">Gr</span><span class="p">)</span>
                <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="n">wxOrange</span><span class="p">,</span><span class="n">matRot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Backbones</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">Backbones</span><span class="p">:</span>
                <span class="n">Backbone</span> <span class="o">=</span> <span class="n">Backbones</span><span class="p">[</span><span class="n">chain</span><span class="p">]</span>
                <span class="n">RenderBackbone</span><span class="p">(</span><span class="n">Backbone</span><span class="p">,</span><span class="n">BackboneColor</span><span class="p">,</span><span class="n">bondR</span><span class="p">)</span>
<span class="c">#        print time.time()-time0</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SwapBuffers</span><span class="p">()</span>
       
    <span class="k">def</span> <span class="nf">OnSize</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;size&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnFocus</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>         <span class="c">#not needed?? Bind commented out below</span>
        <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;focus&#39;</span><span class="p">)</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">])</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>        
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addOgl</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">])</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Name&#39;</span><span class="p">])</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">altDown</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">Font</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">GetFont</span><span class="p">()</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">Choice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">mapData</span><span class="p">[</span><span class="s">&#39;Flip&#39;</span><span class="p">]:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; save as/key:&#39;</span><span class="p">,</span><span class="s">&#39;jpeg&#39;</span><span class="p">,</span><span class="s">&#39;tiff&#39;</span><span class="p">,</span><span class="s">&#39;bmp&#39;</span><span class="p">,</span><span class="s">&#39;c: center on 1/2,1/2,1/2&#39;</span><span class="p">,</span>
            <span class="s">&#39;u: roll up&#39;</span><span class="p">,</span><span class="s">&#39;d: roll down&#39;</span><span class="p">,</span><span class="s">&#39;l: roll left&#39;</span><span class="p">,</span><span class="s">&#39;r: roll right&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">choice</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; save as/key:&#39;</span><span class="p">,</span><span class="s">&#39;jpeg&#39;</span><span class="p">,</span><span class="s">&#39;tiff&#39;</span><span class="p">,</span><span class="s">&#39;bmp&#39;</span><span class="p">,</span><span class="s">&#39;c: center on 1/2,1/2,1/2&#39;</span><span class="p">,</span><span class="s">&#39;n: next&#39;</span><span class="p">,</span><span class="s">&#39;p: previous&#39;</span><span class="p">]</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span><span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_DROPDOWN</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="p">,</span><span class="n">choices</span><span class="o">=</span><span class="n">choice</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span> <span class="n">OnKeyBox</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="s">&#39; save as/key:&#39;</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MOUSEWHEEL</span><span class="p">,</span> <span class="n">OnMouseWheel</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_LEFT_DOWN</span><span class="p">,</span> <span class="n">OnMouseDown</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_RIGHT_DOWN</span><span class="p">,</span> <span class="n">OnMouseDown</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MIDDLE_DOWN</span><span class="p">,</span> <span class="n">OnMouseDown</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_KEY_UP</span><span class="p">,</span> <span class="n">OnKey</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MOTION</span><span class="p">,</span> <span class="n">OnMouseMove</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SIZE</span><span class="p">,</span> <span class="n">OnSize</span><span class="p">)</span>
<span class="c">#    Page.canvas.Bind(wx.EVT_SET_FOCUS, OnFocus)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">Amat</span><span class="p">,</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;viewPoint&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s">&#39;backColor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">drawingData</span><span class="p">[</span><span class="s">&#39;backColor&#39;</span><span class="p">])</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">,])</span><span class="o">/</span><span class="mf">255.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCurrent</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>
        
<span class="c">################################################################################</span>
<span class="c">#### Plot Rigid Body</span>
<span class="c">################################################################################</span>
</div>
<div class="viewcode-block" id="PlotRigidBody"><a class="viewcode-back" href="../GSASIIplot.html#GSASIIplot.PlotRigidBody">[docs]</a><span class="k">def</span> <span class="nf">PlotRigidBody</span><span class="p">(</span><span class="n">G2frame</span><span class="p">,</span><span class="n">rbType</span><span class="p">,</span><span class="n">AtInfo</span><span class="p">,</span><span class="n">rbData</span><span class="p">,</span><span class="n">defaults</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;RB plotting package. Can show rigid body structures as balls &amp; sticks</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">FindBonds</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
        <span class="n">rbTypes</span> <span class="o">=</span> <span class="n">rbData</span><span class="p">[</span><span class="s">&#39;rbTypes&#39;</span><span class="p">]</span>
        <span class="n">Radii</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">Atype</span> <span class="ow">in</span> <span class="n">rbTypes</span><span class="p">:</span>
            <span class="n">Radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AtInfo</span><span class="p">[</span><span class="n">Atype</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">Atype</span> <span class="o">==</span> <span class="s">&#39;H&#39;</span><span class="p">:</span>
                <span class="n">Radii</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">Radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Radii</span><span class="p">)</span>
        <span class="n">Bonds</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Radii</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
            <span class="n">Dx</span> <span class="o">=</span> <span class="n">XYZ</span><span class="o">-</span><span class="n">xyz</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dx</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">sumR</span> <span class="o">=</span> <span class="n">Radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">Radii</span>
            <span class="n">IndB</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_greater</span><span class="p">(</span><span class="n">dist</span><span class="o">-</span><span class="mf">0.85</span><span class="o">*</span><span class="n">sumR</span><span class="p">,</span><span class="mf">0.</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">IndB</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">Bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Dx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">Radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sumR</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">Bonds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">Dx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">Radii</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">sumR</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">Bonds</span>
                        
    <span class="n">Wt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">])</span>
    <span class="n">Rd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Gr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Bl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">])</span>
    <span class="n">uBox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">uEdges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">1</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">2</span><span class="p">]],[</span><span class="n">uBox</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">uBox</span><span class="p">[</span><span class="mi">3</span><span class="p">]]])</span>
    <span class="n">uColors</span> <span class="o">=</span> <span class="p">[</span><span class="n">Rd</span><span class="p">,</span><span class="n">Gr</span><span class="p">,</span><span class="n">Bl</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">rbType</span> <span class="o">==</span> <span class="s">&#39;Vector&#39;</span><span class="p">:</span>
        <span class="n">atNames</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">Ty</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">Ty</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rbData</span><span class="p">[</span><span class="s">&#39;rbTypes&#39;</span><span class="p">])]</span>
        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]</span> <span class="k">for</span> <span class="n">Ty</span> <span class="ow">in</span> <span class="n">rbData</span><span class="p">[</span><span class="s">&#39;rbTypes&#39;</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">imag</span><span class="p">,</span><span class="n">mag</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rbData</span><span class="p">[</span><span class="s">&#39;VectMag&#39;</span><span class="p">]):</span>
            <span class="n">XYZ</span> <span class="o">+=</span> <span class="n">mag</span><span class="o">*</span><span class="n">rbData</span><span class="p">[</span><span class="s">&#39;rbVect&#39;</span><span class="p">][</span><span class="n">imag</span><span class="p">]</span>
        <span class="n">Bonds</span> <span class="o">=</span> <span class="n">FindBonds</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rbType</span> <span class="o">==</span> <span class="s">&#39;Residue&#39;</span><span class="p">:</span>
<span class="c">#        atNames = [str(i)+&#39;:&#39;+Ty for i,Ty in enumerate(rbData[&#39;atNames&#39;])]</span>
        <span class="n">atNames</span> <span class="o">=</span> <span class="n">rbData</span><span class="p">[</span><span class="s">&#39;atNames&#39;</span><span class="p">]</span>
        <span class="n">XYZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rbData</span><span class="p">[</span><span class="s">&#39;rbXYZ&#39;</span><span class="p">])</span>      <span class="c">#don&#39;t mess with original!</span>
        <span class="n">Seq</span> <span class="o">=</span> <span class="n">rbData</span><span class="p">[</span><span class="s">&#39;rbSeq&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ia</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ang</span><span class="p">,</span><span class="n">mv</span> <span class="ow">in</span> <span class="n">Seq</span><span class="p">:</span>
            <span class="n">va</span> <span class="o">=</span> <span class="n">XYZ</span><span class="p">[</span><span class="n">ia</span><span class="p">]</span><span class="o">-</span><span class="n">XYZ</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">ang</span><span class="p">,</span><span class="n">va</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">mv</span><span class="p">:</span>
                <span class="n">vb</span> <span class="o">=</span> <span class="n">XYZ</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">-</span><span class="n">XYZ</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span>
                <span class="n">vb</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">vb</span><span class="p">)</span>
                <span class="n">XYZ</span><span class="p">[</span><span class="n">im</span><span class="p">]</span> <span class="o">=</span> <span class="n">XYZ</span><span class="p">[</span><span class="n">ib</span><span class="p">]</span><span class="o">+</span><span class="n">vb</span>
        <span class="n">Bonds</span> <span class="o">=</span> <span class="n">FindBonds</span><span class="p">(</span><span class="n">XYZ</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rbType</span> <span class="o">==</span> <span class="s">&#39;Z-matrix&#39;</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="c">#    def SetRBOrigin():</span>
<span class="c">#        page = getSelection()</span>
<span class="c">#        if page:</span>
<span class="c">#            if G2frame.dataDisplay.GetPageText(page) == &#39;Rigid bodies&#39;:</span>
<span class="c">#                G2frame.MapPeaksTable.SetData(mapPeaks)</span>
<span class="c">#                panel = G2frame.dataDisplay.GetPage(page).GetChildren()</span>
<span class="c">#                names = [child.GetName() for child in panel]</span>
<span class="c">#                panel[names.index(&#39;grid window&#39;)].Refresh()</span>
            
    <span class="k">def</span> <span class="nf">OnMouseDown</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnMouseMove</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">newxy</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()</span>
                                
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">Dragging</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">LeftIsDown</span><span class="p">():</span>
                <span class="n">SetRotation</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New quaternion: </span><span class="si">%.2f</span><span class="s">+, </span><span class="si">%.2f</span><span class="s">i+ ,</span><span class="si">%.2f</span><span class="s">j+, </span><span class="si">%.2f</span><span class="s">k&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
<span class="c">#            elif event.RightIsDown():</span>
<span class="c">#                SetRBOrigin(newxy)</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">MiddleIsDown</span><span class="p">():</span>
                <span class="n">SetRotationZ</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
                <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New quaternion: </span><span class="si">%.2f</span><span class="s">+, </span><span class="si">%.2f</span><span class="s">i+ ,</span><span class="si">%.2f</span><span class="s">j+, </span><span class="si">%.2f</span><span class="s">k&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">Q</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;move&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">OnMouseWheel</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetWheelRotation</span><span class="p">()</span><span class="o">/</span><span class="mi">24</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="n">defaults</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]))</span>
        <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="s">&#39;New camera distance: </span><span class="si">%.2f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">defaults</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]),</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;wheel&#39;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">SetBackground</span><span class="p">():</span>
        <span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">A</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s">&#39;backColor&#39;</span><span class="p">]</span>
        <span class="n">glClearColor</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">G</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">A</span><span class="p">)</span>
        <span class="n">glClear</span><span class="p">(</span><span class="n">GL_COLOR_BUFFER_BIT</span> <span class="o">|</span> <span class="n">GL_DEPTH_BUFFER_BIT</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">SetLights</span><span class="p">():</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_DEPTH_TEST</span><span class="p">)</span>
        <span class="n">glShadeModel</span><span class="p">(</span><span class="n">GL_FLAT</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_LIGHTING</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_LIGHT0</span><span class="p">)</span>
        <span class="n">glLightModeli</span><span class="p">(</span><span class="n">GL_LIGHT_MODEL_TWO_SIDE</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">glLightfv</span><span class="p">(</span><span class="n">GL_LIGHT0</span><span class="p">,</span><span class="n">GL_AMBIENT</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">8</span><span class="p">])</span>
        <span class="n">glLightfv</span><span class="p">(</span><span class="n">GL_LIGHT0</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        
<span class="c">#    def SetRBOrigin(newxy):</span>
<span class="c">##first get translation vector in screen coords.       </span>
<span class="c">#        oldxy = defaults[&#39;oldxy&#39;]</span>
<span class="c">#        if not len(oldxy): oldxy = list(newxy)</span>
<span class="c">#        dxy = newxy-oldxy</span>
<span class="c">#        defaults[&#39;oldxy&#39;] = list(newxy)</span>
<span class="c">#        V = np.array([dxy[0],-dxy[1],0.])/100.</span>
<span class="c">#        Q = defaults[&#39;Quaternion&#39;]</span>
<span class="c">#        V = G2mth.prodQVQ(G2mth.invQ(Q),V)</span>
<span class="c">#        rbData[&#39;rbXYZ&#39;] += V</span>
<span class="c">#        PlotRigidBody(G2frame,rbType,AtInfo,rbData,defaults) </span>
<span class="c">#               </span>
    <span class="k">def</span> <span class="nf">SetRotation</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>
<span class="c">#first get rotation vector in screen coords. &amp; angle increment        </span>
        <span class="n">oldxy</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldxy</span><span class="p">):</span> <span class="n">oldxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">newxy</span><span class="o">-</span><span class="n">oldxy</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mf">0.</span><span class="p">])</span>
        <span class="n">A</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c"># next transform vector back to xtal coordinates via inverse quaternion</span>
<span class="c"># &amp; make new quaternion</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQVQ</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">invQ</span><span class="p">(</span><span class="n">Q</span><span class="p">),</span><span class="n">V</span><span class="p">)</span>
        <span class="n">DQ</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">DQ</span><span class="p">)</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>
<span class="c"># finally get new view vector - last row of rotation matrix</span>
        <span class="n">VD</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">Q2Mat</span><span class="p">(</span><span class="n">Q</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">VD</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">VD</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">VD</span>
        
    <span class="k">def</span> <span class="nf">SetRotationZ</span><span class="p">(</span><span class="n">newxy</span><span class="p">):</span>                        
<span class="c">#first get rotation vector (= view vector) in screen coords. &amp; angle increment        </span>
        <span class="n">View</span> <span class="o">=</span> <span class="n">glGetIntegerv</span><span class="p">(</span><span class="n">GL_VIEWPORT</span><span class="p">)</span>
        <span class="n">cent</span> <span class="o">=</span> <span class="p">[</span><span class="n">View</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">View</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">oldxy</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldxy</span><span class="p">):</span> <span class="n">oldxy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">dxy</span> <span class="o">=</span> <span class="n">newxy</span><span class="o">-</span><span class="n">oldxy</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;oldxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">newxy</span><span class="p">)</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;viewDir&#39;</span><span class="p">]</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*.</span><span class="mi">25</span>
        <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*.</span><span class="mi">25</span>
        <span class="k">if</span> <span class="n">newxy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cent</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">newxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cent</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>        
<span class="c"># next transform vector back to xtal coordinates &amp; make new quaternion</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">Qx</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Qy</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">AVdeg2Q</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Qx</span><span class="p">)</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">prodQQ</span><span class="p">(</span><span class="n">Q</span><span class="p">,</span><span class="n">Qy</span><span class="p">)</span>
        <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>

    <span class="k">def</span> <span class="nf">RenderUnitVectors</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
        <span class="n">glLineWidth</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glBegin</span><span class="p">(</span><span class="n">GL_LINES</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">uEdges</span><span class="p">,</span><span class="n">uColors</span><span class="p">):</span>
            <span class="n">glColor3ubv</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="o">-</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">glVertex3fv</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">glEnd</span><span class="p">()</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        <span class="n">glColor4ubv</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_COLOR_MATERIAL</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">RenderSphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">color</span><span class="p">):</span>
        <span class="n">glMaterialfv</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">gluNewQuadric</span><span class="p">()</span>
        <span class="n">gluSphere</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">RenderBonds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Bonds</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="nb">slice</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="n">glMaterialfv</span><span class="p">(</span><span class="n">GL_FRONT_AND_BACK</span><span class="p">,</span><span class="n">GL_DIFFUSE</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">Dx</span> <span class="ow">in</span> <span class="n">Bonds</span><span class="p">:</span>
            <span class="n">glPushMatrix</span><span class="p">()</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Dx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">Z</span><span class="p">:</span>
                <span class="n">azm</span> <span class="o">=</span> <span class="n">atan2d</span><span class="p">(</span><span class="o">-</span><span class="n">Dx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="n">Dx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">phi</span> <span class="o">=</span> <span class="n">acosd</span><span class="p">(</span><span class="n">Dx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">Z</span><span class="p">)</span>
                <span class="n">glRotate</span><span class="p">(</span><span class="o">-</span><span class="n">azm</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">glRotate</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">gluNewQuadric</span><span class="p">()</span>
                <span class="n">gluCylinder</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="nb">slice</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">glPopMatrix</span><span class="p">()</span>            
        <span class="n">glPopMatrix</span><span class="p">()</span>
                
    <span class="k">def</span> <span class="nf">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">matRot</span><span class="p">):</span>       
        <span class="n">glPushMatrix</span><span class="p">()</span>
        <span class="n">glTranslate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>
        <span class="n">glDisable</span><span class="p">(</span><span class="n">GL_LIGHTING</span><span class="p">)</span>
        <span class="n">glRasterPos3f</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">matRot</span><span class="p">)</span>
        <span class="n">glRotate</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>             <span class="c">#fix to flip about x-axis</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">gltext</span><span class="o">.</span><span class="n">TextElement</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">label</span><span class="p">,</span><span class="n">font</span><span class="o">=</span><span class="n">Font</span><span class="p">,</span><span class="n">foreground</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">WHITE</span><span class="p">)</span>
        <span class="n">text</span><span class="o">.</span><span class="n">draw_text</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">0.025</span><span class="p">)</span>
        <span class="n">glEnable</span><span class="p">(</span><span class="n">GL_LIGHTING</span><span class="p">)</span>
        <span class="n">glPopMatrix</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">Draw</span><span class="p">(</span><span class="n">caller</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
<span class="c">#useful debug?        </span>
<span class="c">#        if caller:</span>
<span class="c">#            print caller</span>
<span class="c"># end of useful debug</span>
        <span class="n">cPos</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span>
        <span class="n">VS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">GetSize</span><span class="p">())</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">VS</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">VS</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">Zclip</span> <span class="o">=</span> <span class="mf">500.0</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;Quaternion&#39;</span><span class="p">]</span>
        <span class="n">SetBackground</span><span class="p">()</span>
        <span class="n">glInitNames</span><span class="p">()</span>
        <span class="n">glPushName</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL_PROJECTION</span><span class="p">)</span>
        <span class="n">glLoadIdentity</span><span class="p">()</span>
        <span class="n">glViewport</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">VS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">VS</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">gluPerspective</span><span class="p">(</span><span class="mf">20.</span><span class="p">,</span><span class="n">aspect</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">500.</span><span class="p">)</span>
        <span class="n">gluLookAt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">cPos</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">SetLights</span><span class="p">()</span>            
            
        <span class="n">glMatrixMode</span><span class="p">(</span><span class="n">GL_MODELVIEW</span><span class="p">)</span>
        <span class="n">glLoadIdentity</span><span class="p">()</span>
        <span class="n">matRot</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">Q2Mat</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">matRot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">matRot</span><span class="p">,[[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">]]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],]),</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">glMultMatrixf</span><span class="p">(</span><span class="n">matRot</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">RenderUnitVectors</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="k">for</span> <span class="n">iat</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XYZ</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="n">atom</span>
            <span class="n">CL</span> <span class="o">=</span> <span class="n">AtInfo</span><span class="p">[</span><span class="n">rbData</span><span class="p">[</span><span class="s">&#39;rbTypes&#39;</span><span class="p">][</span><span class="n">iat</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">CL</span><span class="p">)</span><span class="o">/</span><span class="mf">255.</span>
            <span class="n">RenderSphere</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">radius</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
            <span class="n">RenderBonds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">Bonds</span><span class="p">[</span><span class="n">iat</span><span class="p">],</span><span class="mf">0.05</span><span class="p">,</span><span class="n">color</span><span class="p">)</span>
            <span class="n">RenderLabel</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">atNames</span><span class="p">[</span><span class="n">iat</span><span class="p">],</span><span class="n">matRot</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SwapBuffers</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnSize</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;size&#39;</span><span class="p">)</span>
        
    <span class="k">try</span><span class="p">:</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Rigid body&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>        
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">Plot</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">addOgl</span><span class="p">(</span><span class="s">&#39;Rigid body&#39;</span><span class="p">)</span>
        <span class="n">plotNum</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">plotList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;Rigid body&#39;</span><span class="p">)</span>
        <span class="n">Page</span> <span class="o">=</span> <span class="n">G2frame</span><span class="o">.</span><span class="n">G2plotNB</span><span class="o">.</span><span class="n">nb</span><span class="o">.</span><span class="n">GetPage</span><span class="p">(</span><span class="n">plotNum</span><span class="p">)</span>
        <span class="n">Page</span><span class="o">.</span><span class="n">views</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">view</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">altDown</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">()</span>
    <span class="n">Font</span> <span class="o">=</span> <span class="n">Page</span><span class="o">.</span><span class="n">GetFont</span><span class="p">()</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MOUSEWHEEL</span><span class="p">,</span> <span class="n">OnMouseWheel</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_LEFT_DOWN</span><span class="p">,</span> <span class="n">OnMouseDown</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_RIGHT_DOWN</span><span class="p">,</span> <span class="n">OnMouseDown</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MIDDLE_DOWN</span><span class="p">,</span> <span class="n">OnMouseDown</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MOTION</span><span class="p">,</span> <span class="n">OnMouseMove</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SIZE</span><span class="p">,</span> <span class="n">OnSize</span><span class="p">)</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s">&#39;position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaults</span><span class="p">[</span><span class="s">&#39;cameraPos&#39;</span><span class="p">]</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s">&#39;backColor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">Page</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCurrent</span><span class="p">()</span>
    <span class="n">Draw</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/G2_html_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Von Dreele and Toby for Argonne National Laboratory.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>