

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>G2export_CIF &mdash; GSAS-II 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="GSAS-II 0.2.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for G2export_CIF</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">########### SVN repository information ###################</span>
<span class="c"># $Date: 2013-10-29 11:42:23 -0500 (Tue, 29 Oct 2013) $</span>
<span class="c"># $Author: toby $</span>
<span class="c"># $Revision: 1127 $</span>
<span class="c"># $URL: https://subversion.xray.aps.anl.gov/pyGSAS/trunk/exports/G2export_CIF.py $</span>
<span class="c"># $Id: G2export_CIF.py 1127 2013-10-29 16:42:23Z toby $</span>
<span class="c">########### SVN repository information ###################</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">*Module G2export_CIF: CIF Exports*</span>
<span class="sd">------------------------------------------------------</span>

<span class="sd">This implements a complex exporter :class:`ExportCIF` that can implement an</span>
<span class="sd">entire project in a complete CIF intended for submission as a</span>
<span class="sd">publication. In addition, there are two subclasses of :class:`ExportCIF`:</span>
<span class="sd">:class:`ExportPhaseCIF` and :class:`ExportDataCIF` that</span>
<span class="sd">export a single phase or data set. Note that ``self.mode`` determines</span>
<span class="sd">what is written:</span>

<span class="sd"> * `self.mode=&quot;simple&quot;` creates a simple CIF with only coordinates</span>
<span class="sd">   or data, while </span>

<span class="sd"> * `self.mode=&quot;full&quot;` creates a complete CIF of project.</span>
<span class="sd"> </span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cPickle</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">wx.lib.scrolledpanel</span> <span class="kn">as</span> <span class="nn">wxscroll</span>
<span class="kn">import</span> <span class="nn">wx.lib.resizewidget</span> <span class="kn">as</span> <span class="nn">rw</span>
<span class="kn">import</span> <span class="nn">GSASIIpath</span>
<span class="n">GSASIIpath</span><span class="o">.</span><span class="n">SetVersionNumber</span><span class="p">(</span><span class="s">&quot;$Revision: 1127 $&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">GSASIIIO</span> <span class="kn">as</span> <span class="nn">G2IO</span>
<span class="kn">import</span> <span class="nn">GSASIIgrid</span> <span class="kn">as</span> <span class="nn">G2gd</span>
<span class="kn">import</span> <span class="nn">GSASIIstrIO</span> <span class="kn">as</span> <span class="nn">G2stIO</span>
<span class="kn">import</span> <span class="nn">GSASIImath</span> <span class="kn">as</span> <span class="nn">G2mth</span>
<span class="kn">import</span> <span class="nn">GSASIIlattice</span> <span class="kn">as</span> <span class="nn">G2lat</span>
<span class="kn">import</span> <span class="nn">GSASIIspc</span> <span class="kn">as</span> <span class="nn">G2spc</span>
<span class="kn">import</span> <span class="nn">GSASIIphsGUI</span> <span class="kn">as</span> <span class="nn">G2pg</span>
<span class="kn">import</span> <span class="nn">GSASIIstrMain</span> <span class="kn">as</span> <span class="nn">G2stMn</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c">#True to skip printing of reflection/powder profile lists</span>

<span class="n">CIFdic</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="ExportCIF"><a class="viewcode-back" href="../exports.html#G2export_CIF.ExportCIF">[docs]</a><span class="k">class</span> <span class="nc">ExportCIF</span><span class="p">(</span><span class="n">G2IO</span><span class="o">.</span><span class="n">ExportBaseclass</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Used to create a CIF of an entire project</span>

<span class="sd">    :param wx.Frame G2frame: reference to main GSAS-II frame</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">G2frame</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span> <span class="c"># fancy way to say &lt;parentclass&gt;.__init__</span>
            <span class="n">G2frame</span><span class="o">=</span><span class="n">G2frame</span><span class="p">,</span>
            <span class="n">formatName</span> <span class="o">=</span> <span class="s">&#39;Full CIF&#39;</span><span class="p">,</span>
            <span class="n">extension</span><span class="o">=</span><span class="s">&#39;.cif&#39;</span><span class="p">,</span>
            <span class="n">longFormatName</span> <span class="o">=</span> <span class="s">&#39;Export project as CIF&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exporttype</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;project&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;full&#39;</span>

<div class="viewcode-block" id="ExportCIF.Exporter"><a class="viewcode-back" href="../exports.html#G2export_CIF.ExportCIF.Exporter">[docs]</a>    <span class="k">def</span> <span class="nf">Exporter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Export a CIF. Export can be full or simple (as set by self.mode).</span>
<span class="sd">        &quot;simple&quot; skips data, distances &amp; angles, etc. and can only include</span>
<span class="sd">        a single phase while &quot;full&quot; is intended for for publication submission.</span>
<span class="sd">        &#39;&#39;&#39;</span>

<span class="c">#***** define functions for export method =======================================</span>
        <span class="k">def</span> <span class="nf">openCIF</span><span class="p">(</span><span class="n">filnam</span><span class="p">):</span>
            <span class="s">&#39;opens the output file&#39;</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filnam</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">closeCIF</span><span class="p">():</span>
            <span class="s">&#39;close the output file&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            
        <span class="k">def</span> <span class="nf">WriteCIFitem</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Write CIF data items to the file. Formats values as needed.</span>
<span class="sd">            Also used without a value for loops, comments, loop headers, etc.</span>
<span class="sd">            &#39;&#39;&#39;</span>            
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">70</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;; &#39;</span><span class="o">+</span><span class="n">value</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;; &#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s">&quot; &quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&#39;  &#39;</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;&#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">65</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;  &#39;</span> <span class="o">+</span> <span class="n">value</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">WriteAudit</span><span class="p">():</span>
            <span class="s">&#39;Write the CIF audit values. Perhaps should be in a single element loop.&#39;</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_audit_creation_method&#39;</span><span class="p">,</span>
                         <span class="s">&#39;created in GSAS-II&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_audit_creation_date&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_audit_author_name&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_audit_update_record&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span><span class="o">+</span><span class="s">&#39;  Initial software-generated CIF&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">WriteOverall</span><span class="p">():</span>
            <span class="sd">&#39;&#39;&#39;Write out overall refinement information.</span>

<span class="sd">            More could be done here, but this is a good start.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_info_datetime&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_calc_method&#39;</span><span class="p">,</span> <span class="s">&#39;Rietveld Refinement&#39;</span><span class="p">)</span>
            <span class="c">#WriteCIFitem(&#39;_refine_ls_shift/su_max&#39;,DAT1)</span>
            <span class="c">#WriteCIFitem(&#39;_refine_ls_shift/su_mean&#39;,DAT2)</span>
            <span class="c">#WriteCIFitem(&#39;_refine_diff_density_max&#39;,rhomax)    #these need to be defined for each phase!</span>
            <span class="c">#WriteCIFitem(&#39;_refine_diff_density_min&#39;,rhomin)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_computing_structure_refinement&#39;</span><span class="p">,</span><span class="s">&#39;GSAS-II (Toby &amp; Von Dreele, J. Appl. Cryst. 46, 544-549, 2013)&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">vars</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Covariance&#39;</span><span class="p">][</span><span class="s">&#39;varyList&#39;</span><span class="p">]))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">vars</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_refine_ls_number_parameters&#39;</span><span class="p">,</span><span class="nb">vars</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">GOF</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Covariance&#39;</span><span class="p">][</span><span class="s">&#39;Rvals&#39;</span><span class="p">][</span><span class="s">&#39;GOF&#39;</span><span class="p">],</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">GOF</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_refine_ls_goodness_of_fit_all&#39;</span><span class="p">,</span><span class="n">GOF</span><span class="p">)</span>

            <span class="c"># get restraint info</span>
            <span class="c"># restraintDict = self.OverallParms.get(&#39;Restraints&#39;,{})</span>
            <span class="c"># for i in  self.OverallParms[&#39;Constraints&#39;]:</span>
            <span class="c">#     print i</span>
            <span class="c">#     for j in self.OverallParms[&#39;Constraints&#39;][i]:</span>
            <span class="c">#         print j</span>
            <span class="c">#WriteCIFitem(&#39;_refine_ls_number_restraints&#39;,TEXT)</span>
            <span class="c"># other things to consider reporting</span>
            <span class="c"># _refine_ls_number_reflns</span>
            <span class="c"># _refine_ls_goodness_of_fit_obs</span>
            <span class="c"># _refine_ls_wR_factor_obs</span>
            <span class="c"># _refine_ls_restrained_S_all</span>
            <span class="c"># _refine_ls_restrained_S_obs</span>

            <span class="c"># include an overall profile r-factor, if there is more than one powder histogram</span>
            <span class="n">R</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Covariance&#39;</span><span class="p">][</span><span class="s">&#39;Rvals&#39;</span><span class="p">][</span><span class="s">&#39;Rwp&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># OVERALL WEIGHTED R-FACTOR&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_refine_ls_wR_factor_obs&#39;</span><span class="p">,</span><span class="n">R</span><span class="p">)</span>
                <span class="c"># _refine_ls_R_factor_all</span>
                <span class="c"># _refine_ls_R_factor_obs                </span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_refine_ls_matrix_type&#39;</span><span class="p">,</span><span class="s">&#39;full&#39;</span><span class="p">)</span>
            <span class="c">#WriteCIFitem(&#39;_refine_ls_matrix_type&#39;,&#39;userblocks&#39;)</span>

        <span class="k">def</span> <span class="nf">writeCIFtemplate</span><span class="p">(</span><span class="n">G2dict</span><span class="p">,</span><span class="n">tmplate</span><span class="p">,</span><span class="n">defaultname</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Write out the selected or edited CIF template</span>
<span class="sd">            An unedited CIF template file is copied, comments intact; an edited</span>
<span class="sd">            CIF template is written out from PyCifRW which of course strips comments. </span>
<span class="sd">            In all cases the initial data_ header is stripped (there should only be one!)</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">CIFobj</span> <span class="o">=</span> <span class="n">G2dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;CIF_template&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">defaultname</span><span class="p">:</span>
                <span class="n">defaultname</span> <span class="o">=</span> <span class="n">defaultname</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">defaultname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;[^a-zA-Z0-9_-]&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">defaultname</span><span class="p">)</span>
                <span class="n">defaultname</span> <span class="o">=</span> <span class="n">tmplate</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">defaultname</span> <span class="o">+</span> <span class="s">&quot;.cif&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">defaultname</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">templateDefName</span> <span class="o">=</span> <span class="s">&#39;template_&#39;</span><span class="o">+</span><span class="n">tmplate</span><span class="o">+</span><span class="s">&#39;.cif&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">CIFobj</span><span class="p">:</span> <span class="c"># copying a template</span>
                <span class="k">for</span> <span class="n">pth</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()]</span><span class="o">+</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                    <span class="n">fil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span><span class="n">defaultname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="ow">and</span> <span class="n">defaultname</span><span class="p">:</span> <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pth</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                        <span class="n">fil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span><span class="n">templateDefName</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fil</span><span class="p">):</span> <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="n">CIFobj</span><span class="o">+</span><span class="s">&#39; not found in path!&#39;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">CIFobj</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">CIFobj</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CIFobj</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Error: requested template file has disappeared: &quot;</span><span class="o">+</span><span class="n">CIFobj</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">CIFobj</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">dict2CIF</span><span class="p">(</span><span class="n">CIFobj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">CIFobj</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">WriteOut</span><span class="p">()</span>
            <span class="c"># remove the PyCifRW header, if present</span>
            <span class="c">#if txt.find(&#39;PyCifRW&#39;) &gt; -1 and txt.find(&#39;data_&#39;) &gt; -1:</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;# GSAS-II edited template follows &quot;</span><span class="o">+</span><span class="n">txt</span><span class="p">[</span><span class="n">txt</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;data_&quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">:]</span>
            <span class="c">#txt = txt.replace(&#39;data_&#39;,&#39;#&#39;)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">FormatSH</span><span class="p">(</span><span class="n">phasenam</span><span class="p">):</span>
            <span class="s">&#39;Format a full spherical harmonics texture description as a string&#39;</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info            </span>
            <span class="n">pfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">textureData</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SH Texture&#39;</span><span class="p">]</span>    
            <span class="k">if</span> <span class="n">textureData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Order&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;Spherical Harmonics correction. Order = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Order&#39;</span><span class="p">])</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot; Model: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">textureData</span><span class="p">[</span><span class="s">&#39;Model&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">    Orientation angles: &quot;</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;omega&#39;</span><span class="p">,</span><span class="s">&#39;chi&#39;</span><span class="p">,</span><span class="s">&#39;phi&#39;</span><span class="p">]:</span>
                    <span class="n">aname</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="s">&#39;SH &#39;</span><span class="o">+</span><span class="n">name</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">name</span> <span class="o">+</span> <span class="s">&quot; = &quot;</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span><span class="o">-</span><span class="mf">0.09</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="p">[</span><span class="n">aname</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;; &quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;    Coefficients:  &quot;</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">textureData</span><span class="p">[</span><span class="s">&#39;SH Coeff&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">aname</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="n">name</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">s1</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
                        <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;    &quot;</span>
                    <span class="n">s1</span> <span class="o">+=</span> <span class="n">aname</span> <span class="o">+</span> <span class="s">&#39; = &#39;</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0009</span><span class="p">)</span>
                    <span class="n">s1</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="p">[</span><span class="n">aname</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span>
                    <span class="n">s1</span> <span class="o">+=</span> <span class="s">&quot;; &quot;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">s1</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">def</span> <span class="nf">FormatHAPpo</span><span class="p">(</span><span class="n">phasenam</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;return the March-Dollase/SH correction for every</span>
<span class="sd">            histogram in the current phase formatted into a</span>
<span class="sd">            character string</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info            </span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">histogram</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">histogram</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;HKLF&quot;</span><span class="p">):</span> <span class="k">continue</span> <span class="c"># powder only</span>
                <span class="n">Histogram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histogram</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Histogram</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">hapData</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">][</span><span class="n">histogram</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Pref.Ori.&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;MD&#39;</span><span class="p">:</span>
                    <span class="n">aname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;:MD&#39;</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;March-Dollase correction&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;, histogram &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39; coef. = &#39;</span> <span class="o">+</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="p">[</span><span class="n">aname</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39; axis = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Pref.Ori.&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># must be SH</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span> <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;Simple spherical harmonic correction&#39;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;, histogram &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39; Order = &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Pref.Ori.&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;    Coefficients:  &quot;</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Pref.Ori.&#39;</span><span class="p">][</span><span class="mi">5</span><span class="p">]:</span>
                        <span class="n">aname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="n">item</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="n">s1</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
                            <span class="n">s1</span> <span class="o">=</span> <span class="s">&quot;    &quot;</span>
                        <span class="n">s1</span> <span class="o">+=</span> <span class="n">aname</span> <span class="o">+</span> <span class="s">&#39; = &#39;</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aname</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0009</span><span class="p">)</span>
                        <span class="n">s1</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="p">[</span><span class="n">aname</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span>
                        <span class="n">s1</span> <span class="o">+=</span> <span class="s">&quot;; &quot;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">s1</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">def</span> <span class="nf">FormatBackground</span><span class="p">(</span><span class="n">bkg</span><span class="p">,</span><span class="n">hId</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Display the Background information as a descriptive text string.</span>
<span class="sd">            </span>
<span class="sd">            TODO: this needs to be expanded to show the diffuse peak and</span>
<span class="sd">            Debye term information as well. (Bob)</span>

<span class="sd">            :returns: the text description (str)</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span>
            <span class="n">fxn</span><span class="p">,</span> <span class="n">bkgdict</span> <span class="o">=</span> <span class="n">bkg</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="n">fxn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="s">&#39;Background function: &quot;&#39;</span><span class="o">+</span><span class="n">fxn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;&quot; function with &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span><span class="o">+</span><span class="s">&#39; terms:</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="s">&quot;    &quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fxn</span><span class="p">[</span><span class="mi">3</span><span class="p">:]):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">Back:</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">hfx</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="n">l</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="s">&#39;    &#39;</span>
                <span class="n">l</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="n">l</span>
            <span class="k">if</span> <span class="n">bkgdict</span><span class="p">[</span><span class="s">&#39;nDebye&#39;</span><span class="p">]:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  Background Debye function parameters: A, R, U:&#39;</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A:&#39;</span><span class="p">,</span><span class="s">&#39;R:&#39;</span><span class="p">,</span><span class="s">&#39;U:&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bkgdict</span><span class="p">[</span><span class="s">&#39;nDebye&#39;</span><span class="p">]):</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;Debye&#39;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                        <span class="n">txt</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">bkgdict</span><span class="p">[</span><span class="s">&#39;debyeTerms&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
            <span class="k">if</span> <span class="n">bkgdict</span><span class="p">[</span><span class="s">&#39;nPeaks&#39;</span><span class="p">]:</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  Background peak parameters: pos, int, sig, gam:&#39;</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;pos:&#39;</span><span class="p">,</span><span class="s">&#39;int:&#39;</span><span class="p">,</span><span class="s">&#39;sig:&#39;</span><span class="p">,</span><span class="s">&#39;gam:&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bkgdict</span><span class="p">[</span><span class="s">&#39;nPeaks&#39;</span><span class="p">]):</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">hfx</span><span class="o">+</span><span class="s">&#39;BkPk&#39;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                        <span class="n">txt</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">bkgdict</span><span class="p">[</span><span class="s">&#39;peaksList&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="o">*</span><span class="n">j</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
            <span class="k">return</span> <span class="n">txt</span>

        <span class="k">def</span> <span class="nf">FormatInstProfile</span><span class="p">(</span><span class="n">instparmdict</span><span class="p">,</span><span class="n">hId</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Format the instrumental profile parameters with a</span>
<span class="sd">            string description. Will only be called on PWDR histograms</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">instparmdict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hfx</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span>
            <span class="k">if</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">inst</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;Finger-Cox-Jephcoat function parameters U, V, W, X, Y, SH/L:</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  peak variance(Gauss) = Utan(Th)^2^+Vtan(Th)+W:</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  peak HW(Lorentz) = X/cos(Th)+Ytan(Th); SH/L = S/L+H/L</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  U, V, W in (centideg)^2^, X &amp; Y in centideg</span><span class="se">\n</span><span class="s">    &#39;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;U&#39;</span><span class="p">,</span><span class="s">&#39;V&#39;</span><span class="p">,</span><span class="s">&#39;W&#39;</span><span class="p">,</span><span class="s">&#39;X&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">,</span><span class="s">&#39;SH/L&#39;</span><span class="p">]:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">hfx</span><span class="o">+</span><span class="n">item</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>                    
            <span class="k">elif</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">inst</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>    <span class="c">#to be tested after TOF Rietveld done</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;Von Dreele-Jorgenson-Windsor function parameters</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span> \
                    <span class="s">&#39;   alpha, beta-0, beta-1, beta-q, sig-0, sig-1, sig-q, X, Y:</span><span class="se">\n</span><span class="s">    &#39;</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">,</span><span class="s">&#39;bet-0&#39;</span><span class="p">,</span><span class="s">&#39;bet-1&#39;</span><span class="p">,</span><span class="s">&#39;bet-q&#39;</span><span class="p">,</span><span class="s">&#39;sig-0&#39;</span><span class="p">,</span><span class="s">&#39;sig-1&#39;</span><span class="p">,</span><span class="s">&#39;sig-q&#39;</span><span class="p">,</span><span class="s">&#39;X&#39;</span><span class="p">,</span><span class="s">&#39;Y&#39;</span><span class="p">]:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">hfx</span><span class="o">+</span><span class="n">item</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">def</span> <span class="nf">FormatPhaseProfile</span><span class="p">(</span><span class="n">phasenam</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Format the phase-related profile parameters (size/strain)</span>
<span class="sd">            with a string description.</span>
<span class="sd">            return an empty string or None if there are no</span>
<span class="sd">            powder histograms for this phase.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info</span>
            <span class="n">SGData</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span> <span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span>          
            <span class="k">for</span> <span class="n">histogram</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">histogram</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;HKLF&quot;</span><span class="p">):</span> <span class="k">continue</span> <span class="c"># powder only</span>
                <span class="n">Histogram</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histogram</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Histogram</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">hapData</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;Histograms&#39;</span><span class="p">][</span><span class="n">histogram</span><span class="p">]</span>
                <span class="n">pId</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
                <span class="n">hId</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
                <span class="n">phfx</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s">:</span><span class="si">%d</span><span class="s">:&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pId</span><span class="p">,</span><span class="n">hId</span><span class="p">)</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Size&#39;</span><span class="p">]</span>
                <span class="n">mustrain</span> <span class="o">=</span> <span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Mustrain&#39;</span><span class="p">]</span>
                <span class="n">hstrain</span> <span class="o">=</span> <span class="n">hapData</span><span class="p">[</span><span class="s">&#39;HStrain&#39;</span><span class="p">]</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;  Crystallite size model &quot;</span><span class="si">%s</span><span class="s">&quot; for </span><span class="si">%s</span><span class="s"> (microns)</span><span class="se">\n</span><span class="s">  &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">phasenam</span><span class="p">)</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Size;i&#39;</span><span class="p">,</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;uniax&#39;</span> <span class="ow">in</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Size;i&#39;</span><span class="p">,</span><span class="s">&#39;Size;a&#39;</span><span class="p">,</span><span class="s">&#39;Size;mx&#39;</span><span class="p">]</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;anisotropic axis is </span><span class="si">%s</span><span class="se">\n</span><span class="s">  &#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;parameters: equatorial size, axial size, G/L mix</span><span class="se">\n</span><span class="s">    &#39;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                <span class="k">elif</span> <span class="s">&#39;ellip&#39;</span> <span class="ow">in</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;parameters: S11, S22, S33, S12, S13, S23, G/L mix</span><span class="se">\n</span><span class="s">    &#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Size;mx&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>                                           
                <span class="k">else</span><span class="p">:</span>       <span class="c">#isotropic</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;parameters: Size, G/L mix</span><span class="se">\n</span><span class="s">    &#39;</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>    <span class="c">#skip the aniso value                </span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  Mustrain model &quot;</span><span class="si">%s</span><span class="s">&quot; for </span><span class="si">%s</span><span class="s"> (10^6^)</span><span class="se">\n</span><span class="s">  &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mustrain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">phasenam</span><span class="p">)</span>
                <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">,</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;uniax&#39;</span> <span class="ow">in</span> <span class="n">mustrain</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Mustrain;i&#39;</span><span class="p">,</span><span class="s">&#39;Mustrain;a&#39;</span><span class="p">,</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">]</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;anisotropic axis is </span><span class="si">%s</span><span class="se">\n</span><span class="s">  &#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;parameters: equatorial mustrain, axial mustrain, G/L mix</span><span class="se">\n</span><span class="s">    &#39;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">mustrain</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                <span class="k">elif</span> <span class="s">&#39;general&#39;</span> <span class="ow">in</span> <span class="n">mustrain</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="s">&#39;parameters: &#39;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">G2spc</span><span class="o">.</span><span class="n">MustrainNames</span><span class="p">(</span><span class="n">SGData</span><span class="p">)):</span>
                        <span class="n">names</span> <span class="o">+=</span> <span class="n">name</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
                            <span class="n">names</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  &#39;</span>
                    <span class="n">names</span> <span class="o">+=</span> <span class="s">&#39;G/L mix</span><span class="se">\n</span><span class="s">    &#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">names</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mustrain</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">+=</span> <span class="n">txt</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span>
                            <span class="n">txt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="n">txt</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">mustrain</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">txt</span>                                           
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phfx</span><span class="o">+</span><span class="s">&#39;Mustrain;mx&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">mustrain</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                    
                <span class="k">else</span><span class="p">:</span>       <span class="c">#isotropic</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;  parameters: Mustrain, G/L mix</span><span class="se">\n</span><span class="s">    &#39;</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">phfx</span><span class="o">+</span><span class="n">item</span>
                        <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">mustrain</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                        <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span>    <span class="c">#skip the aniso value                </span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">  Macrostrain for </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s">&#39;  parameters: &#39;</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">HStrainNames</span><span class="p">(</span><span class="n">SGData</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">+=</span> <span class="n">name</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">txt</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">phfx</span><span class="o">+</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">hstrain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;, &#39;</span>
            <span class="k">return</span> <span class="n">s</span>
        
        <span class="k">def</span> <span class="nf">FmtAtomType</span><span class="p">(</span><span class="n">sym</span><span class="p">):</span>
            <span class="s">&#39;Reformat a GSAS-II atom type symbol to match CIF rules&#39;</span>
            <span class="n">sym</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="c"># underscores are not allowed: no isotope designation?</span>
            <span class="c"># in CIF, oxidation state sign symbols come after, not before</span>
            <span class="k">if</span> <span class="s">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">sym</span><span class="p">:</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;+&#39;</span>
            <span class="k">elif</span> <span class="s">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">sym</span><span class="p">:</span>
                <span class="n">sym</span> <span class="o">=</span> <span class="n">sym</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span>
            <span class="k">return</span> <span class="n">sym</span>
            
        <span class="k">def</span> <span class="nf">PutInCol</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">wid</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Pad a value to &gt;=wid+1 columns by adding spaces at the end. Always</span>
<span class="sd">            adds at least one space</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="s">&#39;?&#39;</span>
            <span class="n">fmt</span> <span class="o">=</span> <span class="s">&#39;{:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">wid</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;} &#39;</span>
            <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">MakeUniqueLabel</span><span class="p">(</span><span class="n">lbl</span><span class="p">,</span><span class="n">labellist</span><span class="p">):</span>
            <span class="s">&#39;Make sure that every atom label is unique&#39;</span>
            <span class="n">lbl</span> <span class="o">=</span> <span class="n">lbl</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">lbl</span><span class="p">:</span> <span class="c"># deal with a blank label</span>
                <span class="n">lbl</span> <span class="o">=</span> <span class="s">&#39;A_1&#39;</span>
            <span class="k">if</span> <span class="n">lbl</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">labellist</span><span class="p">:</span>
                <span class="n">labellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">lbl</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">lbl</span>
            <span class="k">if</span> <span class="s">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">lbl</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[:</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="n">lbl</span><span class="p">[</span><span class="n">lbl</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">while</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">labellist</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lbl</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">+</span><span class="s">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">labellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lbl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">WriteAtomsNuclear</span><span class="p">(</span><span class="n">phasenam</span><span class="p">):</span>
            <span class="s">&#39;Write atom positions to CIF&#39;</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info</span>
            <span class="n">General</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">cia</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">]</span>
            <span class="n">Atoms</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">cfrac</span> <span class="o">=</span> <span class="n">cx</span><span class="o">+</span><span class="mi">3</span>
            <span class="n">fpfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::Afrac:&#39;</span>        
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atoms</span><span class="p">):</span>
                <span class="n">fval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fpfx</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">at</span><span class="p">[</span><span class="n">cfrac</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">fval</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># PHASE HAS NO ATOMS!&#39;</span><span class="p">)</span>
                <span class="k">return</span>
                
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># ATOMIC COORDINATES AND DISPLACEMENT PARAMETERS&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_ &#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_label&#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_type_symbol&#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_fract_x&#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_fract_y&#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_fract_z&#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_occupancy&#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_adp_type&#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_U_iso_or_equiv&#39;</span><span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_symmetry_multiplicity&#39;</span><span class="p">)</span>

            <span class="n">varnames</span> <span class="o">=</span> <span class="p">{</span><span class="n">cx</span><span class="p">:</span><span class="s">&#39;Ax&#39;</span><span class="p">,</span><span class="n">cx</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="s">&#39;Ay&#39;</span><span class="p">,</span><span class="n">cx</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="s">&#39;Az&#39;</span><span class="p">,</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="s">&#39;Afrac&#39;</span><span class="p">,</span>
                        <span class="n">cia</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="s">&#39;AUiso&#39;</span><span class="p">,</span><span class="n">cia</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="s">&#39;AU11&#39;</span><span class="p">,</span><span class="n">cia</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="s">&#39;AU22&#39;</span><span class="p">,</span><span class="n">cia</span><span class="o">+</span><span class="mi">4</span><span class="p">:</span><span class="s">&#39;AU33&#39;</span><span class="p">,</span>
                        <span class="n">cia</span><span class="o">+</span><span class="mi">5</span><span class="p">:</span><span class="s">&#39;AU12&#39;</span><span class="p">,</span><span class="n">cia</span><span class="o">+</span><span class="mi">6</span><span class="p">:</span><span class="s">&#39;AU13&#39;</span><span class="p">,</span><span class="n">cia</span><span class="o">+</span><span class="mi">7</span><span class="p">:</span><span class="s">&#39;AU23&#39;</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labellist</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="n">pfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::&#39;</span>
            <span class="c"># loop over all atoms</span>
            <span class="n">naniso</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;macromolecular&#39;</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">MakeUniqueLabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">labellist</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span> <span class="c"># label</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">MakeUniqueLabel</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">labellist</span><span class="p">),</span><span class="mi">6</span><span class="p">)</span> <span class="c"># label</span>
                <span class="n">fval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fpfx</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">at</span><span class="p">[</span><span class="n">cfrac</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">fval</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># ignore any atoms that have a occupancy set to 0 (exact)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">FmtAtomType</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="p">]),</span><span class="mi">4</span><span class="p">)</span> <span class="c"># type</span>
                <span class="k">if</span> <span class="n">at</span><span class="p">[</span><span class="n">cia</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;I&#39;</span><span class="p">:</span>
                    <span class="n">adp</span> <span class="o">=</span> <span class="s">&#39;Uiso &#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">adp</span> <span class="o">=</span> <span class="s">&#39;Uani &#39;</span>
                    <span class="n">naniso</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c"># compute Uequiv crudely</span>
                    <span class="c"># correct: Defined as &quot;1/3 trace of diagonalized U matrix&quot;.</span>
                    <span class="c"># SEE cell2GS &amp; Uij2Ueqv to GSASIIlattice. Former is needed to make the GS matrix used by the latter.</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="n">varnames</span><span class="p">[</span><span class="n">cia</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">at</span><span class="p">[</span><span class="n">cia</span><span class="o">+</span><span class="n">j</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span><span class="n">cx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">cx</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">cia</span><span class="p">,</span><span class="n">cia</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cx</span><span class="p">,</span><span class="n">cx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">cx</span><span class="o">+</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">dig</span> <span class="o">=</span> <span class="mi">11</span>
                        <span class="n">sigdig</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.00009</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dig</span> <span class="o">=</span> <span class="mi">10</span>
                        <span class="n">sigdig</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.009</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">cia</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">adp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">var</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="n">varnames</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">dvar</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="s">&quot;d&quot;</span><span class="o">+</span><span class="n">varnames</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dvar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="p">:</span>
                            <span class="n">dvar</span> <span class="o">=</span> <span class="n">var</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">cia</span><span class="o">+</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">adp</span> <span class="o">==</span> <span class="s">&#39;Uani &#39;</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="mf">3.</span>
                            <span class="n">sig</span> <span class="o">=</span> <span class="n">sigdig</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c">#print var,(var in self.parmDict),(var in self.sigDict)</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">at</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dvar</span><span class="p">,</span><span class="n">sigdig</span><span class="p">)</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">sig</span><span class="p">),</span><span class="n">dig</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">cs</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">naniso</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
            <span class="c"># now loop over aniso atoms</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">loop_&#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_aniso_label&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_aniso_U_11&#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_aniso_U_12&#39;</span> <span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_aniso_U_13&#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_aniso_U_22&#39;</span> <span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_aniso_U_23&#39;</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _atom_site_aniso_U_33&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atoms</span><span class="p">):</span>
                <span class="n">fval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fpfx</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">at</span><span class="p">[</span><span class="n">cfrac</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">fval</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># ignore any atoms that have a occupancy set to 0 (exact)</span>
                <span class="k">if</span> <span class="n">at</span><span class="p">[</span><span class="n">cia</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;I&#39;</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labellist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span> <span class="c"># label</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">):</span>
                    <span class="n">sigdig</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0009</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="n">pfx</span><span class="o">+</span><span class="n">varnames</span><span class="p">[</span><span class="n">cia</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">at</span><span class="p">[</span><span class="n">cia</span><span class="o">+</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="n">sigdig</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">sig</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">HillSortElements</span><span class="p">(</span><span class="n">elmlist</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Sort elements in &quot;Hill&quot; order: C, H, others, (where others</span>
<span class="sd">            are alphabetical).</span>

<span class="sd">            :params list elmlist: a list of element strings</span>

<span class="sd">            :returns: a sorted list of element strings</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">newlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">oldlist</span> <span class="o">=</span> <span class="n">elmlist</span><span class="p">[:]</span>
            <span class="k">for</span> <span class="n">elm</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;C&#39;</span><span class="p">,</span><span class="s">&#39;H&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">elm</span> <span class="ow">in</span> <span class="n">elmlist</span><span class="p">:</span>
                    <span class="n">newlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elm</span><span class="p">)</span>
                    <span class="n">oldlist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">oldlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">elm</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">newlist</span><span class="o">+</span><span class="nb">sorted</span><span class="p">(</span><span class="n">oldlist</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">WriteComposition</span><span class="p">(</span><span class="n">phasenam</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;determine the composition for the unit cell, crudely determine Z and</span>
<span class="sd">            then compute the composition in formula units</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info</span>
            <span class="n">General</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">General</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cellZ&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">cia</span> <span class="o">=</span> <span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">]</span>
            <span class="n">Atoms</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">fpfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::Afrac:&#39;</span>        
            <span class="n">cfrac</span> <span class="o">=</span> <span class="n">cx</span><span class="o">+</span><span class="mi">3</span>
            <span class="n">cmult</span> <span class="o">=</span> <span class="n">cs</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">compDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># combines H,D &amp; T</span>
            <span class="n">sitemultlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">massDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomTypes&#39;</span><span class="p">],</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;AtomMass&#39;</span><span class="p">]))</span>
            <span class="n">cellmass</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atoms</span><span class="p">):</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">atype</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">atype</span> <span class="o">=</span> <span class="n">atype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atype</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">atype</span> <span class="o">=</span> <span class="n">atype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">atype</span> <span class="o">=</span> <span class="n">atype</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">+</span><span class="n">atype</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c"># force case conversion</span>
                <span class="k">if</span> <span class="n">atype</span> <span class="o">==</span> <span class="s">&quot;D&quot;</span> <span class="ow">or</span> <span class="n">atype</span> <span class="o">==</span> <span class="s">&quot;D&quot;</span><span class="p">:</span> <span class="n">atype</span> <span class="o">=</span> <span class="s">&quot;H&quot;</span>
                <span class="n">fvar</span> <span class="o">=</span> <span class="n">fpfx</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">fval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fvar</span><span class="p">,</span><span class="n">at</span><span class="p">[</span><span class="n">cfrac</span><span class="p">])</span>
                <span class="n">mult</span> <span class="o">=</span> <span class="n">at</span><span class="p">[</span><span class="n">cmult</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">massDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="p">]):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Error: No mass found for atom type &#39;</span><span class="o">+</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="p">])</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Will not compute cell contents for phase &#39;</span><span class="o">+</span><span class="n">phasenam</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">cellmass</span> <span class="o">+=</span> <span class="n">massDict</span><span class="p">[</span><span class="n">at</span><span class="p">[</span><span class="n">ct</span><span class="p">]]</span><span class="o">*</span><span class="n">mult</span><span class="o">*</span><span class="n">fval</span>
                <span class="n">compDict</span><span class="p">[</span><span class="n">atype</span><span class="p">]</span> <span class="o">=</span> <span class="n">compDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">atype</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">mult</span><span class="o">*</span><span class="n">fval</span>
                <span class="k">if</span> <span class="n">fval</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">sitemultlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mult</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="c"># no elements!</span>
            <span class="k">if</span> <span class="n">Z</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Z has not been computed or set by user</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">sitemultlist</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">sitemultlist</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">m</span> <span class="o">%</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">Z</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">General</span><span class="p">[</span><span class="s">&#39;cellZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span> <span class="c"># save it</span>

            <span class="c"># when scattering factors are included in the CIF, this needs to be</span>
            <span class="c"># added to the loop here but only in the one-block case.</span>
            <span class="c"># For multiblock CIFs, scattering factors go in the histogram</span>
            <span class="c"># blocks  (for all atoms in all appropriate phases) - an example?:</span>
<span class="c">#loop_</span>
<span class="c">#    _atom_type_symbol</span>
<span class="c">#    _atom_type_description</span>
<span class="c">#    _atom_type_scat_dispersion_real</span>
<span class="c">#    _atom_type_scat_dispersion_imag</span>
<span class="c">#    _atom_type_scat_source</span>
<span class="c">#    &#39;C&#39; &#39;C&#39; 0.0033 0.0016</span>
<span class="c">#                         &#39;International Tables Vol C Tables 4.2.6.8 and 6.1.1.4&#39;</span>
<span class="c">#    &#39;H&#39; &#39;H&#39; 0.0000 0.0000</span>
<span class="c">#                         &#39;International Tables Vol C Tables 4.2.6.8 and 6.1.1.4&#39;</span>
<span class="c">#    &#39;P&#39; &#39;P&#39; 0.1023 0.0942</span>
<span class="c">#                         &#39;International Tables Vol C Tables 4.2.6.8 and 6.1.1.4&#39;</span>
<span class="c">#    &#39;Cl&#39; &#39;Cl&#39; 0.1484 0.1585</span>
<span class="c">#                         &#39;International Tables Vol C Tables 4.2.6.8 and 6.1.1.4&#39;</span>
<span class="c">#    &#39;Cu&#39; &#39;Cu&#39; 0.3201 1.2651</span>
<span class="c">#                         &#39;International Tables Vol C Tables 4.2.6.8 and 6.1.1.4&#39;</span>

            <span class="c">#if oneblock: # add scattering factors for current phase here</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">loop_  _atom_type_symbol _atom_type_number_in_cell&#39;</span><span class="p">)</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="nb">reload</span><span class="p">(</span><span class="n">G2mth</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">HillSortElements</span><span class="p">(</span><span class="n">compDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;  &#39;</span> <span class="o">+</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
                             <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">compDict</span><span class="p">[</span><span class="n">elem</span><span class="p">],</span><span class="o">-</span><span class="mf">0.009</span><span class="p">,</span><span class="bp">True</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">formula</span><span class="p">:</span> <span class="n">formula</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span>
                <span class="n">formula</span> <span class="o">+=</span> <span class="n">elem</span>
                <span class="k">if</span> <span class="n">compDict</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span> <span class="o">==</span> <span class="n">Z</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">formula</span> <span class="o">+=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">compDict</span><span class="p">[</span><span class="n">elem</span><span class="p">]</span><span class="o">/</span><span class="n">Z</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s"># Note that Z affects _cell_formula_sum and _weight&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span> <span class="s">&#39;_cell_formula_units_Z&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">Z</span><span class="p">))</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span> <span class="s">&#39;_chemical_formula_sum&#39;</span><span class="p">,</span><span class="n">formula</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span> <span class="s">&#39;_chemical_formula_weight&#39;</span><span class="p">,</span>
                          <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">cellmass</span><span class="o">/</span><span class="n">Z</span><span class="p">,</span><span class="o">-</span><span class="mf">0.09</span><span class="p">,</span><span class="bp">True</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">WriteDistances</span><span class="p">(</span><span class="n">phasenam</span><span class="p">,</span><span class="n">SymOpList</span><span class="p">,</span><span class="n">offsetList</span><span class="p">,</span><span class="n">symOpList</span><span class="p">,</span><span class="n">G2oprList</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Report bond distances and angles for the CIF</span>

<span class="sd">            Note that _geom_*_symmetry_* fields are values of form</span>
<span class="sd">            n_klm where n is the symmetry operation in SymOpList (counted</span>
<span class="sd">            starting with 1) and (k-5, l-5, m-5) are translations to add</span>
<span class="sd">            to (x,y,z). See</span>
<span class="sd">            http://www.iucr.org/__data/iucr/cifdic_html/1/cif_core.dic/Igeom_angle_site_symmetry_.html</span>

<span class="sd">            TODO: need a method to select publication flags for distances/angles</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info            </span>
            <span class="n">Atoms</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="c"># create a dict for storing Pub flag for bonds/angles, if needed</span>
            <span class="k">if</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;DisAglHideFlag&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&quot;DisAglHideFlag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">DisAngSel</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&quot;DisAglHideFlag&quot;</span><span class="p">]</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">cia</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">]</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">fpfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::Afrac:&#39;</span>        
            <span class="n">cfrac</span> <span class="o">=</span> <span class="n">cx</span><span class="o">+</span><span class="mi">3</span>
            <span class="n">DisAglData</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># create a list of atoms, but skip atoms with zero occupancy</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fpfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::Afrac:&#39;</span>        
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fpfx</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">atom</span><span class="p">[</span><span class="n">cfrac</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cn</span><span class="p">:</span><span class="n">cn</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;DisAglCtls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
                <span class="c"># should not happen, since DisAglDialog should be called</span>
                <span class="c"># for all phases before getting here</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">DisAglDialog</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="p">,</span>
                    <span class="p">{},</span>
                    <span class="n">generalData</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                    <span class="k">return</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;OrigAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;TargAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">SymOpList</span><span class="p">,</span><span class="n">offsetList</span><span class="p">,</span><span class="n">symOpList</span><span class="p">,</span><span class="n">G2oprList</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">AllOps</span><span class="p">(</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">])</span>

            <span class="n">xpandSGdata</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">xpandSGdata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;SGOps&#39;</span><span class="p">:</span><span class="n">symOpList</span><span class="p">,</span>
                                <span class="s">&#39;SGInv&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                                <span class="s">&#39;SGLatt&#39;</span><span class="p">:</span><span class="s">&#39;P&#39;</span><span class="p">,</span>
                                <span class="s">&#39;SGCen&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),})</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpandSGdata</span>

            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="c">#+ volume</span>
            <span class="k">if</span> <span class="s">&#39;pId&#39;</span> <span class="ow">in</span> <span class="n">phasedict</span><span class="p">:</span>
                <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
                <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;covData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Covariance&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">AtomLabels</span><span class="p">,</span><span class="n">DistArray</span><span class="p">,</span><span class="n">AngArray</span> <span class="o">=</span> <span class="n">G2stMn</span><span class="o">.</span><span class="n">RetDistAngle</span><span class="p">(</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">],</span>
                    <span class="n">DisAglData</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c"># inside DistAngle for missing atom types in DisAglCtls</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;**** ERROR - try again but do &quot;Reset&quot; to fill in missing atom types ****&#39;</span><span class="p">)</span>
                    
            <span class="c"># loop over interatomic distances for this phase</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># MOLECULAR GEOMETRY&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_bond_atom_site_label_1&#39;</span> <span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_bond_atom_site_label_2&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_bond_distance&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_bond_site_symmetry_1&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_bond_site_symmetry_2&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_bond_publ_flag&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">AtomLabels</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">Dist</span> <span class="o">=</span> <span class="n">DistArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">D</span> <span class="ow">in</span> <span class="n">Dist</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">PutInCol</span><span class="p">(</span><span class="n">AtomLabels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">PutInCol</span><span class="p">(</span><span class="n">AtomLabels</span><span class="p">[</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">6</span><span class="p">)</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="n">D</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">sig</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.00009</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="n">sig</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot;  1_555 &quot;</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; {:3d}_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot;{:1d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">DisAngSel</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))):</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; no&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; yes&quot;</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="c"># loop over interatomic angles for this phase</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">loop_&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_angle_atom_site_label_1&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_angle_atom_site_label_2&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_angle_atom_site_label_3&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_angle&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_angle_site_symmetry_1&#39;</span> <span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_angle_site_symmetry_2&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_angle_site_symmetry_3&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _geom_angle_publ_flag&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">AtomLabels</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">Dist</span> <span class="o">=</span> <span class="n">DistArray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">tup</span> <span class="ow">in</span> <span class="n">AngArray</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">Dj</span> <span class="o">=</span> <span class="n">Dist</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">Dk</span> <span class="o">=</span> <span class="n">Dist</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">PutInCol</span><span class="p">(</span><span class="n">AtomLabels</span><span class="p">[</span><span class="n">Dj</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">PutInCol</span><span class="p">(</span><span class="n">AtomLabels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">PutInCol</span><span class="p">(</span><span class="n">AtomLabels</span><span class="p">[</span><span class="n">Dk</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="mi">6</span><span class="p">)</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sig</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">sig</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.009</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sig</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; {:3d}_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Dj</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">Dj</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot;{:1d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot;  1_555 &quot;</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; {:3d}_&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Dk</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">Dk</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot;{:1d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Dk</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]),</span><span class="n">i</span><span class="p">,</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Dj</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">DisAngSel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; no&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">+=</span> <span class="s">&quot; yes&quot;</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">WritePhaseInfo</span><span class="p">(</span><span class="n">phasenam</span><span class="p">):</span>
            <span class="s">&#39;Write out the phase information for the selected phase&#39;</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># phase info for &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; follows&#39;</span><span class="p">)</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info            </span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_phase_name&#39;</span><span class="p">,</span> <span class="n">phasenam</span><span class="p">)</span>
            <span class="n">cellList</span><span class="p">,</span><span class="n">cellSig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetCell</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
            <span class="n">defsigL</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="o">-</span><span class="mf">0.00001</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="p">[</span><span class="o">-</span><span class="mf">0.001</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.01</span><span class="p">]</span> <span class="c"># significance to use when no sigma</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;length_a&#39;</span><span class="p">,</span><span class="s">&#39;length_b&#39;</span><span class="p">,</span><span class="s">&#39;length_c&#39;</span><span class="p">,</span>
                     <span class="s">&#39;angle_alpha&#39;</span><span class="p">,</span><span class="s">&#39;angle_beta &#39;</span><span class="p">,</span><span class="s">&#39;angle_gamma&#39;</span><span class="p">,</span>
                     <span class="s">&#39;volume&#39;</span><span class="p">]</span>
            <span class="n">prevsig</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">lbl</span><span class="p">,</span><span class="n">defsig</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">sig</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">defsigL</span><span class="p">,</span><span class="n">cellList</span><span class="p">,</span><span class="n">cellSig</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sig</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span>
                    <span class="n">prevsig</span> <span class="o">=</span> <span class="o">-</span><span class="n">sig</span> <span class="c"># use this as the significance for next value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">defsig</span><span class="p">,</span><span class="n">prevsig</span><span class="p">),</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_cell_&#39;</span><span class="o">+</span><span class="n">lbl</span><span class="p">,</span><span class="n">txt</span><span class="p">)</span>
                    
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_symmetry_cell_setting&#39;</span><span class="p">,</span>
                         <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SGSys&#39;</span><span class="p">])</span>

            <span class="n">spacegroup</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">][</span><span class="s">&#39;SpGrp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c"># regularize capitalization and remove trailing H/R</span>
            <span class="n">spacegroup</span> <span class="o">=</span> <span class="n">spacegroup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">spacegroup</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;rh &#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_symmetry_space_group_name_H-M&#39;</span><span class="p">,</span><span class="n">spacegroup</span><span class="p">)</span>

            <span class="c"># generate symmetry operations including centering and center of symmetry</span>
            <span class="n">SymOpList</span><span class="p">,</span><span class="n">offsetList</span><span class="p">,</span><span class="n">symOpList</span><span class="p">,</span><span class="n">G2oprList</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">AllOps</span><span class="p">(</span>
                <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">])</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_</span><span class="se">\n</span><span class="s">    _space_group_symop_id</span><span class="se">\n</span><span class="s">    _space_group_symop_operation_xyz&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SymOpList</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   {:3d}  {:}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">op</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>

            <span class="c"># loop over histogram(s) used in this phase</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">oneblock</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span><span class="p">:</span>
                <span class="c"># report pointers to the histograms used in this phase</span>
                <span class="n">histlist</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;Histograms&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;Histograms&#39;</span><span class="p">][</span><span class="n">hist</span><span class="p">][</span><span class="s">&#39;Use&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">phasebyhistDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hist</span><span class="p">):</span>
                            <span class="n">phasebyhistDict</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">phasebyhistDict</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">phasenam</span><span class="p">,]</span>
                        <span class="n">blockid</span> <span class="o">=</span> <span class="n">datablockidDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">blockid</span><span class="p">:</span>
                            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Internal error: no block for data. Phase &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span>
                                <span class="n">phasenam</span><span class="p">)</span><span class="o">+</span><span class="s">&quot; histogram &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hist</span><span class="p">))</span>
                            <span class="n">histlist</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">break</span>
                        <span class="n">histlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blockid</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">histlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;# Note: phase has no associated data&#39;</span><span class="p">)</span>

            <span class="c"># report atom params</span>
            <span class="k">if</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;nuclear&#39;</span><span class="p">,</span><span class="s">&#39;macromolecular&#39;</span><span class="p">]:</span>        <span class="c">#this needs macromolecular variant, etc!</span>
                <span class="n">WriteAtomsNuclear</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s">&quot;no export for &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&quot; coordinates implemented&quot;</span>
            <span class="c"># report cell contents</span>
            <span class="n">WriteComposition</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span> <span class="ow">and</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;nuclear&#39;</span><span class="p">:</span>      <span class="c"># report distances and angles</span>
                <span class="n">WriteDistances</span><span class="p">(</span><span class="n">phasenam</span><span class="p">,</span><span class="n">SymOpList</span><span class="p">,</span><span class="n">offsetList</span><span class="p">,</span><span class="n">symOpList</span><span class="p">,</span><span class="n">G2oprList</span><span class="p">)</span>
                
        <span class="k">def</span> <span class="nf">Yfmt</span><span class="p">(</span><span class="n">ndec</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
            <span class="s">&#39;Format intensity values&#39;</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;{:.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ndec</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;f}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>  <span class="c"># strip zeros to right of decimal</span>
            <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>  <span class="c"># and decimal place when not needed</span>
            
        <span class="k">def</span> <span class="nf">WriteReflStat</span><span class="p">(</span><span class="n">refcount</span><span class="p">,</span><span class="n">hklmin</span><span class="p">,</span><span class="n">hklmax</span><span class="p">,</span><span class="n">dmin</span><span class="p">,</span><span class="n">dmax</span><span class="p">,</span><span class="n">nRefSets</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="s">&#39;Write reflection statistics&#39;</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_number_total&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">refcount</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">hklmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">nRefSets</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># hkl range has no meaning with multiple phases</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_limit_h_min&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hklmin</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_limit_h_max&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hklmax</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_limit_k_min&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hklmin</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_limit_k_max&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hklmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_limit_l_min&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hklmin</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_limit_l_max&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hklmax</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
            <span class="k">if</span> <span class="n">hklmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_d_resolution_low  &#39;</span><span class="p">,</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_d_resolution_high &#39;</span><span class="p">,</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span><span class="o">-</span><span class="mf">0.009</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">WritePowderData</span><span class="p">(</span><span class="n">histlbl</span><span class="p">):</span>
            <span class="s">&#39;Write out the selected powder diffraction histogram info&#39;</span>
            <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">histlbl</span><span class="p">]</span>
            <span class="n">inst</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Instrument Parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hId</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
            <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span>
            
            <span class="k">if</span> <span class="s">&#39;Lam1&#39;</span> <span class="ow">in</span> <span class="n">inst</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;I(L2)/I(L1)&#39;</span><span class="p">,</span><span class="n">inst</span><span class="p">[</span><span class="s">&#39;I(L2)/I(L1)&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">sratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;I(L2)/I(L1)&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0009</span><span class="p">)</span>
                <span class="n">lam1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Lam1&#39;</span><span class="p">,</span><span class="n">inst</span><span class="p">[</span><span class="s">&#39;Lam1&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">slam1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Lam1&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">)</span>
                <span class="n">lam2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Lam2&#39;</span><span class="p">,</span><span class="n">inst</span><span class="p">[</span><span class="s">&#39;Lam2&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">slam2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Lam2&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">)</span>
                <span class="c"># always assume Ka1 &amp; Ka2 if two wavelengths are present</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_diffrn_radiation_type&#39;</span><span class="p">,</span><span class="s">&#39;K</span><span class="se">\\</span><span class="s">a~1,2~&#39;</span><span class="p">)</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_&#39;</span> <span class="o">+</span> 
                             <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _diffrn_radiation_wavelength&#39;</span> <span class="o">+</span>
                             <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _diffrn_radiation_wavelength_wt&#39;</span> <span class="o">+</span> 
                             <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _diffrn_radiation_wavelength_id&#39;</span><span class="p">)</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;  &#39;</span> <span class="o">+</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">lam1</span><span class="p">,</span><span class="n">slam1</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span><span class="o">+</span>
                             <span class="n">PutInCol</span><span class="p">(</span><span class="s">&#39;1.0&#39;</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span> <span class="o">+</span> 
                             <span class="n">PutInCol</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;  &#39;</span> <span class="o">+</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">lam2</span><span class="p">,</span><span class="n">slam2</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span><span class="o">+</span>
                             <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="n">sratio</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span><span class="o">+</span>
                             <span class="n">PutInCol</span><span class="p">(</span><span class="s">&#39;2&#39;</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lam1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Lam&#39;</span><span class="p">,</span><span class="n">inst</span><span class="p">[</span><span class="s">&#39;Lam&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">slam1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Lam&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">)</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_diffrn_radiation_wavelength&#39;</span><span class="p">,</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">lam1</span><span class="p">,</span><span class="n">slam1</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">oneblock</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">phasebyhistDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histlbl</span><span class="p">):</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># No phases associated with this data set&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># PHASE TABLE&#39;</span><span class="p">)</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_&#39;</span> <span class="o">+</span>
                                 <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _pd_phase_id&#39;</span> <span class="o">+</span> 
                                 <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _pd_phase_block_id&#39;</span> <span class="o">+</span> 
                                 <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _pd_phase_mass_%&#39;</span><span class="p">)</span>
                    <span class="n">wtFrSum</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="k">for</span> <span class="n">phasenam</span> <span class="ow">in</span> <span class="n">phasebyhistDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histlbl</span><span class="p">):</span>
                        <span class="n">hapData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;Histograms&#39;</span><span class="p">][</span><span class="n">histlbl</span><span class="p">]</span>
                        <span class="n">General</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
                        <span class="n">wtFrSum</span> <span class="o">+=</span> <span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;Mass&#39;</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">phasenam</span> <span class="ow">in</span> <span class="n">phasebyhistDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histlbl</span><span class="p">):</span>
                        <span class="n">hapData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;Histograms&#39;</span><span class="p">][</span><span class="n">histlbl</span><span class="p">]</span>
                        <span class="n">General</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
                        <span class="n">wtFr</span> <span class="o">=</span> <span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">General</span><span class="p">[</span><span class="s">&#39;Mass&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">wtFrSum</span>
                        <span class="n">pfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span>
                        <span class="k">if</span> <span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="p">:</span>
                            <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Scale&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">wtFr</span><span class="o">/</span><span class="n">hapData</span><span class="p">[</span><span class="s">&#39;Scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sig</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0001</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span>
                            <span class="s">&#39;  &#39;</span><span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">])</span> <span class="o">+</span>
                            <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">datablockidDict</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span><span class="o">+</span>
                            <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">wtFr</span><span class="p">,</span><span class="n">sig</span><span class="p">)</span>
                            <span class="p">)</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_&#39;</span> <span class="o">+</span>
                                 <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _gsas_proc_phase_R_F_factor&#39;</span> <span class="o">+</span>
                                 <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _gsas_proc_phase_R_Fsqd_factor&#39;</span> <span class="o">+</span>
                                 <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _gsas_proc_phase_id&#39;</span> <span class="o">+</span>
                                 <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _gsas_proc_phase_block_id&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">phasenam</span> <span class="ow">in</span> <span class="n">phasebyhistDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">histlbl</span><span class="p">):</span>
                        <span class="n">pfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span>
                            <span class="s">&#39;  &#39;</span><span class="o">+</span>
                            <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Rf&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span><span class="o">-.</span><span class="mo">0000</span><span class="mi">9</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Rf^2&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">,</span><span class="o">-.</span><span class="mo">0000</span><span class="mi">9</span><span class="p">)</span><span class="o">+</span>
                            <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span>
                            <span class="s">&#39;  &#39;</span><span class="o">+</span><span class="n">datablockidDict</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span>
                            <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># single phase in this histogram</span>
                <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;0:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_refine_ls_R_F_factor      &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Rf&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_refine_ls_R_Fsqd_factor   &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Rf^2&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
                
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_prof_R_factor   &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;R&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_prof_wR_factor  &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;wR&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_gsas_proc_ls_prof_R_B_factor &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Rb&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_gsas_proc_ls_prof_wR_B_factor&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;wRb&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_prof_wR_expected&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;wRmin&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Instrument Parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;X&#39;</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_diffrn_radiation_probe&#39;</span><span class="p">,</span><span class="s">&#39;x-ray&#39;</span><span class="p">)</span>
                <span class="n">pola</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Instrument Parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Polariz.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pola</span><span class="p">:</span>
                    <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Polariz.&#39;</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0009</span><span class="p">)</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">pola</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">sig</span><span class="p">)</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_diffrn_radiation_polarisn_ratio&#39;</span><span class="p">,</span><span class="n">txt</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Instrument Parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;N&#39;</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_diffrn_radiation_probe&#39;</span><span class="p">,</span><span class="s">&#39;neutron&#39;</span><span class="p">)</span>
            <span class="c"># TOF (note that this may not be defined)</span>
            <span class="c">#if histblk[&#39;Instrument Parameters&#39;][0][&#39;Type&#39;][1][2] == &#39;T&#39;:</span>
            <span class="c">#    WriteCIFitem(&#39;_pd_meas_2theta_fixed&#39;,text)</span>
            

            <span class="c"># TODO: this will need help from Bob</span>
            <span class="c">#if not oneblock:</span>
            <span class="c">#WriteCIFitem(&#39;\n# SCATTERING FACTOR INFO&#39;)</span>
            <span class="c">#WriteCIFitem(&#39;loop_  _atom_type_symbol&#39;)</span>
            <span class="c">#if histblk[&#39;Instrument Parameters&#39;][0][&#39;Type&#39;][1][1] == &#39;X&#39;:</span>
            <span class="c">#    WriteCIFitem(&#39;      _atom_type_scat_dispersion_real&#39;)</span>
            <span class="c">#    WriteCIFitem(&#39;      _atom_type_scat_dispersion_imag&#39;)</span>
            <span class="c">#    for lbl in (&#39;a1&#39;,&#39;a2&#39;,&#39;a3&#39;, &#39;a4&#39;, &#39;b1&#39;, &#39;b2&#39;, &#39;b3&#39;, &#39;b4&#39;, &#39;c&#39;):</span>
            <span class="c">#        WriteCIFitem(&#39;      _atom_type_scat_Cromer_Mann_&#39;+lbl)</span>
            <span class="c">#elif histblk[&#39;Instrument Parameters&#39;][0][&#39;Type&#39;][1][1] == &#39;N&#39;:</span>
            <span class="c">#    WriteCIFitem(&#39;      _atom_type_scat_length_neutron&#39;)</span>
            <span class="c">#WriteCIFitem(&#39;      _atom_type_scat_source&#39;)</span>

            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_background_function&#39;</span><span class="p">,</span><span class="n">FormatBackground</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Background&#39;</span><span class="p">],</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]))</span>

            <span class="c"># TODO: this will need help from Bob</span>
            <span class="c">#WriteCIFitem(&#39;_exptl_absorpt_process_details&#39;,&#39;?&#39;)</span>
            <span class="c">#WriteCIFitem(&#39;_exptl_absorpt_correction_T_min&#39;,&#39;?&#39;)</span>
            <span class="c">#WriteCIFitem(&#39;_exptl_absorpt_correction_T_max&#39;,&#39;?&#39;)</span>
            <span class="c">#C extinction</span>
            <span class="c">#WRITE(IUCIF,&#39;(A)&#39;) &#39;# Extinction correction&#39;</span>
            <span class="c">#CALL WRVAL(IUCIF,&#39;_gsas_exptl_extinct_corr_T_min&#39;,TEXT(1:10))</span>
            <span class="c">#CALL WRVAL(IUCIF,&#39;_gsas_exptl_extinct_corr_T_max&#39;,TEXT(11:20))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">oneblock</span><span class="p">:</span>                 <span class="c"># instrumental profile terms go here</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_profile_function&#39;</span><span class="p">,</span> 
                    <span class="n">FormatInstProfile</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">],</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]))</span>

            <span class="c">#refprx = &#39;_refln.&#39; # mm</span>
            <span class="n">refprx</span> <span class="o">=</span> <span class="s">&#39;_refln_&#39;</span> <span class="c"># normal</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># STRUCTURE FACTOR TABLE&#39;</span><span class="p">)</span>            
            <span class="c"># compute maximum intensity reflection</span>
            <span class="n">Imax</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">phasenam</span> <span class="ow">in</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;Histograms&#39;</span><span class="p">][</span><span class="n">histlbl</span><span class="p">][</span><span class="s">&#39;Scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">refList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">][</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;RefList&#39;</span><span class="p">])</span>
                <span class="n">I100</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">refList</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">*</span><span class="n">refList</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
                <span class="c">#Icorr = np.array([refl[13] for refl in histblk[&#39;Reflection Lists&#39;][phasenam]])[0]</span>
                <span class="c">#FO2 = np.array([refl[8] for refl in histblk[&#39;Reflection Lists&#39;][phasenam]])</span>
                <span class="c">#I100 = scale*FO2*Icorr</span>
                <span class="n">Imax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Imax</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">I100</span><span class="p">))</span>

            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   _pd_refln_phase_id&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;index_h&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;index_k&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;index_l&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;F_squared_meas&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;F_squared_calc&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;phase_calc&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   _pd_refln_d_spacing&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Imax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   _gsas_i100_meas&#39;</span><span class="p">)</span>

            <span class="n">refcount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">hklmin</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">hklmax</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">phasenam</span> <span class="ow">in</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;Histograms&#39;</span><span class="p">][</span><span class="n">histlbl</span><span class="p">][</span><span class="s">&#39;Scale&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">phaseid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
                <span class="n">refcount</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">][</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;RefList&#39;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">ref</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">][</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;RefList&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;DEBUG: skipping reflection list&#39;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">hklmin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">hklmin</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">hklmax</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">dmax</span> <span class="o">=</span> <span class="n">dmin</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">phaseid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">hkl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]):</span>
                        <span class="n">hklmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span><span class="n">hklmax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">hklmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span><span class="n">hklmin</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hkl</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">I</span> <span class="ow">in</span> <span class="n">ref</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">10</span><span class="p">]:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="o">-</span><span class="mf">0.0009</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="o">-</span><span class="mf">0.9</span><span class="p">),</span><span class="mi">7</span><span class="p">)</span>
                    <span class="n">dmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span><span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">dmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span><span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="o">-</span><span class="mf">0.009</span><span class="p">),</span><span class="mi">8</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Imax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="mf">100.</span><span class="o">*</span><span class="n">I100</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="n">Imax</span><span class="p">,</span><span class="o">-</span><span class="mf">0.09</span><span class="p">),</span><span class="mi">6</span><span class="p">)</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>

            <span class="n">WriteReflStat</span><span class="p">(</span><span class="n">refcount</span><span class="p">,</span><span class="n">hklmin</span><span class="p">,</span><span class="n">hklmax</span><span class="p">,</span><span class="n">dmin</span><span class="p">,</span><span class="n">dmax</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Reflection Lists&#39;</span><span class="p">]))</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># POWDER DATA TABLE&#39;</span><span class="p">)</span>
            <span class="c"># is data fixed step? If the step varies by &lt;0.01% treat as fixed step</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span><span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span><span class="o">/</span><span class="mf">10000.</span><span class="p">:</span>
                <span class="n">fixedstep</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fixedstep</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="n">fixedstep</span><span class="p">:</span> <span class="c"># and not TOF</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_meas_2theta_range_min&#39;</span><span class="p">,</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_meas_2theta_range_max&#39;</span><span class="p">,</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_meas_2theta_range_inc&#39;</span><span class="p">,</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">))</span>
                <span class="c"># zero correct, if defined</span>
                <span class="n">zero</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">zerolst</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Instrument Parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Zero&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">zerolst</span><span class="p">:</span> <span class="n">zero</span> <span class="o">=</span> <span class="n">zerolst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Zero&#39;</span><span class="p">,</span><span class="n">zero</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">zero</span><span class="p">:</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_2theta_range_min&#39;</span><span class="p">,</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">zero</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">))</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_2theta_range_max&#39;</span><span class="p">,</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">zero</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">))</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_2theta_range_inc&#39;</span><span class="p">,</span> <span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">steps</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">))</span>
                
            <span class="k">if</span> <span class="n">zero</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_number_of_points&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_meas_number_of_points&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">loop_&#39;</span><span class="p">)</span>
            <span class="c">#            WriteCIFitem(&#39;   _pd_proc_d_spacing&#39;) # need easy way to get this</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fixedstep</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zero</span><span class="p">:</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   _pd_proc_2theta_corrected&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   _pd_meas_2theta_scan&#39;</span><span class="p">)</span>
            <span class="c"># at least for now, always report weights.</span>
            <span class="c">#if countsdata:</span>
            <span class="c">#    WriteCIFitem(&#39;   _pd_meas_counts_total&#39;)</span>
            <span class="c">#else:</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   _pd_meas_intensity_total&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   _pd_calc_intensity_total&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   _pd_proc_intensity_bkg_calc&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;   _pd_proc_ls_weight&#39;</span><span class="p">)</span>
            <span class="n">maxY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">maxY</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">maxY</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">10</span> <span class="c"># this should never happen, but...</span>
            <span class="n">ndec</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">maxY</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c"># 10 sig figs should be enough</span>
            <span class="n">maxSU</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">maxSU</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">maxSU</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># this should never happen, but...</span>
            <span class="n">ndecSU</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">maxSU</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c"># 8 sig figs should be enough</span>
            <span class="n">lowlim</span><span class="p">,</span><span class="n">highlim</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Limits&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;DEBUG: skipping profile list&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>    
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">yobs</span><span class="p">,</span><span class="n">yw</span><span class="p">,</span><span class="n">ycalc</span><span class="p">,</span><span class="n">ybkg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                                <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
                                                <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                                                <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">lowlim</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">highlim</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">yw</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c"># show the point is not in use</span>
    
                    <span class="k">if</span> <span class="n">fixedstep</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">zero</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00009</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">Yfmt</span><span class="p">(</span><span class="n">ndec</span><span class="p">,</span><span class="n">yobs</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">Yfmt</span><span class="p">(</span><span class="n">ndec</span><span class="p">,</span><span class="n">ycalc</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">Yfmt</span><span class="p">(</span><span class="n">ndec</span><span class="p">,</span><span class="n">ybkg</span><span class="p">),</span><span class="mi">11</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">Yfmt</span><span class="p">(</span><span class="n">ndecSU</span><span class="p">,</span><span class="n">yw</span><span class="p">),</span><span class="mi">9</span><span class="p">)</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&quot;  &quot;</span><span class="o">+</span><span class="n">s</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">WriteSingleXtalData</span><span class="p">(</span><span class="n">histlbl</span><span class="p">):</span>
            <span class="s">&#39;Write out the selected single crystal histogram info&#39;</span>
            <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">histlbl</span><span class="p">]</span>

            <span class="c">#refprx = &#39;_refln.&#39; # mm</span>
            <span class="n">refprx</span> <span class="o">=</span> <span class="s">&#39;_refln_&#39;</span> <span class="c"># normal</span>

            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s"># STRUCTURE FACTOR TABLE&#39;</span><span class="p">)</span>            
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;index_h&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;index_k&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;index_l&#39;</span> <span class="o">+</span>
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;F_squared_meas&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;F_squared_sigma&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;F_squared_calc&#39;</span> <span class="o">+</span> 
                         <span class="s">&#39;</span><span class="se">\n</span><span class="s">   &#39;</span> <span class="o">+</span> <span class="n">refprx</span> <span class="o">+</span> <span class="s">&#39;phase_calc&#39;</span>
                         <span class="p">)</span>

            <span class="n">hklmin</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">hklmax</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">dmin</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">refcount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="s">&#39;RefList&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;Data&#39;</span><span class="p">][</span><span class="s">&#39;RefList&#39;</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;  &quot;</span>
                <span class="k">if</span> <span class="n">hklmin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">hklmin</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">hklmax</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">dmax</span> <span class="o">=</span> <span class="n">dmin</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">hkl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">hklmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span><span class="n">hklmax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">hklmin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hkl</span><span class="p">,</span><span class="n">hklmin</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hkl</span><span class="p">),</span><span class="mi">4</span><span class="p">)</span>
                <span class="kn">import</span> <span class="nn">sys</span>
                <span class="k">if</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="mi">0</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="mi">0</span><span class="p">),</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="o">-</span><span class="mf">0.9</span><span class="p">),</span><span class="mi">7</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="n">ref</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">ref</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">/</span> <span class="n">ref</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="o">/</span><span class="mi">10</span><span class="p">)),</span><span class="mi">12</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span><span class="o">/</span><span class="mf">10.</span><span class="p">),</span><span class="mi">10</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">sig</span><span class="o">/</span><span class="mi">10</span><span class="p">)),</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">PutInCol</span><span class="p">(</span><span class="n">G2mth</span><span class="o">.</span><span class="n">ValEsd</span><span class="p">(</span><span class="n">ref</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span><span class="o">-</span><span class="mf">0.9</span><span class="p">),</span><span class="mi">7</span><span class="p">)</span>
                <span class="n">dmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dmax</span><span class="p">,</span><span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">dmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dmin</span><span class="p">,</span><span class="n">ref</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span><span class="p">:</span> <span class="c"># statistics only in a full CIF</span>
                <span class="n">WriteReflStat</span><span class="p">(</span><span class="n">refcount</span><span class="p">,</span><span class="n">hklmin</span><span class="p">,</span><span class="n">hklmax</span><span class="p">,</span><span class="n">dmin</span><span class="p">,</span><span class="n">dmax</span><span class="p">)</span>
                <span class="n">hId</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
                <span class="n">pfx</span> <span class="o">=</span> <span class="s">&#39;0:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hId</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;:&#39;</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_wR_factor_obs    &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;wR&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_R_F_factor_obs   &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Rf&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_reflns_R_Fsqd_factor_obs&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%.4f</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">pfx</span><span class="o">+</span><span class="s">&#39;Rf^2&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">100.</span><span class="p">))</span>
        <span class="k">def</span> <span class="nf">EditAuthor</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="s">&#39;dialog to edit the CIF author info&#39;</span>
            <span class="s">&#39;Edit the CIF author name&#39;</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">SingleStringDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="p">,</span>
                                          <span class="s">&#39;Get CIF Author&#39;</span><span class="p">,</span>
                                          <span class="s">&#39;Provide CIF Author name (Last, First)&#39;</span><span class="p">,</span>
                                          <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dlg</span><span class="o">.</span><span class="n">Show</span><span class="p">():</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">False</span>  <span class="c"># cancel was pressed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Controls&#39;</span><span class="p">][</span><span class="s">&quot;Author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="c"># save for future</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">def</span> <span class="nf">EditInstNames</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="s">&#39;Provide a dialog for editing instrument names&#39;</span>
            <span class="n">dictlist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">keylist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lbllist</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;PWDR&quot;</span><span class="p">):</span> 
                    <span class="n">key2</span> <span class="o">=</span> <span class="s">&quot;Sample Parameters&quot;</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;HKLF&quot;</span><span class="p">):</span> 
                    <span class="n">key2</span> <span class="o">=</span> <span class="s">&quot;Instrument Parameters&quot;</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">][</span><span class="n">key2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    
                <span class="n">lbllist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
                <span class="n">dictlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="n">keylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;InstrName&#39;</span><span class="p">)</span>
                <span class="n">instrname</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;InstrName&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">instrname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="s">&#39;InstrName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">return</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">CallScrolledMultiEditor</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="p">,</span><span class="n">dictlist</span><span class="p">,</span><span class="n">keylist</span><span class="p">,</span>
                <span class="n">prelbl</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">dictlist</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">postlbl</span><span class="o">=</span><span class="n">lbllist</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s">&#39;Instrument names&#39;</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="s">&quot;Edit instrument names. Note that a non-blank</span><span class="se">\n</span><span class="s">name is required for all histograms&quot;</span><span class="p">,</span>
                <span class="n">CopyButton</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            
        <span class="k">def</span> <span class="nf">EditRanges</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Edit the bond distance/angle search range; phase is determined from</span>
<span class="sd">            a pointer placed in the button object (.phasedict) that references the</span>
<span class="sd">            phase dictionary</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="n">but</span><span class="o">.</span><span class="n">phasedict</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">DisAglDialog</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="p">,</span>
                <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">],</span> <span class="c"># edited </span>
                <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">],</span> <span class="c"># defaults</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            
        <span class="k">def</span> <span class="nf">EditCIFDefaults</span><span class="p">():</span>
            <span class="sd">&#39;&#39;&#39;Fills the CIF Defaults window with controls for editing various CIF export</span>
<span class="sd">            parameters (mostly related to templates).</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="o">.</span><span class="n">DestroyChildren</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="s">&#39;Edit CIF settings&#39;</span><span class="p">)</span>
            <span class="n">vbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Creating file &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)))</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Edit CIF Author&#39;</span><span class="p">)</span>
            <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="n">EditAuthor</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Edit Instrument Name(s)&#39;</span><span class="p">)</span>
            <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="n">EditInstNames</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">cpnl</span> <span class="o">=</span> <span class="n">wxscroll</span><span class="o">.</span><span class="n">ScrolledPanel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">300</span><span class="p">))</span>
            <span class="n">cbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">cbox</span><span class="p">,</span><span class="n">cpnl</span><span class="p">)</span>          
            <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span>
                <span class="n">CIFtemplateSelect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span>
                                  <span class="n">cpnl</span><span class="p">,</span><span class="s">&#39;publ&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Controls&#39;</span><span class="p">],</span>
                                  <span class="n">EditCIFDefaults</span><span class="p">,</span>
                                  <span class="s">&quot;Publication (overall) template&quot;</span><span class="p">,</span>
                                  <span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">phasenam</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">cbox</span><span class="p">,</span><span class="n">cpnl</span><span class="p">)</span>          
                <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Phase &#39;</span><span class="o">+</span><span class="n">phasenam</span>
                <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info            </span>
                <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span>
                    <span class="n">CIFtemplateSelect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span>
                                      <span class="n">cpnl</span><span class="p">,</span><span class="s">&#39;phase&#39;</span><span class="p">,</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">],</span>
                                      <span class="n">EditCIFDefaults</span><span class="p">,</span>
                                      <span class="n">title</span><span class="p">,</span>
                                      <span class="n">phasenam</span><span class="p">),</span>
                    <span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
                <span class="n">cpnl</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">cbox</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;nuclear&#39;</span><span class="p">:</span>  
                    <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Edit distance/angle ranges&#39;</span><span class="p">)</span>
                    <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span>  <span class="c"># set a pointer to current phase info</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="n">EditRanges</span><span class="p">)</span>     <span class="c"># phase bond/angle ranges</span>
                    <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Set distance/angle publication flags&#39;</span><span class="p">)</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phasenam</span>  <span class="c"># set a pointer to current phase info     </span>
                    <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="n">SelectDisAglFlags</span><span class="p">)</span>     <span class="c"># phase bond/angle ranges</span>
                    <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">cbox</span><span class="p">,</span><span class="n">cpnl</span><span class="p">)</span>          
                <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Powder dataset &#39;</span><span class="o">+</span><span class="n">hist</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span>
                    <span class="n">CIFtemplateSelect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span>
                                      <span class="n">cpnl</span><span class="p">,</span><span class="s">&#39;powder&#39;</span><span class="p">,</span><span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Sample Parameters&quot;</span><span class="p">],</span>
                                      <span class="n">EditCIFDefaults</span><span class="p">,</span>
                                      <span class="n">title</span><span class="p">,</span>
                                      <span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Sample Parameters&quot;</span><span class="p">][</span><span class="s">&#39;InstrName&#39;</span><span class="p">]),</span>
                    <span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">cbox</span><span class="p">,</span><span class="n">cpnl</span><span class="p">)</span>          
                <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Single Xtal dataset &#39;</span><span class="o">+</span><span class="n">hist</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span>
                    <span class="n">CIFtemplateSelect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span>
                                      <span class="n">cpnl</span><span class="p">,</span><span class="s">&#39;single&#39;</span><span class="p">,</span><span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="n">EditCIFDefaults</span><span class="p">,</span>
                                      <span class="n">title</span><span class="p">,</span>
                                      <span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;InstrName&#39;</span><span class="p">]),</span>
                    <span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
            <span class="n">cpnl</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">cbox</span><span class="p">)</span>
            <span class="n">cpnl</span><span class="o">.</span><span class="n">SetAutoLayout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cpnl</span><span class="o">.</span><span class="n">SetupScrolling</span><span class="p">()</span>
            <span class="c">#cpnl.Bind(rw.EVT_RW_LAYOUT_NEEDED, self.OnLayoutNeeded) # needed if sizes change</span>
            <span class="n">cpnl</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>

            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">btnsizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StdDialogButtonSizer</span><span class="p">()</span>
            <span class="n">btn</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">,</span> <span class="s">&quot;Create CIF&quot;</span><span class="p">)</span>
            <span class="n">btn</span><span class="o">.</span><span class="n">SetDefault</span><span class="p">()</span>
            <span class="n">btnsizer</span><span class="o">.</span><span class="n">AddButton</span><span class="p">(</span><span class="n">btn</span><span class="p">)</span>
            <span class="n">btn</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_CANCEL</span><span class="p">)</span>
            <span class="n">btnsizer</span><span class="o">.</span><span class="n">AddButton</span><span class="p">(</span><span class="n">btn</span><span class="p">)</span>
            <span class="n">btnsizer</span><span class="o">.</span><span class="n">Realize</span><span class="p">()</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">btnsizer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">vbox</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>
            
        <span class="k">def</span> <span class="nf">OnToggleButton</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="s">&#39;Respond to press of ToggleButton in SelectDisAglFlags&#39;</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">but</span><span class="o">.</span><span class="n">GetValue</span><span class="p">():</span>                    
                <span class="n">but</span><span class="o">.</span><span class="n">DisAglSel</span><span class="p">[</span><span class="n">but</span><span class="o">.</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">but</span><span class="o">.</span><span class="n">DisAglSel</span><span class="p">[</span><span class="n">but</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">def</span> <span class="nf">keepTrue</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">keepFalse</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
                
        <span class="k">def</span> <span class="nf">SelectDisAglFlags</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="s">&#39;Select Distance/Angle use flags for the selected phase&#39;</span>
            <span class="n">phasenam</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span><span class="o">.</span><span class="n">phase</span>
            <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span>
            <span class="n">SymOpList</span><span class="p">,</span><span class="n">offsetList</span><span class="p">,</span><span class="n">symOpList</span><span class="p">,</span><span class="n">G2oprList</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">AllOps</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;SGData&#39;</span><span class="p">])</span>
            <span class="n">generalData</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span>
            <span class="c"># create a dict for storing Pub flag for bonds/angles, if needed</span>
            <span class="k">if</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;DisAglHideFlag&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&quot;DisAglHideFlag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">DisAngSel</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&quot;DisAglHideFlag&quot;</span><span class="p">]</span>

            <span class="n">cx</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">cia</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;AtomPtrs&#39;</span><span class="p">]</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">ct</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">cfrac</span> <span class="o">=</span> <span class="n">cx</span><span class="o">+</span><span class="mi">3</span>
            <span class="n">DisAglData</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># create a list of atoms, but skip atoms with zero occupancy</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fpfx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">])</span><span class="o">+</span><span class="s">&#39;::Afrac:&#39;</span>        
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;Atoms&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parmDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fpfx</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">atom</span><span class="p">[</span><span class="n">cfrac</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">xyz</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cn</span><span class="p">:</span><span class="n">cn</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">atom</span><span class="p">[</span><span class="n">cx</span><span class="p">:</span><span class="n">cx</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;DisAglCtls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">generalData</span><span class="p">:</span>
                <span class="c"># should not be used, since DisAglDialog should be called</span>
                <span class="c"># for all phases before getting here</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">DisAglDialog</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span>
                    <span class="p">{},</span>
                    <span class="n">generalData</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                    <span class="k">return</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Dialog</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">DEFAULT_DIALOG_STYLE</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">RESIZE_BORDER</span><span class="p">)</span>
            <span class="n">vbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dlg</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Searching distances for phase &#39;</span><span class="o">+</span><span class="n">phasenam</span>
                                <span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Please wait...&#39;</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">vbox</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">CenterOnParent</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span> <span class="c"># post &quot;please wait&quot;</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span> <span class="c"># and change cursor</span>

            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;OrigAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;TargAtoms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xyz</span>
            <span class="n">SymOpList</span><span class="p">,</span><span class="n">offsetList</span><span class="p">,</span><span class="n">symOpList</span><span class="p">,</span><span class="n">G2oprList</span> <span class="o">=</span> <span class="n">G2spc</span><span class="o">.</span><span class="n">AllOps</span><span class="p">(</span>
                <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">])</span>

            <span class="n">xpandSGdata</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">xpandSGdata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;SGOps&#39;</span><span class="p">:</span><span class="n">symOpList</span><span class="p">,</span>
                                <span class="s">&#39;SGInv&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                                <span class="s">&#39;SGLatt&#39;</span><span class="p">:</span><span class="s">&#39;P&#39;</span><span class="p">,</span>
                                <span class="s">&#39;SGCen&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),})</span>
            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;SGData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xpandSGdata</span>

            <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;Cell&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span> <span class="c">#+ volume</span>
            <span class="k">if</span> <span class="s">&#39;pId&#39;</span> <span class="ow">in</span> <span class="n">phasedict</span><span class="p">:</span>
                <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
                <span class="n">DisAglData</span><span class="p">[</span><span class="s">&#39;covData&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Covariance&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">AtomLabels</span><span class="p">,</span><span class="n">DistArray</span><span class="p">,</span><span class="n">AngArray</span> <span class="o">=</span> <span class="n">G2stMn</span><span class="o">.</span><span class="n">RetDistAngle</span><span class="p">(</span>
                    <span class="n">generalData</span><span class="p">[</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">],</span>
                    <span class="n">DisAglData</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>        <span class="c"># inside DistAngle for missing atom types in DisAglCtls</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;**** ERROR - try again but do &quot;Reset&quot; to fill in missing atom types ****&#39;</span><span class="p">)</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
            <span class="n">txt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="s">&#39;Set publication flags for distances and angles in</span><span class="se">\n</span><span class="s">phase &#39;</span><span class="o">+</span><span class="n">phasenam</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span> 
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dlg</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span>
                                   <span class="s">&#39;The default is to flag all distances and angles as to be&#39;</span><span class="o">+</span>
                                   <span class="s">&#39;</span><span class="se">\n</span><span class="s">published. Change this by pressing appropriate buttons.&#39;</span><span class="p">),</span>
                     <span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
            <span class="n">hbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">hbox</span><span class="p">)</span>
            <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">dlg</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Button appearance: &#39;</span><span class="p">))</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span><span class="n">dlg</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Publish&#39;</span><span class="p">)</span>
            <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TOGGLEBUTTON</span><span class="p">,</span><span class="n">keepFalse</span><span class="p">)</span>
            <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">)</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span><span class="n">dlg</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&quot;Don&#39;t publish&quot;</span><span class="p">)</span>
            <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TOGGLEBUTTON</span><span class="p">,</span><span class="n">keepTrue</span><span class="p">)</span>
            <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">)</span>
            <span class="n">but</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">vbox</span><span class="p">,</span><span class="n">dlg</span><span class="p">)</span>          
            
            <span class="n">cpnl</span> <span class="o">=</span> <span class="n">wxscroll</span><span class="o">.</span><span class="n">ScrolledPanel</span><span class="p">(</span><span class="n">dlg</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">300</span><span class="p">))</span>
            <span class="n">cbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">DistArray</span><span class="p">):</span>
                <span class="n">karr</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">UsedCols</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span>
                                   <span class="s">&#39;distances to/angles around atom &#39;</span><span class="o">+</span><span class="n">AtomLabels</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
                <span class="c">#dbox = wx.GridBagSizer(hgap=5)</span>
                <span class="n">dbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GridBagSizer</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">D</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DistArray</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
                    <span class="n">karr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;{:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">sym</span> <span class="o">=</span> <span class="s">&quot; [{:d} {:d} {:d}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot; #{:d}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">dbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">AtomLabels</span><span class="p">[</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                             <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                             <span class="p">)</span>                    
                    <span class="n">dbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">sym</span><span class="p">),</span>
                             <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                             <span class="p">)</span>
                    <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">karr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">DisAglSel</span> <span class="o">=</span> <span class="n">DisAngSel</span>
                    <span class="k">if</span> <span class="n">DisAngSel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">but</span><span class="o">.</span><span class="n">key</span><span class="p">):</span> <span class="n">but</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TOGGLEBUTTON</span><span class="p">,</span><span class="n">OnToggleButton</span><span class="p">)</span>
                    <span class="n">dbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">border</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">D</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">AngArray</span><span class="p">[</span><span class="n">c</span><span class="p">]):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="s">&quot;{:.1f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">D</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ToggleButton</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">karr</span><span class="p">[</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">c</span><span class="p">,</span><span class="n">karr</span><span class="p">[</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">DisAglSel</span> <span class="o">=</span> <span class="n">DisAngSel</span>
                    <span class="k">if</span> <span class="n">DisAngSel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">but</span><span class="o">.</span><span class="n">key</span><span class="p">):</span> <span class="n">but</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TOGGLEBUTTON</span><span class="p">,</span><span class="n">OnToggleButton</span><span class="p">)</span>
                    <span class="n">dbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,(</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span><span class="n">border</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">UsedCols</span><span class="p">[</span><span class="n">D</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">D</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DistArray</span><span class="p">[</span><span class="n">c</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> <span class="c"># label columns that are used</span>
                    <span class="k">if</span> <span class="n">UsedCols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                        <span class="n">dbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">AtomLabels</span><span class="p">[</span><span class="n">D</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
                                 <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
                                 <span class="n">flag</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span>
                                 <span class="p">)</span>
                <span class="n">dbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;distance&#39;</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                                 <span class="n">flag</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span>
                                 <span class="p">)</span>
                <span class="n">cbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">dbox</span><span class="p">)</span>
                <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">cbox</span><span class="p">,</span><span class="n">cpnl</span><span class="p">)</span>          
            <span class="n">cpnl</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">cbox</span><span class="p">)</span>
            <span class="n">cpnl</span><span class="o">.</span><span class="n">SetAutoLayout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cpnl</span><span class="o">.</span><span class="n">SetupScrolling</span><span class="p">()</span>
            <span class="c">#cpnl.Bind(rw.EVT_RW_LAYOUT_NEEDED, self.OnLayoutNeeded) # needed if sizes change</span>
            <span class="n">cpnl</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>

            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">btnsizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StdDialogButtonSizer</span><span class="p">()</span>
            <span class="n">btn</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">dlg</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">,</span> <span class="s">&quot;Done&quot;</span><span class="p">)</span>
            <span class="n">btn</span><span class="o">.</span><span class="n">SetDefault</span><span class="p">()</span>
            <span class="n">btnsizer</span><span class="o">.</span><span class="n">AddButton</span><span class="p">(</span><span class="n">btn</span><span class="p">)</span>
            <span class="n">btnsizer</span><span class="o">.</span><span class="n">Realize</span><span class="p">()</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">btnsizer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">vbox</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">dlg</span><span class="p">)</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>
            
            <span class="n">dlg</span><span class="o">.</span><span class="n">CenterOnParent</span><span class="p">()</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span>
            
<span class="c">#***** end of functions for export method =======================================</span>
<span class="c">#=================================================================================</span>

        <span class="c"># the export process starts here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitExport</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="c"># load all of the tree into a set of dicts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadTree</span><span class="p">()</span>
        <span class="c"># create a dict with refined values and their uncertainties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadParmDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ExportSelect</span><span class="p">(</span><span class="n">AskFile</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">==</span><span class="s">&#39;simple&#39;</span><span class="p">)):</span>    <span class="c"># set export parameters</span>
            <span class="k">return</span> 
        <span class="c"># Someday: get restraint &amp; constraint info</span>
        <span class="c">#restraintDict = self.OverallParms.get(&#39;Restraints&#39;,{})</span>
        <span class="c">#for i in  self.OverallParms[&#39;Constraints&#39;]:</span>
        <span class="c">#    print i</span>
        <span class="c">#    for j in self.OverallParms[&#39;Constraints&#39;][i]:</span>
        <span class="c">#        print j</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M&quot;</span><span class="p">)</span>
        <span class="c"># is there anything to export?</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ErrorDialog</span><span class="p">(</span>
               <span class="s">&#39;Empty project&#39;</span><span class="p">,</span>
               <span class="s">&#39;Project does not contain any data or phases. Are they interconnected?&#39;</span><span class="p">)</span>
           <span class="k">return</span>
        <span class="c"># get the project file name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="o">.</span><span class="n">GSASprojectfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">:</span> <span class="c"># none defined &amp; needed, save as GPX to get one</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="o">.</span><span class="n">OnFileSaveas</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="o">.</span><span class="n">GSASprojectfile</span><span class="p">:</span> <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="o">.</span><span class="n">GSASprojectfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c"># test for quick CIF mode or no data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">phasenam</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># include all phases</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;simple&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentExportType</span> <span class="o">==</span> <span class="s">&#39;phase&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># this check is probably not needed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ErrorDialog</span><span class="p">(</span>
                    <span class="s">&#39;No phase present&#39;</span><span class="p">,</span>
                    <span class="s">&#39;Cannot create a coordinates CIF with no phases&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">oneblock</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># quick mode: get selected phase</span>
                <span class="n">phasenam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasenam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s">&quot;simple&quot;</span><span class="p">:</span> <span class="c"># powder/single xtal data export</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">oneblock</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># Project export: will this require a multiblock CIF?</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">oneblock</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">oneblock</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># one phase, one dataset, Full CIF</span>
            <span class="n">oneblock</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># make sure required information is present</span>
        <span class="c"># get CIF author name -- required for full CIFs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Controls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Author&quot;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">EditAuthor</span><span class="p">():</span> <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortauthorname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span>

        <span class="c"># check there is an instrument name for every histogram</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span><span class="p">:</span>
            <span class="n">invalid</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">key3</span> <span class="o">=</span> <span class="s">&#39;InstrName&#39;</span>
            <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;PWDR&quot;</span><span class="p">):</span> 
                    <span class="n">key2</span> <span class="o">=</span> <span class="s">&quot;Sample Parameters&quot;</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;HKLF&quot;</span><span class="p">):</span> 
                    <span class="n">key2</span> <span class="o">=</span> <span class="s">&quot;Instrument Parameters&quot;</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">][</span><span class="n">key2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>                    
                <span class="n">instrname</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">instrname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">key3</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="n">invalid</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">instrname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">invalid</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">invalid</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">invalid</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">Note: it may be faster to set the name for</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;one histogram for each instrument and use the</span><span class="se">\n</span><span class="s">&quot;</span>
                    <span class="s">&quot;File/Copy option to duplicate the name&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">EditInstNames</span><span class="p">():</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span><span class="p">:</span>
            <span class="c"># check for a distance-angle range search range for each phase</span>
            <span class="k">for</span> <span class="n">phasenam</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c">#i = self.Phases[phasenam][&#39;pId&#39;]</span>
                <span class="n">phasedict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info            </span>
                <span class="k">if</span> <span class="s">&#39;DisAglCtls&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">]:</span>
                    <span class="n">dlg</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">DisAglDialog</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="p">,</span>
                        <span class="p">{},</span>
                        <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                        <span class="n">phasedict</span><span class="p">[</span><span class="s">&#39;General&#39;</span><span class="p">][</span><span class="s">&#39;DisAglCtls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetData</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                        <span class="k">return</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">oneblock</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span><span class="p">:</span>
            <span class="c"># select a dataset to use (there should only be one set in one block,</span>
            <span class="c"># but take whatever comes 1st)</span>
            <span class="k">for</span> <span class="n">hist</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">:</span>
                <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;PWDR&quot;</span><span class="p">):</span> 
                    <span class="n">instnam</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Sample Parameters&quot;</span><span class="p">][</span><span class="s">&#39;InstrName&#39;</span><span class="p">]</span>
                    <span class="k">break</span> <span class="c"># ignore all but 1st data histogram</span>
                <span class="k">elif</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;HKLF&quot;</span><span class="p">):</span> 
                    <span class="n">instnam</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;InstrName&#39;</span><span class="p">]</span>
                    <span class="k">break</span> <span class="c"># ignore all but 1st data histogram</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span><span class="p">:</span> <span class="c"># give the user a chance to edit all defaults</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Dialog</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">DEFAULT_DIALOG_STYLE</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">RESIZE_BORDER</span><span class="p">)</span>
            <span class="n">EditCIFDefaults</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="o">.</span><span class="n">CenterOnParent</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
                <span class="k">return</span>
        <span class="c">#======================================================================</span>
        <span class="c"># Start writing the CIF - single block</span>
        <span class="c">#======================================================================</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Writing CIF output to file &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;...&quot;</span><span class="p">)</span>
        <span class="n">openCIF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentExportType</span> <span class="o">==</span> <span class="s">&#39;single&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentExportType</span> <span class="o">==</span> <span class="s">&#39;powder&#39;</span><span class="p">:</span>
            <span class="c">#======Data only CIF (powder/xtal) ====================================</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">histnam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span> <span class="o">=</span> <span class="n">hist</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;data_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;PWDR&quot;</span><span class="p">):</span>
                <span class="n">WritePowderData</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;HKLF&quot;</span><span class="p">):</span>
                <span class="n">WriteSingleXtalData</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;should not happen&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">quickmode</span><span class="p">:</span>
            <span class="c">#====Phase only CIF ====================================================</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;data_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phasenam</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># if not already selected, select the first phase (should be one) </span>
                <span class="n">phasenam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c">#print &#39;phasenam&#39;,phasenam</span>
            <span class="n">phaseblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info</span>
            <span class="c"># report the phase info</span>
            <span class="n">WritePhaseInfo</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">oneblock</span><span class="p">:</span>
            <span class="c">#====Single block, data &amp; phase CIF ===================================</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;data_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phasenam</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># if not already selected, select the first phase (should be one) </span>
                <span class="n">phasenam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c">#print &#39;phasenam&#39;,phasenam</span>
            <span class="n">phaseblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="c"># pointer to current phase info</span>
            <span class="n">instnam</span> <span class="o">=</span> <span class="n">instnam</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_block_id&#39;</span><span class="p">,</span>
                         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span>
                         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortauthorname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span> <span class="n">instnam</span><span class="p">)</span>
            <span class="n">WriteAudit</span><span class="p">()</span>
            <span class="n">writeCIFtemplate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Controls&#39;</span><span class="p">],</span><span class="s">&#39;publ&#39;</span><span class="p">)</span> <span class="c"># overall (publication) template</span>
            <span class="n">WriteOverall</span><span class="p">()</span>
            <span class="n">writeCIFtemplate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;General&#39;</span><span class="p">],</span><span class="s">&#39;phase&#39;</span><span class="p">,</span><span class="n">phasenam</span><span class="p">)</span> <span class="c"># write phase template</span>
            <span class="c"># report the phase info</span>
            <span class="n">WritePhaseInfo</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;PWDR&quot;</span><span class="p">):</span>
                <span class="c"># preferred orientation</span>
                <span class="n">SH</span> <span class="o">=</span> <span class="n">FormatSH</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
                <span class="n">MD</span> <span class="o">=</span> <span class="n">FormatHAPpo</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">SH</span> <span class="ow">and</span> <span class="n">MD</span><span class="p">:</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_pref_orient_corr&#39;</span><span class="p">,</span> <span class="n">SH</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">MD</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">SH</span> <span class="ow">or</span> <span class="n">MD</span><span class="p">:</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_pref_orient_corr&#39;</span><span class="p">,</span> <span class="n">SH</span> <span class="o">+</span> <span class="n">MD</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_pref_orient_corr&#39;</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">)</span>
                    <span class="c"># report profile, since one-block: include both histogram and phase info</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_profile_function&#39;</span><span class="p">,</span>
                    <span class="n">FormatInstProfile</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">],</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">])</span>
                    <span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">FormatPhaseProfile</span><span class="p">(</span><span class="n">phasenam</span><span class="p">))</span>
                <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">][</span><span class="s">&quot;Sample Parameters&quot;</span><span class="p">]</span>
                <span class="n">writeCIFtemplate</span><span class="p">(</span><span class="n">histblk</span><span class="p">,</span><span class="s">&#39;powder&#39;</span><span class="p">,</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;InstrName&#39;</span><span class="p">])</span> <span class="c"># write powder template</span>
                <span class="n">WritePowderData</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;HKLF&quot;</span><span class="p">):</span>
                <span class="n">histprm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">][</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">writeCIFtemplate</span><span class="p">(</span><span class="n">histprm</span><span class="p">,</span><span class="s">&#39;single&#39;</span><span class="p">,</span><span class="n">histprm</span><span class="p">[</span><span class="s">&#39;InstrName&#39;</span><span class="p">])</span> <span class="c"># single crystal template</span>
                <span class="n">WriteSingleXtalData</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#=== multiblock: multiple phases and/or histograms ====================</span>
            <span class="n">nsteps</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ProgressDialog</span><span class="p">(</span><span class="s">&#39;CIF progress&#39;</span><span class="p">,</span><span class="s">&#39;starting&#39;</span><span class="p">,</span><span class="n">nsteps</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="p">)</span>
                <span class="n">Size</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()</span>
                <span class="n">Size</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">),</span><span class="n">Size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c"># increase size along x</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">SetSize</span><span class="p">(</span><span class="n">Size</span><span class="p">)</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">CenterOnParent</span><span class="p">()</span>

                <span class="c"># publication info</span>
                <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">step</span><span class="p">,</span><span class="s">&quot;Exporting overall section&quot;</span><span class="p">)</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">data_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="o">+</span><span class="s">&#39;_publ&#39;</span><span class="p">)</span>
                <span class="n">WriteAudit</span><span class="p">()</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_block_id&#39;</span><span class="p">,</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortauthorname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|Overall&quot;</span><span class="p">)</span>
                <span class="n">writeCIFtemplate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OverallParms</span><span class="p">[</span><span class="s">&#39;Controls&#39;</span><span class="p">],</span><span class="s">&#39;publ&#39;</span><span class="p">)</span> <span class="c">#insert the publication template</span>
                <span class="c"># ``template_publ.cif`` or a modified version</span>
                <span class="c"># overall info</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;data_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;_overall&#39;</span><span class="p">)</span>
                <span class="n">WriteOverall</span><span class="p">()</span>
                <span class="c">#============================================================</span>
                <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;# POINTERS TO PHASE AND HISTOGRAM BLOCKS&#39;</span><span class="p">)</span>
                <span class="n">datablockidDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># save block names here -- N.B. check for conflicts between phase &amp; hist names (unlikely!)</span>
                <span class="c"># loop over phase blocks</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">loopprefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_   _pd_phase_block_id&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loopprefix</span> <span class="o">=</span> <span class="s">&#39;_pd_phase_block_id&#39;</span>

                <span class="k">for</span> <span class="n">phasenam</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
                    <span class="n">datablockidDict</span><span class="p">[</span><span class="n">phasenam</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span>
                                 <span class="s">&#39;phase_&#39;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;|&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortauthorname</span><span class="p">))</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">loopprefix</span><span class="p">,</span><span class="n">datablockidDict</span><span class="p">[</span><span class="n">phasenam</span><span class="p">])</span>
                <span class="c"># loop over data blocks</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">loopprefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;loop_   _pd_block_diffractogram_id&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loopprefix</span> <span class="o">=</span> <span class="s">&#39;_pd_block_diffractogram_id&#39;</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span>
                    <span class="n">instnam</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Sample Parameters&quot;</span><span class="p">][</span><span class="s">&#39;InstrName&#39;</span><span class="p">]</span>
                    <span class="n">instnam</span> <span class="o">=</span> <span class="n">instnam</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
                    <span class="n">datablockidDict</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span>
                                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortauthorname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span>
                                             <span class="n">instnam</span> <span class="o">+</span> <span class="s">&quot;_hist_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">loopprefix</span><span class="p">,</span><span class="n">datablockidDict</span><span class="p">[</span><span class="n">hist</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span>
                    <span class="n">instnam</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;InstrName&#39;</span><span class="p">]</span>
                    <span class="n">instnam</span> <span class="o">=</span> <span class="n">instnam</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">histblk</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]</span>
                    <span class="n">datablockidDict</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFdate</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span>
                                             <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shortauthorname</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;|&quot;</span> <span class="o">+</span>
                                             <span class="n">instnam</span> <span class="o">+</span> <span class="s">&quot;_hist_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="n">loopprefix</span><span class="p">,</span><span class="n">datablockidDict</span><span class="p">[</span><span class="n">hist</span><span class="p">])</span>
                <span class="c">#============================================================</span>
                <span class="c"># loop over phases, exporting them</span>
                <span class="n">phasebyhistDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># create a cross-reference to phases by histogram</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">phasenam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                    <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">step</span><span class="p">,</span><span class="s">&quot;Exporting phase &quot;</span><span class="o">+</span><span class="n">phasenam</span><span class="o">+</span><span class="s">&#39; (#&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;pId&#39;</span><span class="p">]</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">data_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="o">+</span><span class="s">&quot;_phase_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;# Information for phase &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_block_id&#39;</span><span class="p">,</span><span class="n">datablockidDict</span><span class="p">[</span><span class="n">phasenam</span><span class="p">])</span>
                    <span class="c"># report the phase</span>
                    <span class="n">writeCIFtemplate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Phases</span><span class="p">[</span><span class="n">phasenam</span><span class="p">][</span><span class="s">&#39;General&#39;</span><span class="p">],</span><span class="s">&#39;phase&#39;</span><span class="p">,</span><span class="n">phasenam</span><span class="p">)</span> <span class="c"># write phase template</span>
                    <span class="n">WritePhaseInfo</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
                    <span class="c"># preferred orientation</span>
                    <span class="n">SH</span> <span class="o">=</span> <span class="n">FormatSH</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
                    <span class="n">MD</span> <span class="o">=</span> <span class="n">FormatHAPpo</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">SH</span> <span class="ow">and</span> <span class="n">MD</span><span class="p">:</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_pref_orient_corr&#39;</span><span class="p">,</span> <span class="n">SH</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">MD</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">SH</span> <span class="ow">or</span> <span class="n">MD</span><span class="p">:</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_pref_orient_corr&#39;</span><span class="p">,</span> <span class="n">SH</span> <span class="o">+</span> <span class="n">MD</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_pref_orient_corr&#39;</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">)</span>
                    <span class="c"># report sample profile terms</span>
                    <span class="n">PP</span> <span class="o">=</span> <span class="n">FormatPhaseProfile</span><span class="p">(</span><span class="n">phasenam</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">PP</span><span class="p">:</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_profile_function&#39;</span><span class="p">,</span><span class="n">PP</span><span class="p">)</span>

                <span class="c">#============================================================</span>
                <span class="c"># loop over histograms, exporting them</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">powderDict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;PWDR&quot;</span><span class="p">):</span> 
                        <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">step</span><span class="p">,</span><span class="s">&quot;Exporting &quot;</span><span class="o">+</span><span class="n">hist</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">data_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="o">+</span><span class="s">&quot;_pwd_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="c">#instnam = histblk[&quot;Sample Parameters&quot;][&#39;InstrName&#39;]</span>
                        <span class="c"># report instrumental profile terms</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_proc_ls_profile_function&#39;</span><span class="p">,</span>
                            <span class="n">FormatInstProfile</span><span class="p">(</span><span class="n">histblk</span><span class="p">[</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">],</span><span class="n">histblk</span><span class="p">[</span><span class="s">&#39;hId&#39;</span><span class="p">]))</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;# Information for histogram &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;: &#39;</span><span class="o">+</span><span class="n">hist</span><span class="p">)</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_block_id&#39;</span><span class="p">,</span><span class="n">datablockidDict</span><span class="p">[</span><span class="n">hist</span><span class="p">])</span>
                        <span class="n">histprm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">][</span><span class="s">&quot;Sample Parameters&quot;</span><span class="p">]</span>
                        <span class="n">writeCIFtemplate</span><span class="p">(</span><span class="n">histprm</span><span class="p">,</span><span class="s">&#39;powder&#39;</span><span class="p">,</span><span class="n">histprm</span><span class="p">[</span><span class="s">&#39;InstrName&#39;</span><span class="p">])</span> <span class="c"># powder template</span>
                        <span class="n">WritePowderData</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xtalDict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">histblk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">hist</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;HKLF&quot;</span><span class="p">):</span> 
                        <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">dlg</span><span class="o">.</span><span class="n">Update</span><span class="p">(</span><span class="n">step</span><span class="p">,</span><span class="s">&quot;Exporting &quot;</span><span class="o">+</span><span class="n">hist</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">data_&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIFname</span><span class="o">+</span><span class="s">&quot;_sx_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                        <span class="c">#instnam = histblk[&quot;Instrument Parameters&quot;][0][&#39;InstrName&#39;]</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;# Information for histogram &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;: &#39;</span><span class="o">+</span><span class="n">hist</span><span class="p">)</span>
                        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;_pd_block_id&#39;</span><span class="p">,</span><span class="n">datablockidDict</span><span class="p">[</span><span class="n">hist</span><span class="p">])</span>
                        <span class="n">histprm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Histograms</span><span class="p">[</span><span class="n">hist</span><span class="p">][</span><span class="s">&quot;Instrument Parameters&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">writeCIFtemplate</span><span class="p">(</span><span class="n">histprm</span><span class="p">,</span><span class="s">&#39;single&#39;</span><span class="p">,</span><span class="n">histprm</span><span class="p">[</span><span class="s">&#39;InstrName&#39;</span><span class="p">])</span> <span class="c"># single crystal template</span>
                        <span class="n">WriteSingleXtalData</span><span class="p">(</span><span class="n">hist</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="k">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">G2frame</span><span class="o">.</span><span class="n">ErrorDialog</span><span class="p">(</span><span class="s">&#39;Exception&#39;</span><span class="p">,</span>
                                         <span class="s">&#39;Error occurred in CIF creation. &#39;</span><span class="o">+</span>
                                         <span class="s">&#39;See full error message in console output &#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

        <span class="n">WriteCIFitem</span><span class="p">(</span><span class="s">&#39;#--&#39;</span> <span class="o">+</span> <span class="mi">15</span><span class="o">*</span><span class="s">&#39;eof--&#39;</span> <span class="o">+</span> <span class="s">&#39;#&#39;</span><span class="p">)</span>
        <span class="n">closeCIF</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;...export completed&quot;</span><span class="p">)</span>
        <span class="c"># end of CIF export</span>
</div></div>
<div class="viewcode-block" id="ExportPhaseCIF"><a class="viewcode-back" href="../exports.html#G2export_CIF.ExportPhaseCIF">[docs]</a><span class="k">class</span> <span class="nc">ExportPhaseCIF</span><span class="p">(</span><span class="n">ExportCIF</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Used to create a simple CIF of at most one phase. Uses exact same code as</span>
<span class="sd">    :class:`ExportCIF` except that `self.mode` is set to &quot;simple&quot; in `self.InitExport`.</span>
<span class="sd">    Shows up in menu as Quick CIF.</span>

<span class="sd">    :param wx.Frame G2frame: reference to main GSAS-II frame</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">G2frame</span><span class="p">):</span>
        <span class="n">G2IO</span><span class="o">.</span><span class="n">ExportBaseclass</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">G2frame</span><span class="o">=</span><span class="n">G2frame</span><span class="p">,</span>
            <span class="n">formatName</span> <span class="o">=</span> <span class="s">&#39;Quick CIF&#39;</span><span class="p">,</span>
            <span class="n">extension</span><span class="o">=</span><span class="s">&#39;.cif&#39;</span><span class="p">,</span>
            <span class="n">longFormatName</span> <span class="o">=</span> <span class="s">&#39;Export one phase in CIF&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exporttype</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;phase&#39;</span><span class="p">]</span>
        <span class="c"># CIF-specific items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;simple&#39;</span>
</div>
<div class="viewcode-block" id="ExportDataCIF"><a class="viewcode-back" href="../exports.html#G2export_CIF.ExportDataCIF">[docs]</a><span class="k">class</span> <span class="nc">ExportDataCIF</span><span class="p">(</span><span class="n">ExportCIF</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Used to create a simple CIF containing diffraction data only. Uses exact same code as</span>
<span class="sd">    :class:`ExportCIF` except that `self.mode` is set to &quot;simple&quot; and `self.currentExportType`</span>
<span class="sd">    is set to &quot;single&quot; or &quot;powder&quot; in `self.InitExport`. Shows up in menus as Data-only CIF.</span>

<span class="sd">    :param wx.Frame G2frame: reference to main GSAS-II frame</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">G2frame</span><span class="p">):</span>
        <span class="n">G2IO</span><span class="o">.</span><span class="n">ExportBaseclass</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">G2frame</span><span class="o">=</span><span class="n">G2frame</span><span class="p">,</span>
            <span class="n">formatName</span> <span class="o">=</span> <span class="s">&#39;Data-only CIF&#39;</span><span class="p">,</span>
            <span class="n">extension</span><span class="o">=</span><span class="s">&#39;.cif&#39;</span><span class="p">,</span>
            <span class="n">longFormatName</span> <span class="o">=</span> <span class="s">&#39;Export data as CIF&#39;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exporttype</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;single&#39;</span><span class="p">,</span><span class="s">&#39;powder&#39;</span><span class="p">]</span>
        <span class="c"># CIF-specific items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;simple&#39;</span>

<span class="c">#===============================================================================</span>
<span class="c"># misc CIF utilities</span>
<span class="c">#===============================================================================</span></div>
<div class="viewcode-block" id="PickleCIFdict"><a class="viewcode-back" href="../exports.html#G2export_CIF.PickleCIFdict">[docs]</a><span class="k">def</span> <span class="nf">PickleCIFdict</span><span class="p">(</span><span class="n">fil</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Loads a CIF dictionary, cherry picks out the items needed</span>
<span class="sd">    by local code and sticks them into a python dict and writes</span>
<span class="sd">    that dict out as a cPickle file for later reuse.</span>
<span class="sd">    If the write fails a warning message is printed,</span>
<span class="sd">    but no exception occurs.</span>

<span class="sd">    :param str fil: file name of CIF dictionary, will usually end</span>
<span class="sd">      in .dic</span>
<span class="sd">    :returns: the dict with the definitions  </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">import</span> <span class="nn">CifFile</span> <span class="kn">as</span> <span class="nn">cif</span> <span class="c"># PyCifRW from James Hester</span>
    <span class="n">cifdic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>             <span class="c"># patch: open file to avoid windows bug</span>
        <span class="n">dictobj</span> <span class="o">=</span> <span class="n">cif</span><span class="o">.</span><span class="n">CifDic</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">dictobj</span> <span class="o">=</span> <span class="n">cif</span><span class="o">.</span><span class="n">CifDic</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;loaded &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fil</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dictobj</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">cifdic</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s">&#39;_definition&#39;</span><span class="p">,</span><span class="s">&#39;_type&#39;</span><span class="p">,</span>
            <span class="s">&#39;_enumeration&#39;</span><span class="p">,</span>
            <span class="s">&#39;_enumeration_detail&#39;</span><span class="p">,</span>
            <span class="s">&#39;_enumeration_range&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dictobj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
                <span class="n">cifdic</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dictobj</span><span class="p">[</span><span class="n">item</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fil</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.cpickle&#39;</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cifdic</span><span class="p">,</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;wrote &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fil</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&#39;Unable to write &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fil</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cifdic</span>
</div>
<div class="viewcode-block" id="LoadCIFdic"><a class="viewcode-back" href="../exports.html#G2export_CIF.LoadCIFdic">[docs]</a><span class="k">def</span> <span class="nf">LoadCIFdic</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Create a composite core+powder CIF lookup dict containing</span>
<span class="sd">    information about all items in the CIF dictionaries, loading</span>
<span class="sd">    pickled files if possible. The routine looks for files</span>
<span class="sd">    named cif_core.cpickle and cif_pd.cpickle in every</span>
<span class="sd">    directory in the path and if they are not found, files</span>
<span class="sd">    cif_core.dic and/or cif_pd.dic are read.</span>

<span class="sd">    :returns: the dict with the definitions  </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">cifdic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ftyp</span> <span class="ow">in</span> <span class="s">&quot;cif_core&quot;</span><span class="p">,</span><span class="s">&quot;cif_pd&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">fil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span><span class="n">ftyp</span><span class="o">+</span><span class="s">&quot;.cpickle&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fil</span><span class="p">):</span> <span class="k">continue</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cifdic</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;reloaded &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fil</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">fil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span><span class="n">ftyp</span><span class="o">+</span><span class="s">&quot;.dic&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fil</span><span class="p">):</span> <span class="k">continue</span>
                <span class="c">#try:</span>
                <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">cifdic</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">PickleCIFdict</span><span class="p">(</span><span class="n">fil</span><span class="p">))</span>
                    <span class="k">break</span>
                <span class="c">#except:</span>
                <span class="c">#    pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;Could not load &#39;</span><span class="o">+</span><span class="n">ftyp</span><span class="o">+</span><span class="s">&#39; dictionary&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cifdic</span>
</div>
<div class="viewcode-block" id="CIFdefHelp"><a class="viewcode-back" href="../exports.html#G2export_CIF.CIFdefHelp">[docs]</a><span class="k">class</span> <span class="nc">CIFdefHelp</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a help button that displays help information on</span>
<span class="sd">    the current data item</span>

<span class="sd">    :param parent: the panel which will be the parent of the button</span>
<span class="sd">    :param str msg: the help text to be displayed</span>
<span class="sd">    :param wx.Dialog helpwin: Frame for CIF editing dialog</span>
<span class="sd">    :param wx.TextCtrl helptxt: TextCtrl where help text is placed</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="n">helpwin</span><span class="p">,</span><span class="n">helptxt</span><span class="p">):</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_HELP</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_onPress</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="c">#self.helpwin = self.parent.helpwin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helpwin</span> <span class="o">=</span> <span class="n">helpwin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helptxt</span> <span class="o">=</span> <span class="n">helptxt</span>
    <span class="k">def</span> <span class="nf">_onPress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;Respond to a button press by displaying the requested text&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c">#helptxt = self.helptxt</span>
            <span class="n">ow</span><span class="p">,</span><span class="n">oh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helptxt</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helptxt</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">helptxt</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">h</span> <span class="o">&gt;</span> <span class="n">oh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">helpwin</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">()</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">helpwin</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="c"># error posting help, ignore</span>
            <span class="k">return</span>
</div>
<div class="viewcode-block" id="CIF2dict"><a class="viewcode-back" href="../exports.html#G2export_CIF.CIF2dict">[docs]</a><span class="k">def</span> <span class="nf">CIF2dict</span><span class="p">(</span><span class="n">cf</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;copy the contents of a CIF out from a PyCifRW block object</span>
<span class="sd">    into a dict</span>

<span class="sd">    :returns: cifblk, loopstructure where cifblk is a dict with</span>
<span class="sd">      CIF items and loopstructure is a list of lists that defines</span>
<span class="sd">      which items are in which loops. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">blk</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="c"># assume templates are a single CIF block, use the 1st</span>
    <span class="n">loopstructure</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="n">blk</span><span class="p">]</span><span class="o">.</span><span class="n">loopnames</span><span class="p">()[:]</span> <span class="c"># copy over the list of loop contents</span>
    <span class="n">dblk</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cf</span><span class="p">[</span><span class="n">blk</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c"># make a copy of all the items in the block</span>
        <span class="n">dblk</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf</span><span class="p">[</span><span class="n">blk</span><span class="p">][</span><span class="n">item</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dblk</span><span class="p">,</span><span class="n">loopstructure</span>
</div>
<div class="viewcode-block" id="dict2CIF"><a class="viewcode-back" href="../exports.html#G2export_CIF.dict2CIF">[docs]</a><span class="k">def</span> <span class="nf">dict2CIF</span><span class="p">(</span><span class="n">dblk</span><span class="p">,</span><span class="n">loopstructure</span><span class="p">,</span><span class="n">blockname</span><span class="o">=</span><span class="s">&#39;Template&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a PyCifRW CIF object containing a single CIF</span>
<span class="sd">    block object from a dict and loop structure list.</span>

<span class="sd">    :param dblk: a dict containing values for each CIF item</span>
<span class="sd">    :param list loopstructure: a list of lists containing the contents of</span>
<span class="sd">      each loop, as an example::</span>

<span class="sd">         [ [&quot;_a&quot;,&quot;_b&quot;], [&quot;_c&quot;], [&quot;_d_1&quot;,&quot;_d_2&quot;,&quot;_d_3&quot;]]</span>

<span class="sd">      this describes a CIF with this type of structure::</span>

<span class="sd">        loop_ _a _b &lt;a1&gt; &lt;b1&gt; &lt;a2&gt; ...</span>
<span class="sd">        loop_ _c &lt;c1&gt; &lt;c2&gt;...</span>
<span class="sd">        loop _d_1 _d_2 _d_3 ...</span>

<span class="sd">      Note that the values for each looped CIF item, such as _a,</span>
<span class="sd">      are contained in a list, for example as cifblk[&quot;_a&quot;]</span>

<span class="sd">    :param str blockname: an optional name for the CIF block.</span>
<span class="sd">      Defaults to &#39;Template&#39;</span>

<span class="sd">    :returns: the newly created PyCifRW CIF object </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">CifFile</span> <span class="kn">as</span> <span class="nn">cif</span> <span class="c"># PyCifRW from James Hester</span>
    <span class="c"># compile a &#39;list&#39; of items in loops</span>
    <span class="n">loopnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loopstructure</span><span class="p">:</span>
        <span class="n">loopnames</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="c"># create a new block</span>
    <span class="n">newblk</span> <span class="o">=</span> <span class="n">cif</span><span class="o">.</span><span class="n">CifBlock</span><span class="p">()</span>
    <span class="c"># add the looped items</span>
    <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">loopstructure</span><span class="p">:</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dblk</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">newblk</span><span class="o">.</span><span class="n">AddCifItem</span><span class="p">(([</span><span class="n">keys</span><span class="p">],[</span><span class="n">vals</span><span class="p">]))</span>
    <span class="c"># add the non-looped items</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dblk</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">newblk</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">dblk</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
    <span class="c"># create a CIF and add the block</span>
    <span class="n">newcf</span> <span class="o">=</span> <span class="n">cif</span><span class="o">.</span><span class="n">CifFile</span><span class="p">()</span>
    <span class="n">newcf</span><span class="p">[</span><span class="n">blockname</span><span class="p">]</span> <span class="o">=</span> <span class="n">newblk</span>    
    <span class="k">return</span> <span class="n">newcf</span>

</div>
<div class="viewcode-block" id="EditCIFtemplate"><a class="viewcode-back" href="../exports.html#G2export_CIF.EditCIFtemplate">[docs]</a><span class="k">class</span> <span class="nc">EditCIFtemplate</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Dialog</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a dialog for editing a CIF template. The edited information is</span>
<span class="sd">    placed in cifblk. If the CIF is saved as a file, the name of that file</span>
<span class="sd">    is saved as ``self.newfile``.</span>
<span class="sd">    </span>
<span class="sd">    :param wx.Frame parent: parent frame or None</span>
<span class="sd">    :param cifblk: dict or PyCifRW block containing values for each CIF item</span>
<span class="sd">    :param list loopstructure: a list of lists containing the contents of</span>
<span class="sd">      each loop, as an example::</span>

<span class="sd">         [ [&quot;_a&quot;,&quot;_b&quot;], [&quot;_c&quot;], [&quot;_d_1&quot;,&quot;_d_2&quot;,&quot;_d_3&quot;]]</span>

<span class="sd">      this describes a CIF with this type of structure::</span>

<span class="sd">        loop_ _a _b &lt;a1&gt; &lt;b1&gt; &lt;a2&gt; ...</span>
<span class="sd">        loop_ _c &lt;c1&gt; &lt;c2&gt;...</span>
<span class="sd">        loop _d_1 _d_2 _d_3 ...</span>

<span class="sd">      Note that the values for each looped CIF item, such as _a,</span>
<span class="sd">      are contained in a list, for example as cifblk[&quot;_a&quot;]</span>
<span class="sd">      </span>
<span class="sd">    :param str defaultname: specifies the default file name to be used for </span>
<span class="sd">      saving the CIF.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">cifblk</span><span class="p">,</span><span class="n">loopstructure</span><span class="p">,</span><span class="n">defaultname</span><span class="p">):</span>
        <span class="n">OKbuttons</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span> <span class="o">=</span> <span class="n">cifblk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loopstructure</span> <span class="o">=</span> <span class="n">loopstructure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newfile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span> <span class="o">=</span> <span class="n">defaultname</span>        
        <span class="k">global</span> <span class="n">CIFdic</span>  <span class="c"># once this is loaded, keep it around</span>
        <span class="k">if</span> <span class="n">CIFdic</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">CIFdic</span> <span class="o">=</span> <span class="n">LoadCIFdic</span><span class="p">()</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">Dialog</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">DEFAULT_DIALOG_STYLE</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">RESIZE_BORDER</span><span class="p">)</span>

        <span class="c"># define widgets that will be needed during panel creation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helptxt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">savebtn</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_CLOSE</span><span class="p">,</span> <span class="s">&quot;Save as template&quot;</span><span class="p">)</span>
        <span class="n">OKbuttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">savebtn</span><span class="p">)</span>
        <span class="n">savebtn</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_onSave</span><span class="p">)</span>
        <span class="n">OKbtn</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">,</span> <span class="s">&quot;Use&quot;</span><span class="p">)</span>
        <span class="n">OKbtn</span><span class="o">.</span><span class="n">SetDefault</span><span class="p">()</span>
        <span class="n">OKbuttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">OKbtn</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SetTitle</span><span class="p">(</span><span class="s">&#39;Edit items in CIF template&#39;</span><span class="p">)</span>
        <span class="n">vbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">cpnl</span> <span class="o">=</span> <span class="n">EditCIFpanel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cifblk</span><span class="p">,</span><span class="n">loopstructure</span><span class="p">,</span><span class="n">CIFdic</span><span class="p">,</span><span class="n">OKbuttons</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">300</span><span class="p">))</span>
        <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">cpnl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_LEFT</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">vbox</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">helptxt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">G2gd</span><span class="o">.</span><span class="n">HorizontalLine</span><span class="p">(</span><span class="n">vbox</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">btnsizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
        <span class="n">btn</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_CANCEL</span><span class="p">)</span>
        <span class="n">btnsizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">btn</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
        <span class="n">btnsizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">savebtn</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
        <span class="n">btnsizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">OKbtn</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
        <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">btnsizer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">vbox</span><span class="p">)</span>
        <span class="n">vbox</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<div class="viewcode-block" id="EditCIFtemplate.Post"><a class="viewcode-back" href="../exports.html#G2export_CIF.EditCIFtemplate.Post">[docs]</a>    <span class="k">def</span> <span class="nf">Post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Display the dialog</span>
<span class="sd">        </span>
<span class="sd">        :returns: True unless Cancel has been pressed.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">)</span></div>
    <span class="k">def</span> <span class="nf">_onSave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;Save CIF entries in a template file&#39;</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FileDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Save as CIF template&quot;</span><span class="p">,</span>
            <span class="n">defaultDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
            <span class="n">defaultFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span><span class="p">,</span>
            <span class="n">wildcard</span><span class="o">=</span><span class="s">&quot;CIF (*.cif)|*.cif&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">SAVE</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">CHANGE_DIR</span>
            <span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">)</span>
        <span class="n">fil</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetPath</span><span class="p">()</span>
        <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span> <span class="c"># ignore a Cancel button</span>
            <span class="n">fil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fil</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;.cif&#39;</span> <span class="c"># force extension</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fil</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">newcf</span> <span class="o">=</span> <span class="n">dict2CIF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">loopstructure</span><span class="p">)</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newcf</span><span class="o">.</span><span class="n">WriteOut</span><span class="p">())</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">newfile</span> <span class="o">=</span> <span class="n">fil</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EndModal</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EditCIFpanel"><a class="viewcode-back" href="../exports.html#G2export_CIF.EditCIFpanel">[docs]</a><span class="k">class</span> <span class="nc">EditCIFpanel</span><span class="p">(</span><span class="n">wxscroll</span><span class="o">.</span><span class="n">ScrolledPanel</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Creates a scrolled panel for editing CIF template items</span>

<span class="sd">    :param wx.Frame parent: parent frame where panel will be placed</span>
<span class="sd">    :param cifblk: dict or PyCifRW block containing values for each CIF item</span>
<span class="sd">    :param list loopstructure: a list of lists containing the contents of</span>
<span class="sd">      each loop, as an example::</span>

<span class="sd">         [ [&quot;_a&quot;,&quot;_b&quot;], [&quot;_c&quot;], [&quot;_d_1&quot;,&quot;_d_2&quot;,&quot;_d_3&quot;]]</span>

<span class="sd">      this describes a CIF with this type of structure::</span>

<span class="sd">        loop_ _a _b &lt;a1&gt; &lt;b1&gt; &lt;a2&gt; ...</span>
<span class="sd">        loop_ _c &lt;c1&gt; &lt;c2&gt;...</span>
<span class="sd">        loop _d_1 _d_2 _d_3 ...</span>

<span class="sd">      Note that the values for each looped CIF item, such as _a,</span>
<span class="sd">      are contained in a list, for example as cifblk[&quot;_a&quot;]</span>

<span class="sd">    :param dict cifdic: optional CIF dictionary definitions</span>
<span class="sd">    :param list OKbuttons: A list of wx.Button objects that should</span>
<span class="sd">      be disabled when information in the CIF is invalid</span>
<span class="sd">    :param (other): optional keyword parameters for wx.ScrolledPanel</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">cifblk</span><span class="p">,</span> <span class="n">loopstructure</span><span class="p">,</span> <span class="n">cifdic</span><span class="o">=</span><span class="p">{},</span> <span class="n">OKbuttons</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="n">wxscroll</span><span class="o">.</span><span class="n">ScrolledPanel</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vbox</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddDict</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span> <span class="o">=</span> <span class="n">cifdic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span> <span class="o">=</span> <span class="n">cifblk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loops</span> <span class="o">=</span> <span class="n">loopstructure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LayoutCalled</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parentOKbuttons</span> <span class="o">=</span> <span class="n">OKbuttons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ValidatedControlsList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_fill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&#39;Fill the scrolled panel with widgets for each CIF item&#39;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AddDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ValidatedControlsList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># delete any only contents</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">vbox</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vbox</span><span class="o">.</span><span class="n">DeleteWindows</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vbox</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Update</span><span class="p">()</span>
        <span class="n">vbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vbox</span> <span class="o">=</span> <span class="n">vbox</span>
        <span class="c"># compile a &#39;list&#39; of items in loops</span>
        <span class="n">loopnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">:</span>
            <span class="n">loopnames</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="c"># post the looped CIF items</span>
        <span class="k">for</span> <span class="n">lnum</span><span class="p">,</span><span class="n">lp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">):</span>
            <span class="n">hbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
            <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&#39;Loop &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">lnum</span><span class="o">+</span><span class="mi">1</span><span class="p">)))</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">hbox</span><span class="p">)</span>
            <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&quot;Add row&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AddDict</span><span class="p">[</span><span class="n">but</span><span class="p">]</span><span class="o">=</span><span class="n">lnum</span>
            
            <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">)</span>            
            <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">OnAddRow</span><span class="p">)</span>
            <span class="n">fbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GridBagSizer</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">fbox</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lp</span><span class="p">):</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">item</span><span class="o">+</span><span class="s">&quot;  &quot;</span><span class="p">)</span>
                <span class="n">fbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">txt</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="c"># if self.cifdic.get(item):</span>
                <span class="c">#     df = self.cifdic[item].get(&#39;_definition&#39;)</span>
                <span class="c">#     if df:</span>
                <span class="c">#         txt.SetToolTipString(G2IO.trim(df))</span>
                <span class="c">#         but = CIFdefHelp(self,</span>
                <span class="c">#                          &quot;Definition for &quot;+item+&quot;:\n\n&quot;+G2IO.trim(df),</span>
                <span class="c">#                          self.parent,</span>
                <span class="c">#                          self.parent.helptxt)</span>
                <span class="c">#         fbox.Add(but,(1,i+1),flag=wx.ALIGN_CENTER)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span><span class="p">[</span><span class="n">item</span><span class="p">]):</span>
                    <span class="n">ent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIFEntryWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span><span class="p">[</span><span class="n">item</span><span class="p">],</span><span class="n">j</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
                    <span class="c">#fbox.Add(ent,(j+2,i+1),flag=wx.EXPAND|wx.ALL)</span>
                    <span class="n">fbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ent</span><span class="p">,(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">flag</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_definition&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">df</span><span class="p">:</span>
                        <span class="n">txt</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">G2IO</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
                        <span class="n">but</span> <span class="o">=</span> <span class="n">CIFdefHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="s">&quot;Definition for &quot;</span><span class="o">+</span><span class="n">item</span><span class="o">+</span><span class="s">&quot;:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="o">+</span><span class="n">G2IO</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">helptxt</span><span class="p">)</span>
                        <span class="n">fbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,(</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">flag</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="p">)</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span><span class="p">[</span><span class="n">item</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">fbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">txt</span><span class="p">,(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">LI_HORIZONTAL</span><span class="p">)</span>
            <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                
        <span class="c"># post the non-looped CIF items</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loopnames</span><span class="p">:</span>
                <span class="n">hbox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
                <span class="n">vbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">hbox</span><span class="p">)</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
                <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
                <span class="n">ent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIFEntryWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">item</span><span class="p">)</span>
                <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_definition&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">df</span><span class="p">:</span>
                        <span class="n">txt</span><span class="o">.</span><span class="n">SetToolTipString</span><span class="p">(</span><span class="n">G2IO</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
                        <span class="n">but</span> <span class="o">=</span> <span class="n">CIFdefHelp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                         <span class="s">&quot;Definition for &quot;</span><span class="o">+</span><span class="n">item</span><span class="o">+</span><span class="s">&quot;:</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="o">+</span><span class="n">G2IO</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">helptxt</span><span class="p">)</span>
                        <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALL</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">vbox</span><span class="p">)</span>
        <span class="c">#vbox.Fit(self.parent)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetAutoLayout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetupScrolling</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">rw</span><span class="o">.</span><span class="n">EVT_RW_LAYOUT_NEEDED</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnLayoutNeeded</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
<div class="viewcode-block" id="EditCIFpanel.OnLayoutNeeded"><a class="viewcode-back" href="../exports.html#G2export_CIF.EditCIFpanel.OnLayoutNeeded">[docs]</a>    <span class="k">def</span> <span class="nf">OnLayoutNeeded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Called when an update of the panel layout is needed. Calls</span>
<span class="sd">        self.DoLayout after the current operations are complete using</span>
<span class="sd">        CallAfter. This is called only once, according to flag</span>
<span class="sd">        self.LayoutCalled, which is cleared in self.DoLayout. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LayoutCalled</span><span class="p">:</span> <span class="k">return</span> <span class="c"># call already queued</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DoLayout</span><span class="p">)</span> <span class="c"># queue a call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LayoutCalled</span> <span class="o">=</span> <span class="bp">True</span></div>
<div class="viewcode-block" id="EditCIFpanel.DoLayout"><a class="viewcode-back" href="../exports.html#G2export_CIF.EditCIFpanel.DoLayout">[docs]</a>    <span class="k">def</span> <span class="nf">DoLayout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the Layout and scroll bars for the Panel. Clears</span>
<span class="sd">        self.LayoutCalled so that next change to panel can</span>
<span class="sd">        request a new update</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">BeginBusyCursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetupScrolling</span><span class="p">()</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">EndBusyCursor</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LayoutCalled</span> <span class="o">=</span> <span class="bp">False</span></div>
<div class="viewcode-block" id="EditCIFpanel.OnAddRow"><a class="viewcode-back" href="../exports.html#G2export_CIF.EditCIFpanel.OnAddRow">[docs]</a>    <span class="k">def</span> <span class="nf">OnAddRow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;add a row to a loop&#39;</span>
        <span class="n">lnum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AddDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">lnum</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loops</span><span class="p">[</span><span class="n">lnum</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifblk</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fill</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="EditCIFpanel.ControlOKButton"><a class="viewcode-back" href="../exports.html#G2export_CIF.EditCIFpanel.ControlOKButton">[docs]</a>    <span class="k">def</span> <span class="nf">ControlOKButton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">setvalue</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Enable or Disable the OK button(s) for the dialog. Note that this is</span>
<span class="sd">        passed into the ValidatedTxtCtrl for use by validators.</span>

<span class="sd">        :param bool setvalue: if True, all entries in the dialog are</span>
<span class="sd">          checked for validity. The first invalid control triggers</span>
<span class="sd">          disabling of buttons.</span>
<span class="sd">          If False then the OK button(s) are disabled with no checking</span>
<span class="sd">          of the invalid flag for each control.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">setvalue</span><span class="p">:</span> <span class="c"># turn button on, do only if all controls show as valid</span>
            <span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ValidatedControlsList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">invalid</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentOKbuttons</span><span class="p">:</span>
                        <span class="n">btn</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentOKbuttons</span><span class="p">:</span>
                    <span class="n">btn</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parentOKbuttons</span><span class="p">:</span>
                <span class="n">btn</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
        </div>
<div class="viewcode-block" id="EditCIFpanel.CIFEntryWidget"><a class="viewcode-back" href="../exports.html#G2export_CIF.EditCIFpanel.CIFEntryWidget">[docs]</a>    <span class="k">def</span> <span class="nf">CIFEntryWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dct</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">dataname</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create an entry widget for a CIF item. Use a validated entry for numb values</span>
<span class="sd">        where int is required when limits are integers and floats otherwise.</span>
<span class="sd">        At present this does not allow entry of the special CIF values of &quot;.&quot; and &quot;?&quot; for</span>
<span class="sd">        numerical values and highlights them as invalid.</span>
<span class="sd">        Use a selection widget when there are specific enumerated values for a string.        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataname</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_enumeration&#39;</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;?&#39;</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="s">&#39;_enumeration&#39;</span><span class="p">]</span>
                <span class="n">choices</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;undefined&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_enumeration_detail&#39;</span><span class="p">,</span><span class="n">values</span><span class="p">):</span>
                    <span class="n">choices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G2IO</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">ent</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">EnumSelector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">choices</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">ent</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;numb&#39;</span><span class="p">:</span>
                <span class="n">mn</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">mx</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">hint</span> <span class="o">=</span> <span class="nb">int</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="p">[</span><span class="n">dataname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_enumeration_range&#39;</span><span class="p">):</span>
                    <span class="n">rng</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cifdic</span><span class="p">[</span><span class="n">dataname</span><span class="p">][</span><span class="s">&#39;_enumeration_range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">rng</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">hint</span> <span class="o">=</span> <span class="nb">float</span>
                    <span class="k">if</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">mn</span> <span class="o">=</span> <span class="n">hint</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">rng</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">mx</span> <span class="o">=</span> <span class="n">hint</span><span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">ent</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">ValidatedTxtCtrl</span><span class="p">(</span>
                        <span class="bp">self</span><span class="p">,</span><span class="n">dct</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">typeHint</span><span class="o">=</span><span class="n">hint</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="n">mn</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="n">mx</span><span class="p">,</span>
                        <span class="n">CIFinput</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">OKcontrol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ControlOKButton</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ValidatedControlsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ent</span>
        <span class="n">rw1</span> <span class="o">=</span> <span class="n">rw</span><span class="o">.</span><span class="n">ResizeWidget</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ent</span> <span class="o">=</span> <span class="n">G2gd</span><span class="o">.</span><span class="n">ValidatedTxtCtrl</span><span class="p">(</span>
            <span class="n">rw1</span><span class="p">,</span><span class="n">dct</span><span class="p">,</span><span class="n">item</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_MULTILINE</span><span class="o">|</span><span class="n">wx</span><span class="o">.</span><span class="n">TE_PROCESS_ENTER</span><span class="p">,</span>
            <span class="n">CIFinput</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">OKcontrol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ControlOKButton</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ValidatedControlsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rw1</span>
</div></div>
<div class="viewcode-block" id="CIFtemplateSelect"><a class="viewcode-back" href="../exports.html#G2export_CIF.CIFtemplateSelect">[docs]</a><span class="k">class</span> <span class="nc">CIFtemplateSelect</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create a set of buttons to show, select and edit a CIF template</span>
<span class="sd">    </span>
<span class="sd">    :param frame: wx.Frame object of parent</span>
<span class="sd">    :param panel: wx.Panel object where widgets should be placed</span>
<span class="sd">    :param str tmplate: one of &#39;publ&#39;, &#39;phase&#39;, or &#39;instrument&#39; to determine</span>
<span class="sd">      the type of template</span>
<span class="sd">    :param dict G2dict: GSAS-II dict where CIF should be placed. The key</span>
<span class="sd">      &quot;CIF_template&quot; will be used to store either a list or a string.</span>
<span class="sd">      If a list, it will contain a dict and a list defining loops. If</span>
<span class="sd">      an str, it will contain a file name.    </span>
<span class="sd">    :param function repaint: reference to a routine to be called to repaint</span>
<span class="sd">      the frame after a change has been made</span>
<span class="sd">    :param str title: A line of text to show at the top of the window</span>
<span class="sd">    :param str defaultname: specifies the default file name to be used for </span>
<span class="sd">      saving the CIF.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">,</span><span class="n">panel</span><span class="p">,</span><span class="n">tmplate</span><span class="p">,</span><span class="n">G2dict</span><span class="p">,</span> <span class="n">repaint</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">defaultname</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict</span> <span class="o">=</span> <span class="n">G2dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repaint</span> <span class="o">=</span> <span class="n">repaint</span>
        <span class="n">templateDefName</span> <span class="o">=</span> <span class="s">&#39;template_&#39;</span><span class="o">+</span><span class="n">tmplate</span><span class="o">+</span><span class="s">&#39;.cif&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CIF</span> <span class="o">=</span> <span class="n">G2dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;CIF_template&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">defaultname</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span> <span class="o">=</span> <span class="n">defaultname</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;[^a-zA-Z0-9_-]&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span> <span class="o">=</span> <span class="n">tmplate</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span> <span class="o">+</span> <span class="s">&quot;.cif&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            
        <span class="n">txt</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="p">)</span>
        <span class="c"># change font on title</span>
        <span class="n">txtfnt</span> <span class="o">=</span> <span class="n">txt</span><span class="o">.</span><span class="n">GetFont</span><span class="p">()</span>
        <span class="n">txtfnt</span><span class="o">.</span><span class="n">SetWeight</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="n">txtfnt</span><span class="o">.</span><span class="n">SetPointSize</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">txtfnt</span><span class="o">.</span><span class="n">GetPointSize</span><span class="p">())</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">SetFont</span><span class="p">(</span><span class="n">txtfnt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Add</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">:</span> <span class="c"># empty or None</span>
            <span class="k">for</span> <span class="n">pth</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()]</span><span class="o">+</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                <span class="n">fil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CIF</span> <span class="o">=</span> <span class="n">fil</span>
                    <span class="n">CIFtxt</span> <span class="o">=</span> <span class="s">&quot;Template: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pth</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
                    <span class="n">fil</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pth</span><span class="p">,</span><span class="n">templateDefName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fil</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CIF</span> <span class="o">=</span> <span class="n">fil</span>
                        <span class="n">CIFtxt</span> <span class="o">=</span> <span class="s">&quot;Template: &quot;</span><span class="o">+</span><span class="n">templateDefName</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Default CIF template &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span><span class="o">+</span><span class="s">&#39; not found in path!&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">CIF</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">CIFtxt</span> <span class="o">=</span> <span class="s">&quot;none! (No template found)&quot;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Error: template file has disappeared: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CIF</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">CIFtxt</span> <span class="o">=</span> <span class="s">&quot;none! (file not found)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="n">CIFtxt</span> <span class="o">=</span> <span class="s">&quot;File: &quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">CIFtxt</span> <span class="o">=</span> <span class="s">&quot;File: ...&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">[</span><span class="o">-</span><span class="mi">50</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CIFtxt</span> <span class="o">=</span> <span class="s">&quot;Template is customized&quot;</span>
        <span class="c"># show template source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="n">CIFtxt</span><span class="p">))</span>
        <span class="c"># show str, button to select file; button to edit (if CIF defined)</span>
        <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&quot;Select Template File&quot;</span><span class="p">)</span>
        <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_onGetTemplateFile</span><span class="p">)</span>
        <span class="n">hbox</span> <span class="o">=</span>  <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">)</span>
        <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">but</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">panel</span><span class="p">,</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span><span class="s">&quot;Edit Template&quot;</span><span class="p">)</span>
        <span class="n">but</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_BUTTON</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_onEditTemplateContents</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CIF</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">but</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span> <span class="c"># nothing to edit!</span>
        <span class="n">hbox</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">but</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">hbox</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_onGetTemplateFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;select a template file&#39;</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">FileDialog</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Read CIF template file&quot;</span><span class="p">,</span>
            <span class="n">defaultDir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
            <span class="n">defaultFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span><span class="p">,</span>
            <span class="n">wildcard</span><span class="o">=</span><span class="s">&quot;CIF (*.cif)|*.cif&quot;</span><span class="p">,</span>
            <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">OPEN</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">CHANGE_DIR</span>
            <span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span>
        <span class="n">fil</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">GetPath</span><span class="p">()</span>
        <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">ID_OK</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cf</span> <span class="o">=</span> <span class="n">G2IO</span><span class="o">.</span><span class="n">ReadCIF</span><span class="p">(</span><span class="n">fil</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cf</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span><span class="s">&quot;No CIF data_ blocks found&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cf</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">,</span> <span class="s">&#39;Error, CIF Template has more than one block: &#39;</span><span class="o">+</span><span class="n">fil</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&quot;CIF_template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fil</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Error reading CIF: &#39;</span><span class="o">+</span><span class="n">fil</span><span class="p">)</span>
                <span class="n">dlg</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MessageDialog</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span>
                                   <span class="s">&#39;Error reading CIF &#39;</span><span class="o">+</span><span class="n">fil</span><span class="p">,</span>
                                   <span class="s">&#39;Error in CIF file&#39;</span><span class="p">,</span>
                                   <span class="n">wx</span><span class="o">.</span><span class="n">OK</span><span class="p">)</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">ShowModal</span><span class="p">()</span>
                <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span> <span class="c">#EditCIFDefaults()</span>

    <span class="k">def</span> <span class="nf">_onEditTemplateContents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="s">&#39;Called to edit the contents of a CIF template&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span>  <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">dblk</span><span class="p">,</span><span class="n">loopstructure</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">)</span> <span class="c"># don&#39;t modify original</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="n">G2IO</span><span class="o">.</span><span class="n">ReadCIF</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CIF</span><span class="p">)</span>
            <span class="n">dblk</span><span class="p">,</span><span class="n">loopstructure</span> <span class="o">=</span> <span class="n">CIF2dict</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span>
        <span class="n">dlg</span> <span class="o">=</span> <span class="n">EditCIFtemplate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cifdefs</span><span class="p">,</span><span class="n">dblk</span><span class="p">,</span><span class="n">loopstructure</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultname</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">Post</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dlg</span><span class="o">.</span><span class="n">newfile</span><span class="p">:</span> <span class="c"># results saved in file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&quot;CIF_template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlg</span><span class="o">.</span><span class="n">newfile</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dict</span><span class="p">[</span><span class="s">&quot;CIF_template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dlg</span><span class="o">.</span><span class="n">cifblk</span><span class="p">,</span><span class="n">dlg</span><span class="o">.</span><span class="n">loopstructure</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">repaint</span><span class="p">()</span> <span class="c">#EditCIFDefaults() # note that this does a dlg.Destroy()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dlg</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>        

<span class="c">#===============================================================================</span>
<span class="c"># end of misc CIF utilities</span>
<span class="c">#===============================================================================</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/G2_html_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">GSAS-II 0.2.0 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Von Dreele and Toby for Argonne National Laboratory.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>